<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Redisä¸‰å¤§ç¼“å­˜é—®é¢˜</title>
      <link href="/cn/Redis%E7%BC%93%E5%AD%98/"/>
      <url>/cn/Redis%E7%BC%93%E5%AD%98/</url>
      
        <content type="html"><![CDATA[<h1 id="Redisç¼“å­˜é—®é¢˜"><a href="#Redisç¼“å­˜é—®é¢˜" class="headerlink" title="Redisç¼“å­˜é—®é¢˜"></a>Redisç¼“å­˜é—®é¢˜</h1><p>ä½•ä¸ºç¼“å­˜ï¼Ÿ</p><blockquote><p>ç¼“å­˜ï¼ˆCacheï¼‰å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼Œä¿—ç§°çš„ç¼“å­˜å°±æ˜¯ç¼“å†²åŒºå†…çš„æ•°æ®ï¼Œä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–ï¼Œå­˜å‚¨äºæœ¬åœ°ã€‚</p></blockquote><p> ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨æ•°æ®äº¤æ¢çš„è¿‡ç¨‹ä¸­ä¸»è¦å­˜åœ¨ç€ä¸‰ä¸ªè§’è‰²ï¼Œé¡¾å®¢ã€å¤–å–æŸœã€å¤–å–å‘˜ã€‚é¡¾å®¢æ‹¿å¤–å–çš„å½¢å¼æœ‰ä¸¤ç§ï¼š</p><ol><li>å¤–å–å‘˜ç›´æ¥æŠŠå¤–å–äº¤ç»™é¡¾å®¢</li><li>å¤–å–å‘˜æŠŠå¤–å–æ”¾äºå¤–å–æŸœï¼Œé¡¾å®¢ä»å¤–å–æŸœé‡Œæ‹¿</li></ol><p>åœ¨è¿™ä¿©ä¸ªåœºæ™¯ä¸­ï¼Œå¤–å–æŸœå°±æƒ³å½“äºæ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬æŠŠ&#x3D;&#x3D;å¤–å–&#x3D;&#x3D;æ”¾åˆ°å¤–å–æŸœä¸­å°±æ˜¯æˆ‘ä»¬è®²åœ°ç¼“å­˜æ“ä½œã€‚</p><p>çŸ¥é“äº†ä»€ä¹ˆæ˜¯ç¼“å­˜åï¼Œæˆ‘ä»¬èŠä¸€èŠä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜ï¼Ÿ</p><p>æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼š</p><blockquote><p>â€œå¤–å–å‘˜åˆ°äº†ä½ å®¶æ¥¼ä¸‹ï¼Œä½†ä½ æ²‰è¿·åœ¨â€™é»‘ç¥è¯â€˜ä¸­æ‰“bossï¼Œæ²¡æœ‰ç†ä¼šå¤–å–å‘˜ã€‚å¯¼è‡´å¤–å–å‘˜å…¶ä»–å¤–å–é¢ä¸´è¶…æ—¶é£é™©ï¼Œäºæ˜¯å¤–å–å‘˜ç›´æ¥è‡ªçˆ†ï¼Œä½ çš„å¤–å–ä¹Ÿæ— äº†ï¼â€ã€‚</p></blockquote><p>æœ‰äº†å¤–å–æŸœåï¼Œå¤–å–å‘˜å¯ä»¥æŠŠå¤–å–æ”¾å…¥å…¶ä¸­ï¼Œç„¶åç»™ç”¨æˆ·å‘ä¸€ä¸ªæå–ç å³å¯ã€‚äºŒè€…ä¸å†æ˜¯ç‚¹å¯¹ç‚¹åœ°äº¤äº’ï¼Œè€Œæ˜¯æœ‰äº†ä¸€ä¸ªçº½å¸¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´åœ°&#x3D;&#x3D;ç¼“å­˜åŒº&#x3D;&#x3D;ã€‚</p><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒæœåŠ¡ç«¯æ˜¯æ•°æ®åº“ï¼Œå®ƒåªéœ€è¦æŠŠæ•°æ®äº¤ç»™<em>redis</em>ï¼Œè€Œå®¢æˆ·ç«¯ä»<em>redis</em>ä¸­è·å–æ•°æ®å³å¯ã€‚è¿™æ ·çš„å¥½å¤„åœ¨äºï¼š</p><ol><li>å¯¹äºæŸäº›ç»å¸¸æ€§è®¿é—®ã€ä¿®æ”¹é¢‘ç‡ä½çš„æ•°æ®ï¼Œæ¯”å¦‚â€œä¸ªäººä¿¡æ¯ã€å¯¼èˆªæ ä¿¡æ¯ã€ç‰©å“çš„ä»‹ç»ä¿¡æ¯â€ã€‚</li><li>ç”¨æˆ·ä»Redisè¿™ä¸ªå¤–å–æŸœé‡Œç›´æ¥è·å–æ•°æ®ï¼Œå‡è½»æ•°æ®åº“çš„é«˜é¢‘è¯·æ±‚å‹åŠ›ã€‚</li><li>å…¶æ¬¡ï¼ŒRediså°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦è¿œè¿œå¿«äºç£ç›˜ï¼Œæé«˜ç”¨æˆ·çš„è®¿é—®é€Ÿåº¦ã€‚</li></ol><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRediså°†æ•°æ®å­˜äºå†…å­˜ä¸­ï¼Œä¹Ÿæ„å‘³ç€ä¸€æ—¦Rediså®•æœºï¼Œæ•°æ®ç›´æ¥æ— äº†ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¹Ÿæœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆï¼š<strong>ä¸»ä»å¤åˆ¶</strong>ã€<strong>å“¨å…µï¼ˆSentinelï¼‰æ¨¡å¼</strong>ã€<strong>æŒä¹…åŒ–æœºåˆ¶</strong>ã€<strong>Redisé›†ç¾¤</strong>ç­‰ã€‚</p></blockquote><p>çœ‹åˆ°è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯è®¤ä¸º<em>Redis</em>ç¼“å­˜æ¨¡å¼æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§é—®é¢˜ï¼Œå°†æ•°æ®æ”¾å…¥<em>Redis</em>åç­‰ç€ç”¨æˆ·æ¥å–ä¼¼ä¹å°±å®Œäº‹å¤§å‰äº†ã€‚æ¸©é¦¨æç¤ºæˆ‘ä»¬åœ¨å¯¹<code>redis</code>ä½¿ç”¨çš„è¿‡ç¨‹ä¸­è¿˜éœ€è¦æ³¨æ„ä»¥ä¸‹ç¼“å­˜ç›¸å…³çš„é—®é¢˜ã€‚</p><h2 id="ä¸€ã€ç¼“å­˜ç©¿é€"><a href="#ä¸€ã€ç¼“å­˜ç©¿é€" class="headerlink" title="ä¸€ã€ç¼“å­˜ç©¿é€"></a>ä¸€ã€ç¼“å­˜ç©¿é€</h2><p>ç¼“å­˜ç©¿é€æŒ‡çš„æ˜¯å¤§é‡æ¶æ„æˆ–è€…éæ³•è¯·æ±‚<strong>é¿å¼€äº†å¯¹ç¼“å­˜çš„è°ƒç”¨</strong>ï¼Œç›´æ¥è®¿é—®æ•°æ®åº“æˆ–è€…åç«¯æœåŠ¡ã€‚</p><p>é¦–å…ˆç»™ä¸€å¼ ç”¨æˆ·è®¿é—®åœ°æµç¨‹å›¾ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/25/j9r7ZCNaEYJPVpo.png" alt="IMG_202408249242_329x300.png"></p><p>ç®€å•è§£é‡Šä»¥ä¸‹ï¼Œå½“ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶ï¼Œå¦‚æœRedisæœ‰å¯¹åº”æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯å­˜åœ¨<code>key</code>ï¼‰ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼›å¦‚æœæ²¡æœ‰å¯¹åº”çš„<code>Key</code>ï¼Œé‚£ä¹ˆè®¿é—®æ•°æ®åº“è¿”å›æ•°æ®ä»¥åŠå­˜å…¥Redisä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è¯·æ±‚ã€‚</p><blockquote><p>Redisæ˜¯ä¸€ç§é«˜æ€§èƒ½çš„é”®å€¼å‹ï¼ˆkey-valueï¼‰æ•°æ®åº“ã€‚</p></blockquote><p>è€Œç¼“å­˜ç©¿é€åˆ™æ˜¯æ²¡æœ‰äº†å¯¹&#x3D;&#x3D;Redis&#x3D;&#x3D;è¿™ä¸€æ­¥æ“ä½œï¼Œé€šè¿‡è®¿é—®ä¸€ä¸ªä¸å¯èƒ½å­˜åœ¨çš„<code>Key</code>ï¼Œç»•è¿‡äº†ä»&#x3D;&#x3D;Redis&#x3D;&#x3D;ä¸­è·å–æ•°æ®ï¼Œå°†è¯·æ±‚å…¨éƒ¨æ‰“åˆ°<code>MySQL</code>ã€‚åˆå› ä¸º<code>MySQL</code>ä¹Ÿæ²¡æœ‰è¯¥<code>Key</code>å¯¹åº”çš„æ•°æ®ï¼Œå¯¼è‡´ä¹‹åçš„å…¨éƒ¨è¯·æ±‚ä¾ç„¶ä¼šæ‰“å‘<code>MySQL</code>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><ul><li>é€šè¿‡<code>id=-1</code>æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆè¿™é‡Œå‡è®¾<code>key</code>ä¹Ÿä¸ºå•†å“<code>id</code>ï¼‰</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">shopStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br></pre></td></tr></table></figure><ul><li>å› ä¸º<code>key</code>ä¸å­˜åœ¨ï¼Œè¿”å›çš„<code>shopStr</code>ä¸º<code>null</code>ï¼Œå¤§é‡è¯·æ±‚ä¼šè®¿é—®æ•°æ®åº“</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Shop</span> <span class="variable">shopInfo</span> <span class="operator">=</span> shopMapper.selectById(id);</span><br></pre></td></tr></table></figure><ul><li>è¿™é‡Œçš„<code>shopInfo</code>ä¹Ÿä¸€å®šä¸º<code>null</code>ï¼›æ—¢ä¸ä¼šè¿”å›æ•°æ®ï¼Œä¹Ÿä¸ä¼šç¼“å­˜æ•°æ®åˆ°&#x3D;&#x3D;Redis&#x3D;&#x3D;ä¸­ï¼Œé™·å…¥æ¶æ€§å¾ªç¯ã€‚</li></ul><p>é‚£æœ‰ä»€ä¹ˆè§£å†³ä¹‹é“å‘¢ï¼Ÿ</p><h3 id="ç¼“å­˜NULLå€¼"><a href="#ç¼“å­˜NULLå€¼" class="headerlink" title="ç¼“å­˜NULLå€¼"></a>ç¼“å­˜NULLå€¼</h3><p>ç¼“å­˜ç©¿é€å½’æ ¹ç»“åº•æ˜¯å› ä¸º<code>MySQL</code>ä¸­æ²¡æœ‰è¯¥<code>id=-1</code>å¯¹åº”åœ°æ•°æ®ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯â€œå“ªæ€•è¿™ä¸ª<code>key</code>å¯¹åº”åœ°æ•°æ®åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹Ÿå°†<code>&quot;&quot;</code>å­˜åˆ°&#x3D;&#x3D;Redis&#x3D;&#x3D;ä¸­â€ã€‚ä¸‹æ¬¡ç”¨æˆ·å†è®¿é—®ï¼Œåœ¨&#x3D;&#x3D;Redis&#x3D;&#x3D;ä¸­ä¹Ÿèƒ½æ‰¾åˆ°å¯¹åº”åœ°<code>Key</code>è€Œä¸ä¼šå°†è¯·æ±‚æ‰“åˆ°<code>MySQL</code>ã€‚</p><blockquote><p>ä¸éœ€è¦æ‹…å¿ƒæ•°æ®å†—æ‚ï¼Œ<code>Redis</code>æ”¯æŒè®¾ç½®é”®ï¼ˆkeyï¼‰çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”å…·å¤‡æ•°æ®æ¸…ç†æœºåˆ¶ã€‚</p></blockquote><h3 id="å¸ƒéš†è¿‡æ»¤å™¨é¢„æ£€æŸ¥"><a href="#å¸ƒéš†è¿‡æ»¤å™¨é¢„æ£€æŸ¥" class="headerlink" title="å¸ƒéš†è¿‡æ»¤å™¨é¢„æ£€æŸ¥"></a>å¸ƒéš†è¿‡æ»¤å™¨é¢„æ£€æŸ¥</h3><p>è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloomFilterï¼‰ï¼Œ ä¸€ç§æ¦‚ç‡å‹æ•°æ®ç»“æ„ã€‚</p><p>å®ç°æ€è·¯å¾ˆç®€å•ï¼Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨å¯¹è¯·æ±‚çš„å‚æ•°æˆ–è€…<code>key</code>è¿›è¡Œ<em>é¢„æ£€æŸ¥</em>ï¼Œå¦‚æœè¯·æ±‚è¢«å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ä¸ºä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåç»­æ“ä½œéƒ½ä¸éœ€è¦ï¼Œä»è€Œå‡å°‘äº†ç¼“å­˜ç©¿é€çš„é£é™©ã€‚</p><p>ä¸è¿‡åˆ¤æ–­æŸ<code>key</code>å­˜åœ¨åï¼Œ<code>redisã€mysql</code>ä¸­å¯èƒ½ä¾ç„¶æ²¡æœ‰å…¶å¯¹åº”æ•°æ®ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦åšåæœŸå¤„ç†ï¼Œæ¯”å¦‚è¯´è®¾å®šä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´æ¥ç¼“å­˜ç©ºå€¼ï¼ˆ<em>å…¶å®ä¹Ÿä¼šç”¨åˆ°ç¬¬ä¸€ä¸ªæ–¹æ¡ˆ</em>ï¼‰ã€‚è¿˜æœ‰ä¸€ä¸ªå¼Šç«¯æ˜¯å¸ƒéš†è¿‡æ»¤å™¨åˆ é™¤æ•°æ®éå¸¸å›°éš¾ã€‚</p><p>åŸºäºå¸ƒéš†è¿‡æ»¤å™¨åœ°æµç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/25/B1siqEmKk3A465f.png" alt="IMG_202408242782_459x486.png"></p><blockquote><p>å› ä¸ºå¸ƒéš†è¿‡æ»¤å™¨æ˜¯åŸºäºå“ˆå¸Œå‡½æ•°å®ç°ï¼Œæ‰€ä»¥è¿˜æ˜¯å­˜åœ¨è¯¯åˆ¤ã€‚å®ƒå¯èƒ½ä¼šè¯¯åˆ¤æŸäº›ä¸å­˜åœ¨çš„æ•°æ®ä¸ºå­˜åœ¨ï¼ˆå‡é˜³æ€§ï¼‰ï¼Œä½†å®ƒæ°¸è¿œä¸ä¼šè¯¯åˆ¤ä¸å­˜åœ¨çš„æ•°æ®ä¸ºå­˜åœ¨ï¼ˆå‡é˜´æ€§ï¼‰ã€‚<br>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åœ°å¥½å¤„åœ¨äºï¼š1ã€åˆ¤æ–­è¿‡ç¨‹éå¸¸å¿«é€Ÿï¼Œå› ä¸ºå®ƒåªæ¶‰åŠå“ˆå¸Œå‡½æ•°å’Œä½æ•°ç»„çš„æ“ä½œã€‚2ã€å¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨å›ºå®šçš„å†…å­˜ç©ºé—´ï¼Œæ— è®ºå­˜å‚¨å¤šå°‘æ•°æ®ï¼Œå…¶å†…å­˜å ç”¨éƒ½å¾ˆå°ã€‚</p></blockquote><h3 id="æ•°æ®æ ¡éªŒ"><a href="#æ•°æ®æ ¡éªŒ" class="headerlink" title="æ•°æ®æ ¡éªŒ"></a>æ•°æ®æ ¡éªŒ</h3><p>å¯¹äº<code>id = -1</code>çš„è¿™ç§â€˜æ˜æ˜¾â€™é”™è¯¯ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ä¸šåŠ¡ä¹‹å‰å°±åšä¸€ä¸ª<strong>å‚æ•°æ ¡éªŒ</strong>ã€‚å…¶æ¬¡åœ¨å­—æ®µè®¾è®¡ä¸Šï¼Œä¿®æ”¹<code>id</code>çš„è‡ªå¢ç­–ç•¥ï¼Œé€šè¿‡â„ç®—æ³•ï¼ˆSnowFlakeï¼‰å®ç°çš„åˆ†å¸ƒå¼<code>Id</code>ä½œä¸ºæ•°æ®ä¸»é”®ï¼Œé˜²æ­¢ç”¨æˆ·çŒœæµ‹å‡º<code>id</code>çš„è§„å¾‹ã€‚</p><blockquote><p>SnowFlakeç®—æ³•æ˜¯ç”±Twitterå¼€æºçš„&#x3D;&#x3D;åˆ†å¸ƒå¼å”¯ä¸€ID&#x3D;&#x3D;ç”Ÿæˆç®—æ³•ã€‚<br>è¿™é‡Œæ¨èä¸€ä¸ªä¼˜åŒ–é›ªèŠ±ç®—æ³•çš„<a href="https://github.com/yitter/IdGenerator">é›ªèŠ±æ¼‚ç§»ç®—æ³•</a>ã€‚</p></blockquote><h2 id="äºŒã€ç¼“å­˜é›ªå´©"><a href="#äºŒã€ç¼“å­˜é›ªå´©" class="headerlink" title="äºŒã€ç¼“å­˜é›ªå´©"></a>äºŒã€ç¼“å­˜é›ªå´©</h2><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨é«˜å¹¶å‘çš„ç³»ç»Ÿä¸­ï¼Œå¤§é‡çš„ç¼“å­˜æ•°æ®<strong>åŒæ—¶è¿‡æœŸ</strong>æˆ–<code>Redis</code>å®•æœºï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚å‡ ä¹åŒæ—¶ç›´æ¥æ‰“åˆ°åç«¯æ•°æ®åº“æˆ–æœåŠ¡ä¸Šï¼Œä»è€Œå¯¹åç«¯ç³»ç»Ÿé€ æˆå·¨å¤§å‹åŠ›ï¼Œç”šè‡³å¯¼è‡´æœåŠ¡å´©æºƒçš„ç°è±¡ã€‚</p><blockquote><p>å¯¹äº<code>Redis</code>å®•æœºçš„è§£å†³æ–¹æ³•åœ¨å‰æ–‡æâ€œæ•°æ®æŒä¹…æ€§â€æ—¶æœ‰æè¿‡ï¼ˆä¸»è¦æ˜¯è¿ç»´äººå‘˜çš„å·¥ä½œï¼‰ã€‚</p></blockquote><p>å¤§è‡´è¿‡ç¨‹å¦‚å›¾ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/25/PgEsvMdT1erLaRQ.png" alt="IMG_202408255516_547x371.png"></p><p>å¯¹äºå¤§é‡ç¼“å­˜æ•°æ®&#x3D;&#x3D;åŒæ—¶è¿‡æœŸ&#x3D;&#x3D;ï¼Œæˆ‘ä»¬å¦‚ä½•å»è§£å†³ä»€ä¹ˆå‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä¸è¦è®©è¿™äº›<code>key</code>åœ¨åŒä¸€æ—¶é—´æ®µè¿‡æœŸå°±å¥½äº†ï¼›ä»¥åŠä¸è¦æŠŠé¸¡è›‹æ”¾åœ¨åŒä¸€ä¸ªç¯®å­é‡Œã€‚</p><h3 id="éšæœºTTLå€¼"><a href="#éšæœºTTLå€¼" class="headerlink" title="éšæœºTTLå€¼"></a>éšæœºTTLå€¼</h3><p>æˆ‘ä»¬åœ¨è®¾è®¡<code>keyTTL</code>æ—¶é‡‡ç”¨<strong>åŸºæœ¬ç¼“å­˜æ—¶é—´+éšæœºæ—¶é—´</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">keyTTL</span> <span class="operator">=</span> redisTTL + randomNumbers(<span class="number">0</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‡è®¾å•ä½ä¸º<strong>Minutes</strong>ï¼Œ<code>redisTTL = 10</code>ï¼Œè¿™æ ·æˆ‘ä»¬æ¯ä¸€æ¬¡è®¾ç½®çš„ç¼“å­˜æ•°æ®è¿‡æœŸæ—¶é—´å°±å¯èƒ½ä¸º<em>10ï¼Œ11ï¼Œ12ï¼Œ13ï¼Œ14ï¼Œ15</em>ï¼Œä¸ä¼šå¯¼è‡´æ‰€æœ‰ç¼“å­˜æ•°æ®åŒæ—¶å¤±æ•ˆã€‚</p><h3 id="å¤šçº§ç¼“å­˜"><a href="#å¤šçº§ç¼“å­˜" class="headerlink" title="å¤šçº§ç¼“å­˜"></a>å¤šçº§ç¼“å­˜</h3><p>å¤šçº§ç¼“å­˜åœ°å®ç°æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç›´æ¥è´´å›¾ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/25/CFr49ZmQRlKkbps.png" alt="IMG_202408259520_574x328.png"></p><p>å¤šçº§ç¼“å­˜å¯ä»¥é¿å…æ•°æ®åŒæ—¶å¤±æ•ˆè€Œå°†è¯·æ±‚å…¨éƒ¨æ‰“åˆ°æ•°æ®åº“çš„é—®é¢˜ï¼Œä½†æ˜¯ï¼Œä¸ç®¡æ˜¯æµè§ˆå™¨è¿˜æ˜¯Nginxï¼Œå®ƒä»¬éƒ½æœ‰å…¶é€‚åˆå­˜å‚¨åœ°æ•°æ®å¯¹è±¡ã€‚</p><blockquote><p><em>æµè§ˆå™¨æœ¬åœ°ç¼“å­˜</em>ä¸€èˆ¬é€‚ç”¨äºé™æ€èµ„æºå¦‚å›¾ç‰‡ã€CSSã€JavaScriptæ–‡ä»¶ç­‰ï¼›<em>Nginxæœ¬åœ°ç¼“å­˜</em>é€‚ç”¨äºå¯ä»¥è¢«å¿«é€Ÿè®¿é—®çš„èµ„æºï¼Œå¦‚å›¾ç‰‡å’Œé™æ€HTMLé¡µé¢ï¼›<em>Tomcatå †ç¼“å­˜</em>é€‚ç”¨äºå­˜å‚¨ä¼šè¯æ•°æ®å’Œçƒ­ç‚¹æ•°æ®ï¼›<em>JVMè¿›ç¨‹ç¼“å­˜</em>é€‚ç”¨äºå¿«é€Ÿè®¿é—®å’Œå¤„ç†é¢‘ç¹ä½¿ç”¨çš„æ•°æ®ã€‚<em>Redisç¼“å­˜</em>é€‚ç”¨äºè·¨å¤šä¸ªåº”ç”¨å®ä¾‹å…±äº«çš„æ•°æ®ã€‚</p></blockquote><h2 id="ä¸‰ã€ç¼“å­˜å‡»ç©¿"><a href="#ä¸‰ã€ç¼“å­˜å‡»ç©¿" class="headerlink" title="ä¸‰ã€ç¼“å­˜å‡»ç©¿"></a>ä¸‰ã€ç¼“å­˜å‡»ç©¿</h2><p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«<strong>çƒ­ç‚¹Key</strong>é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯è¢«é«˜å¹¶å‘è®¿é—®ä¸”<em>ç¼“å­˜é‡å»º</em>ä¸šåŠ¡è¾ƒå¤æ‚çš„<code>key</code>çªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚ä¼šåœ¨&#x3D;&#x3D;ç¬é—´&#x3D;&#x3D;ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</p><p>å½¢è±¡æ¥è¯´ï¼Œå°±æ˜¯æœ‰ä¸€ä¸ªå•†åº—å¾ˆå—æ¬¢è¿ï¼ˆ&#x3D;&#x3D;é«˜å¹¶å‘è®¿é—®&#x3D;&#x3D;ï¼‰ï¼›ä½†æ˜¯æœ‰ä¸€å¤©ğŸ”‘åäº†ï¼ˆ<code>key</code>å¤±æ•ˆï¼‰ï¼Œå¹¶ä¸”ä¿®å¤é’¥åŒ™èŠ±è´¹çš„æ—¶é—´è¾ƒé•¿ï¼ˆ&#x3D;&#x3D;ç¼“å­˜é‡å»º&#x3D;&#x3D;ï¼‰ï¼Œäºæ˜¯å®¢äººè¢«æ‹’ä¹‹é—¨å¤–ï¼ˆ&#x3D;&#x3D;æ— æ³•è·å–ç¼“å­˜&#x3D;&#x3D;ï¼‰ã€‚ä»–ä»¬åªå¥½ä¸€è‚¡è„‘åœ°å»æ‰¾è€æ¿å¼€é—¨ï¼ˆ&#x3D;&#x3D;è¯·æ±‚æ‰“åˆ°æ•°æ®åº“&#x3D;&#x3D;ï¼‰ï¼Œä½†æ˜¯ç”±äºäººå¤ªå¤šï¼Œè€æ¿çš„å®¶ä¹Ÿè¢«æŒ¤çˆ†äº†ï¼ˆ&#x3D;&#x3D;æ•°æ®åº“æ— æ³•æ‰¿å—è¿™äº›å‹åŠ›&#x3D;&#x3D;ï¼‰ã€‚</p><p>è¿™é‡Œå…ˆå¯¹ç¼“å­˜ç©¿é€åšä¸€ä¸ªåŒºåˆ†é¿å…æ··æ·†ï¼š</p><ul><li>ç¼“å­˜ç©¿é€æ˜¯è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„<code>key</code>è€Œç»•è¿‡Redisï¼Œä¸”æ•°æ®åº“ä¹Ÿæ— æ³•é€šè¿‡è¯¥<code>key</code>è·å–æ•°æ®ï¼Œé‡æ„ç¼“å­˜ã€‚</li><li>ç¼“å­˜å‡»ç©¿æ˜¯Redisä¸­çš„<code>key</code>å¤±æ•ˆäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼Œåªä¸è¿‡è®¿é—®é‡è¿‡äºåºå¤§ï¼Œæ•°æ®åº“ç‚¸äº†ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè§£å†³ç¼“å­˜å‡»ç©¿çš„å…³é”®åœ¨äºä¸èƒ½å¤Ÿå¿«é€Ÿã€æœ‰æ•ˆåœ°é‡å»ºç¼“å­˜ã€‚</p><p>æƒ³æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œé’¥åŒ™åäº†ï¼Œä½†æ˜¯å•†åº—æ—è¾¹æœ‰ä¸€ä¸ªä¸“é—¨ä¿®é’¥åŒ™çš„äººï¼Œ5sä¸åˆ°ä½ çš„é’¥åŒ™å°±æ¢äº†æ–°ï¼Œä¹Ÿå°±æ²¡æœ‰äº†åç»­é—®é¢˜ã€‚</p><p>ä¸è¿‡5så¯¹äºç°å®å¾ˆçŸ­ï¼Œä½†å¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´å¾ˆé•¿ã€‚è€Œä¸”é‡å»ºä¸€ä¸ªä¸šåŠ¡å¤æ‚çš„<code>key</code>æ¶ˆè€—çš„æ—¶é—´æ— æ³•é¿å…ã€‚å› æ­¤åœ¨æ—¶é—´ä¸Šä¼˜åŒ–ä¸å¤ªå¯èƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬è§£å†³å‡ºè¿™ä¸ªé—®é¢˜çš„äººå°±å¥½äº†ï¼ˆdogï¼‰ã€‚</p><p>æˆ‘ä»¬åœ¨é¡¾å®¢ä¸è€æ¿çš„å®¶ä¹‹é—´å†åŠ ä¸Šä¸€é“â€œé—¨â€ï¼Œæ¯æ¬¡åªè®©ä¸€ä¸ªé¡¾å®¢è¿›æ¥ï¼Œç„¶åå¸¦å»ä¿®é’¥åŒ™ï¼Œåˆè®©å…¶ä»–é¡¾å®¢åœ¨åº—é—¨å£å…ˆä¼‘æ¯ï¼Œç¨åè€æ¿å†å»å¼€é—¨ã€‚</p><p>è¿™é‡Œçš„é—¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„&#x3D;&#x3D;åŠ é”&#x3D;&#x3D;ã€‚è®©çº¿ç¨‹ä¸€ä¸ªä¸€ä¸ªæ¥ï¼Œå…¶ä»–çº¿ç¨‹åˆ™ä¼‘çœ ã€é‡è¯•ï¼Œç­‰å¾…ç¼“å­˜é‡å»ºå®Œæˆã€å†è·å–ç¼“å­˜ã€‚</p><blockquote><p>æœ¬æ–‡ä¸»è¦è®²çš„æ˜¯Redisï¼Œæ‰€ä»¥è§£å†³æ–¹æ¡ˆåŸºäºRediså®ç°çš„åˆ†å¸ƒå¼é”-äº’æ–¥é”æ¥å®ç°ã€‚</p></blockquote><h3 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h3><blockquote><p>ä½•ä¸ºäº’æ–¥é”ï¼Ÿäº’æ–¥é”ï¼ˆMutexï¼‰æ˜¯ä¸€ç§å¸¸è§çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯¹äºå…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ã€‚å®ƒçš„ä¼˜ç‚¹åœ¨äº<strong>ä¿è¯äº†ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®ç‰¹å®šçš„ä»£ç æ®µ</strong>ï¼Œä»è€Œé¿å…äº†æ•°æ®ç«äº‰å’Œä¸€è‡´æ€§é—®é¢˜ã€‚</p></blockquote><p>è¿™é‡Œè´´ä¸€å¼ é»‘é©¬è®²è§£Redisçš„ç›¸å…³å›¾è§£ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/25/wefqF9SUid7TXzk.png" alt="IMG_202408258897_373x474.png"></p><p>è§£é‡Šä¸€ä¸‹ï¼šå½“çº¿ç¨‹<code>1</code>è®¿é—®ï¼Œçƒ­ç‚¹<code>key</code>å¤±æ•ˆï¼Œå°è¯•è·å–é”æˆåŠŸï¼Œé‚£ä¹ˆçº¿ç¨‹<code>1</code>å°±ä¼šæ‰§è¡Œç¼“å­˜é‡å»ºé€»è¾‘ã€‚å½“çº¿ç¨‹<code>2</code>è®¿é—®ï¼Œçƒ­ç‚¹<code>key</code>ä¹Ÿå¤±æ•ˆï¼Œç”±äºçº¿ç¨‹<code>1</code>æ‹¿åˆ°äº†é”ï¼Œæ‰€ä»¥çº¿ç¨‹<code>2</code>å°è¯•è·å–é”å¤±è´¥ï¼Œé‚£ä¹ˆçº¿ç¨‹<code>2</code>å¼€å§‹ä¼‘çœ ã€é‡æ–°æŸ¥è¯¢ç¼“å­˜ï¼Œç›´åˆ°çº¿ç¨‹<code>1</code>é‡Šæ”¾é”ä¸”ç¼“å­˜é‡å»ºæˆåŠŸï¼Œæ­¤æ—¶çº¿ç¨‹<code>2</code>å°±èƒ½å‘½ä¸­ç¼“å­˜ï¼Œè¿”å›æ•°æ®ã€‚</p><p>å…·ä½“å®ç°çš„è¯ï¼ŒåŸºäº<code>redis</code>çš„<code>setnx</code>æ–¹æ³•ï¼Œå³å¦‚æœ<code>key</code>ä¸å­˜åœ¨æ—¶ï¼Œæ‰æ·»åŠ è¯¥ <code>key</code>çš„å€¼ã€‚Javaä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key,String value)</span>&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®è¶…æ—¶æ—¶é—´redisTTLé˜²æ­¢æ­»é”</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> stringRedisTemplate</span><br><span class="line">            .opsForValue()</span><br><span class="line">            .setIfAbsent(key,value,redisTTL,TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„è®¾ç½®ä¸€ä¸ªé”è¶…æ—¶é‡Šæ”¾æ—¶é—´ï¼Œé˜²æ­¢å…¶ä»–æƒ…å†µå¯¼è‡´æ­»é”é—®é¢˜ã€‚<br>è¡¥å……ï¼šRedisæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„åº”ç”¨ç¨‹åºã€‚</p></blockquote><p>è¿™æ ·è™½ç„¶èƒ½å¤Ÿå‡è½»æœåŠ¡ç«¯å‹åŠ›ï¼Œä½†åœ¨<strong>çº¿ç¨‹ç­‰å¾…æ—¶é—´</strong>é‡Œç”¨æˆ·ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ï¼ˆè¿™è®©å‰ç«¯å¾ˆéš¾åŠï¼‰ã€‚æˆ‘è®¤ä¸ºå¥½çš„æ–¹æ¡ˆåº”è¯¥æ˜¯è¿”å›å…è®¸çš„æ—§æ•°æ®+ç¼“å­˜é‡å»º+ç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤ºã€‚</p><h3 id="é€»è¾‘è¿‡æœŸ"><a href="#é€»è¾‘è¿‡æœŸ" class="headerlink" title="é€»è¾‘è¿‡æœŸ"></a>é€»è¾‘è¿‡æœŸ</h3><p>é€»è¾‘è¿‡æœŸæ˜¯æŒ‡çš„æ˜¯ä¸ç»™çƒ­ç‚¹<code>KEY</code><strong>è®¾ç½®è¿‡æœŸæ—¶é—´</strong>ï¼Œè€Œæ˜¯æ‰‹åŠ¨ç»™<strong>çƒ­ç‚¹KEY</strong>è®¾ç½®<strong>é€»è¾‘è¿‡æœŸå€¼</strong>ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œè¿™æ ·é™¤äº†Redisé›†ç¾¤å®•æœºï¼Œå¦åˆ™çš„è¯éƒ½å¯ä»¥è·å–åˆ°çƒ­ç‚¹æ•°æ®ã€‚è·å–çƒ­ç‚¹æ•°æ®åï¼Œæˆ‘ä»¬å†æ ¹æ®é€»è¾‘è¿‡æœŸå€¼æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å¤±æ•ˆã€‚</p><p>å¦‚æœå¤±æ•ˆäº†ï¼Œå°±åˆéœ€è¦ç¼“å­˜é‡å»ºï¼ŒåŒæ—¶ä¹Ÿä¼šä¼´éšç€ç¼“å­˜å‡»ç©¿é—®é¢˜ã€‚è¿™æ—¶å¯ä»¥é‡‡ç”¨ä¸Šè¿°äº’æ–¥é”çš„æ–¹æ³•ï¼Œè·å–é”å¤±è´¥çš„çº¿ç¨‹ä¹Ÿä¸ç”¨ç­‰å¾…ï¼ˆé‡Šæ”¾æ€§èƒ½ï¼‰ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›&#x3D;&#x3D;æ—§æ•°æ®+æç¤º&#x3D;&#x3D;ï¼›è·å–é”æˆåŠŸåï¼Œå¼€å¯ä¸€ä¸ª&#x3D;&#x3D;ç‹¬ç«‹çº¿ç¨‹&#x3D;&#x3D;å»æ‰§è¡Œç¼“å­˜é‡å»ºä»»åŠ¡ï¼Œä¸»çº¿ç¨‹è¿”å›&#x3D;&#x3D;æ—§æ•°æ®+æç¤º&#x3D;&#x3D;å³å¯ã€‚</p><p>å…·ä½“æ‰§è¡Œæµç¨‹ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/25/37fRDLpEaAPyn8X.png" alt="IMG_202408257801_503x344.png"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DockerHubåŠ é€Ÿæ‹‰å–é•œåƒ</title>
      <link href="/cn/DockerHub%E5%8A%A0%E9%80%9F/"/>
      <url>/cn/DockerHub%E5%8A%A0%E9%80%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="DockerHub-Image-CF-Worker-åŠ é€Ÿ"><a href="#DockerHub-Image-CF-Worker-åŠ é€Ÿ" class="headerlink" title="DockerHub Image CF Worker åŠ é€Ÿ"></a>DockerHub Image CF Worker åŠ é€Ÿ</h1><h2 id="å‰æœŸå‡†å¤‡"><a href="#å‰æœŸå‡†å¤‡" class="headerlink" title="å‰æœŸå‡†å¤‡"></a>å‰æœŸå‡†å¤‡</h2><ol><li>è´­ä¹°ä¸€ä¸ªåŸŸåï¼Œå¦‚ï¼šturing.com</li><li>åœ¨<a href="https://www.cloudflare.com/zh-cn/">CF</a>ä¸­æ·»åŠ ç«™ç‚¹ï¼Œå®ŒæˆDNSçš„è§£æ</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/16/vVGnORQhtxDNXKC.png" alt="æ“ä½œ1"></p><h2 id="ä»£ç é…ç½®"><a href="#ä»£ç é…ç½®" class="headerlink" title="ä»£ç é…ç½®"></a>ä»£ç é…ç½®</h2><ul><li><a href="https://github.com/cmliu/CF-Workers-docker.io">CF-Workers-docker.io</a>ï¼Œä¸€ä¸ªåŸºäº Cloudflare Workers çš„ Docker é•œåƒä»£ç†å·¥å…·<ul><li><a href="https://qninq.cn/archives/cfdockerfast.html">ä¼˜åŒ–ç‰ˆä»£ç </a></li></ul></li><li>å¤åˆ¶<code>_worker.js</code>ä»£ç ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// _worker.js</span></span><br><span class="line"><span class="comment">// Dockeré•œåƒä»“åº“ä¸»æœºåœ°å€</span></span><br><span class="line"><span class="keyword">let</span> hub_host = <span class="string">&#x27;registry-1.docker.io&#x27;</span>;</span><br><span class="line"><span class="comment">// Dockerè®¤è¯æœåŠ¡å™¨åœ°å€</span></span><br><span class="line"><span class="keyword">const</span> auth_url = <span class="string">&#x27;https://auth.docker.io&#x27;</span>;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„å·¥ä½œæœåŠ¡å™¨åœ°å€</span></span><br><span class="line"><span class="keyword">let</span> workers_url = <span class="string">&#x27;https://xxx/&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> å±è”½çˆ¬è™«<span class="variable constant_">UA</span> = [<span class="string">&#x27;netcraft&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ä¸»æœºåé€‰æ‹©å¯¹åº”çš„ä¸Šæ¸¸åœ°å€</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">routeByHosts</span>(<span class="params">host</span>) &#123;</span><br><span class="line"><span class="comment">// å®šä¹‰è·¯ç”±è¡¨</span></span><br><span class="line"><span class="keyword">const</span> routes = &#123;</span><br><span class="line"><span class="comment">// ç”Ÿäº§ç¯å¢ƒ</span></span><br><span class="line"><span class="string">&quot;quay&quot;</span>: <span class="string">&quot;quay.io&quot;</span>,</span><br><span class="line"><span class="string">&quot;gcr&quot;</span>: <span class="string">&quot;gcr.io&quot;</span>,</span><br><span class="line"><span class="string">&quot;k8s-gcr&quot;</span>: <span class="string">&quot;k8s.gcr.io&quot;</span>,</span><br><span class="line"><span class="string">&quot;k8s&quot;</span>: <span class="string">&quot;registry.k8s.io&quot;</span>,</span><br><span class="line"><span class="string">&quot;ghcr&quot;</span>: <span class="string">&quot;ghcr.io&quot;</span>,</span><br><span class="line"><span class="string">&quot;cloudsmith&quot;</span>: <span class="string">&quot;docker.cloudsmith.io&quot;</span>,</span><br><span class="line"><span class="string">&quot;nvcr&quot;</span>: <span class="string">&quot;nvcr.io&quot;</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ç¯å¢ƒ</span></span><br><span class="line"><span class="string">&quot;test&quot;</span>: <span class="string">&quot;registry-1.docker.io&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (host <span class="keyword">in</span> routes) <span class="keyword">return</span> [ routes[host], <span class="literal">false</span> ];</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> [ hub_host, <span class="literal">true</span> ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">RequestInit</span>&#125; */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PREFLIGHT_INIT</span> = &#123;</span><br><span class="line"><span class="comment">// é¢„æ£€è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">Headers</span>(&#123;</span><br><span class="line"><span class="string">&#x27;access-control-allow-origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>, <span class="comment">// å…è®¸æ‰€æœ‰æ¥æº</span></span><br><span class="line"><span class="string">&#x27;access-control-allow-methods&#x27;</span>: <span class="string">&#x27;GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS&#x27;</span>, <span class="comment">// å…è®¸çš„HTTPæ–¹æ³•</span></span><br><span class="line"><span class="string">&#x27;access-control-max-age&#x27;</span>: <span class="string">&#x27;1728000&#x27;</span>, <span class="comment">// é¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´</span></span><br><span class="line">&#125;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ å“åº”</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">any</span>&#125; body å“åº”ä½“</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; status å“åº”çŠ¶æ€ç </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object&lt;string, string&gt;</span>&#125; headers å“åº”å¤´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeRes</span>(<span class="params">body, status = <span class="number">200</span>, headers = &#123;&#125;</span>) &#123;</span><br><span class="line">headers[<span class="string">&#x27;access-control-allow-origin&#x27;</span>] = <span class="string">&#x27;*&#x27;</span> <span class="comment">// å…è®¸æ‰€æœ‰æ¥æº</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(body, &#123; status, headers &#125;) <span class="comment">// è¿”å›æ–°æ„é€ çš„å“åº”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ æ–°çš„URLå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; urlStr URLå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">newUrl</span>(<span class="params">urlStr</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">URL</span>(urlStr) <span class="comment">// å°è¯•æ„é€ æ–°çš„URLå¯¹è±¡</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span> <span class="comment">// æ„é€ å¤±è´¥è¿”å›null</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isUUID</span>(<span class="params">uuid</span>) &#123;</span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é… UUID æ ¼å¼</span></span><br><span class="line"><span class="keyword">const</span> uuidRegex = <span class="regexp">/^[0-9a-f]&#123;8&#125;-[0-9a-f]&#123;4&#125;-[4][0-9a-f]&#123;3&#125;-[89ab][0-9a-f]&#123;3&#125;-[0-9a-f]&#123;12&#125;$/i</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯• UUID å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">return</span> uuidRegex.<span class="title function_">test</span>(uuid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">nginx</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> text = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">body &#123;</span></span><br><span class="line"><span class="string">width: 35em;</span></span><br><span class="line"><span class="string">margin: 0 auto;</span></span><br><span class="line"><span class="string">font-family: Tahoma, Verdana, Arial, sans-serif;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="string">working. Further configuration is required.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p&gt;For online documentation and support please refer to</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial support is available at</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">return</span> text;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">fetch</span>(<span class="params">request, env, ctx</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getReqHeader</span> = (<span class="params">key</span>) =&gt; request.<span class="property">headers</span>.<span class="title function_">get</span>(key); <span class="comment">// è·å–è¯·æ±‚å¤´</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(request.<span class="property">url</span>); <span class="comment">// è§£æè¯·æ±‚URL</span></span><br><span class="line"><span class="keyword">const</span> userAgentHeader = request.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;User-Agent&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> userAgent = userAgentHeader ? userAgentHeader.<span class="title function_">toLowerCase</span>() : <span class="string">&quot;null&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (env.<span class="property">UA</span>) å±è”½çˆ¬è™«<span class="variable constant_">UA</span> = å±è”½çˆ¬è™«<span class="variable constant_">UA</span>.<span class="title function_">concat</span>(<span class="keyword">await</span> <span class="title function_">ADD</span>(env.<span class="property">UA</span>));</span><br><span class="line">workers_url = <span class="string">`https://<span class="subst">$&#123;url.hostname&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> pathname = url.<span class="property">pathname</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–è¯·æ±‚å‚æ•°ä¸­çš„ ns</span></span><br><span class="line"><span class="keyword">const</span> ns = url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;ns&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> hostname = url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;hubhost&#x27;</span>) || url.<span class="property">hostname</span>;</span><br><span class="line"><span class="keyword">const</span> hostTop = hostname.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]; <span class="comment">// è·å–ä¸»æœºåçš„ç¬¬ä¸€éƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> checkHost; <span class="comment">// åœ¨è¿™é‡Œå®šä¹‰ checkHost å˜é‡</span></span><br><span class="line"><span class="comment">// å¦‚æœå­˜åœ¨ ns å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒæ¥ç¡®å®š hub_host</span></span><br><span class="line"><span class="keyword">if</span> (ns) &#123;</span><br><span class="line"><span class="keyword">if</span> (ns === <span class="string">&#x27;docker.io&#x27;</span>) &#123;</span><br><span class="line">hub_host = <span class="string">&#x27;registry-1.docker.io&#x27;</span>; <span class="comment">// è®¾ç½®ä¸Šæ¸¸åœ°å€ä¸º registry-1.docker.io</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">hub_host = ns; <span class="comment">// ç›´æ¥ä½¿ç”¨ ns ä½œä¸º hub_host</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">checkHost = <span class="title function_">routeByHosts</span>(hostTop);</span><br><span class="line">hub_host = checkHost[<span class="number">0</span>]; <span class="comment">// è·å–ä¸Šæ¸¸åœ°å€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fakePage = checkHost ? checkHost[<span class="number">1</span>] : <span class="literal">false</span>; <span class="comment">// ç¡®ä¿ fakePage ä¸ä¸º undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`åŸŸåå¤´éƒ¨: <span class="subst">$&#123;hostTop&#125;</span>\nåä»£åœ°å€: <span class="subst">$&#123;hub_host&#125;</span>\nä¼ªè£…é¦–é¡µ: <span class="subst">$&#123;fakePage&#125;</span>`</span>);</span><br><span class="line"><span class="keyword">const</span> isUuid = <span class="title function_">isUUID</span>(pathname.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (å±è”½çˆ¬è™«<span class="variable constant_">UA</span>.<span class="title function_">some</span>(<span class="function"><span class="params">fxxk</span> =&gt;</span> userAgent.<span class="title function_">includes</span>(fxxk)) &amp;&amp; å±è”½çˆ¬è™«<span class="variable constant_">UA</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// é¦–é¡µæ”¹æˆä¸€ä¸ªnginxä¼ªè£…é¡µ</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="keyword">await</span> <span class="title function_">nginx</span>(), &#123;</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/html; charset=UTF-8&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> conditions = [</span><br><span class="line">isUuid,</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/_&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/r&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/v2/user&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/v2/orgs&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/v2/_catalog&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/v2/categories&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;/v2/feature-flags&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;search&#x27;</span>),</span><br><span class="line">pathname.<span class="title function_">includes</span>(<span class="string">&#x27;source&#x27;</span>),</span><br><span class="line">pathname === <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">pathname === <span class="string">&#x27;/favicon.ico&#x27;</span>,</span><br><span class="line">pathname === <span class="string">&#x27;/auth/profile&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (conditions.<span class="title function_">some</span>(<span class="function"><span class="params">condition</span> =&gt;</span> condition) &amp;&amp; (fakePage === <span class="literal">true</span> || hostTop == <span class="string">&#x27;docker&#x27;</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (env.<span class="property">URL302</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">redirect</span>(env.<span class="property">URL302</span>, <span class="number">302</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.<span class="property">URL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (env.<span class="property">URL</span>.<span class="title function_">toLowerCase</span>() == <span class="string">&#x27;nginx&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">//é¦–é¡µæ”¹æˆä¸€ä¸ªnginxä¼ªè£…é¡µ</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="keyword">await</span> <span class="title function_">nginx</span>(), &#123;</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/html; charset=UTF-8&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(env.<span class="property">URL</span>, request));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newUrl = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;https://registry.hub.docker.com&quot;</span> + pathname + url.<span class="property">search</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤åˆ¶åŸå§‹è¯·æ±‚çš„æ ‡å¤´</span></span><br><span class="line"><span class="keyword">const</span> headers = <span class="keyword">new</span> <span class="title class_">Headers</span>(request.<span class="property">headers</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¡®ä¿ Host å¤´éƒ¨è¢«æ›¿æ¢ä¸º hub.docker.com</span></span><br><span class="line">headers.<span class="title function_">set</span>(<span class="string">&#x27;Host&#x27;</span>, <span class="string">&#x27;registry.hub.docker.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newRequest = <span class="keyword">new</span> <span class="title class_">Request</span>(newUrl, &#123;</span><br><span class="line"><span class="attr">method</span>: request.<span class="property">method</span>,</span><br><span class="line"><span class="attr">headers</span>: headers,</span><br><span class="line"><span class="attr">body</span>: request.<span class="property">method</span> !== <span class="string">&#x27;GET&#x27;</span> &amp;&amp; request.<span class="property">method</span> !== <span class="string">&#x27;HEAD&#x27;</span> ? <span class="keyword">await</span> request.<span class="title function_">blob</span>() : <span class="literal">null</span>,</span><br><span class="line"><span class="attr">redirect</span>: <span class="string">&#x27;follow&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">fetch</span>(newRequest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹åŒ…å« %2F å’Œ %3A çš„è¯·æ±‚</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="regexp">/%2F/</span>.<span class="title function_">test</span>(url.<span class="property">search</span>) &amp;&amp; <span class="regexp">/%3A/</span>.<span class="title function_">test</span>(url.<span class="title function_">toString</span>())) &#123;</span><br><span class="line"><span class="keyword">let</span> modifiedUrl = url.<span class="title function_">toString</span>().<span class="title function_">replace</span>(<span class="regexp">/%3A(?=.*?&amp;)/</span>, <span class="string">&#x27;%3Alibrary%2F&#x27;</span>);</span><br><span class="line">url = <span class="keyword">new</span> <span class="title function_">URL</span>(modifiedUrl);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`handle_url: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†tokenè¯·æ±‚</span></span><br><span class="line"><span class="keyword">if</span> (url.<span class="property">pathname</span>.<span class="title function_">includes</span>(<span class="string">&#x27;/token&#x27;</span>)) &#123;</span><br><span class="line"><span class="keyword">let</span> token_parameter = &#123;</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;auth.docker.io&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;User-Agent&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;User-Agent&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Accept&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;Accept&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Accept-Language&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;Accept-Language&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;Accept-Encoding&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> token_url = auth_url + url.<span class="property">pathname</span> + url.<span class="property">search</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(token_url, request), token_parameter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ /v2/ è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="keyword">if</span> ( hub_host == <span class="string">&#x27;registry-1.docker.io&#x27;</span> &amp;&amp; <span class="regexp">/^\/v2\/[^/]+\/[^/]+\/[^/]+$/</span>.<span class="title function_">test</span>(url.<span class="property">pathname</span>) &amp;&amp; !<span class="regexp">/^\/v2\/library/</span>.<span class="title function_">test</span>(url.<span class="property">pathname</span>)) &#123;</span><br><span class="line"><span class="comment">//url.pathname = url.pathname.replace(/\/v2\//, &#x27;/v2/library/&#x27;);</span></span><br><span class="line">url.<span class="property">pathname</span> = <span class="string">&#x27;/v2/library/&#x27;</span> + url.<span class="property">pathname</span>.<span class="title function_">split</span>(<span class="string">&#x27;/v2/&#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`modified_url: <span class="subst">$&#123;url.pathname&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ”¹è¯·æ±‚çš„ä¸»æœºå</span></span><br><span class="line">url.<span class="property">hostname</span> = hub_host;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ è¯·æ±‚å‚æ•°</span></span><br><span class="line"><span class="keyword">let</span> parameter = &#123;</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Host&#x27;</span>: hub_host,</span><br><span class="line"><span class="string">&#x27;User-Agent&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;User-Agent&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Accept&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;Accept&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Accept-Language&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;Accept-Language&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="title function_">getReqHeader</span>(<span class="string">&quot;Accept-Encoding&quot;</span>),</span><br><span class="line"><span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">cacheTtl</span>: <span class="number">3600</span> <span class="comment">// ç¼“å­˜æ—¶é—´</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ Authorizationå¤´</span></span><br><span class="line"><span class="keyword">if</span> (request.<span class="property">headers</span>.<span class="title function_">has</span>(<span class="string">&quot;Authorization&quot;</span>)) &#123;</span><br><span class="line">parameter.<span class="property">headers</span>.<span class="property">Authorization</span> = <span class="title function_">getReqHeader</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘èµ·è¯·æ±‚å¹¶å¤„ç†å“åº”</span></span><br><span class="line"><span class="keyword">let</span> original_response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(url, request), parameter);</span><br><span class="line"><span class="keyword">let</span> original_response_clone = original_response.<span class="title function_">clone</span>();</span><br><span class="line"><span class="keyword">let</span> original_text = original_response_clone.<span class="property">body</span>;</span><br><span class="line"><span class="keyword">let</span> response_headers = original_response.<span class="property">headers</span>;</span><br><span class="line"><span class="keyword">let</span> new_response_headers = <span class="keyword">new</span> <span class="title class_">Headers</span>(response_headers);</span><br><span class="line"><span class="keyword">let</span> status = original_response.<span class="property">status</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ Www-Authenticate å¤´</span></span><br><span class="line"><span class="keyword">if</span> (new_response_headers.<span class="title function_">get</span>(<span class="string">&quot;Www-Authenticate&quot;</span>)) &#123;</span><br><span class="line"><span class="keyword">let</span> auth = new_response_headers.<span class="title function_">get</span>(<span class="string">&quot;Www-Authenticate&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(auth_url, <span class="string">&#x27;g&#x27;</span>);</span><br><span class="line">new_response_headers.<span class="title function_">set</span>(<span class="string">&quot;Www-Authenticate&quot;</span>, response_headers.<span class="title function_">get</span>(<span class="string">&quot;Www-Authenticate&quot;</span>).<span class="title function_">replace</span>(re, workers_url));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†é‡å®šå‘</span></span><br><span class="line"><span class="keyword">if</span> (new_response_headers.<span class="title function_">get</span>(<span class="string">&quot;Location&quot;</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">httpHandler</span>(request, new_response_headers.<span class="title function_">get</span>(<span class="string">&quot;Location&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›ä¿®æ”¹åçš„å“åº”</span></span><br><span class="line"><span class="keyword">let</span> response = <span class="keyword">new</span> <span class="title class_">Response</span>(original_text, &#123;</span><br><span class="line">status,</span><br><span class="line"><span class="attr">headers</span>: new_response_headers</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†HTTPè¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Request</span>&#125; req è¯·æ±‚å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; pathname è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">httpHandler</span>(<span class="params">req, pathname</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> reqHdrRaw = req.<span class="property">headers</span>;</span><br><span class="line"><span class="comment">// å¤„ç†é¢„æ£€è¯·æ±‚</span></span><br><span class="line"><span class="keyword">if</span> (req.<span class="property">method</span> === <span class="string">&#x27;OPTIONS&#x27;</span> &amp;&amp;</span><br><span class="line">reqHdrRaw.<span class="title function_">has</span>(<span class="string">&#x27;access-control-request-headers&#x27;</span>)</span><br><span class="line">) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="literal">null</span>, <span class="variable constant_">PREFLIGHT_INIT</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> rawLen = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> reqHdrNew = <span class="keyword">new</span> <span class="title class_">Headers</span>(reqHdrRaw);</span><br><span class="line"><span class="keyword">const</span> refer = reqHdrNew.<span class="title function_">get</span>(<span class="string">&#x27;referer&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> urlStr = pathname;</span><br><span class="line"><span class="keyword">const</span> urlObj = <span class="title function_">newUrl</span>(urlStr);</span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">RequestInit</span>&#125; */</span></span><br><span class="line"><span class="keyword">const</span> reqInit = &#123;</span><br><span class="line"><span class="attr">method</span>: req.<span class="property">method</span>,</span><br><span class="line"><span class="attr">headers</span>: reqHdrNew,</span><br><span class="line"><span class="attr">redirect</span>: <span class="string">&#x27;follow&#x27;</span>,</span><br><span class="line"><span class="attr">body</span>: req.<span class="property">body</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">proxy</span>(urlObj, reqInit, rawLen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»£ç†è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">URL</span>&#125; urlObj URLå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">RequestInit</span>&#125; reqInit è¯·æ±‚åˆå§‹åŒ–å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; rawLen åŸå§‹é•¿åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">proxy</span>(<span class="params">urlObj, reqInit, rawLen</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(urlObj.<span class="property">href</span>, reqInit);</span><br><span class="line"><span class="keyword">const</span> resHdrOld = res.<span class="property">headers</span>;</span><br><span class="line"><span class="keyword">const</span> resHdrNew = <span class="keyword">new</span> <span class="title class_">Headers</span>(resHdrOld);</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯é•¿åº¦</span></span><br><span class="line"><span class="keyword">if</span> (rawLen) &#123;</span><br><span class="line"><span class="keyword">const</span> newLen = resHdrOld.<span class="title function_">get</span>(<span class="string">&#x27;content-length&#x27;</span>) || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> badLen = (rawLen !== newLen);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (badLen) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">makeRes</span>(res.<span class="property">body</span>, <span class="number">400</span>, &#123;</span><br><span class="line"><span class="string">&#x27;--error&#x27;</span>: <span class="string">`bad len: <span class="subst">$&#123;newLen&#125;</span>, except: <span class="subst">$&#123;rawLen&#125;</span>`</span>,</span><br><span class="line"><span class="string">&#x27;access-control-expose-headers&#x27;</span>: <span class="string">&#x27;--error&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> status = res.<span class="property">status</span>;</span><br><span class="line">resHdrNew.<span class="title function_">set</span>(<span class="string">&#x27;access-control-expose-headers&#x27;</span>, <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">resHdrNew.<span class="title function_">set</span>(<span class="string">&#x27;access-control-allow-origin&#x27;</span>, <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">resHdrNew.<span class="title function_">set</span>(<span class="string">&#x27;Cache-Control&#x27;</span>, <span class="string">&#x27;max-age=1500&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤ä¸å¿…è¦çš„å¤´</span></span><br><span class="line">resHdrNew.<span class="title function_">delete</span>(<span class="string">&#x27;content-security-policy&#x27;</span>);</span><br><span class="line">resHdrNew.<span class="title function_">delete</span>(<span class="string">&#x27;content-security-policy-report-only&#x27;</span>);</span><br><span class="line">resHdrNew.<span class="title function_">delete</span>(<span class="string">&#x27;clear-site-data&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(res.<span class="property">body</span>, &#123;</span><br><span class="line">status,</span><br><span class="line"><span class="attr">headers</span>: resHdrNew</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ADD</span>(<span class="params">envadd</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> addtext = envadd.<span class="title function_">replace</span>(<span class="regexp">/[ |&quot;&#x27;\r\n]+/g</span>, <span class="string">&#x27;,&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/,+/g</span>, <span class="string">&#x27;,&#x27;</span>);<span class="comment">// å°†ç©ºæ ¼ã€åŒå¼•å·ã€å•å¼•å·å’Œæ¢è¡Œç¬¦æ›¿æ¢ä¸ºé€—å·</span></span><br><span class="line"><span class="keyword">if</span> (addtext.<span class="title function_">charAt</span>(<span class="number">0</span>) == <span class="string">&#x27;,&#x27;</span>) addtext = addtext.<span class="title function_">slice</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (addtext.<span class="title function_">charAt</span>(addtext.<span class="property">length</span> - <span class="number">1</span>) == <span class="string">&#x27;,&#x27;</span>) addtext = addtext.<span class="title function_">slice</span>(<span class="number">0</span>, addtext.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> add = addtext.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="keyword">return</span> add;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™æ®µè„šæœ¬å®ç°äº†ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯å’Œ Docker Hub ä¹‹é—´è½¬å‘è¯·æ±‚å’Œå“åº”ï¼ŒåŒæ—¶å¤„ç†ä¸€äº›ç‰¹å®šçš„å¤´ä¿¡æ¯å’Œé‡å®šå‘</li><li>æ‰“å¼€ CF éƒ¨ç½²Workers</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/16/91paUIWzm8dvFuk.png" alt=" æ“ä½œ2"></p><ul><li>åˆ›å»ºå®Œæˆåï¼Œç¼–è¾‘<code>js</code>ä»£ç </li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/16/HeqRJ5rmEP3b2fO.png" alt=" æ“ä½œ3"></p><ul><li>å°†ä¸Šè¿°<code>jS</code>ä»£ç å¤åˆ¶ä¸Šå»ï¼Œä¿®æ”¹<code>let workers_url = &#39;https://turing.com&#39;</code>ä¸ºè‡ªå·±çš„åŸŸå</li><li>å†è¿›è¡Œè®¿é—®ï¼Œå¦‚æœæˆåŠŸéƒ¨ç½²ï¼Œé¡µé¢ä¼šè·³è½¬åˆ°<code>docker-hub</code></li><li>å†è¿›è¡Œè®¾ç½®-è§¦å‘å™¨-æ·»åŠ è·¯ç”±<ul><li>è·¯ç”±æ”¯æŒé€šé…ç¬¦ï¼Œä¸€èˆ¬è®¾ç½®ä¸º<code>Workersé¡¹ç›®å.åŸŸå</code><ul><li><code>docker-hub.turing.com</code></li></ul></li><li>åŒºåŸŸåˆ™æ˜¯ç«™ç‚¹ï¼Œæ·»åŠ çš„åŸŸå<code>turing.com</code></li></ul></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/16/91paUIWzm8dvFuk.png" alt="æ“ä½œ4"></p><ul><li>é€šè¿‡é…ç½®çš„è·¯ç”±ï¼Œå†æ¬¡è®¿é—®ï¼Œå¦‚æœæˆåŠŸéƒ¨ç½²ï¼Œé¡µé¢ä¼šè·³è½¬åˆ°<code>docker-hub</code></li></ul><h2 id="æ‹‰å–ç¤ºä¾‹"><a href="#æ‹‰å–ç¤ºä¾‹" class="headerlink" title="æ‹‰å–ç¤ºä¾‹"></a>æ‹‰å–ç¤ºä¾‹</h2><ul><li>æ‹‰å–ä»“åº“ï¼š<code>docker pull docker-hub.turing.com/library/alpine:latest</code></li><li>æ‹‰å–æˆåŠŸåï¼Œ<code>docker images</code>ï¼ŒæŸ¥çœ‹</li><li>ç®€åŒ–æ‹‰å–å‘½ä»¤ï¼Œé…ç½®dockeré•œåƒåï¼Œç›´æ¥<code>docker pull alpine:latest</code>å³å¯</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://docker-hub.turing.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ææœº </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>åª’ä½“èµ„æºç®¡ç†</title>
      <link href="/cn/%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/"/>
      <url>/cn/%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸»è¦æ˜¯å®ç°æœåŠ¡ç«¯å¦‚ä½•å®Œæˆèµ„æºçš„ä¸Šä¼ ä»¥åŠåç»­ç®¡ç†</p></blockquote><h1 id="åª’èµ„ç®¡ç†"><a href="#åª’èµ„ç®¡ç†" class="headerlink" title="åª’èµ„ç®¡ç†"></a>åª’èµ„ç®¡ç†</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ä½•ä¸ºåª’èµ„ï¼š</p><ul><li>åª’ä½“èµ„æºç®¡ç†(Media Asset Managementï¼ŒMAM)ç³»ç»Ÿæ˜¯å»ºç«‹åœ¨å¤šåª’ä½“ã€ç½‘ç»œã€æ•°æ®åº“å’Œæ•°å­—å­˜å‚¨ç­‰å…ˆè¿›æŠ€æœ¯åŸºç¡€ä¸Šçš„ä¸€ä¸ªå¯¹å„ç§åª’ä½“åŠå†…å®¹(å¦‚è§†&#x2F;éŸ³é¢‘èµ„æ–™ã€æ–‡æœ¬æ–‡ä»¶ã€å›¾è¡¨ç­‰)è¿›è¡Œæ•°å­—åŒ–å­˜å‚¨ã€ç®¡ç†ä»¥åŠåº”ç”¨çš„æ€»ä½“è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ•°å­—åª’ä½“çš„é‡‡é›†ã€ç¼–ç›®ã€ç®¡ç†ã€ä¼ è¾“å’Œç¼–ç è½¬æ¢ç­‰æ‰€æœ‰ç¯èŠ‚</li><li>å…¶ä¸»è¦æ˜¯æ»¡è¶³åª’ä½“èµ„æºæ‹¥æœ‰è€…æ”¶é›†ã€ä¿å­˜ã€æŸ¥æ‰¾ã€ç¼–è¾‘ã€å‘å¸ƒå„ç§ä¿¡æ¯çš„è¦æ±‚ï¼Œä¸ºåª’ä½“èµ„æºçš„ä½¿ç”¨è€…æä¾›è®¿é—®å†…å®¹çš„ä¾¿æ·æ–¹æ³•ï¼Œå®ç°å¯¹åª’ä½“èµ„æºçš„é«˜æ•ˆç®¡ç†ï¼Œå¤§å¹…åº¦æé«˜åª’ä½“èµ„æºçš„ä»·å€¼</li></ul><p>åª’èµ„ç®¡ç†çš„ä¸»è¦ç®¡ç†å¯¹è±¡ï¼š</p><ul><li>è§†é¢‘ã€å›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³ä¹ç­‰</li></ul><p>åª’èµ„çš„ä¸»è¦çš„å‡ ä¸ªåŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>åª’èµ„æŸ¥è¯¢ï¼šæŸ¥è¯¢è‡ªå·±æ‰€æ‹¥æœ‰çš„çš„åª’èµ„ä¿¡æ¯</li><li>æ–‡ä»¶ä¸Šä¼ ï¼šåŒ…æ‹¬ä¸Šä¼ å›¾ç‰‡ã€ä¸Šä¼ æ–‡æ¡£ã€ä¸Šä¼ è§†é¢‘ï¼ˆé‡è¦ï¼‰</li><li>è§†é¢‘å¤„ç†ï¼šè§†é¢‘ä¸Šä¼ æˆåŠŸï¼Œç³»ç»Ÿè‡ªåŠ¨å¯¹è§†é¢‘è¿›è¡Œç¼–ç å¤„ç†ï¼ˆé‡è¦ï¼‰</li><li>æ–‡ä»¶åˆ é™¤ï¼šåˆ é™¤è‡ªå·±ä¸Šä¼ çš„åª’èµ„æ–‡ä»¶</li></ul><p>å¾ˆé‡è¦çš„ä¸€ä¸ªé—®é¢˜æ˜¯åª’èµ„åˆ°åº•ä¸Šä¼ åˆ°å“ªé‡Œå»ï¼Ÿç”¨æˆ·å¦‚ä½•å¿«é€Ÿè®¿é—®ï¼Ÿè¿™äº›å¯ä»¥é€šè¿‡åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿè§£å†³ã€‚</p><h2 id="åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ"></a>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</h2><h3 id="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ"><a href="#ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ"></a>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</h3><blockquote><p>å¯ä»¥ç®€å•ç†è§£å…¶åŠŸèƒ½å°±æ˜¯ä¸Šä¼ åª’ä½“èµ„æºï¼Œè¿›è¡Œå­˜å‚¨</p></blockquote><p>æ–‡ä»¶ç³»ç»Ÿçš„å®šä¹‰ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿä¸­è´Ÿè´£ç®¡ç†å’Œå­˜å‚¨æ–‡ä»¶ä¿¡æ¯çš„è½¯ä»¶æœºæ„ç§°ä¸ºæ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼Œç®€ç§°æ–‡ä»¶ç³»ç»Ÿ</li><li>æ“ä½œç³»ç»Ÿé€šè¿‡æ–‡ä»¶ç³»ç»Ÿæä¾›çš„æ¥å£å»å­˜å–æ–‡ä»¶ï¼Œç”¨æˆ·é€šè¿‡æ“ä½œç³»ç»Ÿè®¿é—®ç£ç›˜ä¸Šçš„æ–‡ä»¶</li><li>å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿï¼šFAT16&#x2F;FAT32ã€NTFSã€HFSã€UFSã€APFSã€XFSã€Ext4ç­‰</li></ul><p>ä¸€äº›çŸ­è§†é¢‘å¹³å°(bilibili)æ‹¥æœ‰å¤§é‡çš„è§†é¢‘ã€å›¾ç‰‡ï¼Œè¿™äº›è§†é¢‘æ–‡ä»¶ã€å›¾ç‰‡æ–‡ä»¶è¯¥å¦‚ä½•å­˜å‚¨å‘¢ï¼Ÿå¦‚ä½•å­˜å‚¨å¯ä»¥æ»¡è¶³äº’è”ç½‘ä¸Šæµ·é‡ç”¨æˆ·çš„æµè§ˆå‘¢ï¼Ÿ</p><ul><li>å³ç­”ï¼š<strong>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</strong>å°±æ˜¯æµ·é‡ç”¨æˆ·è®¿é—®æµ·é‡æ–‡ä»¶çš„æ–¹æ¡ˆ</li></ul><p>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼šå¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼Œä¸€ä¸ªè®¡ç®—æœºæ— æ³•å­˜å‚¨æµ·é‡çš„æ–‡ä»¶ï¼Œé€šè¿‡ç½‘ç»œå°†è‹¥å¹²è®¡ç®—æœºç»„ç»‡èµ·æ¥å…±åŒå»å­˜å‚¨æµ·é‡çš„æ–‡ä»¶ï¼Œå»æ¥æ”¶æµ·é‡ç”¨æˆ·çš„è¯·æ±‚ï¼Œè¿™äº›ç»„ç»‡èµ·æ¥çš„è®¡ç®—æœºé€šè¿‡è®¡ç®—æœºç½‘ç»œé€šä¿¡</p><ul><li>è¿™æ ·åšçš„å¥½å¤„<ol><li>ä¸€å°è®¡ç®—æœºçš„æ–‡ä»¶ç³»ç»Ÿå¤„ç†èƒ½åŠ›æ‰©å……åˆ°å¤šå°è®¡ç®—æœºåŒæ—¶å¤„ç†</li><li>ä¸€å°è®¡ç®—æœºæŒ‚äº†ï¼Œ è¿˜æœ‰å¦å¤–å‰¯æœ¬è®¡ç®—æœºæä¾›æ•°æ®</li><li>æ¯å°è®¡ç®—æœºå¯ä»¥æ”¾åœ¨ä¸åŒçš„åœ°åŸŸï¼Œç”¨æˆ·å¯ä»¥å°±è¿‘è®¿é—®ï¼Œæé«˜è®¿é—®é€Ÿåº¦</li></ol></li></ul><h3 id="åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„äº§å“"><a href="#åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„äº§å“" class="headerlink" title="åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„äº§å“"></a>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„äº§å“</h3><ol><li>NFS</li><li>GFS</li><li>HDFS</li><li>äº‘è®¡ç®—å‚å®¶<ul><li>é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆObject Storage Serviceï¼Œç®€ç§° OSSï¼‰<ul><li><a href="https://www.aliyun.com/product/oss">å®˜æ–¹ç½‘ç«™</a></li></ul></li><li>ç™¾åº¦å¯¹è±¡å­˜å‚¨BOS<ul><li><a href="https://cloud.baidu.com/product/bos.html">å®˜æ–¹ç½‘ç«™</a></li></ul></li></ul></li></ol><h3 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h3><p>MinIOæ˜¯ä¸€ä¸ªè½»é‡çš„æœåŠ¡ï¼Œå¯ä»¥ç”¨æ¥æ„å»ºåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚å…¶å…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨&#x2F;è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œæä¾›äº†Javaã€Pythonã€GOç­‰å¤šç‰ˆæœ¬SDKæ”¯æŒã€‚</p><ul><li><a href="https://min.io/%EF%BC%8C">å®˜ç½‘</a></li><li><a href="https://www.minio.org.cn/">å®˜ç½‘-ä¸­æ–‡</a></li></ul><p> MinIOé‡‡ç”¨å»ä¸­å¿ƒåŒ–å…±äº«æ¶æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯å¯¹ç­‰å…³ç³»ï¼Œé€šè¿‡Nginxå¯å¯¹MinIOè¿›è¡Œè´Ÿè½½å‡è¡¡è®¿é—®</p><ul><li>å»ä¸­å¿ƒåŒ–æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ<ul><li>åœ¨å¤§æ•°æ®é¢†åŸŸï¼Œé€šå¸¸çš„è®¾è®¡ç†å¿µéƒ½æ˜¯æ— ä¸­å¿ƒå’Œåˆ†å¸ƒå¼ã€‚MinIOåˆ†å¸ƒå¼æ¨¡å¼å¯ä»¥å¸®åŠ©ä½ æ­å»ºä¸€ä¸ªé«˜å¯ç”¨çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™äº›å­˜å‚¨è®¾å¤‡ï¼Œè€Œä¸ç”¨è€ƒè™‘å…¶çœŸå®ç‰©ç†ä½ç½®</li></ul></li></ul><p>MinIOå°†åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡å™¨ä¸Šçš„å¤šå—ç¡¬ç›˜ç»„æˆä¸€ä¸ªå¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚ç”±äºç¡¬ç›˜åˆ†å¸ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œåˆ†å¸ƒå¼MinIOé¿å…äº†å•ç‚¹æ•…éšœ</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/8h2TK47lb3YBLDU.png" alt="MinIOå­˜å‚¨æœåŠ¡"></p><ul><li>MinIOä½¿ç”¨<em><strong>çº åˆ ç æŠ€æœ¯</strong></em>æ¥ä¿æŠ¤æ•°æ®ï¼Œå®ƒæ˜¯ä¸€ç§æ¢å¤ä¸¢å¤±å’ŒæŸåæ•°æ®çš„æ•°å­¦ç®—æ³•ã€‚ä¸Šå›¾ç”±8å—ç¡¬ç›˜ç»„æˆä¸€ä¸ªé›†åˆï¼Œå½“ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šé€šè¿‡çº åˆ ç ç®—æ³•è®¡ç®—å¯¹æ–‡ä»¶è¿›è¡Œ<em><strong>åˆ†å—å­˜å‚¨</strong></em>ï¼Œé™¤äº†å°†æ–‡ä»¶æœ¬èº«åˆ†æˆ4ä¸ªæ•°æ®å—ï¼Œè¿˜ä¼šç”Ÿæˆ4ä¸ªæ ¡éªŒå—ï¼Œæ•°æ®å—å’Œæ ¡éªŒå¼€ä¼šåˆ†æ•£çš„å­˜å‚¨åœ¨è¿™8å—ç¡¬ç›˜ä¸Š</li><li>å³ä¾¿ä¸¢å¤±ä¸€åŠæ•°é‡(N&#x2F;2)çš„ç¡¬ç›˜ï¼Œä»å¯ä»¥æ¢å¤æ•°æ®ã€‚ä¾‹å¦‚ä¸Šé¢é›†åˆä¸­æœ‰4ä¸ªä»¥å†…çš„ç¡¬ç›˜æŸå®³ï¼Œä»å¯ä¿è¯æ•°æ®æ¢å¤ï¼Œä¸å½±å“ä¸Šä¼ å’Œä¸‹è½½</li></ul><h4 id="æ­å»ºMinIO"><a href="#æ­å»ºMinIO" class="headerlink" title="æ­å»ºMinIO"></a>æ­å»ºMinIO</h4><p>ä¸ç”¨æƒ³å¤æ‚ï¼Œå…¶å®å°±æ˜¯æ­å»ºä¸€ä¸ªç±»ä¼¼äºé˜¿é‡Œäº‘OSSçš„äº‘å­˜å‚¨æœåŠ¡ï¼Œä¸è¿‡å¤šäº†ä¸€æ­¥éƒ¨ç½²MinIOã€‚ç”šè‡³ä½¿ç”¨åŸºæœ¬éƒ½æ˜¯ä¸€è‡´ï¼Œéƒ¨ç½²MinIOâ€“åˆ›å»ºBucketâ€“ä¸Šä¼ èµ„æºåˆ°Bucketâ€“ç”ŸæˆURLã€‚è€Œå…¶ä¸­çš„APIè°ƒç”¨é€šè¿‡æŸ¥çœ‹å®˜ç½‘çš„ä½¿ç”¨æ–‡æ¡£å³å¯ã€‚</p><ol><li>é¦–å…ˆï¼Œä¸‹è½½MinIO<ol><li><code>https://dl.min.io/server/minio/release/</code></li></ol></li><li>ç„¶åï¼Œé€šè¿‡å¤šä¸ªèŠ‚ç‚¹æ„å»ºä¸€ä¸ªåˆ†å¸ƒå¼çš„æœåŠ¡<ol><li>éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®<code>ip:9000</code>è¿›è¡Œç™»å½•</li><li>é»˜è®¤è´¦å·å¯†ç å‡ä¸º<code>minioadmin</code></li></ol></li><li>åœ¨å…¶æä¾›UIç•Œé¢ä¸­ï¼Œå¯ä»¥åˆ›å»ºbucketï¼Œå®Œæˆèµ„æºçš„ä¸Šä¼ ã€é¢„è§ˆã€åˆ é™¤ç­‰</li><li>æœ€åï¼Œå°±æ˜¯JAVA SDKçš„ä½¿ç”¨<ol><li><a href="https://docs.min.io/docs/java-client-quickstart-guide.html">æ–‡æ¡£é“¾æ¥</a></li></ol></li></ol><p>å…·ä½“æ“ä½œï¼š</p><ul><li>åœ¨å·¥ç¨‹ä¸­æ·»åŠ ä¾èµ–<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­éœ€è¦ä¸‰ä¸ªå‚æ•°æ‰èƒ½è¿æ¥åˆ°minioæœåŠ¡</li></ul><table><thead><tr><th align="center">Parameters</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">Endpoint</td><td align="center">S3 æœåŠ¡çš„ URL</td></tr><tr><td align="center">Access Key</td><td align="center">æœåŠ¡ä¸­è´¦æˆ·çš„è®¿é—®å¯†é’¥ï¼ˆä¹Ÿç§°ä¸ºç”¨æˆ· IDï¼‰</td></tr><tr><td align="center">Secret Key</td><td align="center">æœåŠ¡ä¸­è´¦æˆ·çš„å¯†é’¥ï¼ˆåˆåå¯†ç ï¼‰<br></td></tr></tbody></table><ul><li>å®˜æ–¹ç»™å‡ºçš„åŸºæœ¬æ–‡æ¡£<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploader</span> &#123;  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  </span><br><span class="line">      <span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidKeyException &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;   </span><br><span class="line">      <span class="comment">// åˆ›å»ºMinIOå®¢æˆ·ç«¯ï¼Œè¿æ¥å‚æ•°å°±æ˜¯ä¸Šè¿°è¡¨æ ¼ä¸­çš„ä¸‰ä¸ªå‚æ•°ï¼Œip:9000ã€minioadminã€minioadmin  </span></span><br><span class="line">      <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span>  </span><br><span class="line">          MinioClient.builder()  </span><br><span class="line">              .endpoint(<span class="string">&quot;https://play.min.io&quot;</span>)  </span><br><span class="line">              .credentials(<span class="string">&quot;Q3AM3UQ867SPQQA43P2F&quot;</span>, <span class="string">&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;</span>)  </span><br><span class="line">              .build();  </span><br><span class="line">      <span class="comment">// åˆ¤æ–­Bucketå­˜ä¸å­˜åœ¨</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span>  minioClient.bucketExists(BucketExistsArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">      <span class="keyword">if</span> (!found) &#123;  </span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªBucket asiatrip</span></span><br><span class="line">  minioClient.makeBucket(MakeBucketArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());  </span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">// å°† &#x27;/home/user/Photos/asiaphotos.zip&#x27; æ–‡ä»¶å‘½åä¸º &#x27;asiaphotos-2015.zip&#x27;  </span></span><br><span class="line">      <span class="comment">// å¹¶ä¸Šä¼ åˆ° &#x27;asiatrip&#x27; é‡Œï¼ˆç¤ºä¾‹ä»£ç åˆ›å»ºçš„bucketï¼‰  </span></span><br><span class="line">      minioClient.uploadObject(  </span><br><span class="line">          UploadObjectArgs.builder()  </span><br><span class="line">              .bucket(<span class="string">&quot;asiatrip&quot;</span>)  </span><br><span class="line">              .object(<span class="string">&quot;asiaphotos-2015.zip&quot;</span>)  </span><br><span class="line">              .filename(<span class="string">&quot;/home/user/Photos/asiaphotos.zip&quot;</span>)  </span><br><span class="line">              .build());  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (MinioException e) &#123;  </span><br><span class="line">      System.out.println(<span class="string">&quot;Error occurred: &quot;</span> + e);  </span><br><span class="line">      System.out.println(<span class="string">&quot;HTTP trace: &quot;</span> + e.httpTrace());  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>åœ¨ç»™å‡ºçš„æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬åœ¨serviceè°ƒç”¨åï¼Œæ‹¿åˆ°è®¿é—®é“¾æ¥ï¼Œå†ä¿å­˜åˆ°æ•°æ®åº“ä¸­</li></ul><h2 id="æ–­ç‚¹ç»­ä¼ "><a href="#æ–­ç‚¹ç»­ä¼ " class="headerlink" title="æ–­ç‚¹ç»­ä¼ "></a>æ–­ç‚¹ç»­ä¼ </h2><blockquote><p>ä¹‹å‰çš„è‹ç©¹å¤–å–é¡¹ç›®éƒ½æ˜¯å›¾ç‰‡çš„ä¸Šä¼ ï¼Œä½†æ˜¯å¤§æ–‡ä»¶ã€è§†é¢‘çš„è¯ï¼Œè¯¥å¦‚ä½•ä¸Šä¼ ç¡®ä¿æœåŠ¡å‘¢ï¼Ÿ</p></blockquote><h3 id="ä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ "><a href="#ä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ " class="headerlink" title="ä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ "></a>ä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ </h3><ul><li>é€šå¸¸è§†é¢‘æ–‡ä»¶éƒ½æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥å¯¹äºåª’èµ„ç³»ç»Ÿè¦æ»¡è¶³å¤§æ–‡ä»¶çš„ä¸Šä¼ éœ€æ±‚ã€‚HTTPåè®®æœ¬èº«å¯¹ä¸Šä¼ æ–‡ä»¶å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯å®¢æˆ·çš„ç½‘ç»œç¯å¢ƒä¹‹ç±»ã€ç”µè„‘ç¡¬ä»¶ç¯å¢ƒç­‰å‚å·®ä¸é½ï¼Œå¦‚æœä¸€ä¸ªå¤§æ–‡ä»¶å¿«ä¸Šä¼ å®Œäº†ï¼Œä½†æ˜¯çªç„¶æ–­ç½‘äº†ï¼Œæ²¡æœ‰ä¸Šä¼ å®Œæˆï¼Œéœ€è¦å®¢æˆ·é‡æ–°ä¸Šä¼ ï¼Œé‚£ä¹ˆç”¨æˆ·ä½“éªŒå°±éå¸¸å·®ã€‚æ‰€ä»¥å¯¹äºå¤§æ–‡ä»¶ä¸Šä¼ çš„æœ€åŸºæœ¬è¦æ±‚å°±æ˜¯<strong>æ–­ç‚¹ç»­ä¼ </strong>ã€‚</li><li>ç®€å•ç†è§£ï¼šæŠŠè¾ƒå¤§çš„æ–‡ä»¶æŒ‰â€œå—â€ï¼ˆå°æ–‡ä»¶ï¼‰çš„å¤§å°è¿›è¡Œåˆ†å—ï¼Œæœ€ååˆæˆå¤§æ–‡ä»¶</li><li>æ€è·¯å¦‚ä¸‹ï¼š<ol><li>å‰ç«¯ä¸Šä¼ å‰å…ˆæŠŠæ–‡ä»¶åˆ†æˆå—</li><li>ä¸€å—ä¸€å—çš„ä¸Šä¼ ï¼Œä¸Šä¼ ä¸­æ–­åé‡æ–°ä¸Šä¼ ã€‚å·²ä¸Šä¼ çš„åˆ†å—åˆ™ä¸ç”¨å†ä¸Šä¼ </li><li>å„åˆ†å—ä¸Šä¼ å®Œæˆåï¼Œåœ¨æœåŠ¡ç«¯åˆå¹¶æ–‡ä»¶</li></ol></li><li>æ–‡ä»¶åˆ†å—çš„æµç¨‹ï¼š<ol><li>è·å–æºæ–‡ä»¶é•¿åº¦</li><li>æ ¹æ®è®¾å®šçš„åˆ†å—æ–‡ä»¶å¤§å°ï¼Œè®¡ç®—å‡ºå—æ•°ï¼ˆå‘ä¸Šå–æ•´ï¼Œä¾‹å¦‚33.4Mçš„æ–‡ä»¶ï¼Œå—å¤§å°ä¸º1Mï¼Œåˆ™éœ€è¦34å—ï¼‰</li><li>ä»æºæ–‡ä»¶è¯»å–æ•°æ®ï¼Œå¹¶ä¾æ¬¡å‘æ¯ä¸€ä¸ªå—æ–‡ä»¶å†™æ•°æ®</li></ol></li><li>æ–‡ä»¶åˆå¹¶çš„æµç¨‹ï¼š<ol><li>æ‰¾åˆ°è¦åˆå¹¶çš„æ–‡ä»¶å¹¶æŒ‰æ–‡ä»¶åˆ†å—çš„å…ˆåé¡ºåºæ’åº</li><li>åˆ›å»ºåˆå¹¶æ–‡ä»¶</li><li>ä¾æ¬¡ä»åˆ†å—æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå†å‘åˆå¹¶æ–‡ä»¶å†™å…¥æ•°æ®</li></ol></li><li>è¡¥å……ï¼Œæ–‡ä»¶çš„md5ï¼š<ul><li>ä¸€ç§å“ˆå¸Œç®—æ³•ï¼Œâ€Œç”¨äºå¯¹æ–‡ä»¶è¿›è¡ŒéªŒè¯å’Œå®Œæ•´æ€§æ£€æŸ¥</li></ul></li></ul><h2 id="è§†é¢‘å¤„ç†"><a href="#è§†é¢‘å¤„ç†" class="headerlink" title="è§†é¢‘å¤„ç†"></a>è§†é¢‘å¤„ç†</h2><blockquote><p>åœ¨ä»¥å‰å›¾ç‰‡ä¸Šä¼ ä¹‹åæ— éœ€è¿‡å¤šå¤„ç†ï¼Œæ‹¿åˆ°å›¾ç‰‡é“¾æ¥ä½¿ç”¨å³å¯ï¼Œå¯æ˜¯è§†é¢‘è¯¥åŠå‘¢ï¼Ÿ</p></blockquote><h3 id="è®²è®²è§†é¢‘ç¼–ç "><a href="#è®²è®²è§†é¢‘ç¼–ç " class="headerlink" title="è®²è®²è§†é¢‘ç¼–ç "></a>è®²è®²è§†é¢‘ç¼–ç </h3><ul><li>è§†é¢‘ä¸Šä¼ æˆåŠŸåï¼Œéœ€è¦å¯¹è§†é¢‘è¿›è¡Œ<strong>è½¬ç </strong>å¤„ç†</li><li>ä»€ä¹ˆæ˜¯è§†é¢‘ç¼–ç ï¼Ÿå®šä¹‰å¦‚ä¸‹ï¼š<ul><li>æ‰€è°“è§†é¢‘ç¼–ç æ–¹å¼å°±æ˜¯æŒ‡é€šè¿‡å‹ç¼©æŠ€æœ¯ï¼Œå°†åŸå§‹è§†é¢‘æ ¼å¼çš„æ–‡ä»¶è½¬æ¢æˆå¦ä¸€ç§è§†é¢‘æ ¼å¼æ–‡ä»¶çš„æ–¹å¼ã€‚è§†é¢‘æµä¼ è¾“ä¸­æœ€ä¸ºé‡è¦çš„ç¼–è§£ç æ ‡å‡†æœ‰å›½é™…ç”µè”çš„H.261ã€H.263ã€H.264ï¼Œè¿åŠ¨é™æ­¢å›¾åƒä¸“å®¶ç»„çš„M-JPEGå’Œå›½é™…æ ‡å‡†åŒ–ç»„ç»‡è¿åŠ¨å›¾åƒä¸“å®¶ç»„çš„MPEGç³»åˆ—æ ‡å‡†ï¼Œæ­¤å¤–åœ¨äº’è”ç½‘ä¸Šè¢«å¹¿æ³›åº”ç”¨çš„è¿˜æœ‰Real-Networksçš„RealVideoã€å¾®è½¯å…¬å¸çš„WMVä»¥åŠAppleå…¬å¸çš„QuickTimeç­‰ã€‚</li></ul></li><li>é¦–å…ˆæˆ‘ä»¬è¦åˆ†æ¸…æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼<ul><li><code>æ–‡ä»¶æ ¼å¼</code>æ˜¯æŒ‡ï¼š<code>.mp4</code>ã€<code>.avi</code>ã€<code>.rmvb</code>ç­‰è¿™äº›ä¸åŒæ‰©å±•åçš„è§†é¢‘æ–‡ä»¶çš„æ–‡ä»¶æ ¼å¼ã€‚è§†é¢‘æ–‡ä»¶çš„å†…å®¹ä¸»è¦åŒ…æ‹¬è§†é¢‘ã€éŸ³é¢‘ï¼Œå…¶æ–‡ä»¶æ ¼å¼æ˜¯æŒ‰ç…§ä¸€å®šçš„ç¼–ç æ ¼å¼å»ç¼–ç ï¼Œå¹¶ä¸”æŒ‰ç…§è¯¥æ–‡ä»¶æ‰€è§„å®šçš„å°è£…æ ¼å¼ï¼Œå°†è§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ç­‰ä¿¡æ¯å°è£…åˆ°ä¸€èµ·ï¼Œæ’­æ”¾å™¨ä¼šæ ¹æ®ä»–ä»¬çš„å°è£…æ ¼å¼å»æå–å‡ºç¼–ç ï¼Œç„¶åç”±æ’­æ”¾å™¨è§£ç ï¼Œæœ€ç»ˆæ’­æ”¾éŸ³è§†é¢‘</li><li><code>ç¼–ç æ ¼å¼</code>æ˜¯æŒ‡ï¼šé€šè¿‡éŸ³è§†é¢‘çš„å‹ç¼©æŠ€æœ¯ï¼Œå°†è§†é¢‘æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§è§†é¢‘æ ¼å¼ï¼Œé€šè¿‡è§†é¢‘ç¼–ç å®ç°æµåª’ä½“çš„ä¼ è¾“ã€‚æ¯”å¦‚ä¸€ä¸ª.aviçš„è§†é¢‘æ–‡ä»¶åŸæ¥çš„ç¼–ç æ˜¯aï¼Œé€šè¿‡ç¼–ç åç¼–ç æ ¼å¼å˜ä¸ºb</li></ul></li><li>éŸ³è§†é¢‘ç¼–ç æ ¼å¼ç§ç±»ç¹å¤šï¼Œä¸»è¦ç”±ä»¥ä¸‹å‡ ç±»<ul><li><code>MPEGç³»åˆ—</code>ï¼ˆç”±ISOä¸‹å±çš„MPEGå¼€å‘ï¼‰<ul><li>è§†é¢‘ç¼–ç æ–¹é¢ä¸»è¦æ˜¯Mpeg1ï¼ˆVCDï¼‰ã€Mpeg2ï¼ˆDVDï¼‰ã€Mpeg4ï¼ˆdivxï¼Œxvidï¼‰ã€Mpeg4 AVC</li><li>éŸ³é¢‘ç¼–ç æ–¹é¢ä¸»è¦æ˜¯MPEG Audio Layer 1&#x2F;2ã€MPEG Audio Layer 3ï¼ˆMP3ï¼‰ã€MPEG-2 AAC ã€MPEG-4 AAC</li></ul></li><li><code>H.26Xç³»åˆ—</code>ï¼ˆç”±ITUä¸»å¯¼ï¼Œä¾§é‡ç½‘ç»œä¼ è¾“ï¼Œæ³¨æ„ï¼šåªæ˜¯è§†é¢‘ç¼–ç ï¼‰<ul><li>åŒ…æ‹¬H.261ã€H.262ã€H.263ã€H.263+ã€H.263++ã€H.264</li></ul></li></ul></li><li>ç›®å‰æœ€å¸¸ç”¨çš„ç¼–ç æ ‡å‡†æ˜¯<ul><li>è§†é¢‘ï¼šH.264</li><li>éŸ³é¢‘ï¼šAAC</li></ul></li></ul><h3 id="åŸºäºFFmpegå®ç°è½¬ç "><a href="#åŸºäºFFmpegå®ç°è½¬ç " class="headerlink" title="åŸºäºFFmpegå®ç°è½¬ç "></a>åŸºäºFFmpegå®ç°è½¬ç </h3><ul><li>ä»€ä¹ˆæ˜¯FFmpegï¼Ÿ<ul><li>FFmpegæ˜¯ä¸€å¥—å¯ä»¥ç”¨æ¥è®°å½•ã€è½¬æ¢æ•°å­—éŸ³é¢‘ã€è§†é¢‘ï¼Œå¹¶èƒ½å°†å…¶è½¬åŒ–ä¸ºæµçš„å¼€æºè®¡ç®—æœºç¨‹åº</li><li>æä¾›å½•åˆ¶ã€è½¬æ¢ä»¥åŠæµå¼ä¼ è¾“éŸ³è§†é¢‘çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ</li><li>å®ƒåŒ…å«äº†éå¸¸å…ˆè¿›çš„éŸ³é¢‘&#x2F;è§†é¢‘ç¼–è§£ç åº“libavcodec</li><li>æ”¯æŒå¤šç¯å¢ƒï¼Œå…¶ç¼–ç åº“å¯ä»¥ä½¿ç”¨GPUåŠ é€Ÿ</li></ul></li><li>ä¸‹è½½<ul><li><a href="https://www.ffmpeg.org/download.html#build-windows">FFmpeg</a>ï¼Œå¹¶å°†å…¶binç›®å½•åŠ å…¥ç¯å¢ƒå˜é‡</li></ul></li><li>æµ‹è¯•æ˜¯å¦æ­£å¸¸ï¼š<code>ffmpeg -version</code></li><li>å®‰è£…æˆåŠŸåï¼Œåšä¸€ä¸‹ç®€å•æµ‹è¯•ï¼Œå°†.mp4æ–‡ä»¶è½¬ä¸º.aviï¼Œå†å°†.aviè½¬ä¸º.gifç­‰<ul><li><code>ffmpeg -i xx.mp4 xx.avi</code></li><li><code>ffmpeg -i xx.avi xx.gif</code></li></ul></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/glepT1EqDvSY7w5.jpg" alt="è½¬æ¢ç»“æœ"></li><li>åœ¨é¡¹ç›®ä¸­ä¸€èˆ¬åŸºäºFFmpegåˆ›å»ºå·¥å…·ç±»ï¼Œæ¥å®Œæˆå¯¹è§†é¢‘çš„è½¬ç ï¼Œç„¶åä¸Šä¼ </li></ul>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JSR-303è§„èŒƒ</title>
      <link href="/cn/JSR303/"/>
      <url>/cn/JSR303/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ•°æ®æ ¡éªŒçš„å¥½å¤„æ¯åº¸ç½®ç–‘ï¼Œå› ä¸ºé»‘é©¬çš„ã€Šå­¦æˆåœ¨çº¿ã€‹é¡¹ç›®ç”¨åˆ°äº†å‚æ•°æ ¡éªŒçš„è§„èŒƒ-<code>JSR-303</code>ï¼Œæ‰€ä»¥è¿™é‡Œè®°å½•ä¸€ä¸‹<br>å®˜ç½‘ : <code>https://beanvalidation.org/</code></p></blockquote><h3 id="ä¸€ã€ä½•ä¸ºJSR-303è§„èŒƒ"><a href="#ä¸€ã€ä½•ä¸ºJSR-303è§„èŒƒ" class="headerlink" title="ä¸€ã€ä½•ä¸ºJSR-303è§„èŒƒ"></a>ä¸€ã€ä½•ä¸ºJSR-303è§„èŒƒ</h3><p>JSR-303æ˜¯ä¸€å¥—åœ¨Java EEå’ŒJava SEä¸­ç”¨äºJavaBeanéªŒè¯çš„Java APIè§„èŒƒã€‚è¿™é¡¹å·¥ä½œçš„æŠ€æœ¯ç›®æ ‡æ˜¯ä¸ºJavaåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜æä¾›ç±»çº§çº¦æŸå£°æ˜å’ŒéªŒè¯å·¥å…·ï¼Œä»¥åŠçº¦æŸå…ƒæ•°æ®å­˜å‚¨åº“å’ŒæŸ¥è¯¢APIã€‚<br>äººè¯å°±æ˜¯ï¼šJSR-303æä¾›äº†ä¸€å¥—é€šè¿‡æ³¨è§£çš„æ–¹å¼å®ç°å¯¹JavaBeançš„å±æ€§è¿›è¡ŒéªŒè¯</p><p>æˆªæ­¢åˆ°ç›®å‰ä¸ºæ­¢ï¼Œbean validationè§„èŒƒå·²ç»æ›´æ–°åˆ°äº†1.1(JSR-349), 2.0(JSR-380)ï¼Œ3.0 ç­‰ç‰ˆæœ¬ï¼Œä¸è¿‡å‡çº§åçš„ç‰ˆæœ¬ï¼Œä»…ä»…æ˜¯æ·»åŠ äº†è‹¥å¹²æ³¨è§£è€Œå·²ï¼Œæ ¸å¿ƒå†…å®¹éƒ½æœªå˜åŠ¨<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/05/3Y8f7sZpAxBuRDg.png" alt="ç‰ˆæœ¬å¯¹æ¯”å›¾"></p><h3 id="äºŒã€å®ç°JSR-303è§„èŒƒ"><a href="#äºŒã€å®ç°JSR-303è§„èŒƒ" class="headerlink" title="äºŒã€å®ç°JSR-303è§„èŒƒ"></a>äºŒã€å®ç°JSR-303è§„èŒƒ</h3><p><code>SpringBoot</code>æä¾›äº†<code>JSR-303</code>çš„æ”¯æŒï¼Œå®ƒå°±æ˜¯<code>spring-boot-stater-validation</code>ï¼Œå®ƒçš„åº•å±‚ä½¿ç”¨<code>Hibernate Validation</code>ï¼Œ<code>Hibernate Validation</code>æ˜¯<code>Bean Validation</code>çš„å‚è€ƒå®ç°ã€‚</p><blockquote><p>Hibernate Validationæ˜¯ä¸€ç§ç”¨äºJavaå¯¹è±¡éªŒè¯çš„æ¡†æ¶ï¼Œâ€Œå®ƒå…è®¸å¼€å‘è€…åœ¨å¯¹è±¡çš„å±æ€§ä¸Š<strong>æ·»åŠ æ³¨è§£</strong>ï¼Œâ€Œä»¥å®šä¹‰éªŒè¯è§„åˆ™ï¼Œâ€Œç¡®ä¿å¯¹è±¡çš„çŠ¶æ€æ»¡è¶³ç‰¹å®šçš„ä¸šåŠ¡è§„åˆ™</p></blockquote><p>é¦–å…ˆï¼Œå¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå¯¹æ·»åŠ è¯¾ç¨‹ä¿¡æ¯æ¥å£è¿›è¡Œæ ¡éªŒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æ–°å¢è¯¾ç¨‹åŸºç¡€ä¿¡æ¯æ¥å£&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span> &#123;  </span><br><span class="line">    <span class="comment">// æœºæ„id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">22L</span>;  </span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥æ¥å£ä¸­ï¼Œé€šè¿‡AddCourseDtoæ¥æ”¶å‚æ•°ï¼Œäºæ˜¯å¯¹è¯¥beanå±æ€§æ·»åŠ æ ¡éªŒè§„åˆ™</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="meta">@ApiModel(value = &quot;AddCourseDto&quot;, description = &quot;æ–°å¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddCourseDto</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;è¯¾ç¨‹åç§°ä¸èƒ½ä¸ºç©º&quot;)</span>  </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;è¯¾ç¨‹åç§°&quot;, required = true)</span>  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;é€‚ç”¨äººç¾¤ä¸èƒ½ä¸ºç©º&quot;)</span>  </span><br><span class="line">    <span class="meta">@Size(min = 10, message = &quot;é€‚ç”¨äººç¾¤å†…å®¹è¿‡å°‘ï¼Œè‡³å°‘10ä¸ªå­—ç¬¦&quot;)</span>  </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;é€‚ç”¨äººç¾¤&quot;, required = true)</span>  </span><br><span class="line">    <span class="keyword">private</span> String users;  </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;è¯¾ç¨‹ä»‹ç»&quot;)</span>  </span><br><span class="line">    <span class="keyword">private</span> String description;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;è¯¾ç¨‹å›¾ç‰‡&quot;, required = true)</span>  </span><br><span class="line">    <span class="keyword">private</span> String pic;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;æ”¶è´¹è§„åˆ™ä¸èƒ½ä¸ºç©º&quot;)</span>  </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;æ”¶è´¹è§„åˆ™ï¼Œå¯¹åº”æ•°æ®å­—å…¸&quot;, required = true)</span>  </span><br><span class="line">    <span class="keyword">private</span> String charge;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;åŸä»·&quot;)</span>  </span><br><span class="line">    <span class="keyword">private</span> Float originalPrice;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å…¶ä¸­ç”¨åˆ°äº†<code>@NotEmpty</code>å’Œ<code>@Size</code>ä¸¤ä¸ªæ³¨è§£ï¼Œ<code>@NotEmpty</code>è¡¨ç¤ºå±æ€§ä¸èƒ½ä¸ºç©ºï¼Œ<code>@Size</code>è¡¨ç¤ºé™åˆ¶å±æ€§å†…å®¹çš„é•¿åº¦ï¼Œå…¶ä¸­çš„messageæ˜¯å¼‚å¸¸è¿”å›çš„ä¿¡æ¯</p></li><li><p>è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ³¨è§£ï¼Œæ¯”å¦‚è¯´ï¼š</p><ul><li><code>@NULL</code>ï¼Œè¦æ±‚å±æ€§ä¸ºç©º</li><li><code>@NotNull</code>ï¼Œè¦æ±‚å±æ€§ä¸ä¸ºç©º</li><li><code>@NotBlank</code>ï¼Œè¦æ±‚å­—ç¬¦ä¸²ä¸ä¸ºç©ºï¼Œåœ¨æ¯”è¾ƒæ—¶ä¼šå»é™¤å­—ç¬¦ä¸²çš„ç©ºæ ¼</li><li>â€¦â€¦</li></ul></li><li><p>å¦‚æœæ³¨è§£æŠ¥é”™ï¼Œæ£€æŸ¥Spring Bootçš„ç‰ˆæœ¬</p></li></ul><p>æœ€åï¼Œå®šä¹‰å¥½äº†æ ¡éªŒè§„åˆ™è¿˜éœ€è¦åœ¨Controlleræ–¹æ³•ä¸­æ·»åŠ <code>@Validated</code>æ³¨è§£å¼€å¯æ ¡éªŒï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æ–°å¢è¯¾ç¨‹åŸºç¡€ä¿¡æ¯æ¥å£&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> AddCourseDto addCourseDto)</span> &#123;  </span><br><span class="line">    <span class="comment">// æœºæ„id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">22L</span>;  </span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ ¡éªŒå‡ºé”™ï¼ŒSpringä¼šæŠ›å‡º<code>MethodArgumentNotValidException</code>å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¸­æ•è·å¼‚å¸¸ï¼Œè§£æå‡ºå¼‚å¸¸å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>  </span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">doMethodArgumentNotValidException</span><span class="params">(MethodArgumentNotValidException exception)</span> &#123;  </span><br><span class="line">    <span class="comment">// ç”±äºç”¨æˆ·è¾“å…¥çš„å†…å®¹å¯èƒ½å­˜åœ¨å¤šå¤„é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†æ‰€æœ‰é”™è¯¯ä¿¡æ¯éƒ½æç¤ºç»™ç”¨æˆ·  </span></span><br><span class="line">    <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> exception.getBindingResult();  </span><br><span class="line">    <span class="comment">// è·å–é”™è¯¯é›†åˆ  </span></span><br><span class="line">    List&lt;FieldError&gt; fieldErrors = bindingResult.getFieldErrors();  </span><br><span class="line">    <span class="comment">// æ‹¼æ¥å­—ç¬¦ä¸²  </span></span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();  </span><br><span class="line">    fieldErrors.forEach(fieldError -&gt; stringBuffer.append(fieldError.getDefaultMessage()).append(<span class="string">&quot;,&quot;</span>));  </span><br><span class="line">    <span class="comment">// è®°å½•æ—¥å¿—  </span></span><br><span class="line">    log.error(stringBuffer.toString());  </span><br><span class="line">    <span class="comment">// å“åº”ç»™ç”¨æˆ·  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(stringBuffer.toString());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼Œå°†å¿…å¡«é¡¹è®¾ç½®ä¸ºç©ºï¼Œé€‚ç”¨äººç¾¤è®¾ç½®å°äº10ä¸ªå­—ï¼Œå“åº”ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//localhost:53040/content/course  </span></span><br><span class="line">  </span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span>   </span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json  </span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked  </span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">03</span> Feb <span class="number">2023</span> <span class="number">04</span><span class="punctuation">:</span><span class="number">52</span><span class="punctuation">:</span><span class="number">30</span> GMT  </span><br><span class="line">Connection<span class="punctuation">:</span> close  </span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;errMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è¯¾ç¨‹åç§°ä¸èƒ½ä¸ºç©º,é€‚ç”¨äººç¾¤å†…å®¹è¿‡å°‘ï¼Œè‡³å°‘10ä¸ªå­—ç¬¦,&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€åˆ†ç»„æ ¡éªŒ"><a href="#ä¸‰ã€åˆ†ç»„æ ¡éªŒ" class="headerlink" title="ä¸‰ã€åˆ†ç»„æ ¡éªŒ"></a>ä¸‰ã€åˆ†ç»„æ ¡éªŒ</h3><p>æœ‰ä¸€ä¸ªé—®é¢˜ï¼šè®¢å•æ ‡å·æ˜¯ç”±ç³»ç»Ÿç”Ÿæˆï¼Œæ‰€ä»¥åœ¨æ·»åŠ è®¢å•æ—¶ï¼Œè¦æ±‚è®¢å•ç¼–å·ä¸ºç©ºï¼›ä½†æ˜¯åœ¨æ›´æ–°è®¢å•æ—¶ï¼Œè¦æ±‚è®¢å•ç¼–å·ä¸èƒ½ä¸ºç©ºã€‚äºæ˜¯ï¼Œåœ¨åŒä¸€ä¸ªå±æ€§ä¸Šè®¾ç½®ä¸€ä¸ªæ ¡éªŒè§„åˆ™ä¸èƒ½æ»¡è¶³è¦æ±‚ã€‚</p><p>æ­¤æ—¶å°±éœ€è¦ç”¨åˆ°<em>åˆ†ç»„æ ¡éªŒ</em>ï¼Œåœ¨åŒä¸€ä¸ªå±æ€§å®šä¹‰å¤šä¸ªæ ¡éªŒè§„åˆ™å±äºä¸åŒçš„åˆ†ç»„</p><ul><li>æ·»åŠ è®¢å•å®šä¹‰<code>@NULL</code>è§„åˆ™å±äº<code>insert</code>åˆ†ç»„ï¼Œæ›´æ–°è®¢å•å®šä¹‰<code>@NotEmpty</code>å±äº<code>update</code>åˆ†ç»„ï¼Œ<code>insert</code>å’Œ<code>update</code>æ˜¯åˆ†ç»„çš„åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰</li></ul><h4 id="å®ç°åˆ†ç»„"><a href="#å®ç°åˆ†ç»„" class="headerlink" title="å®ç°åˆ†ç»„"></a>å®ç°åˆ†ç»„</h4><ol><li>å®šä¹‰ä¸åŒçš„æ¥å£ç±»å‹ï¼ˆç©ºæ¥å£ï¼‰è¡¨ç¤ºä¸åŒçš„åˆ†ç»„<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> æ ¡éªŒåˆ†ç»„  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Insert</span>&#123;&#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>&#123;&#125;; </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>&#123;&#125;;  </span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><ul><li>ç”¨classç±»å‹æ¥è¡¨ç¤ºä¸åŒçš„åˆ†ç»„</li></ul><ol start="2"><li><p>åœ¨å®šä¹‰æ ¡éªŒè§„åˆ™æ—¶æŒ‡å®šåˆ†ç»„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(message = &quot;æ·»åŠ è¯¾ç¨‹åç§°ä¸èƒ½ä¸ºç©º&quot;, groups = ValidationGroups.Insert.class)</span>  </span><br><span class="line"><span class="meta">@NotEmpty(message = &quot;ä¿®æ”¹è¯¾ç¨‹åç§°ä¸èƒ½ä¸ºç©º&quot;, groups = ValidationGroups.Update.class)</span>  </span><br><span class="line"><span class="meta">@ApiModelProperty(value = &quot;è¯¾ç¨‹åç§°&quot;, required = true)</span>  </span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨Controlleræ–¹æ³•ä¸­å¯åŠ¨æ ¡éªŒè§„åˆ™æ—¶æŒ‡å®šè¦ä½¿ç”¨çš„åˆ†ç»„å</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æ–°å¢è¯¾ç¨‹åŸºç¡€ä¿¡æ¯æ¥å£&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(ValidationGroups.Insert.class)</span> AddCourseDto addCourseDto)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">22L</span>;  </span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>å¦‚æœ<code>javax.validation.constraints</code>åŒ…ä¸‹çš„æ ¡éªŒè§„åˆ™æ»¡è¶³ä¸äº†éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹å†™æ ¡éªŒä»£ç å’Œè‡ªå®šä¹‰æ ¡éªŒè§„åˆ™æ³¨è§£ã€‚</p><h3 id="å››ã€è¡¥å……"><a href="#å››ã€è¡¥å……" class="headerlink" title="å››ã€è¡¥å……"></a>å››ã€è¡¥å……</h3><p>@NotEmptyã€@NotBlankã€@NotNullä¸‰è€…çš„åŒºåˆ«ï¼š</p><ol><li><strong>@NotNull</strong><ul><li>é€‚ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹(Integerï¼ŒLongï¼ŒDoubleç­‰ç­‰)ï¼Œå½“<code>@NotNull</code>æ³¨è§£è¢«ä½¿ç”¨åœ¨Stringç±»å‹çš„æ•°æ®ä¸Šï¼Œåˆ™è¡¨ç¤ºè¯¥æ•°æ®ä¸èƒ½ä¸º Nullï¼ˆä½†æ˜¯å¯ä»¥ä¸º Emptyï¼‰</li></ul></li><li><strong>@NotBlank</strong> <ul><li>é€‚ç”¨äºStringç±»å‹çš„æ•°æ®ä¸Šï¼Œå‚æ•°ä¸èƒ½ä¸ºNullä¸”å»æ‰å­—ç¬¦ä¸²çš„ç©ºæ ¼ä¹‹å$size &gt; 0$ï¼Œå¿…é¡»æœ‰å®é™…å­—ç¬¦</li></ul></li><li><strong>@NotEmpty</strong><ul><li>é€‚ç”¨äº Stringã€Collectioné›†åˆã€Mapã€æ•°ç»„ç­‰ç­‰ï¼Œå‚æ•°ä¸èƒ½ä¸ºNullæˆ–è€…é•¿åº¦ä¸º 0</li></ul></li></ol><p>å‰ç«¯è¯·æ±‚åç«¯æ¥å£ä¼ è¾“å‚æ•°ï¼Œä¸ºä»€ä¹ˆ<code>Controller</code>ä¸­å’Œ<code>Service</code>ä¸­éƒ½éœ€è¦æ ¡éªŒï¼Ÿ</p><ol><li><code>Controller</code>ä¸­æ ¡éªŒè¯·æ±‚å‚æ•°çš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬ï¼šå¿…å¡«é¡¹æ ¡éªŒã€æ•°æ®æ ¼å¼æ ¡éªŒï¼Œæ¯”å¦‚ï¼šå‚æ•°æ˜¯å¦ç¬¦åˆä¸€å®šçš„æ—¥æœŸæ ¼å¼ç­‰</li><li><code>Service</code>ä¸­è¦æ ¡éªŒçš„æ˜¯ä¸šåŠ¡è§„åˆ™ç›¸å…³çš„å†…å®¹ï¼Œæ¯”å¦‚ï¼šè¯¾ç¨‹å·²ç»å®¡æ ¸é€šè¿‡ï¼Œæ‰€ä»¥æäº¤å¤±è´¥ç­‰</li></ol>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®æ ¡éªŒ </tag>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªåŠ¨æ›´æ–°åšå®¢å†…å®¹</title>
      <link href="/cn/%E5%8D%9A%E5%AE%A2%E5%86%85%E5%AE%B9%E6%9B%B4%E6%96%B0%E8%84%9A%E6%9C%AC/"/>
      <url>/cn/%E5%8D%9A%E5%AE%A2%E5%86%85%E5%AE%B9%E6%9B%B4%E6%96%B0%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è‹¦äºæ¯å¤©æ‰‹åŠ¨æ›´æ–°åšå®¢å†…å®¹ï¼Œåšä¸€ä¸ªæ¯æ—¥é›¶ç‚¹çš„è‡ªåŠ¨æ›´æ–°è„šæœ¬</p></blockquote><h2 id="è„šæœ¬åˆ›å»º"><a href="#è„šæœ¬åˆ›å»º" class="headerlink" title="è„šæœ¬åˆ›å»º"></a>è„šæœ¬åˆ›å»º</h2><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªå­˜æ”¾è„šæœ¬æ–‡ä»¶çš„ç›®å½•ï¼Œæ–°å»ºä¸€ä¸ªä»¥<code>.bat</code>ç»“å°¾çš„æ–‡ä»¶</p><p>è§£æ</p><ul><li><code>.bat</code>ï¼šbatæ–‡ä»¶æ˜¯windowsä¸‹çš„æ‰¹å¤„ç†æ–‡ä»¶ï¼Œä¹Ÿè¢«ç§°ä¸ºæ‰¹å¤„ç†ç¨‹åºæˆ–è„šæœ¬</li><li>æ‰¹å¤„ç†æ–‡ä»¶ï¼šæ— æ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå®ƒåŒ…å«ä¸€æ¡æˆ–å¤šæ¡å‘½ä»¤ï¼Œå®ƒçš„æ–‡ä»¶æ‰©å±•åä¸º <code>.bat</code> æˆ– <code>.cmd</code></li><li>ä½¿ç”¨ï¼šåœ¨å‘½ä»¤è¡Œçª—å£ä¸‹è¾“å…¥æ‰¹å¤„ç†æ–‡ä»¶çš„åç§°ï¼Œæˆ–è€…åŒå‡»è¯¥æ‰¹å¤„ç†æ–‡ä»¶ï¼Œç³»ç»Ÿå°±ä¼šè°ƒç”¨<code>cmd.exe</code>æŒ‰ç…§è¯¥æ–‡ä»¶ä¸­å„ä¸ªå‘½ä»¤å‡ºç°çš„é¡ºåºæ¥é€ä¸ªè¿è¡Œ</li><li>ä½œç”¨ï¼šç®€åŒ–æ—¥å¸¸æˆ–é‡å¤æ€§çš„ä»»åŠ¡</li></ul><p>ç›®çš„ï¼š æ¯å¤©å®šæ—¶æ›´æ–°åšå®¢å†…å®¹çš„è„šæœ¬</p><ol><li>æ›´æ–°åšå®¢å†…å®¹</li><li>è®°å½•æ—¥å¿—ï¼Œæ—¥å¿—æ–‡ä»¶å­˜æ”¾äºè„šæœ¬æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œæ—¥å¿—ä¸»è¦åŒ…å«åšå®¢æ˜¯å¦æ›´æ–°æˆåŠŸã€æ›´æ–°æ—¶é—´</li><li>å®šæ—¶ä»»åŠ¡ï¼Œè®©æ›´æ–°åšå®¢è„šæœ¬æ¯å¤©8ç‚¹è‡ªåŠ¨æ‰§è¡Œ</li><li>é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼Œå®šæœŸæ¸…ç†æ–‡ä»¶å†…å®¹ï¼ˆå¯ç›´æ¥åˆ é™¤ï¼Œé—´éš”ä¸º1å‘¨ï¼‰</li></ol><h2 id="è„šæœ¬ç¼–å†™"><a href="#è„šæœ¬ç¼–å†™" class="headerlink" title="è„šæœ¬ç¼–å†™"></a>è„šæœ¬ç¼–å†™</h2><p>é€šè¿‡vscodeæ‰“å¼€åˆ›å»ºçš„<code>updateBlog.bat</code>æ–‡ä»¶ï¼Œè¿›è¡Œç¼–è¾‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chcp 65001</span><br><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line">@REM <span class="built_in">log</span> file</span><br><span class="line"><span class="built_in">set</span> <span class="string">&quot;logFile=%~dp0\updateblog_log.txt&quot;</span></span><br><span class="line">@REM directory judge</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">&quot;D:\Blog\zybolg&quot;</span> (</span><br><span class="line">Â  Â  <span class="built_in">echo</span> Directory D:\Blog\zybolg does not exist. &gt;&gt; <span class="string">&quot;%logFile%&quot;</span></span><br><span class="line">Â  Â  <span class="built_in">exit</span> /b</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">@REM record <span class="built_in">log</span> and run</span><br><span class="line"><span class="built_in">echo</span> Runing hexo deploy... &gt;&gt; <span class="string">&quot;%logFile%&quot;</span></span><br><span class="line">call cmd /c <span class="string">&quot;cd /d D:\Blog\zybolg &amp;&amp; hexo cl &amp;&amp; (echo hexo cl Command succeeded... &gt;&gt; &quot;</span>%logFile%<span class="string">&quot;) || (echo hexo cl Command failed! &gt;&gt; &quot;</span>%logFile%<span class="string">&quot;)&quot;</span></span><br><span class="line">call cmd /c <span class="string">&quot;cd /d D:\Blog\zybolg &amp;&amp; hexo g &amp;&amp; (echo hexo g Command succeeded... &gt;&gt; &quot;</span>%logFile%<span class="string">&quot;) || (echo hexo g Command failed! &gt;&gt; &quot;</span>%logFile%<span class="string">&quot;)&quot;</span></span><br><span class="line">call cmd /c <span class="string">&quot;cd /d D:\Blog\zybolg &amp;&amp; hexo d &amp;&amp; (echo hexo d Command succeeded... &gt;&gt; &quot;</span>%logFile%<span class="string">&quot;) || (echo hexo d Command failed! &gt;&gt; &quot;</span>%logFile%<span class="string">&quot;)&quot;</span></span><br><span class="line"></span><br><span class="line">@REM get current <span class="built_in">date</span></span><br><span class="line"><span class="built_in">set</span> <span class="string">&quot;currentDate=%date% %time%&quot;</span></span><br><span class="line"><span class="built_in">echo</span> The Blog Update on %currentDate% &gt;&gt; <span class="string">&quot;%logFile%&quot;</span></span><br><span class="line"><span class="built_in">echo</span> ----------------------------------------------------- &gt;&gt; <span class="string">&quot;%logFile%&quot;</span></span><br><span class="line">@REM <span class="built_in">exit</span> System</span><br><span class="line"><span class="built_in">exit</span> /b</span><br></pre></td></tr></table></figure><p>å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼ˆåŒä¸€ç›®å½•ä¸‹ï¼‰è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chcp 65001</span><br><span class="line"></span><br><span class="line">@REM del script file</span><br><span class="line"><span class="built_in">set</span> <span class="string">&quot;del_logfile=%~dp0\*.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> exist <span class="string">&quot;%del_logfile%&quot;</span> (</span><br><span class="line">Â  Â  del <span class="string">&quot;%del_logfile%&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">exit</span> /b</span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h2><p>å‘½ä»¤è§£æï¼š</p><ul><li><code>chcp 65001</code>ï¼šè®¾ç½®ä»£ç é¡µç¼–ç ä¸ºUTF-8</li><li><code>@echo off</code>ï¼šå…³é—­å‘½ä»¤å›æ˜¾ï¼Œäººè¯å°±æ˜¯å³æ‰§è¡Œå‘½ä»¤æ—¶ä¸åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå‘½ä»¤æœ¬èº«ï¼Œåªæ˜¾ç¤ºå‘½ä»¤çš„æ‰§è¡Œç»“æœ <ul><li><code>echo my love china</code></li><li>cmdçª—å£åªä¼šæ˜¾ç¤ºmy love china</li></ul></li><li>æ·»åŠ æ³¨é‡Š<ul><li><code>@REM</code>å’Œ<code>::</code></li><li>åŒç†ï¼Œ<code>@REM</code>ä¸ä¼šå›æ˜¾å‘½ä»¤</li></ul></li><li>å‘½ä»¤çš„è¿æ¥<ul><li><code>&amp;</code>ç¬¦å·å°†å¤šä¸ªå‘½ä»¤è¿æ¥èµ·æ¥åœ¨ä¸€è¡Œä¸­æ‰§è¡Œ</li></ul></li><li>å®šä¹‰å’Œä½¿ç”¨å˜é‡<ul><li><code>set &quot;var=value&quot;</code></li><li>åç»­ç”¨<code>&quot;%var%&quot;</code>æ¥å¼•ç”¨è¯¥å˜é‡</li></ul></li><li>ç¯å¢ƒå˜é‡çš„è·å–<ul><li><code>&quot;%ç¯å¢ƒå˜é‡å%&quot;</code>æ¥è·å–ç³»ç»Ÿå·²æœ‰çš„ç¯å¢ƒå˜é‡çš„å€¼</li><li>æ¯”å¦‚<code>&quot;%PATH%&quot;</code></li></ul></li><li>IFè¯­å¥<ul><li><code>if æ¡ä»¶ (æ‰§è¡Œè¯­å¥)</code></li><li><code>if æ¡ä»¶ 1 (æ‰§è¡Œè¯­å¥ 1) else if æ¡ä»¶ 2 (æ‰§è¡Œè¯­å¥ 2) else (æ‰§è¡Œè¯­å¥ 3)</code></li></ul></li><li><code>start</code>å‘½ä»¤<ul><li>å¼‚æ­¥ï¼Œå¹¶è¡Œæ‰§è¡Œ</li></ul></li><li><code>call</code>å‘½ä»¤<ul><li>åŒæ­¥ï¼Œä¸²è¡Œæ‰§è¡Œ</li></ul></li><li>Forå¾ªç¯çš„<ul><li>éå†æ–‡ä»¶ï¼š<code>for %%i in (*.txt) do (æ‰§è¡Œè¯­å¥)</code></li><li>éå†æ–‡ä»¶å¤¹ï¼š<code>for /r æ–‡ä»¶å¤¹ %%i in (*) do (å‘½ä»¤)</code></li><li>æŒ‰æ•°å­—èŒƒå›´å¾ªç¯ï¼š<code>for /l %%i in (1,1,10) do (æ‰§è¡Œè¯­å¥)</code></li></ul></li><li><code>%~dp0</code>ï¼šå˜é‡ï¼Œå½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•è·¯å¾„</li><li><code>exit /b</code>: ä½¿ç”¨<code>exit</code>å‘½ä»¤é€€å‡ºè„šæœ¬<ul><li><code>/b</code>å‚æ•°è¡¨ç¤ºç«‹å³é€€å‡ºï¼Œä¸æ‰§è¡Œåç»­çš„å‘½ä»¤</li></ul></li><li>ç›®å½•åˆ‡æ¢<ul><li><code>cd ç›®å½•è·¯å¾„</code>  | <code>cd /d ç›®å½•è·¯å¾„</code></li><li><code>/d</code>ï¼šwindowsç¯å¢ƒä¸èƒ½ç›´æ¥cdåˆ‡æ¢ç›®å½•ï¼Œéœ€è¦åŠ ä¸Šè¯¥å‚æ•°</li></ul></li><li>é‡å®šå‘<ul><li><code>&gt; è¾“å‡ºæ–‡ä»¶è·¯å¾„</code> | <code>&gt;&gt; è¾“å‡ºæ–‡ä»¶è·¯å¾„</code></li><li>åˆ†åˆ«æ˜¯è¦†ç›–å’Œè¿½åŠ </li><li>æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º</li></ul></li><li>æš‚åœæ§åˆ¶å°çš„è¿è¡Œ<ul><li><code>pause</code> å‘½ä»¤</li></ul></li><li>å¤åˆ¶ã€ç§»åŠ¨ã€åˆ é™¤ï¼ˆæ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼‰ç­‰è¯­å¥</li><li>â€¦â€¦</li></ul><h2 id="å®šæ—¶ä»»åŠ¡"><a href="#å®šæ—¶ä»»åŠ¡" class="headerlink" title="å®šæ—¶ä»»åŠ¡"></a>å®šæ—¶ä»»åŠ¡</h2><p>å¼€å¯å®šæ—¶ä»»åŠ¡ï¼š</p><ul><li>åœ¨ç¨‹åºæœç´¢æ ï¼Œè¾“å…¥ï¼šä»»åŠ¡è®¡åˆ’ç¨‹åº<ul><li>å¦‚å›¾æ‰€ç¤ºï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/04/VbSMIrT8iAd3v4o.webp" alt="ä»»åŠ¡è®¡åˆ’ç¨‹åº"></li></ul></li><li>åˆ›å»ºåŸºæœ¬ä»»åŠ¡ï¼ŒæŒ‰ç…§æµç¨‹å®Œæˆ<ul><li>å¦‚ä¸‹å›¾ï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/04/MYU4GdqkK9aJc6F.png" alt="ä»»åŠ¡è®¡åˆ’è¡¨"></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> ææœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¼‚å¸¸å¤„ç†</title>
      <link href="/cn/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"/>
      <url>/cn/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="ç»Ÿä¸€å¼‚å¸¸å¤„ç†"><a href="#ç»Ÿä¸€å¼‚å¸¸å¤„ç†" class="headerlink" title="ç»Ÿä¸€å¼‚å¸¸å¤„ç†"></a>ç»Ÿä¸€å¼‚å¸¸å¤„ç†</h1><ol><li>å‰ç«¯å’Œåç«¯éœ€è¦åšä¸€äº›çº¦å®š<ul><li>é”™è¯¯ä¿¡æ¯ç»Ÿä¸€ä»¥Jsonæ ¼å¼è¿”å›ç»™å‰ç«¯</li><li>ä»¥HTTPçŠ¶æ€ç å†³å®šå½“å‰æ˜¯å¦å‡ºé”™ï¼Œé<code>200</code>çŠ¶æ€ç ä¸ºæ“ä½œå¼‚å¸¸</li><li>å¯¹ä¸åŒçš„å¼‚å¸¸è®¾ç½®ä¸åŒçš„<code>code</code>ç è¿”å›ï¼Œå‰ç«¯æ ¹æ®<code>code</code>ç å“åº”ç»™ç”¨æˆ·å…·ä½“çš„å¼‚å¸¸ä¿¡æ¯</li></ul></li><li>è§„èŒƒå¼‚å¸¸ä¿¡æ¯<ul><li>ä»£ç ä¸­ç»Ÿä¸€æŠ›å‡ºé¡¹ç›®çš„<em>è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹</em>ï¼Œè¿™æ ·å¯ä»¥ç»Ÿä¸€å»æ•è·è¿™ä¸€ç±»æˆ–å‡ ç±»çš„å¼‚å¸¸</li><li>è§„èŒƒäº†å¼‚å¸¸ç±»å‹ï¼Œå°±å¯ä»¥å»è·å–åˆ°è¯¥å¼‚å¸¸ä¿¡æ¯</li><li>å¦‚æœæ•è·äº†éé¡¹ç›®è‡ªå®šä¹‰çš„å¼‚å¸¸ç±»å‹ï¼Œåˆ™ç»Ÿä¸€å‘ç”¨æˆ·æç¤º<code>æ‰§è¡Œè¿‡ç¨‹å¼‚å¸¸ï¼Œè¯·é‡è¯•</code>çš„é”™è¯¯ä¿¡æ¯</li></ul></li></ol><ul><li>æ•è·å¼‚å¸¸<ul><li>ä»£ç ç»Ÿä¸€ä½¿ç”¨try&#x2F;catchæ–¹å¼å»æ•è·ä»£ç æ¯”è¾ƒè‡ƒè‚¿ï¼Œå¯ä»¥é€šè¿‡SpringMVCæä¾›çš„æ§åˆ¶å™¨å¢å¼ºç±»ç»Ÿä¸€å»å®Œæˆå¼‚å¸¸çš„æ•è·</li></ul></li></ul><p>é¦–å…ˆå¼•å…¥ä¸€äº›ç›¸å…³çš„ä¾èµ–ï¼Œæ¯”å¦‚è¯´<code>log4j2</code>å»è®°å½•æ—¥å¿—ï¼Œ<code>spring-web</code>å»ä½¿ç”¨<code>@ControllerAdvice</code>æ³¨è§£ï¼Œé€šè¿‡<code>lombok</code>å»ä½¿ç”¨ä¸€äº›ç®€åŒ–å¼€å‘çš„æ³¨è§£</p><p>ç„¶åå¯ä»¥å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»æˆ–å¸¸é‡ç±»ï¼Œæšä¸¾ä¸€äº›é€šç”¨çš„å¼‚å¸¸ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> é€šç”¨é”™è¯¯ä¿¡æ¯  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ErrorCommon</span> &#123;  </span><br><span class="line">    UNKOWN_ERROR(<span class="string">&quot;æ‰§è¡Œè¿‡ç¨‹å¼‚å¸¸ï¼Œè¯·é‡è¯•&quot;</span>),  </span><br><span class="line">    PARAS_ERROR(<span class="string">&quot;éæ³•å‚æ•°&quot;</span>),  </span><br><span class="line">    OBJECT_NULL(<span class="string">&quot;å¯¹è±¡ä¸ºç©º&quot;</span>),  </span><br><span class="line">    QUERY_NULL(<span class="string">&quot;æŸ¥è¯¢ç»“æœä¸ºç©º&quot;</span>),  </span><br><span class="line">    REQUEST_NULL(<span class="string">&quot;è¯·æ±‚å‚æ•°ä¸ºç©º&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String errMessage;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> errMessage;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ErrorCommon(String errMessage) &#123;  </span><br><span class="line">        <span class="built_in">this</span>.errMessage = errMessage;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> é¡¹ç›®ä¸šåŠ¡å¼‚å¸¸ç±»  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String errMessage;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> errMessage;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(String errMessage)</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>(errMessage);  </span><br><span class="line">        <span class="built_in">this</span>.errMessage = errMessage;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">castError</span><span class="params">(ErrorCommon errorCommon)</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(commonError.getErrMessage());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">castError</span><span class="params">(String errMessage)</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(errMessage);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå¼‚å¸¸å“åº”å¤„ç†ç±»ï¼Œä¸€èˆ¬åç«¯ä¼šæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ç»“æœå“åº”ç±»<code>Result</code>ï¼Œç”¨æ¥å“åº”å¼‚å¸¸ä¿¡æ¯å’Œå¼‚å¸¸<code>code</code>ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * åç«¯ç»Ÿä¸€è¿”å›ç»“æœ  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Integer code; <span class="comment">//ç¼–ç </span></span><br><span class="line">    <span class="keyword">private</span> String msg; <span class="comment">//é”™è¯¯ä¿¡æ¯  </span></span><br><span class="line">    <span class="keyword">private</span> T data; <span class="comment">//æ•°æ®  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;...&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T object)</span> &#123;...&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">error</span><span class="params">(String msg)</span> &#123;...&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ„å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨"><a href="#æ„å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨" class="headerlink" title="æ„å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨"></a>æ„å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨</h1><p>é¦–å…ˆï¼Œåœ¨ä¸šåŠ¡ä¸­ä¸ºäº†æ•è·å¼‚å¸¸ã€å¯¹å¼‚å¸¸è¿›è¡Œç»Ÿä¸€å¤„ç†ã€è®©å¼‚å¸¸èƒ½å¤Ÿå‹å¥½çš„å“åº”ç»™ç”¨æˆ·å’Œè®°å½•ï¼Œæˆ‘ä»¬éƒ½ä¼šè‡ªå»ºä¸€ä¸ª<em>å…¨å±€å¼‚å¸¸å¤„ç†å™¨</em>ã€‚<br>å…¶æ¬¡ï¼ŒJSR303è§„èŒƒçš„<code>Validator</code>å‚æ•°æ ¡éªŒå™¨ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸æ— æ³•ä½¿ç”¨try-catchè¯­å¥ç›´æ¥æ•è·ã€‚</p><p>ä»<code>Spring 3.0</code> - <code>Spring 3.2</code>ç‰ˆæœ¬ä¹‹é—´ï¼Œå¯¹Springæ¶æ„å’ŒSpringMVCçš„Controllerçš„å¼‚å¸¸æ•è·æä¾›äº†ç›¸åº”çš„å¼‚å¸¸å¤„ç†</p><ul><li><code>@ExceptionHandler</code><ul><li><code>Spring3.0</code>æä¾›çš„æ ‡è¯†åœ¨æ–¹æ³•æˆ–ç±»ä¸Šçš„æ³¨è§£</li><li>è¡¨æ˜æ–¹æ³•å¤„ç†çš„å¼‚å¸¸ç±»å‹</li></ul></li><li><code>@ControllerAdvice</code><ul><li><code>Spring3.2</code>æä¾›çš„æ ‡è¯†åœ¨ç±»ä¸Šçš„æ³¨è§£</li><li>å¢å¼ºSpringMVCä¸­çš„Controllerï¼Œé€šå¸¸ä¸<code>@ExceptionHandler</code>ç»“åˆä½¿ç”¨ï¼Œæ¥å¤„ç†SpringMVCçš„å¼‚å¸¸ä¿¡æ¯</li><li>å¯ä»¥æŒ‡å®šæ‹¦æˆªå“ªäº›ç±»å‹çš„æ§åˆ¶å™¨</li></ul></li><li><code>@RestControllerAdvice</code><ul><li>è¯¥æ³¨è§£æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼š<code>@ControllerAdvice</code>+<code>@ResponseBody</code>æ•ˆæœ</li><li>å’Œ<code>@RestController</code>æ³¨è§£å·®ä¸å¤šæ¦‚å¿µ</li></ul></li><li><code>@ResponseStatus</code><ul><li><code>Spring3.0</code>æä¾›çš„æ ‡è¯†åœ¨æ–¹æ³•æˆ–ç±»ä¸Šçš„æ³¨è§£</li><li>è®¾ç½®å“åº”çŠ¶æ€ç </li></ul></li></ul><p>é€šè¿‡ä¸Šé¢çš„æ³¨è§£åŸºæœ¬å®ç°é¡¹ç›®çš„å…¨å±€å¼‚å¸¸å¤„ç†ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> å…¨å±€å¼‚å¸¸å¤„ç†å™¨  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹ä¿¡æ¯</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(ServiceException.class)</span>  </span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span> <span class="comment">// è¯¥å¼‚å¸¸æšä¸¾é”™è¯¯ç ä¸º500ï¼Œ  </span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span><span class="params">(ServiceException exception)</span> &#123; </span><br><span class="line">        log.error(<span class="string">&quot;å¼‚å¸¸ä¿¡æ¯ï¼š&#123;&#125;&quot;</span>, exception.getErrMessage());  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>.error(exception.getErrMessage());  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹sqlå¼‚å¸¸å¤„ç†é’ˆå¯¹æ€§å¤„ç†   </span></span><br><span class="line"><span class="meta">@ExceptionHandler(SQLIntegrityConstraintViolationException.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span> <span class="params">(SQLIntegrityConstraintViolationException ex)</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="comment">//æ’å…¥çš„æŸä¸€å­—æ®µå€¼ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰å·²å­˜åœ¨</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();  </span><br><span class="line">    <span class="comment">//å­—æ®µå±æ€§é‡å¤çš„å¼‚å¸¸å¤„ç†</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†é¡¹ç›®ä¸­æ²¡æœ‰è¢«è®°å½•çš„å¼‚å¸¸ç±»å‹</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span>  </span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span><span class="params">(Exception exception)</span> &#123;  </span><br><span class="line">        log.error(<span class="string">&quot;å¼‚å¸¸ä¿¡æ¯ï¼š&#123;&#125;&quot;</span>, exception.getMessage());  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>.error(exception.getMessage());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œå¯ä»¥æ ¹æ®æ ¡éªŒç»“æœï¼Œä¸»åŠ¨æŠ›å‡ºè‡ªå®šä¹‰çš„å¼‚å¸¸ç±»å¯¹è±¡ï¼ŒæŠ›å‡ºå¼‚å¸¸æ—¶æŒ‡å®šè¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯ï¼Œå¼‚å¸¸å¤„ç†å™¨æ•è·å¼‚å¸¸ä¿¡æ¯è®°å½•ã€å¼‚å¸¸æ—¥å¿—ï¼Œå¹¶å“åº”ç»™ç”¨æˆ·</p><ul><li>å¯ä»¥åœ¨comonåŒ…ä¸­è‡ªå®šä¹‰å¼‚å¸¸ç±»å¯¹è±¡ï¼Œç„¶åç»§æ‰¿<code>ServiceException</code>ç±»å³å¯ï¼Œä¾‹å¦‚ï¼š<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * è´¦å·ä¸å­˜åœ¨å¼‚å¸¸  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountNotFoundException</span> <span class="keyword">extends</span> <span class="title class_">ServiceException</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountNotFoundException</span><span class="params">()</span> &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountNotFoundException</span><span class="params">(String msg)</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>(msg);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å¯¹äºæœªçŸ¥å¼‚å¸¸ï¼šåœ¨æ¥å£æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›è¿è¡Œæ—¶å¼‚å¸¸ä¹Ÿä¼šè¢«å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€æ•è·ï¼Œè®°å½•å¼‚å¸¸æ—¥å¿—ï¼Œç»Ÿä¸€å“åº”ç»™ç”¨æˆ·500é”™è¯¯ï¼Œåœ¨å¼‚å¸¸å¤„ç†å…¶ä¸­è¿˜å¯ä»¥å¯¹æŸä¸ªå¼‚å¸¸ç±»å‹è¿›è¡Œå•ç‹¬å¤„ç†ï¼ˆä¾‹å¦‚ç¤ºä¾‹ä¸­çš„sqlå¼‚å¸¸ï¼‰</p><p>å“åº”ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span>   </span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json  </span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked  </span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">03</span> Feb <span class="number">2023</span> <span class="number">04</span><span class="punctuation">:</span><span class="number">52</span><span class="punctuation">:</span><span class="number">30</span> GMT  </span><br><span class="line">Connection<span class="punctuation">:</span> close  </span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line"><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;500&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼‚å¸¸ä¿¡æ¯&quot;</span><span class="punctuation">,</span> </span><br><span class="line"><span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>...<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ</title>
      <link href="/cn/RabbitMQ/"/>
      <url>/cn/RabbitMQ/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://www.bilibili.com/video/BV1S142197x7?vd_source=7341c7fca3b496e9108bb1fd49c634ef">é…åˆé»‘é©¬çš„å¾®æœåŠ¡è¯¾ç¨‹ä½¿ç”¨</a><br><a href="https://b11et3un53m.feishu.cn/wiki/FYNkwb1i6i0qwCk7lF2caEq5nRe">é»‘é©¬æ–‡æ¡£</a></p></blockquote><h1 id="å‰æ™¯æè¦ï¼Ÿ"><a href="#å‰æ™¯æè¦ï¼Ÿ" class="headerlink" title="å‰æ™¯æè¦ï¼Ÿ"></a>å‰æ™¯æè¦ï¼Ÿ</h1><blockquote><p>RabbitMQæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„å¼‚æ­¥é€šè®¯ç»„ä»¶ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œå®˜ç½‘ï¼š<code>https://www.rabbitmq.com/</code></p></blockquote><p>åŒæ­¥é€šè®¯</p><ul><li>å°±å¦‚åŒæ‰“è§†é¢‘ç”µè¯ï¼ŒåŒæ–¹çš„äº¤äº’éƒ½æ˜¯å®æ—¶çš„ã€‚å› æ­¤åŒä¸€æ—¶åˆ»ä½ åªèƒ½è·Ÿä¸€ä¸ªäººæ‰“è§†é¢‘ç”µè¯</li></ul><p>å¼‚æ­¥é€šè®¯</p><ul><li>å°±åŒå‘å¾®ä¿¡èŠå¤©ï¼ŒåŒæ–¹çš„äº¤äº’ä¸æ˜¯å®æ—¶çš„ï¼Œä½ ä¸éœ€è¦ç«‹åˆ»ç»™å¯¹æ–¹å›åº”ï¼Œå› æ­¤ä½ å¯ä»¥å¤šçº¿æ“ä½œï¼ŒåŒæ—¶è·Ÿå¤šäººèŠå¤©</li></ul><p>ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œå¦‚æœä½ éœ€è¦å®æ—¶é€šä¿¡é‚£ä¹ˆä½¿ç”¨åŒæ­¥è°ƒç”¨ï¼ˆOpenFeignå°±æ˜¯åŒæ­¥è°ƒç”¨ï¼‰ï¼Œå¦‚æœä½ è¿½æ±‚é«˜æ•ˆç‡å’Œå¤šäººé€šè®¯ä¸éœ€è¦å®æ—¶å“åº”ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨å¼‚æ­¥è°ƒç”¨</p><h1 id="åˆè¯†RabbitMQ"><a href="#åˆè¯†RabbitMQ" class="headerlink" title="åˆè¯†RabbitMQ"></a>åˆè¯†RabbitMQ</h1><h2 id="åŒæ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹"><a href="#åŒæ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹" class="headerlink" title="åŒæ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹"></a>åŒæ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹</h2><p>ä»¥é»‘é©¬å•†åŸçš„ç”¨æˆ·ä½™é¢æ”¯ä»˜ä¸ºä¾‹ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/TJf872VqjElgHBS.png" alt="ç”¨æˆ·ä½™é¢æ”¯ä»˜"></p><ul><li>ä»æ”¯ä»˜æœåŠ¡åˆ°ç”¨æˆ·æœåŠ¡æ˜¯ä¸€ä¸ªç­‰å¾…è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆæ”¯ä»˜æ‰èƒ½ä¿®æ”¹æ”¯ä»˜çŠ¶æ€ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªåŒæ­¥è°ƒç”¨</li><li>å¯æ˜¯åç»­çš„äº¤æ˜“ã€çŸ­ä¿¡ã€ç§¯åˆ†æœåŠ¡å’Œæ”¯ä»˜ä¹‹é—´ä¸éœ€è¦ç­‰å¾…è¿‡ç¨‹ï¼Œå¦‚æœè¿˜æ˜¯åŒæ­¥è°ƒç”¨ä¼šé€ æˆä¸€äº›é—®é¢˜ï¼š<ul><li>æ‰©å±•æ€§å·®</li><li>æ€§èƒ½ä¸‹é™ï¼ŒåŒæ­¥è°ƒç”¨éƒ½æ˜¯éœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªæœåŠ¡å®Œæˆ</li><li>çº§è”æ€§é—®é¢˜ï¼Œäº¤æ˜“æœåŠ¡å¤±è´¥å¯¹æ”¯ä»˜æœåŠ¡å’Œå…¶ä»–æœåŠ¡çš„å½±å“</li></ul></li></ul><p>åŒæ­¥è°ƒç”¨çš„ä¼˜åŠ¿æ˜¯æ—¶æ•ˆæ€§å¼ºï¼Œç­‰å¾…åˆ°ç»“æœåæ‰è¿”å›</p><h2 id="å¼‚æ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹"><a href="#å¼‚æ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹" class="headerlink" title="å¼‚æ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹"></a>å¼‚æ­¥è°ƒç”¨ä¼˜ç¼ºç‚¹</h2><p>åŒæ­¥è°ƒç”¨ä¸»è¦æœ‰2ä¸ªè§’è‰²;</p><ul><li>æœåŠ¡è°ƒç”¨è€…</li><li>æœåŠ¡æä¾›è€…</li></ul><p>å¼‚æ­¥è°ƒç”¨ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼š</p><ul><li>æ¶ˆæ¯å‘é€è€…ï¼šæŠ•é€’æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„æœåŠ¡è°ƒç”¨è€…</li><li>æ¶ˆæ¯æ¥æ”¶è€…ï¼šæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„æœåŠ¡æä¾›è€…</li><li>æ¶ˆæ¯ä»£ç†ï¼šç®¡ç†ã€æš‚å­˜ã€è½¬å‘æ¶ˆæ¯ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆå¾®ä¿¡æœåŠ¡å™¨</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/HE4CoJBw3AmOQ71.png" alt="å¼‚æ­¥è°ƒç”¨"></p><p>ä¸¾ä¸ªä¾‹å­ï¼šå¤–å–å‘˜ï¼Œå¤–å–æŸœï¼Œå®¢äººåˆ†åˆ«å¯¹åº”ä¸Šé¢ä¸‰ä¸ªè§’è‰²ï¼›å¦‚æœæ˜¯åŒæ­¥ï¼Œå¤–å–å‘˜éœ€è¦æŠŠå¤–å–äº¤ç»™å®¢äººä¹‹åæ‰èƒ½ç»§ç»­é€ä¸‹ä¸€å•å¤–å–ï¼Œå¦‚æœå®¢æˆ·ä¸´æ—¶æœ‰äº‹æ— æ³•å»æ‹¿å¤–å–ï¼Œé‚£ä¹ˆå¤–å–å‘˜å°±ä¼šä¸€ç›´ç­‰å¾…å®¢æˆ·ï¼›å¯æœ‰äº†å¤–å–æŸœï¼Œå¤–å–å‘˜å¯ä»¥æŠŠè¯¥ç”¨æˆ·çš„å¤–å–æ”¾åˆ°å¤–å–æŸœé‡Œï¼Œç„¶åç»™å®¢äººå‘ä¸€ä¸ªå¼€æŸœç å°±å¯ä»¥ç»§ç»­é€ä¸‹ä¸€å•å¤–å–</p><p>åŒæ ·é»‘é©¬å•†åŸçš„ç”¨æˆ·ä½™é¢æ”¯ä»˜ä¸ºä¾‹ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/3HuQlFkwLr2i8DG.png" alt="ç”¨æˆ·ä½™é¢æ”¯ä»˜"></p><ul><li>æ”¯ä»˜æœåŠ¡ä¸å†åŒæ­¥è°ƒç”¨ä¸šåŠ¡å…³è”åº¦ä½çš„æœåŠ¡ï¼Œè€Œæ˜¯å‘é€æ¶ˆæ¯é€šçŸ¥åˆ°Broker(æ¶ˆæ¯ä»£ç†)ï¼Œå…¶ä»–æœåŠ¡ç›‘å¬brokerå³å¯ï¼Œè¿™æ ·å…·å¤‡ä¸‹åˆ—ä¼˜åŠ¿ï¼š<ul><li>è§£é™¤æ”¯ä»˜æœåŠ¡ä¸çŸ­ä¿¡ç­‰æœåŠ¡è€¦åˆï¼Œæ‹“å±•æ€§å¼º</li><li>æ— éœ€ç­‰å¾…ï¼Œæ”¯ä»˜æœåŠ¡åœ¨ä¿®æ”¹å®Œè®¢å•çŠ¶æ€åç›´æ¥è¿”å›ä¿¡æ¯ç»™ç”¨æˆ·ï¼Œæ€§èƒ½å¥½</li><li>æ•…éšœéš”ç¦»ï¼Œä¸‹æ¸¸æœåŠ¡æ•…éšœä¸å½±å“ä¸Šæ¸¸ä¸šåŠ¡</li><li>ç¼“å­˜æ¶ˆæ¯ï¼Œæµé‡å‰Šå³°å¡«è°·<ul><li>å½“QPSè¾ƒé«˜æ—¶ï¼Œå¯ä»¥é€šè¿‡æ¶ˆæ¯ç»„ä»¶æ¥å¹³è¡¡</li></ul></li></ul></li><li>ä¸è¿‡å¼‚æ­¥è°ƒç”¨ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜<ul><li>ä¸èƒ½ç«‹å³å¾—åˆ°è°ƒç”¨ç»“æœï¼Œæ—¶æ•ˆæ€§å·®</li><li>ä¸ç¡®å®šä¸‹æ¸¸ä¸šåŠ¡æ‰§è¡Œæ˜¯å¦æˆåŠŸ</li><li>ä¸šåŠ¡å®‰å…¨ä¾èµ–äºBrokerçš„å¯é æ€§</li></ul></li></ul><h2 id="MQæŠ€æœ¯é€‰å‹"><a href="#MQæŠ€æœ¯é€‰å‹" class="headerlink" title="MQæŠ€æœ¯é€‰å‹"></a>MQæŠ€æœ¯é€‰å‹</h2><p>MQï¼ˆMessageQueueï¼‰ï¼Œä¸­æ–‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­—é¢æ¥çœ‹å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚ä¹Ÿå°±æ˜¯å¼‚æ­¥è°ƒç”¨ä¸­çš„Broker</p><p>å¸‚é¢ä¸Šå¸¸è§çš„å‡ æ¬¾æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/Gz3Aetn24mkhpcy.png" alt="å¯¹æ¯”å›¾"></p><h1 id="RabbitMQå…¥é—¨"><a href="#RabbitMQå…¥é—¨" class="headerlink" title="RabbitMQå…¥é—¨"></a>RabbitMQå…¥é—¨</h1><h2 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h2><p>åŸºäºdockerå®‰è£…éƒ¨ç½²</p><ul><li>æ‹‰å–é•œåƒï¼š rabbitmq:3.8-management</li><li>éƒ¨ç½²</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> -e RABBITMQ_DEFAULT_USER=itheima \</span><br><span class="line"> -e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class="line"> -v mq-plugins:/plugins \</span><br><span class="line"> --name mq \</span><br><span class="line"> --hostname mq \</span><br><span class="line"> -p 15672:15672 \</span><br><span class="line"> -p 5672:5672 \</span><br><span class="line"> --network heima \</span><br><span class="line"> -d \</span><br><span class="line"> rabbitmq:3.8-management</span><br></pre></td></tr></table></figure><ul><li>15672ï¼šRabbitMQæä¾›çš„ç®¡ç†æ§åˆ¶å°çš„ç«¯å£</li><li>5672ï¼šRabbitMQçš„æ¶ˆæ¯å‘é€å¤„ç†æ¥å£</li><li>è®¿é—®:<code>è™šæ‹ŸæœºIP:15672</code>å³å¯çœ‹åˆ°ç®¡ç†æ§åˆ¶å°</li></ul><p>RabbitMOå¯¹åº”çš„æ¶æ„å¦‚å›¾ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/BroGIjtT8xdvE2s.png" alt="MQæ¶æ„å›¾"></p><p>å…¶ä¸­åŒ…å«å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li><code>publisher</code>ï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯å‘é€æ¶ˆæ¯çš„ä¸€æ–¹</li><li><code>consumer</code>ï¼šæ¶ˆè´¹è€…ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„ä¸€æ–¹</li><li><code>queue</code>ï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯ã€‚ç”Ÿäº§è€…æŠ•é€’çš„æ¶ˆæ¯ä¼šæš‚å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ¶ˆè´¹è€…å¤„ç†</li><li><code>exchange</code>ï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±ã€‚ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ç”±äº¤æ¢æœºå†³å®šæŠ•é€’åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</li><li><code>virtual host</code>ï¼šè™šæ‹Ÿä¸»æœºï¼Œèµ·åˆ°æ•°æ®éš”ç¦»çš„ä½œç”¨ã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºç›¸äº’ç‹¬ç«‹ï¼Œæœ‰å„è‡ªçš„exchangeã€queueï¼Œäº’ä¸å½±å“ï¼›ä¸åŒçš„ä¸šåŠ¡ã€é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸åŒçš„è™šæ‹Ÿä¸»æœº</li></ul><h2 id="æ–°å»ºé˜Ÿåˆ—ã€ç»‘å®šäº¤æ¢æœº"><a href="#æ–°å»ºé˜Ÿåˆ—ã€ç»‘å®šäº¤æ¢æœº" class="headerlink" title="æ–°å»ºé˜Ÿåˆ—ã€ç»‘å®šäº¤æ¢æœº"></a>æ–°å»ºé˜Ÿåˆ—ã€ç»‘å®šäº¤æ¢æœº</h2><p>éœ€æ±‚ï¼šåœ¨RabbitMQçš„æ§åˆ¶å°å®Œæˆä¸‹åˆ—æ“ä½œ</p><ul><li>æ–°å»ºé˜Ÿåˆ—hello.queue1å’Œhello.queue2<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/JckXmN9d2zae3Tn.png" alt="æ·»åŠ é˜Ÿåˆ—"></li></ul></li><li>å‘é»˜è®¤çš„amp.fanoutäº¤æ¢æœºå‘é€ä¸€æ¡æ¶ˆæ¯<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/PCAhdBkWyIK5JnF.png" alt="å‘æ¶ˆæ¯"></li></ul></li><li>æŸ¥çœ‹æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾hello.queue1å’Œhello.queue2<ul><li>æ²¡æœ‰ä»»ä½•æ¶ˆæ¯åˆ°è¾¾2ä¸ªé˜Ÿåˆ—ä¸­</li></ul></li></ul><p>åˆ†æåŸå› </p><ul><li>é¦–å…ˆï¼Œäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±ï¼Œæ²¡æœ‰å­˜å‚¨åŠŸèƒ½</li><li>å…¶æ¬¡ï¼Œè¿™é‡Œä¹Ÿæ²¡æœ‰è®¾ç½®äº¤æ¢æœºå’Œé˜Ÿåˆ—ä¹‹é—´è·¯ç”±ï¼Œäº¤æ¢æœºéœ€è¦ç»‘å®šé˜Ÿåˆ—</li></ul><p>æ·»åŠ ç»‘å®šå…³ç³»</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/27/9CNUVK68fLo4zub.png" alt="Bindings"></p><h2 id="æ•°æ®éš”ç¦»"><a href="#æ•°æ®éš”ç¦»" class="headerlink" title="æ•°æ®éš”ç¦»"></a>æ•°æ®éš”ç¦»</h2><p>éœ€æ±‚ï¼šåœ¨RabbitMQçš„æ§åˆ¶å°å®Œæˆä¸‹åˆ—æ“ä½œ</p><ul><li>æ–°å»ºä¸€ä¸ªç”¨æˆ·hmall<ul><li>åœ¨<code>admin</code>æ¨¡å—å¯¹åº”å¤„ï¼Œæ·»åŠ ç”¨æˆ·hmall</li></ul></li><li>ä¸ºhmallç”¨æˆ·åˆ›å»ºä¸€ä¸ªvirtual host<ul><li>é€€å‡ºï¼Œä½¿ç”¨hmallç”¨æˆ·ç™»å½•ï¼Œåœ¨<code>admin</code>æ¨¡å—çš„<code>virtual host</code>åŠŸèƒ½ä¸­å¸¸è§è™šæ‹Ÿä¸»æœº&#x2F;hmall</li></ul></li><li>æµ‹è¯•ä¸åŒvirtual hostä¹‹é—´çš„æ•°æ®éš”ç¦»ç°è±¡<ul><li>ä¸åŒçš„è™šæ‹Ÿä¸»æœºï¼Œæ— æ³•è®¿é—®å…¶å¯¹åº”çš„é˜Ÿåˆ—</li></ul></li></ul><h2 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h2><h3 id="ä½•ä¸ºSpringAMQP"><a href="#ä½•ä¸ºSpringAMQP" class="headerlink" title="ä½•ä¸ºSpringAMQP?"></a>ä½•ä¸ºSpringAMQP?</h3><p>ç”±äº<code>RabbitMQ</code>é‡‡ç”¨äº†AMQPåè®®ï¼Œå› æ­¤å®ƒå…·å¤‡è·¨è¯­è¨€çš„ç‰¹æ€§ã€‚ä»»ä½•è¯­è¨€åªè¦éµå¾ªAMQPåè®®æ”¶å‘æ¶ˆæ¯ï¼Œéƒ½å¯ä»¥ä¸<code>RabbitMQ</code>äº¤äº’ã€‚å¹¶ä¸”<code>RabbitMQ</code>å®˜æ–¹ä¹Ÿæä¾›äº†å„ç§ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯</p><p>ä½†æ˜¯ï¼ŒRabbitMQå®˜æ–¹æä¾›çš„Javaå®¢æˆ·ç«¯ç¼–ç ç›¸å¯¹å¤æ‚ï¼Œä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸‹æˆ‘ä»¬æ›´å¤šä¼šç»“åˆSpringæ¥ä½¿ç”¨ã€‚è€ŒSpringçš„å®˜æ–¹åˆšå¥½åŸºäºRabbitMQæä¾›äº†è¿™æ ·ä¸€å¥—&#x3D;&#x3D;æ¶ˆæ¯æ”¶å‘çš„æ¨¡æ¿å·¥å…·&#x3D;&#x3D;ï¼šSpringAMQPã€‚å¹¶ä¸”è¿˜åŸºäºSpringBootå¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…</p><ul><li>SpringAMQPå®˜æ–¹æ–‡æ¡£ï¼š<code>https://spring.io/projects/spring-amqp</code></li></ul><p>SpringAMQPæä¾›äº†ä¸‰ä¸ªåŠŸèƒ½:</p><ul><li>è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»</li><li>åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯</li><li>å°è£…äº†RabbitTemplateå·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯</li></ul><h3 id="å¯¼å…¥Demoå·¥ç¨‹"><a href="#å¯¼å…¥Demoå·¥ç¨‹" class="headerlink" title="å¯¼å…¥Demoå·¥ç¨‹"></a>å¯¼å…¥Demoå·¥ç¨‹</h3><p>å¯¼å…¥é»‘é©¬èµ„æ–™çš„Demoå·¥ç¨‹</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/BGfse9xiHQKpzrW.png" alt="demo"></p><p>åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š</p><ul><li>mq-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†é¡¹ç›®ä¾èµ–</li><li>publisherï¼šæ¶ˆæ¯çš„å‘é€è€…</li><li>consumerï¼šæ¶ˆæ¯çš„æ¶ˆè´¹è€…</li></ul><p>AMQPä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h3><p>é¦–å…ˆåœ¨RabbitMQæ§åˆ¶å°æ–°å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼šsimple.queue</p><p>å…¶æ¬¡åœ¨<code>publisher</code>æœåŠ¡çš„<code>application.yml</code>ä¸­æ·»åŠ é…ç½®</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">rabbitmq:</span>  </span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span> <span class="comment"># ä½ çš„è™šæ‹ŸæœºIP  </span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># ç«¯å£  </span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span> <span class="comment"># è™šæ‹Ÿä¸»æœº  </span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itheima</span> <span class="comment"># ç”¨æˆ·å  </span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span> <span class="comment"># å¯†ç </span></span><br></pre></td></tr></table></figure><p>æœ€åï¼Œç¼–å†™ä¸€æ®µæµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAmqpTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—åç§°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, spring amqp!&quot;</span>;</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>RabbitTemplate rabbitTemplate;</code>è¿™å°±æ˜¯MQçš„æ¶ˆæ¯å‘é€å·¥å…·</li></ul><p>æ‰“å¼€æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ¶ˆæ¯æ˜¯å¦æˆåŠŸå‘é€</p><h3 id="æ¶ˆæ¯æ¥æ”¶"><a href="#æ¶ˆæ¯æ¥æ”¶" class="headerlink" title="æ¶ˆæ¯æ¥æ”¶"></a>æ¶ˆæ¯æ¥æ”¶</h3><p>é¦–å…ˆåœ¨<code>consumer</code>æœåŠ¡çš„<code>application.yml</code>ä¸­æ·»åŠ é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span> <span class="comment"># ä½ çš„è™šæ‹ŸæœºIP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># ç«¯å£</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span> <span class="comment"># è™šæ‹Ÿä¸»æœº</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itheima</span> <span class="comment"># ç”¨æˆ·å</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span> <span class="comment"># å¯†ç </span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>consumer</code>æœåŠ¡çš„<code>com.itheima.consumer.listener</code>åŒ…ä¸­æ–°å»ºä¸€ä¸ªç±»<code>SpringRabbitListener</code>æ¶ˆæ¯ç›‘å¬å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringRabbitListener</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ©ç”¨RabbitListeneræ¥å£°æ˜è¦ç›‘å¬çš„é˜Ÿåˆ—ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// å°†æ¥ä¸€æ—¦ç›‘å¬çš„é˜Ÿåˆ—ä¸­æœ‰äº†æ¶ˆæ¯ï¼Œå°±ä¼šæ¨é€ç»™å½“å‰æœåŠ¡ï¼Œè°ƒç”¨å½“å‰æ–¹æ³•ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</span></span><br><span class="line">    <span class="comment">// å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­æ¥æ”¶çš„å°±æ˜¯æ¶ˆæ¯ä½“çš„å†…å®¹</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span>  </span><br><span class="line">InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨consumeræœåŠ¡ï¼Œç„¶ååœ¨publisheræœåŠ¡ä¸­è¿è¡Œæµ‹è¯•ä»£ç ï¼Œå‘é€MQæ¶ˆæ¯ã€‚é€šè¿‡æŸ¥çœ‹consumeræœåŠ¡çš„æ§åˆ¶å°ï¼Œæ£€éªŒæ¶ˆæ¯æ˜¯å¦è¾“å‡ºï¼›</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/jKfspnTitZmlY78.png" alt="æ¶ˆæ¯"></p><h3 id="WorkQueuesæ¨¡å‹"><a href="#WorkQueuesæ¨¡å‹" class="headerlink" title="WorkQueuesæ¨¡å‹"></a>WorkQueuesæ¨¡å‹</h3><p>Work queuesï¼Œä»»åŠ¡æ¨¡å‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯<em><strong>è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</strong></em></p><p>ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨work queuesï¼Ÿ</p><ul><li>å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦</li></ul><p>ä½¿ç”¨work queuesçš„å¥½å¤„</p><ul><li>å¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜</li></ul><p><strong>åœºæ™¯æ¨¡æ‹Ÿï¼š</strong></p><p>é¦–å…ˆï¼Œåœ¨æ§åˆ¶å°åˆ›å»ºä¸€ä¸ªæ–°çš„é˜Ÿåˆ—ï¼Œå‘½åä¸º<code>work.queue</code></p><p>å…¶æ¬¡ï¼Œåœ¨publisheræœåŠ¡ä¸­çš„SpringAmqpTestç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œæ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * workQueue</span></span><br><span class="line"><span class="comment">     * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWorkQueue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;work.queue&quot;</span>;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, message_&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œæ¯20æ¯«ç§’å‘é€ä¸€æ¬¡ï¼Œç›¸å½“äºæ¯ç§’å‘é€50æ¡æ¶ˆæ¯</span></span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message + i);</span><br><span class="line">        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼Œæ¨¡æ‹Ÿæ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;work.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenWorkQueue1</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span> + LocalTime.now());</span><br><span class="line">    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;work.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenWorkQueue2</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span> + LocalTime.now());</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¨¡æ‹Ÿä»»åŠ¡è€—æ—¶ï¼š<ul><li>æ¶ˆè´¹è€…1 sleepäº†20æ¯«ç§’ï¼Œç›¸å½“äºæ¯ç§’é’Ÿå¤„ç†50ä¸ªæ¶ˆæ¯</li><li>æ¶ˆè´¹è€…2 sleepäº†200æ¯«ç§’ï¼Œç›¸å½“äºæ¯ç§’å¤„ç†5ä¸ªæ¶ˆæ¯</li></ul></li></ul><p>æœ€åï¼Œå¯åŠ¨ConsumerApplicationåï¼Œæ‰§è¡ŒpublisheræœåŠ¡ç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³•<code>testWorkQueue()</code></p><p>ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_0ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">58.998</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_1ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.010</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_2ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.045</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_4ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.101</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_6ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.163</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_3ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.222</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_8ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.224</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_10ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.284</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_12ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.346</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_14ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.408</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_5ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.435</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_16ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.466</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_18ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.529</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_20ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.589</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_7ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.647</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_22ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.649</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_24ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.711</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_26ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.773</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_28ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.835</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_9ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.849</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_30ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.897</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_32ã€‘<span class="number">18</span>:<span class="number">34</span>:<span class="number">59.957</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_34ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.020</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_11ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.063</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_36ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.079</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_38ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.141</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_40ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.203</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_42ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.263</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_13ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.277</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_44ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.322</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_46ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.383</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_48ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.445</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_15ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.489</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_17ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.704</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_19ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">00.915</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_21ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">01.129</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_23ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">01.342</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_25ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">01.554</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_27ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">01.769</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_29ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">01.981</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_31ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">02.196</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_33ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">02.411</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_35ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">02.624</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_37ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">02.837</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_39ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">03.038</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_41ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">03.252</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_43ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">03.467</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_45ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">03.681</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_47ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">03.891</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_49ã€‘<span class="number">18</span>:<span class="number">35</span>:<span class="number">04.105</span></span><br></pre></td></tr></table></figure><ul><li>ä»ç»“æœå¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…å„å¤„ç†äº†25æ¡æ¶ˆæ¯</li><li>å› ä¸º<code>Sleep</code>çš„åŸå› ï¼Œæ¶ˆè´¹è€…1æ¯”æ¶ˆè´¹è€…2å…ˆå¤„ç†å®Œ</li></ul><p>ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯<em><strong>å¹³å‡åˆ†é…</strong></em>ç»™æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚å¯¼è‡´1ä¸ªæ¶ˆè´¹è€…ç©ºé—²ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹è€…å¿™çš„ä¸å¯å¼€äº¤ã€‚æ²¡æœ‰å……åˆ†åˆ©ç”¨æ¯ä¸€ä¸ªæ¶ˆè´¹è€…çš„èƒ½åŠ›ï¼Œæœ€ç»ˆæ¶ˆæ¯å¤„ç†çš„è€—æ—¶è¿œè¿œè¶…è¿‡äº†1ç§’</p><h4 id="èƒ½è€…å¤šåŠ³"><a href="#èƒ½è€…å¤šåŠ³" class="headerlink" title="èƒ½è€…å¤šåŠ³"></a>èƒ½è€…å¤šåŠ³</h4><p>åœ¨springä¸­æœ‰ä¸€ä¸ªç®€å•çš„é…ç½®ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ é…ç½®</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯,å¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯,æ‰€ä»¥å¤„ç†èƒ½åŠ›è¶Šå¼ºï¼Œå¤„ç†çš„æ¶ˆæ¯è¶Šå¤š</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡æµ‹è¯•ï¼Œç»“æœä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_0ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.801</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_1ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.815</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_2ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.844</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_3ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.875</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_4ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.905</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_5ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.936</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_6ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.966</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_7ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">46.997</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_8ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.028</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_9ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.058</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_10ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.088</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_11ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.119</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_12ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.150</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_13ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.181</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_14ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.210</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_15ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.241</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_16ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.272</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_17ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.302</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_18ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.333</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_19ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.364</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_20ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.393</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_21ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.423</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_22ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.451</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_23ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.484</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_24ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.515</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_25ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.546</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_26ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.576</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_27ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.607</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_28ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.637</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_29ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.669</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_30ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.699</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_31ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.729</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_32ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.760</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_33ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.791</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_34ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.820</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_35ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.850</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_36ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.880</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_37ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.913</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_38ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.942</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_39ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">47.973</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_40ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.005</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_41ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.036</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_42ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.065</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_43ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.096</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_44ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.126</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_45ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.157</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_46ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.187</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_47ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.218</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_48ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.248</span></span><br><span class="line">æ¶ˆè´¹è€…<span class="number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_49ã€‘<span class="number">19</span>:<span class="number">42</span>:<span class="number">48.279</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥å‘ç°ï¼Œç”±äºæ¶ˆè´¹è€…1å¤„ç†é€Ÿåº¦è¾ƒå¿«ï¼Œæ‰€ä»¥å¤„ç†äº†æ›´å¤šçš„æ¶ˆæ¯ï¼›æ¶ˆè´¹è€…2å¤„ç†é€Ÿåº¦è¾ƒæ…¢ï¼Œåªå¤„ç†äº†7æ¡æ¶ˆæ¯ã€‚è€Œæœ€ç»ˆæ€»çš„æ‰§è¡Œè€—æ—¶ä¹Ÿåœ¨1ç§’å·¦å³ï¼Œå¤§å¤§æå‡</li><li>æ­£æ‰€è°“èƒ½è€…å¤šåŠ³ï¼Œè¿™æ ·å……åˆ†åˆ©ç”¨äº†æ¯ä¸€ä¸ªæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…æ¶ˆæ¯ç§¯å‹é—®é¢˜</li></ul><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>WorkQueueæ¨¡å‹çš„ä½¿ç”¨ï¼š</p><ul><li>å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†</li><li>é€šè¿‡è®¾ç½®prefetchæ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡ï¼Œæœ€å¤§åŒ–åˆ©ç”¨æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›æˆ‘ï¼Œé˜²æ­¢æ¶ˆæ¯æŒ¤å‹</li></ul><h3 id="äº¤æ¢æœºç±»å‹"><a href="#äº¤æ¢æœºç±»å‹" class="headerlink" title="äº¤æ¢æœºç±»å‹"></a>äº¤æ¢æœºç±»å‹</h3><p>åœ¨ä¸Šé¢çš„ä¸¤ä¸ªæµ‹è¯•æ¡ˆä¾‹ä¸­ï¼Œéƒ½æ²¡æœ‰äº¤æ¢æœºå‚ä¸ï¼Œç”Ÿäº§è€…ç›´æ¥å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ã€‚è€Œä¸€æ—¦å¼•å…¥äº¤æ¢æœºï¼Œæ¶ˆæ¯å‘é€çš„æ¨¡å¼ä¼šæœ‰å¾ˆå¤§å˜åŒ–ï¼š</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/cX2zpfqt6duT7el.png" alt="äº¤æ¢æœº"></li></ul><p>åœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ªExchangeè§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–ï¼š</p><ul><li><strong>Publisher</strong>ï¼šç”Ÿäº§è€…ï¼Œä¸å†å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯å‘ç»™äº¤æ¢æœº</li><li><strong>Exchange</strong>ï¼šäº¤æ¢æœºï¼Œä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ã€‚å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äºExchangeçš„ç±»å‹</li><li><strong>Queue</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯ã€‚ä¸è¿‡é˜Ÿåˆ—ä¸€å®šè¦ä¸äº¤æ¢æœºç»‘å®š</li><li><strong>Consumer</strong>ï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ–</li></ul><p>Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸Exchangeç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼</p><p><em><strong>äº¤æ¢æœºçš„ç±»å‹</strong></em>æœ‰å››ç§</p><ol><li><strong>Fanout</strong>ï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šè¯¥äº¤æ¢æœºçš„é˜Ÿåˆ—</li><li><strong>Direct</strong>ï¼šè®¢é˜…ï¼ŒåŸºäºRoutingKeyï¼ˆè·¯ç”±keyï¼‰å‘é€ç»™è®¢é˜…äº†æ¶ˆæ¯çš„é˜Ÿåˆ—</li><li><strong>Topic</strong>ï¼šé€šé…ç¬¦è®¢é˜…ï¼Œä¸Directç±»ä¼¼ï¼Œåªä¸è¿‡RoutingKeyå¯ä»¥ä½¿ç”¨é€šé…ç¬¦</li><li><strong>Headers</strong>å¤´åŒ¹é…ï¼ŒåŸºäºMQçš„æ¶ˆæ¯å¤´åŒ¹é…ï¼Œä½¿ç”¨è¾ƒå°‘</li></ol><h3 id="Fanoutäº¤æ¢æœº"><a href="#Fanoutäº¤æ¢æœº" class="headerlink" title="Fanoutäº¤æ¢æœº"></a>Fanoutäº¤æ¢æœº</h3><p><strong>ä»‹ç»ï¼š</strong><br>Fanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œæˆ‘è§‰å¾—åœ¨MQä¸­å«å¹¿æ’­(å…¬å‘Š)æ›´åˆé€‚</p><p>åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/RLlBEJvY4eyIwMX.png" alt="å¹¿æ’­æ¨¡å¼"></li></ul><ol><li>å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ—</li><li>æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ°Exchangeï¼ˆäº¤æ¢æœºï¼‰</li><li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœº</li><li>äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—</li><li>è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…èƒ½æ‹¿åˆ°æ¶ˆæ¯</li></ol><p><strong>æµ‹è¯•ï¼š</strong></p><ol><li><p>åˆ›å»ºä¸€ä¸ªåä¸º <code>hmall.fanout</code>çš„äº¤æ¢æœºï¼Œç±»å‹æ˜¯<code>Fanout</code></p></li><li><p>åˆ›å»ºä¸¤ä¸ªé˜Ÿåˆ—<code>fanout.queue1</code>å’Œ<code>fanout.queue2</code>ï¼Œç»‘å®šåˆ°äº¤æ¢æœº<code>hmall.fanout</code></p></li><li><p>å‘é€æ¶ˆæ¯</p><ol><li>åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// äº¤æ¢æœºåç§°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.fanout&quot;</span>;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, everyone!&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>æ¥å—æ¶ˆæ¯</p><ol><li>åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ ä¸¤ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°Fanoutæ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°Fanoutæ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ol><p>ç”±ç»“æœå¯çŸ¥ï¼Œæ¶ˆè´¹è€…1ã€2éƒ½æ”¶åˆ°äº†åŒæ ·çš„æ¶ˆæ¯</p><p><strong>æ€»ç»“ï¼š</strong><br>äº¤æ¢æœºçš„ä½œç”¨æ˜¯ï¼š</p><ul><li>æ¥æ”¶publisherå‘é€çš„æ¶ˆæ¯</li><li>å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—</li><li>ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±</li><li>FanoutExchangeçš„ä¼šå°†æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—</li></ul><h3 id="Directäº¤æ¢æœº"><a href="#Directäº¤æ¢æœº" class="headerlink" title="Directäº¤æ¢æœº"></a>Directäº¤æ¢æœº</h3><p><strong>ä»‹ç»ï¼š</strong><br>åœ¨Fanoutæ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ°Directç±»å‹çš„Exchange</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/it3oSIpsCh2mVTY.png" alt="DirectExchange"></li></ul><p>åœ¨Directæ¨¡å‹ä¸‹ï¼š</p><ul><li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª<code>Routing Key</code>ï¼ˆè·¯ç”±keyï¼‰</li><li>ç”Ÿäº§è€…åœ¨å‘Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ <code>Routing Key</code></li><li>Exchangeæ ¹æ®æ¶ˆæ¯çš„<code>Routing Key</code>è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„<code>Routing key</code>ä¸æ¶ˆæ¯çš„ <code>Routing key</code>å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯</li></ul><p><strong>æµ‹è¯•ï¼š</strong></p><ol><li><p>å£°æ˜ä¸€ä¸ªåä¸º<code>hmall.direct</code>çš„äº¤æ¢æœº</p></li><li><p>å£°æ˜é˜Ÿåˆ—<code>direct.queue1</code>ï¼Œç»‘å®š<code>hmall.direct</code>ï¼Œ<code>binding Key</code>ä¸º<code>blud</code>å’Œ<code>red</code></p></li><li><p>å£°æ˜é˜Ÿåˆ—<code>direct.queue2</code>ï¼Œç»‘å®š<code>hmall.direct</code>ï¼Œ<code>binding Key</code>ä¸º<code>yellow</code>å’Œ<code>red</code></p></li><li><p>åœ¨<code>consumer</code>æœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬direct.queue1å’Œdirect.queue2</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨publisherä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘<code>hmall.direct</code>å‘é€æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDirectExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// äº¤æ¢æœºåç§°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.direct&quot;</span>;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;çº¢è‰²è­¦æŠ¥ï¼æ—¥æœ¬ä¹±æ’æ ¸åºŸæ°´ï¼Œå¯¼è‡´æµ·æ´‹ç”Ÿç‰©å˜å¼‚ï¼ŒæƒŠç°å“¥æ–¯æ‹‰ï¼&quot;</span>;</span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;red&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>ç»“æœ</p><ul><li>å½“ä½¿ç”¨è·¯ç”±ä¸ºredè¿™ä¸ªkeyæ—¶ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°äº†æ¶ˆæ¯</li><li>åˆ‡æ¢ä¸ºbludï¼Œåªæœ‰æ¶ˆè´¹è€…1å¤„ç†äº†æ¶ˆæ¯</li><li>åˆ‡æ¢ä¸ºyeallowï¼Œåªæœ‰æ¶ˆè´¹è€…2å¤„ç†äº†æ¶ˆæ¯</li><li><strong>æ€»ç»“ï¼š</strong><br>Directäº¤æ¢æœºä¸Fanoutäº¤æ¢æœºçš„å·®å¼‚</li><li>Fanoutäº¤æ¢æœºå°†æ¶ˆæ¯è·¯ç”±ç»™æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—</li><li>Directäº¤æ¢æœºæ ¹æ®RoutingKeyåˆ¤æ–­è·¯ç”±ç»™å“ªä¸ªé˜Ÿåˆ—</li><li>å¦‚æœå¤šä¸ªé˜Ÿåˆ—å…·æœ‰ç›¸åŒçš„RoutingKeyï¼Œåˆ™ä¸FanoutåŠŸèƒ½ç±»ä¼¼</li></ul><h3 id="Topicäº¤æ¢æœº"><a href="#Topicäº¤æ¢æœº" class="headerlink" title="Topicäº¤æ¢æœº"></a>Topicäº¤æ¢æœº</h3><p><strong>ä»‹ç»ï¼š</strong><br><code>Topic</code>ç±»å‹çš„<code>Exchange</code>ä¸<code>Direct</code>ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®<code>Routing Key</code>æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåªä¸è¿‡<code>Topic</code>ç±»å‹<code>Exchange</code>å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š<code>Binding Key</code> çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼</p><p><code>Binding Key</code> ä¸€èˆ¬éƒ½æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥<code>.</code>åˆ†å‰²ï¼Œä¾‹å¦‚ï¼š <code>item.insert</code></p><p>é€šé…ç¬¦è§„åˆ™</p><ul><li><code>#</code>ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯</li><li><code>*</code>ï¼šä»…ä»…åŒ¹é…ä¸€ä¸ªå•è¯</li></ul><p>ä¸¾ä¾‹ï¼š</p><ul><li><code>item.#</code>ï¼šèƒ½å¤ŸåŒ¹é…<code>item.spu.insert</code> æˆ–è€… <code>item.spu</code>    </li><li><code>item.*</code>ï¼šåªèƒ½åŒ¹é…<code>item.spu</code></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/xbwQeniSqOudRXU.png" alt="TopicExchangeæ¨¡å‹"></p><p>æ­¤æ—¶publisherå‘é€çš„æ¶ˆæ¯ä½¿ç”¨çš„<code>Routing Key</code>å…±æœ‰å››ç§ï¼š</p><ul><li><code>china.news</code> ä»£è¡¨æœ‰ä¸­å›½çš„æ–°é—»æ¶ˆæ¯</li><li><code>china.weather</code> ä»£è¡¨ä¸­å›½çš„å¤©æ°”æ¶ˆæ¯</li><li><code>japan.news</code> åˆ™ä»£è¡¨æ—¥æœ¬æ–°é—»</li><li><code>japan.weather</code> ä»£è¡¨æ—¥æœ¬çš„å¤©æ°”æ¶ˆæ¯</li></ul><p>è§£é‡Š</p><ul><li><code>topic.queue1</code>ï¼šç»‘å®šçš„æ˜¯<code>china.#</code> ï¼Œå‡¡æ˜¯ä»¥ <code>china.</code>å¼€å¤´çš„<code>routing key</code> éƒ½ä¼šè¢«åŒ¹é…åˆ°ï¼Œå¦‚ï¼š<ul><li><code>china.news</code></li><li><code>china.weather</code></li></ul></li><li><code>topic.queue2</code>ï¼šç»‘å®šçš„æ˜¯<code>#.news</code> ï¼Œå‡¡æ˜¯ä»¥ <code>.news</code>ç»“å°¾çš„ <code>routing key</code> éƒ½ä¼šè¢«åŒ¹é…ï¼Œå¦‚ï¼š<ul><li><code>china.news</code></li><li><code>japan.news</code></li></ul></li></ul><p><strong>æµ‹è¯•ï¼š</strong></p><ul><li>é¦–å…ˆï¼Œåœ¨æ§åˆ¶å°æŒ‰ç…§å›¾ç¤ºä¾‹å­åˆ›å»ºé˜Ÿåˆ—ã€äº¤æ¢æœºï¼Œå¹¶åˆ©ç”¨é€šé…ç¬¦ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</li><li>æ¶ˆæ¯å‘é€ä»£ç ï¼š<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * topicExchange</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendTopicExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// äº¤æ¢æœºåç§°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.topic&quot;</span>;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;å–œæŠ¥ï¼å­™æ‚Ÿç©ºå¤§æˆ˜å“¥æ–¯æ‹‰ï¼Œèƒœ!&quot;</span>;</span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;china.news&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>æ¶ˆæ¯æ¥æ”¶ä»£ç ï¼š<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ€»ç»“ï¼š</strong></p><p>Directäº¤æ¢æœºä¸Topicäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ</p><ul><li>Topicäº¤æ¢æœºæ¥æ”¶çš„æ¶ˆæ¯Routing Keyå¿…é¡»æ˜¯å¤šä¸ªå•è¯ï¼Œä»¥ <code>.</code> åˆ†å‰²</li><li>Topicäº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®šæ—¶çš„binding Keyå¯ä»¥æŒ‡å®šé€šé…ç¬¦<ul><li><code>#</code>ï¼šä»£è¡¨ä»»æ„ä¸ªå•è¯</li><li><code>*</code>ï¼šä»£è¡¨1ä¸ªå•è¯</li></ul></li></ul><h3 id="å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº"><a href="#å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº" class="headerlink" title="å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº"></a>å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</h3><p>åœ¨æ­¤ä¹‹å‰éƒ½æ˜¯åŸºäºRabbitMQæ§åˆ¶å°æ¥åˆ›å»ºé˜Ÿåˆ—ã€äº¤æ¢æœºã€‚ä½†æ˜¯åœ¨å®é™…å¼€å‘æ—¶ï¼Œé˜Ÿåˆ—å’Œäº¤æ¢æœºæ˜¯ç¨‹åºå‘˜å®šä¹‰çš„ï¼Œå°†æ¥é¡¹ç›®ä¸Šçº¿ï¼Œåˆè¦äº¤ç»™è¿ç»´å»åˆ›å»ºã€‚é‚£ä¹ˆç¨‹åºå‘˜å°±éœ€è¦æŠŠæ‰€æœ‰ç”¨åˆ°çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºåéƒ½å†™ä¸‹æ¥ï¼Œäº¤ç»™è¿ç»´ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯å¾ˆå®¹æ˜“å‡ºç°é”™è¯¯</p><p>å› æ­¤æ¨èçš„åšæ³•æ˜¯ç”±ç¨‹åºå¯åŠ¨æ—¶æ£€æŸ¥é˜Ÿåˆ—å’Œäº¤æ¢æœºæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨è‡ªåŠ¨åˆ›å»ºç›¸åº”é˜Ÿåˆ—å’Œäº¤æ¢æœº</p><p>&#x3D;&#x3D;éœ€è¦ç”¨åˆ°çš„åŸºæœ¬API&#x3D;&#x3D;</p><ul><li>SpringAMQPæä¾›Queueç±»ã€å·¥å‚ç±»QueueBuilderç”¨æ¥åˆ›å»ºé˜Ÿåˆ—</li><li>SpringAMQPè¿˜æä¾›äº†ä¸€ä¸ªExchangeæ¥å£ï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºï¼š<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/E3krgNav4oiyH6F.png" alt="äº¤æ¢æœºæ„å»º"></li></ul></li><li>SpringAMQPè¿˜æä¾›äº†ExchangeBuilderæ¥ç®€åŒ–åˆ›å»ºé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„è¿‡ç¨‹<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/30/1rLE3KYgwuJNPAM.png" alt="ExchangeBuilder"></li></ul></li><li>åœ¨ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºæ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨BindingBuilderç±»æ¥åˆ›å»ºBindingå¯¹è±¡</li></ul><h4 id="fanoutäº¤æ¢æœºç¤ºä¾‹"><a href="#fanoutäº¤æ¢æœºç¤ºä¾‹" class="headerlink" title="fanoutäº¤æ¢æœºç¤ºä¾‹"></a>fanoutäº¤æ¢æœºç¤ºä¾‹</h4><p>åœ¨consumeræœåŠ¡ä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Fanoutç±»å‹äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;hmall.fanout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¬¬1ä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1</span><span class="params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¬¬2ä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2</span><span class="params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬å¯ä»¥åœ¨æ¶ˆè´¹è€…è¿™è¾¹å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºå’Œç»‘å®šå…³ç³»ï¼Œå› ä¸ºä½œä¸ºå‘é€æ–¹æ¥è®²ï¼Œå‘é€æ–¹ä¸éœ€è¦å…³å¿ƒé˜Ÿåˆ—ï¼Œå‘é€å‘å”¯ä¸€å…³å¿ƒçš„æ˜¯äº¤æ¢æœºï¼Œå‘æŸä¸ªäº¤æ¢æœºå‘æ¶ˆæ¯å°±å¯ä»¥äº†</p><h4 id="directäº¤æ¢æœºåˆ›å»ºç¤ºä¾‹"><a href="#directäº¤æ¢æœºåˆ›å»ºç¤ºä¾‹" class="headerlink" title="directäº¤æ¢æœºåˆ›å»ºç¤ºä¾‹"></a>directäº¤æ¢æœºåˆ›å»ºç¤ºä¾‹</h4><p>directæ¨¡å¼ç”±äºè¦ç»‘å®šå¤šä¸ªRouting keyï¼Œä¼šéå¸¸éº»çƒ¦ï¼Œæ¯ä¸€ä¸ªRouting keyéƒ½è¦ç¼–å†™ä¸€ä¸ªbinding</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Directç±»å‹äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;hmall.direct&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¬¬1ä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1WithRed</span><span class="params">(Queue directQueue1, DirectExchange directExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue1).to(directExchange).with(<span class="string">&quot;red&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1WithBlue</span><span class="params">(Queue directQueue1, DirectExchange directExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue1).to(directExchange).with(<span class="string">&quot;blue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¬¬2ä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2WithRed</span><span class="params">(Queue directQueue2, DirectExchange directExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue2).to(directExchange).with(<span class="string">&quot;red&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2WithYellow</span><span class="params">(Queue directQueue2, DirectExchange directExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue2).to(directExchange).with(<span class="string">&quot;yellow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> äº¤æ¢æœºåˆ›å»ºæ–¹å¼ï¼š</p><ul><li><code>ExchangeBuilder.directExchange(&quot;hmall.direct&quot;).build();</code>\</li><li>åˆ©ç”¨ExchangeBuilderiå¯ä»¥åˆ›å»ºå„ä¸ªäº¤æ¢æœº</li></ul><p>åœ¨æ§åˆ¶å°åˆ é™¤ä¹‹å‰åˆ›å»ºäº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼Œç„¶åé‡å¯é¡¹ç›®ï¼Œå®Œæˆè‡ªåŠ¨åˆ›å»º</p><h4 id="åŸºäºæ³¨è§£å£°æ˜"><a href="#åŸºäºæ³¨è§£å£°æ˜" class="headerlink" title="åŸºäºæ³¨è§£å£°æ˜"></a>åŸºäºæ³¨è§£å£°æ˜</h4><p>åŸºäº@Beançš„æ–¹å¼å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºä¾ç„¶éº»çƒ¦ï¼ŒSpringè¿˜æä¾›äº†åŸºäºæ³¨è§£æ–¹å¼æ¥å£°æ˜</p><p>ä¾‹å¦‚ï¼Œå£°æ˜Directæ¨¡å¼çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼Œå°†å˜ä¸º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜Topicæ¨¡å¼çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;china.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;#.news&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯è½¬æ¢å™¨"><a href="#æ¶ˆæ¯è½¬æ¢å™¨" class="headerlink" title="æ¶ˆæ¯è½¬æ¢å™¨"></a>æ¶ˆæ¯è½¬æ¢å™¨</h3><p>Springçš„æ¶ˆæ¯å‘é€ä»£ç æ¥æ”¶çš„æ¶ˆæ¯ä½“æ˜¯ä¸€ä¸ªObjectï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/qpMP5jzuYtU8LNE.png" alt="æ¶ˆæ¯å‘é€"></p><p>åœ¨æ•°æ®ä¼ è¾“æ—¶ï¼Œå®ƒä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡<br>é»˜è®¤æƒ…å†µä¸‹Springé‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JDKåºåˆ—åŒ–ï¼Œè€ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜</p><ul><li>æ•°æ®ä½“ç§¯è¿‡å¤§</li><li>æœ‰å®‰å…¨æ¼æ´</li><li>å¯è¯»æ€§å·®<br>è¡¥å……</li><li><strong>JDKåºåˆ—åŒ–</strong>æ˜¯Javaæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œâ€Œå…è®¸å°†Javaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµï¼Œâ€Œä»¥ä¾¿åœ¨ç½‘ç»œä¸Šä¼ è¾“æˆ–ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–</li><li>â€ŒJDKåºåˆ—åŒ–æœºåˆ¶é€šè¿‡å®ç°<code>java.io.Serializable</code>æ¥å£æˆ–è‡ªå®šä¹‰<code>writeObject</code>å’Œ<code>readObject</code>æ–¹æ³•æ¥è¿›è¡Œå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</li><li>ä¸ºäº†ç¡®ä¿ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œâ€Œé€šå¸¸ä¼šåœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ª<code>serialVersionUID</code>ï¼Œâ€Œç”¨äºåœ¨ååºåˆ—åŒ–æ—¶éªŒè¯åºåˆ—åŒ–å¯¹è±¡çš„ç‰ˆæœ¬ä¸€è‡´æ€§â€Œ</li><li>ä¼˜ç‚¹<ul><li>è·¨å¹³å°æ€§ï¼šJavaå¹³å°æä¾›äº†ç»Ÿä¸€çš„åºåˆ—åŒ–æœºåˆ¶ï¼Œâ€Œä½¿å¾—Javaå¯¹è±¡å¯ä»¥åœ¨ä¸åŒçš„å¹³å°ä¹‹é—´è¿›è¡Œä¼ è¾“å’Œä¿å­˜</li><li>ç®€å•æ˜“ç”¨ï¼šJavaæä¾›äº†å†…ç½®çš„åºåˆ—åŒ–æœºåˆ¶ï¼Œâ€Œæ— éœ€é¢å¤–çš„é…ç½®æˆ–å¤æ‚çš„ç¼–ç è¿‡ç¨‹</li></ul></li></ul><h4 id="æµ‹è¯•é»˜è®¤çš„æ¶ˆæ¯è½¬æ¢å™¨"><a href="#æµ‹è¯•é»˜è®¤çš„æ¶ˆæ¯è½¬æ¢å™¨" class="headerlink" title="æµ‹è¯•é»˜è®¤çš„æ¶ˆæ¯è½¬æ¢å™¨"></a>æµ‹è¯•é»˜è®¤çš„æ¶ˆæ¯è½¬æ¢å™¨</h4><p>é¦–å…ˆï¼Œåœ¨consumeræœåŠ¡ä¸­å£°æ˜ä¸€ä¸ªæ–°çš„é…ç½®ç±»MessageConfigï¼Œåˆ©ç”¨@Beançš„æ–¹å¼åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">objectQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;object.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡å¯consumeræœåŠ¡ä»¥åï¼Œè¯¥é˜Ÿåˆ—å°±ä¼šè¢«è‡ªåŠ¨åˆ›å»ºå‡ºæ¥ã€‚<br>å…¶æ¬¡ï¼Œåœ¨publisheræ¨¡å—çš„SpringAmqpTestä¸­æ–°å¢ä¸€ä¸ªæ¶ˆæ¯å‘é€çš„ä»£ç ï¼Œå‘é€ä¸€ä¸ªMapå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMap</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// å‡†å¤‡æ¶ˆæ¯</span></span><br><span class="line">    Map&lt;String,Object&gt; msg = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    msg.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;æŸ³å²©&quot;</span>);</span><br><span class="line">    msg.put(<span class="string">&quot;age&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;object.queue&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘é€æ¶ˆæ¯åæŸ¥çœ‹æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯æ ¼å¼éå¸¸ä¸å‹å¥½ï¼Œå¯è¯»æ€§å¾ˆå·®ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/YPqSwpyM85WUDHI.png" alt="MAPæ¶ˆæ¯"></p><h4 id="é…ç½®JSONè½¬æ¢å™¨"><a href="#é…ç½®JSONè½¬æ¢å™¨" class="headerlink" title="é…ç½®JSONè½¬æ¢å™¨"></a>é…ç½®JSONè½¬æ¢å™¨</h4><p>æ˜¾ç„¶ï¼ŒJDKåºåˆ—åŒ–æ–¹å¼å¹¶ä¸åˆé€‚ã€‚æˆ‘ä»¬å¸Œæœ›æ¶ˆæ¯ä½“çš„ä½“ç§¯æ›´å°ã€å¯è¯»æ€§æ›´é«˜ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨JSONæ–¹å¼æ¥åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–<br>åœ¨<code>publisher</code>å’Œ<code>consumer</code>ä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ul><li>å¦‚æœä½¿ç”¨çš„æ˜¯ Spring Boot çš„ spring-boot-starter-web æˆ– spring-boot-starter-amqpï¼Œå®ƒä»¬éƒ½ä¼šè‡ªåŠ¨åŒ…å« Jackson ä¾èµ–</li></ul><p><strong>é…ç½®æ¶ˆæ¯è½¬æ¢å™¨</strong><br>åœ¨<code>publisher</code>å’Œ<code>consumer</code>ä¸¤ä¸ªæœåŠ¡çš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªBeanå³å¯ï¼Œä¸ä¸€å®šæ”¾å¯åŠ¨ç±»ï¼Œè¿™é‡Œåªæ˜¯æ–¹ä¾¿è¡Œäº‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jackson2JsonMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼ˆåŒåºåˆ—åŒ–IDï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯</span></span><br><span class="line">    jackson2JsonMessageConverter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jackson2JsonMessageConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>^9a12b6</p><p>æ¶ˆæ¯è½¬æ¢å™¨ä¸­æ·»åŠ çš„<code>message Id</code>å¯ä»¥ä¾¿äºæˆ‘ä»¬å°†æ¥åšå¹‚ç­‰æ€§åˆ¤æ–­<br>è¡¥å……</p><ul><li>å¹‚ç­‰æ€§ï¼šç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿäº†å‰¯ä½œç”¨ ^0100ef</li><li><a href="https://blog.csdn.net/sugelachao/article/details/124410578">åœºæ™¯</a><ul><li>æ”¯ä»˜åœºæ™¯ï¼šç”¨æˆ·è´­ä¹°å•†å“ä½¿ç”¨æ”¯ä»˜å®æ”¯ä»˜ï¼Œæ”¯ä»˜æ‰£æ¬¾æˆåŠŸï¼Œä½†æ˜¯è¿”å›ç»“æœçš„æ—¶å€™ç½‘ç»œå¼‚å¸¸ï¼Œæ­¤æ—¶é’±å·²ç»æ‰£äº†ï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œç¬¬äºŒæ¬¡æ‰£æ¬¾ï¼Œè¿”å›ç»“æœæˆåŠŸï¼Œç”¨æˆ·æŸ¥è¯¢ä½™é¢è¿”å‘ç°å¤šæ‰£é’±äº†ã€‚å› æ­¤éœ€è¦å¯¹äºæ¯ä¸€ç¬”è®¢å•ï¼Œæ“ä½œå¤šæ¬¡ï¼Œä¹Ÿåªèƒ½æ‰£ä¸€æ¬¡é’±</li><li>ä¸€é”®ä¸‰è¿ï¼šå°ç ´ç«™æœ‰ä¸€ä¸ªä¸€é”®ä¸‰è¿çš„åŠŸèƒ½ï¼Œé•¿æŒ‰å¯ä»¥å¯¹upä¸»è¿›è¡Œæ¿€åŠ±ï¼Œæ¯ä¸ªäººå¯¹æ¯ä¸ªè§†é¢‘åªæœ‰ä¸€ä¸ªä¸€é”®ä¸‰è¿çš„æœºä¼šã€‚å°±ç®—å†å–œæ¬¢æŸä¸ªè§†é¢‘ï¼Œå¤šæ¬¡æ“ä½œï¼Œä¹Ÿåªèƒ½æœ‰ä¸€é”®ä¸‰è¿ä¸€æ¬¡<br>åˆ°MQæ§åˆ¶å°<strong>åˆ é™¤</strong><code>object.queue</code>ä¸­çš„æ—§çš„æ¶ˆæ¯ï¼Œé‡å¯æœåŠ¡ï¼Œç„¶åå†æ¬¡æ‰§è¡Œåˆšæ‰çš„æ¶ˆæ¯å‘é€çš„ä»£ç ï¼Œåˆ°MQçš„æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯ç»“æ„ï¼š</li></ul></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/7GiRtdf3MqbHplj.png" alt="JSONåºåˆ—åŒ–"></p><ul><li>æ•°æ®å¤§å°ã€å¯è¯»æ€§éƒ½å¾—åˆ°äº†ä¼˜åŒ–</li></ul><h2 id="ä¸šåŠ¡æ”¹é€ "><a href="#ä¸šåŠ¡æ”¹é€ " class="headerlink" title="ä¸šåŠ¡æ”¹é€ "></a>ä¸šåŠ¡æ”¹é€ </h2><p>æ¡ˆä¾‹éœ€æ±‚</p><ul><li>æ”¹é€ ä½™é¢æ”¯ä»˜åŠŸèƒ½ï¼Œå°†æ”¯ä»˜æˆåŠŸååŸºäºOpenFeignæ›´æ–°è®¢å•çš„çŠ¶æ€æ¥å£ï¼Œæ”¹ä¸ºåŸºäºRabbitMQçš„å¼‚æ­¥é€šçŸ¥</li><li>å¦‚å›¾ï¼š<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/b4DdPMxqGpVvUEc.png" alt="æœåŠ¡æ”¹åŠ¨"><br>ç›®å‰æ²¡æœ‰é€šçŸ¥æœåŠ¡å’Œç§¯åˆ†æœåŠ¡ï¼Œå› æ­¤æˆ‘ä»¬åªå…³æ³¨äº¤æ˜“æœåŠ¡ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</li></ul></li><li>å®šä¹‰<code>direct</code>ç±»å‹äº¤æ¢æœºï¼Œå‘½åä¸º<code>pay.direct</code></li><li>å®šä¹‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå‘½åä¸º<code>trade.pay.success.queue</code></li><li>å°†<code>trade.pay.success.queue</code>ä¸<code>pay.direct</code>ç»‘å®šï¼Œ<code>Binding Key</code>ä¸º<code>pay.success</code></li><li>æ”¯ä»˜æˆåŠŸæ—¶ä¸å†è°ƒç”¨æ›´æ–°è®¢å•çŠ¶æ€çš„æ¥å£ï¼Œè€Œæ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°<code>pay.direct</code>ï¼Œå‘é€æ¶ˆæ¯çš„<code>Routing Key</code>ä¸º<code>pay.success</code>ï¼Œæ¶ˆæ¯å†…å®¹æ˜¯è®¢å•id</li><li>äº¤æ˜“æœåŠ¡ç›‘å¬<code>trade.pay.success.queue</code>é˜Ÿåˆ—ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åæ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜</li></ul><h3 id="é…ç½®MQ"><a href="#é…ç½®MQ" class="headerlink" title="é…ç½®MQ"></a>é…ç½®MQ</h3><p>ä¸ç®¡æ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œéƒ½éœ€è¦é…ç½®MQçš„åŸºæœ¬ä¿¡æ¯ã€‚åˆ†ä¸ºä¸¤æ­¥ï¼š</p><ul><li>æ·»åŠ ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ¶ˆæ¯å‘é€ã€æ¥æ”¶--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹é…ç½®</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span> <span class="comment"># ä½ çš„è™šæ‹ŸæœºIP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># ç«¯å£</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span> <span class="comment"># è™šæ‹Ÿä¸»æœº</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itheima</span> <span class="comment"># ç”¨æˆ·å</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span> <span class="comment"># å¯†ç </span></span><br></pre></td></tr></table></figure><p>é»‘é©¬çš„è§†é¢‘åœ¨hm-comoné…ç½®äº†æ¶ˆæ¯è½¬æ¢å™¨ï¼Œè¦ä¹ˆåœ¨å…¶ä»–æœåŠ¡ä¸­éƒ½å¼•å…¥<code>spring-boot-starter-amqp&lt;</code>ä¾èµ–ï¼Œå¦åˆ™æ›¿æ¢æ‰hm-comonçš„pomæ–‡ä»¶ä¸­çš„rabbitã€amqpä¾èµ–ï¼Œä¸ç„¶é¡¹ç›®å¯åŠ¨å¤±è´¥</p><h3 id="æ¶ˆæ¯æ¥æ”¶-1"><a href="#æ¶ˆæ¯æ¥æ”¶-1" class="headerlink" title="æ¶ˆæ¯æ¥æ”¶"></a>æ¶ˆæ¯æ¥æ”¶</h3><p>åœ¨trade-serviceæœåŠ¡ä¸­å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ç›‘å¬ç±»<code>PayStatusListener</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayStatusListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = &quot;trade.pay.success.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = &quot;pay.topic&quot;),</span></span><br><span class="line"><span class="meta">            key = &quot;pay.success&quot;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenPaySuccess</span><span class="params">(Long orderId)</span>&#123;</span><br><span class="line">        orderService.markOrderPaySuccess(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯å‘é€-1"><a href="#æ¶ˆæ¯å‘é€-1" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h3><p>ä¿®æ”¹<code>pay-service</code>æœåŠ¡ä¸‹çš„<code>PayOrderServiceImpl</code>ç±»ä¸­çš„<code>tryPayOrderByBalance</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPayOrderByBalance</span><span class="params">(PayOrderDTO payOrderDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢æ”¯ä»˜å•</span></span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">po</span> <span class="operator">=</span> getById(payOrderDTO.getId());</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span>(!PayStatus.WAIT_BUYER_PAY.equalsValue(po.getStatus()))&#123;</span><br><span class="line">        <span class="comment">// è®¢å•ä¸æ˜¯æœªæ”¯ä»˜ï¼ŒçŠ¶æ€å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;äº¤æ˜“å·²æ”¯ä»˜æˆ–å…³é—­ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.å°è¯•æ‰£å‡ä½™é¢</span></span><br><span class="line">    userClient.deductMoney(payOrderDTO.getPw(), po.getAmount());</span><br><span class="line">    <span class="comment">// 4.ä¿®æ”¹æ”¯ä»˜å•çŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> markPayOrderSuccess(payOrderDTO.getId(), LocalDateTime.now());</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;äº¤æ˜“å·²æ”¯ä»˜æˆ–å…³é—­ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¿®æ”¹è®¢å•çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// tradeClient.markOrderPaySuccess(po.getBizOrderNo());</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;pay.direct&quot;</span>, <span class="string">&quot;pay.success&quot;</span>, po.getBizOrderNo());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ”¯ä»˜æˆåŠŸçš„æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ”¯ä»˜å•idï¼š&#123;&#125;ï¼Œ äº¤æ˜“å•idï¼š&#123;&#125;&quot;</span>, po.getId(), po.getBizOrderNo(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼Œå¦‚æœè®¢å•çŠ¶æ€æ”¹å˜ä¸ºâ€å·²æ”¯ä»˜â€œï¼Œåˆ™å®Œæˆäº†æ¶ˆæ¯çš„å‘é€å’Œå¤„ç†ï¼›æ‰“å¼€RabbitMqçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯»å–äº†ä¸€æ¡æ¶ˆæ¯</p><h1 id="RabbitMQé«˜çº§åŠŸèƒ½"><a href="#RabbitMQé«˜çº§åŠŸèƒ½" class="headerlink" title="RabbitMQé«˜çº§åŠŸèƒ½"></a>RabbitMQé«˜çº§åŠŸèƒ½</h1><p>æ¶ˆæ¯çš„é‡è¦æ€§æ¯åº¸ç½®ç–‘ï¼Œåœ¨æ”¯ä»˜æœåŠ¡ä¸­å¦‚æœMQé€šçŸ¥å¤±è´¥ï¼Œæ”¯ä»˜æµæ°´æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸï¼Œè€Œäº¤æ˜“æœåŠ¡ä¸­çš„è®¢å•çŠ¶æ€å´æ˜¾ç¤ºæœªæ”¯ä»˜ï¼Œå¯¼è‡´æ•°æ®å‡ºç°äº†ä¸ä¸€è‡´ï¼Œå¯¹ç”¨æˆ·ä½“éªŒéå¸¸ä¸å¥½<br>å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å°½å¯èƒ½ç¡®ä¿MQæ¶ˆæ¯çš„å¯é æ€§ï¼Œå³ï¼šæ¶ˆæ¯åº”è¯¥è‡³å°‘è¢«æ¶ˆè´¹è€…å¤„ç†1æ¬¡</p><p>æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</p><ul><li>å‘é€æ¶ˆæ¯æ—¶ä¸¢å¤±ï¼š<ul><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶è¿æ¥MQå¤±è´¥</li><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°<code>Exchange</code></li><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„<code>Exchange</code>åï¼Œæœªæ‰¾åˆ°åˆé€‚çš„<code>Queue</code></li><li>æ¶ˆæ¯åˆ°è¾¾MQåï¼Œå¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸</li></ul></li><li>MQå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼š<ul><li>æ¶ˆæ¯åˆ°è¾¾MQï¼Œä¿å­˜åˆ°é˜Ÿåˆ—åï¼Œå°šæœªæ¶ˆè´¹å°±çªç„¶å®•æœº</li></ul></li><li>æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶ï¼š<ul><li>æ¶ˆæ¯æ¥æ”¶åå°šæœªå¤„ç†çªç„¶å®•æœº</li><li>æ¶ˆæ¯æ¥æ”¶åå¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸</li></ul></li></ul><p>è¦è§£å†³æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ï¼Œä¿è¯MQçš„å¯é æ€§ï¼Œå°±å¿…é¡»ä»3ä¸ªæ–¹é¢å…¥æ‰‹ï¼š</p><ul><li>ç¡®ä¿ç”Ÿäº§è€…ä¸€å®šæŠŠæ¶ˆæ¯å‘é€åˆ°MQ</li><li>ç¡®ä¿MQä¸ä¼šå°†æ¶ˆæ¯å¼„ä¸¢</li><li>ç¡®ä¿æ¶ˆè´¹è€…ä¸€å®šè¦å¤„ç†æ¶ˆæ¯</li></ul><h2 id="ä¸€ã€ç”Ÿäº§è€…çš„å¯é æ€§"><a href="#ä¸€ã€ç”Ÿäº§è€…çš„å¯é æ€§" class="headerlink" title="ä¸€ã€ç”Ÿäº§è€…çš„å¯é æ€§"></a>ä¸€ã€ç”Ÿäº§è€…çš„å¯é æ€§</h2><h3 id="ç”Ÿäº§è€…é‡è¯•æœºåˆ¶"><a href="#ç”Ÿäº§è€…é‡è¯•æœºåˆ¶" class="headerlink" title="ç”Ÿäº§è€…é‡è¯•æœºåˆ¶"></a>ç”Ÿäº§è€…é‡è¯•æœºåˆ¶</h3><p>ç¬¬ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œå‡ºç°äº†ç½‘ç»œæ•…éšœï¼Œå¯¼è‡´ä¸MQçš„è¿æ¥ä¸­æ–­ï¼Œå‘é€æ¶ˆæ¯å¤±è´¥<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSpringAMQPæä¾›äº†æ¶ˆæ¯å‘é€æ—¶çš„&#x3D;&#x3D;é‡è¯•æœºåˆ¶&#x3D;&#x3D;ã€‚å³ï¼šå½“<code>RabbitTemplate</code>ä¸MQè¿æ¥è¶…æ—¶åï¼Œå¤šæ¬¡é‡è¯•<br>ä¿®æ”¹<code>publisher</code>æ¨¡å—çš„<code>application.yaml</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯è¶…æ—¶é‡è¯•æœºåˆ¶</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> </span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> </span><br></pre></td></tr></table></figure><p>ç›¸å…³è§£é‡Š</p><ul><li><code>connection-timeout: 1s</code>ï¼Œå¦‚æœåœ¨1ç§’å†…æ— æ³•è¿æ¥åˆ° RabbitMQï¼Œç³»ç»Ÿä¼šè¶…æ—¶å¹¶åœæ­¢å°è¯•è¿æ¥</li><li><code>retry</code> é‡è¯•æœºåˆ¶<ul><li><code>initial-interval: 1000ms</code>ï¼Œè¿™æ˜¯åœ¨ç¬¬ä¸€æ¬¡å¤±è´¥åç­‰å¾…é‡æ–°å°è¯•çš„æ—¶é—´é—´éš”</li><li><code>multiplier: 1</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå€æ•°ï¼Œç”¨äºè®¡ç®—ä¸‹ä¸€æ¬¡é‡è¯•çš„ç­‰å¾…æ—¶é—´<ul><li>æ¯æ¬¡å¤±è´¥åï¼Œç³»ç»Ÿä¼šå°† <code>initial-interval</code> ä¹˜ä»¥è¿™ä¸ªå€æ•°ï¼Œä»¥ç¡®å®šä¸‹ä¸€æ¬¡ç­‰å¾…çš„æ—¶é—´é—´éš”</li></ul></li><li><code>max-attempts: 3</code>ï¼Œè¿™æ˜¯è®¾ç½®çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¾¾åˆ°è¿™ä¸ªé™åˆ¶åï¼Œç³»ç»Ÿå°†åœæ­¢å°è¯•å‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦é‡‡å–å…¶ä»–æªæ–½æ¥å¤„ç†æ¶ˆæ¯å‘é€å¤±è´¥çš„æƒ…å†µ</li></ul></li></ul><p>æµ‹è¯•</p><ul><li>åˆ©ç”¨å‘½ä»¤<code>docker stop mq</code>ï¼Œåœæ‰RabbitMQæœåŠ¡</li><li>æµ‹è¯•å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå‘ç°ä¼šæ¯éš”1ç§’é‡è¯•1æ¬¡ï¼Œæ€»å…±é‡è¯•äº†3æ¬¡<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/8yUMOWeTGdlDi1b.png" alt="æµ‹è¯•ç»“æœ"></li><li>è¶…æ—¶é‡è¯•æœºåˆ¶é…ç½®æˆåŠŸ</li></ul></li></ul><p><strong>æ³¨æ„</strong>ï¼šå½“ç½‘ç»œä¸ç¨³å®šçš„æ—¶å€™ï¼Œåˆ©ç”¨<em>é‡è¯•æœºåˆ¶</em>å¯ä»¥æœ‰æ•ˆæé«˜æ¶ˆæ¯å‘é€çš„æˆåŠŸç‡ã€‚ä¸è¿‡SpringAMQPæä¾›çš„é‡è¯•æœºåˆ¶æ˜¯<strong>é˜»å¡å¼</strong>çš„é‡è¯•ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šæ¬¡é‡è¯•ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå½“å‰çº¿ç¨‹æ˜¯è¢«é˜»å¡çš„<br>å¦‚æœå¯¹äºä¸šåŠ¡æ€§èƒ½æœ‰è¦æ±‚ï¼Œå»ºè®®ç¦ç”¨é‡è¯•æœºåˆ¶ã€‚å¦‚æœä¸€å®šè¦ä½¿ç”¨ï¼Œè¯·åˆç†é…ç½®ç­‰å¾…æ—¶é•¿å’Œé‡è¯•æ¬¡æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹æ¥æ‰§è¡Œå‘é€æ¶ˆæ¯çš„ä»£ç </p><h3 id="ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶"><a href="#ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶" class="headerlink" title="ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶"></a>ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªè¦ç”Ÿäº§è€…ä¸MQä¹‹é—´çš„ç½‘è·¯è¿æ¥é¡ºç•…ï¼ŒåŸºæœ¬ä¸ä¼šå‡ºç°å‘é€æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ— éœ€è€ƒè™‘è¿™ç§é—®é¢˜<br>ä¸è¿‡ï¼Œåœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šå‡ºç°æ¶ˆæ¯å‘é€åˆ°MQä¹‹ååˆä¸¢å¤±çš„ç°è±¡ï¼Œæ¯”å¦‚ï¼š</p><ul><li>MQå†…éƒ¨å¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿäº†å¼‚å¸¸</li><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°<code>Exchange</code></li><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„<code>Exchange</code>åï¼Œæœªæ‰¾åˆ°åˆé€‚çš„<code>Queue</code>ï¼Œå› æ­¤æ— æ³•è·¯ç”±<br>é’ˆå¯¹ä¸Šè¿°æƒ…å†µï¼ŒRabbitMQæä¾›äº†&#x3D;&#x3D;ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤æœºåˆ¶&#x3D;&#x3D;ï¼ŒåŒ…æ‹¬<code>Publisher Confirm</code>å’Œ<code>Publisher Return</code>ä¸¤ç§ã€‚åœ¨å¼€å¯ç¡®è®¤æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™MQåï¼ŒMQä¼šæ ¹æ®æ¶ˆæ¯å¤„ç†çš„æƒ…å†µç»™<code>Publisher</code>è¿”å›ä¸åŒçš„<strong>å›æ‰§</strong></li></ul><p>å…·ä½“å¦‚å›¾æ‰€ç¤ºï¼š</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/CExajFgL1yRbmrl.png" alt="å›æ‰§è¿”å›"></li></ul><p>å…·ä½“æµç¨‹ï¼š</p><ul><li>å½“æ¶ˆæ¯æŠ•é€’åˆ°MQï¼Œä½†æ˜¯è·¯ç”±å¤±è´¥æ—¶ï¼Œé€šè¿‡<strong>Publisher Return</strong>è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼ŒåŒæ—¶è¿”å›ackçš„ç¡®è®¤ä¿¡æ¯ï¼Œä»£è¡¨æŠ•é€’æˆåŠŸ</li><li>ä¸´æ—¶æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜ŸæˆåŠŸï¼Œè¿”å›ACKï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ</li><li>æŒä¹…æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜Ÿå®ŒæˆæŒä¹…åŒ–ï¼Œè¿”å›ACK ï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ</li><li>å…¶å®ƒæƒ…å†µéƒ½ä¼šè¿”å›NACKï¼Œå‘ŠçŸ¥æŠ•é€’å¤±è´¥<br>å…¶ä¸­<code>ACk</code>å’Œ<code>NACK</code>å±äº<strong>Publisher Confirm</strong>æœºåˆ¶ï¼Œ<code>ack</code>æ˜¯æŠ•é€’æˆåŠŸï¼›<code>nack</code>æ˜¯æŠ•é€’å¤±è´¥ã€‚è€Œ<code>return</code>åˆ™å±äº<strong>Publisher Return</strong>æœºåˆ¶</li></ul><p>é»˜è®¤ä¸¤ç§æœºåˆ¶éƒ½æ˜¯å…³é—­çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¼€å¯</p><h3 id="å®ç°ç”Ÿäº§è€…ç¡®è®¤"><a href="#å®ç°ç”Ÿäº§è€…ç¡®è®¤" class="headerlink" title="å®ç°ç”Ÿäº§è€…ç¡®è®¤"></a>å®ç°ç”Ÿäº§è€…ç¡®è®¤</h3><p>åœ¨publisheræ¨¡å—çš„<code>application.yaml</code>ä¸­æ·»åŠ é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># å¼€å¯publisher confirmæœºåˆ¶ï¼Œå¹¶è®¾ç½®confirmç±»å‹</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯publisher returnæœºåˆ¶</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>publisher-confirm-type</code>æœ‰ä¸‰ç§æ¨¡å¼å¯é€‰ï¼š</p><ul><li><code>none</code>ï¼šå…³é—­confirmæœºåˆ¶</li><li><code>simple</code>ï¼šåŒæ­¥é˜»å¡ç­‰å¾…MQçš„å›æ‰§</li><li><code>correlated</code>ï¼šMQå¼‚æ­¥å›è°ƒæœºåˆ¶è¿”å›å›æ‰§ï¼ˆæ¨èä½¿ç”¨ï¼Œä¼˜åŒ–æ€§èƒ½ï¼‰</li></ul><h4 id="å®šä¹‰ReturnCallback"><a href="#å®šä¹‰ReturnCallback" class="headerlink" title="å®šä¹‰ReturnCallback"></a>å®šä¹‰ReturnCallback</h4><p>æ¯ä¸ª<code>RabbitTemplate</code>åªèƒ½é…ç½®ä¸€ä¸ª<code>ReturnCallback</code>ï¼ˆå‘é€å¤±è´¥æ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ï¼‰ï¼Œå› æ­¤å¯ä»¥åœ¨é…ç½®ç±»ä¸­ç»Ÿä¸€è®¾ç½®</p><ul><li>åœ¨punlisherä¸­æ–°å»ºä¸€ä¸ªäººé…ç½®ç±»MqConfig</li><li>å†…å®¹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è§¦å‘return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>@PostConstruct</code>æ³¨è§£è§£é‡Šï¼ˆè€ç”Ÿå¸¸è°ˆäº†ä¹Ÿæ˜¯ï¼‰<ul><li>å®ƒä¸»è¦ç”¨äºç±», åœ¨beanè¢«åˆ›å»ºå¹¶å®Œæˆå±æ€§æ³¨å…¥åï¼Œæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¸¦æœ‰<code>@PostConstruct</code>æ³¨è§£çš„æ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨</li><li>beanç”Ÿå‘½å‘¨æœŸçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸ä¹‹ç±»ä¼¼</li><li>Beanæ³¨è§£çš„initMethodå­—æ®µï¼Œä»¥åŠå®ç°åˆå§‹åŒ–beançš„æ¥å£ä¸ä¹‹ç±»ä¼¼</li></ul></li><li>Beançš„ç”Ÿå‘¨æœŸï¼š<ul><li>å®ä¾‹åŒ–</li><li>ä¾èµ–æ³¨å…¥</li><li>åˆå§‹åŒ–</li><li>ä½¿ç”¨</li><li>é”€æ¯</li></ul></li><li>ä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§åŸºäºæ¥å£çš„æ–¹å¼å®ç°ReturnCallback<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/id6Iy1tfq24WxzC.png" alt="ReturnCallback"></li></ul></li><li>æ³¨æ„ï¼šéœ€è¦å»é…ç½®æ—¥å¿—çº§åˆ«ï¼Œå¦åˆ™ä¸ä¼šæœ‰log.debugçš„è¾“å‡º</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">level:com.itheima:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰ConfirmCallback"><a href="#å®šä¹‰ConfirmCallback" class="headerlink" title="å®šä¹‰ConfirmCallback"></a>å®šä¹‰ConfirmCallback</h4><p>ç”±äºæ¯ä¸ªæ¶ˆæ¯å‘é€æ—¶çš„å¤„ç†é€»è¾‘ä¸ä¸€å®šç›¸åŒï¼Œå› æ­¤ConfirmCallbackéœ€è¦åœ¨æ¯æ¬¡å‘æ¶ˆæ¯æ—¶å®šä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œæ˜¯åœ¨è°ƒç”¨RabbitTemplateä¸­<code>convertAndSend</code>æ–¹æ³•æ—¶ï¼Œå¤šä¼ é€’ä¸€ä¸ªå‚æ•°ï¼šCorrelationData(ç›¸å…³æ•°æ®ï¼Œå¯¹æ¯”æ•°æ®)<br>è¿™é‡Œçš„CorrelationDataä¸­åŒ…å«ä¸¤ä¸ªè¦ç‚¹ï¼š</p><ul><li><code>id</code>ï¼šæ¶ˆæ¯çš„å”¯ä¸€æ ‡ç¤ºï¼ŒMQå¯¹ä¸åŒçš„æ¶ˆæ¯çš„å›æ‰§ä»¥æ­¤åšåˆ¤æ–­ï¼Œé¿å…æ··æ·†</li><li><code>SettableListenableFuture</code>ï¼šå›æ‰§ç»“æœçš„Futureå¯¹è±¡<br>å°†æ¥MQçš„å›æ‰§å°±ä¼šé€šè¿‡è¿™ä¸ª<code>Future</code>æ¥è¿”å›ï¼Œæˆ‘ä»¬å¯ä»¥æå‰ç»™<code>CorrelationData</code>ä¸­çš„<code>Future</code>æ·»åŠ å›è°ƒå‡½æ•°æ¥å¤„ç†æ¶ˆæ¯å›æ‰§ï¼š</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/iL1KxXdlyWrwHYF.png" alt="å›è°ƒå‡½æ•°"></li></ul><p>æ³¨æ„ï¼š</p><ul><li>spring boot 3ä»¥ä¸Šçš„ç”¨<code>rabbitTemplate.setConfirmCallback()</code>å‘é€æ¶ˆæ¯ä¸ç”¨æ·»åŠ æœ€åçš„CorrelationDataå‚æ•°</li></ul><p>æµ‹è¯•ï¼š</p><ul><li>å‘ç³»ç»Ÿè‡ªå¸¦çš„äº¤æ¢æœºå‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”æ·»åŠ <code>ConfirmCallback</code>ï¼Œä»£ç å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºCorrelationData</span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    <span class="comment">// 2.ç»™Futureæ·»åŠ ConfirmCallback</span></span><br><span class="line">    cd.getFuture().addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.1.Futureå‘ç”Ÿå¼‚å¸¸æ—¶çš„å¤„ç†é€»è¾‘ï¼ŒåŸºæœ¬ä¸ä¼šè§¦å‘</span></span><br><span class="line">            log.error(<span class="string">&quot;send message fail&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(CorrelationData.Confirm result)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.2.Futureæ¥æ”¶åˆ°å›æ‰§çš„å¤„ç†é€»è¾‘ï¼Œå‚æ•°ä¸­çš„resultå°±æ˜¯å›æ‰§å†…å®¹</span></span><br><span class="line">            <span class="keyword">if</span>(result.isAck())&#123; <span class="comment">// result.isAck()ï¼Œbooleanç±»å‹ï¼Œtrueä»£è¡¨ackå›æ‰§ï¼Œfalse ä»£è¡¨ nackå›æ‰§</span></span><br><span class="line">                log.debug(<span class="string">&quot;å‘é€æ¶ˆæ¯æˆåŠŸï¼Œæ”¶åˆ° ack!&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123; <span class="comment">// result.getReason()ï¼ŒStringç±»å‹ï¼Œè¿”å›nackæ—¶çš„å¼‚å¸¸æè¿°</span></span><br><span class="line">                log.error(<span class="string">&quot;å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œæ”¶åˆ° nack, reason : &#123;&#125;&quot;</span>, result.getReason());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 3.å‘é€æ¶ˆæ¯</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/OzsABofn49RmLV6.png" alt="ç»“æœå›¾"></li><li>å¯ä»¥çœ‹åˆ°ï¼Œç”±äºä¼ é€’çš„<code>Routing Key</code>æ˜¯é”™è¯¯çš„ï¼Œè·¯ç”±å¤±è´¥åï¼Œè§¦å‘äº†<code>return callback</code>ï¼ŒåŒæ—¶ä¹Ÿæ”¶åˆ°äº†ack</li><li>å½“ä¿®æ”¹ä¸ºæ­£ç¡®çš„<code>Routing Key</code>ä»¥åï¼Œå°±ä¸ä¼šè§¦å‘<code>return callback</code>äº†ï¼Œåªæ”¶åˆ°ack</li><li>å¦‚æœäº¤æ¢æœºéƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼Œåˆ™åªä¼šæ”¶åˆ°nack<br>è§¦å‘<code>ConfirmCallback</code>çš„3ç§æƒ…å†µï¼š</li><li>è·¯ç”±å¤±è´¥ï¼šä¸€èˆ¬æ˜¯å› ä¸ºRouting Keyé”™è¯¯å¯¼è‡´</li><li>äº¤æ¢æœºåç§°é”™è¯¯</li><li>MQå†…éƒ¨æ•…éšœï¼šè¿™ç§éœ€è¦å¤„ç†ï¼Œä½†æ¦‚ç‡å¾€å¾€è¾ƒä½ã€‚å› æ­¤åªæœ‰å¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚éå¸¸é«˜çš„ä¸šåŠ¡æ‰éœ€è¦å¼€å¯ï¼Œè€Œä¸”ä»…ä»…éœ€è¦å¼€å¯ConfirmCallbackå¤„ç†nackå°±å¯ä»¥äº†</li></ul><p>æ€»çš„æ¥è¯´ï¼Œå¦‚æœè·¯ç”±é”™è¯¯ã€äº¤æ¢æœºä¸å­˜åœ¨å°±ä¼šè§¦å‘ConfirmCallbackï¼›åªæœ‰å½“äº¤æ¢æœºå­˜åœ¨ï¼Œè·¯ç”±é”™è¯¯æ—¶ä¼šè§¦å‘ReturnCallBack</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/CExajFgL1yRbmrl.png" alt="CallBackè§¦å‘"></li></ul><p>æ³¨æ„ï¼šå¼€å¯ç”Ÿäº§è€…ç¡®è®¤æ¯”è¾ƒæ¶ˆè€—MQæ€§èƒ½ï¼Œä¸€èˆ¬ä¸å»ºè®®å¼€å¯ï¼›è€Œä¸”åœ¨è§¦å‘ConfirmCallbackæ—¶ï¼Œä¸»è¦åŸå› æ˜¯å› ä¸ºå¼€å‘äººå‘˜ç¼–ç¨‹é”™è¯¯å¯¼è‡´</p><h2 id="äºŒã€MQçš„å¯é æ€§"><a href="#äºŒã€MQçš„å¯é æ€§" class="headerlink" title="äºŒã€MQçš„å¯é æ€§"></a>äºŒã€MQçš„å¯é æ€§</h2><p>æ¶ˆæ¯åˆ°è¾¾MQä»¥åï¼Œå¦‚æœMQä¸èƒ½<em>åŠæ—¶ä¿å­˜</em>ï¼Œä¹Ÿä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œæ‰€ä»¥MQçš„å¯é æ€§ä¹Ÿéå¸¸é‡è¦</p><h3 id="æ•°æ®æŒä¹…åŒ–"><a href="#æ•°æ®æŒä¹…åŒ–" class="headerlink" title="æ•°æ®æŒä¹…åŒ–"></a>æ•°æ®æŒä¹…åŒ–</h3><p>é»˜è®¤æƒ…å†µä¸‹MQçš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜å­˜å‚¨çš„ä¸´æ—¶æ•°æ®ï¼ˆæå‡æ€§èƒ½ï¼‰ï¼Œé‡å¯åå°±ä¼šæ¶ˆå¤±ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œå¿…é¡»é…ç½®&#x3D;&#x3D;æ•°æ®æŒä¹…åŒ–&#x3D;&#x3D;ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>äº¤æ¢æœºæŒä¹…åŒ–<ul><li>åœ¨MQæ§åˆ¶å°çš„<code>Exchanges</code>é¡µé¢ï¼Œæ·»åŠ äº¤æ¢æœºæ—¶å¯ä»¥é…ç½®äº¤æ¢æœºçš„<code>Durability</code>å‚æ•°ï¼Œè®¾ç½®ä¸º<code>Durable</code>å°±æ˜¯æŒä¹…åŒ–æ¨¡å¼ï¼Œ<code>Transient</code>å°±æ˜¯ä¸´æ—¶æ¨¡å¼</li></ul></li><li>é˜Ÿåˆ—æŒä¹…åŒ–<ul><li>åœ¨MQæ§åˆ¶å°çš„Queuesé¡µé¢ï¼Œæ·»åŠ é˜Ÿåˆ—æ—¶ï¼ŒåŒæ ·å¯ä»¥é…ç½®é˜Ÿåˆ—çš„<code>Durability</code>å‚æ•°</li></ul></li><li>æ¶ˆæ¯æŒä¹…åŒ–<ul><li>åœ¨æ§åˆ¶å°å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥æ·»åŠ å¾ˆå¤šå‚æ•°ï¼Œè€Œæ¶ˆæ¯çš„æŒä¹…åŒ–æ˜¯è¦é…ç½®ä¸€ä¸ª<code>properties</code>ï¼Œè®¾ç½®Delivery mdoeä¸ºNon-persistentå°±æ˜¯ä¸´æ—¶æ¨¡å¼ï¼ŒPersistenä¸ºæŒä¹…åŒ–æ¨¡å¼<br>è¯´æ˜ï¼š</li></ul></li><li>åœ¨å¼€å¯æŒä¹…åŒ–æœºåˆ¶ä»¥åï¼Œå¦‚æœåŒæ—¶è¿˜å¼€å¯äº†ç”Ÿäº§è€…ç¡®è®¤ï¼Œé‚£ä¹ˆMQä¼šåœ¨æ¶ˆæ¯æŒä¹…åŒ–ä»¥åæ‰å‘é€ACKå›æ‰§ï¼Œè¿›ä¸€æ­¥ç¡®ä¿æ¶ˆæ¯çš„å¯é æ€§</li><li>å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œä¸ºäº†å‡å°‘IOæ¬¡æ•°ï¼Œå‘é€åˆ°MQçš„æ¶ˆæ¯å¹¶ä¸æ˜¯é€æ¡æŒä¹…åŒ–åˆ°æ•°æ®åº“çš„ï¼Œè€Œæ˜¯æ¯éš”ä¸€æ®µæ—¶é—´æ‰¹é‡æŒä¹…</li><li>é—´éš”æ—¶é—´ä¸€èˆ¬åœ¨100æ¯«ç§’å·¦å³ï¼Œè¿™å°±ä¼šå¯¼è‡´ACKæœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œå› æ­¤å»ºè®®ç”Ÿäº§è€…ç¡®è®¤å…¨éƒ¨é‡‡ç”¨å¼‚æ­¥æ–¹å¼ï¼Œå¦åˆ™å¯¹MQçš„æ€§èƒ½å½±å“å·¨å¤§</li></ul><h3 id="LazyQueue"><a href="#LazyQueue" class="headerlink" title="LazyQueue"></a>LazyQueue</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQä¼šå°†æ¥æ”¶åˆ°çš„ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ä»¥é™ä½æ¶ˆæ¯æ”¶å‘çš„&#x3D;&#x3D;å»¶è¿Ÿ&#x3D;&#x3D;ã€‚ä½†åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¿™ä¼šå¯¼è‡´<strong>æ¶ˆæ¯ç§¯å‹</strong>ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å½“æ¶ˆè´¹è€…å®•æœºæˆ–å‡ºç°ç½‘ç»œæ•…éšœ</li><li>å½“æ¶ˆæ¯å‘é€é‡æ¿€å¢ï¼Œè¶…è¿‡äº†æ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦</li><li>å½“æ¶ˆè´¹è€…å¤„ç†ä¸šåŠ¡å‘ç”Ÿé˜»å¡</li></ul><p>ä¸€æ—¦å‡ºç°æ¶ˆæ¯å †ç§¯é—®é¢˜ï¼ŒRabbitMQçš„å†…å­˜å ç”¨å°±ä¼šè¶Šæ¥è¶Šé«˜ï¼Œç›´åˆ°è§¦å‘å†…å­˜é¢„è­¦ä¸Šé™ã€‚æ­¤æ—¶RabbitMQä¼šå°†å†…å­˜æ¶ˆæ¯åˆ·åˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¸ªè¡Œä¸ºæˆä¸º<code>PageOut</code><br><code>PageOut</code>ä¼šè€—è´¹ä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”ä¼šé˜»å¡é˜Ÿåˆ—è¿›ç¨‹ã€‚å› æ­¤åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­RabbitMQä¸ä¼šå†å¤„ç†æ–°çš„æ¶ˆæ¯ï¼Œç”Ÿäº§è€…çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ï¼ˆä»¥ä¸Šéƒ½æ˜¯æ¶ˆæ¯éæŒä¹…åŒ–æ—¶ï¼‰</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»RabbitMQçš„3.6.0ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å¢åŠ äº†Lazy Queuesï¼ˆæƒ°æ€§é˜Ÿåˆ—ï¼‰çš„æ¨¡å¼ã€‚æƒ°æ€§é˜Ÿåˆ—çš„ç‰¹å¾å¦‚ä¸‹ï¼š</p><ul><li>æ¥æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜å…¥ç£ç›˜è€Œéå†…å­˜</li><li>æ¶ˆè´¹è€…è¦æ¶ˆè´¹æ¶ˆæ¯æ—¶æ‰ä¼šä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯æ‡’åŠ è½½ï¼‰</li><li>æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨</li></ul><p><em><strong>æ§åˆ¶å°é…ç½®Lazyæ¨¡å¼ï¼š</strong></em></p><ul><li>åœ¨æ·»åŠ é˜Ÿåˆ—çš„æ—¶å€™è‰²è®¾ç½®Argumentsæ—¶ï¼Œæ·»åŠ <code>x-queue-mod=lazy</code>å‚æ•°ï¼Œå³å¯è®¾ç½®é˜Ÿåˆ—ä¸ºLazyæ¨¡å¼<br><em><strong>ä»£ç é…ç½®Lazyæ¨¡å¼ï¼š</strong></em></li><li>åœ¨åˆ©ç”¨SpringAMQPå£°æ˜é˜Ÿåˆ—çš„æ—¶å€™ï¼Œæ·»åŠ <code>x-queue-mod=lazy</code>å‚æ•°è®¾ç½®é˜Ÿåˆ—ä¸ºLazyæ¨¡å¼ï¼Œç¤ºä¾‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">lazyQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder</span><br><span class="line">            .durable(<span class="string">&quot;lazy.queue&quot;</span>)</span><br><span class="line">            .lazy() <span class="comment">// å¼€å¯Lazyæ¨¡å¼</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™é‡Œæ˜¯é€šè¿‡<code>QueueBuilder</code>çš„<code>lazy()</code>å‡½æ•°é…ç½®Lazyæ¨¡å¼ï¼Œåº•å±‚æºç å¦‚ä¸‹<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/symb1nJQviRK5Dw.png" alt="Lazyæ¨¡å¼"></li></ul></li><li>ä¹Ÿå¯ä»¥åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å¹¶è®¾ç½®ä¸ºLazyæ¨¡å¼ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(</span></span><br><span class="line"><span class="meta">        name = &quot;lazy.queue&quot;,</span></span><br><span class="line"><span class="meta">        durable = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">        arguments = @Argument(name = &quot;x-queue-mode&quot;, value = &quot;lazy&quot;)</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenLazyQueue</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;æ¥æ”¶åˆ° lazy.queueçš„æ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°å·²æœ‰é˜Ÿåˆ—ä¸ºlazyæ¨¡å¼"><a href="#æ›´æ–°å·²æœ‰é˜Ÿåˆ—ä¸ºlazyæ¨¡å¼" class="headerlink" title="æ›´æ–°å·²æœ‰é˜Ÿåˆ—ä¸ºlazyæ¨¡å¼"></a>æ›´æ–°å·²æœ‰é˜Ÿåˆ—ä¸ºlazyæ¨¡å¼</h4><p>å¯¹äºå·²ç»å­˜åœ¨çš„é˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸ºlazyæ¨¡å¼ï¼Œä½†æ˜¯è¦é€šè¿‡è®¾ç½®policyå®ç°ï¼Œå¯ä»¥åŸºäºå‘½ä»¤è¡Œè®¾ç½®policyï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rabbitmqctl set_policy Lazy &quot;^lazy-queue$&quot; &#x27;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#x27; --apply-to queues </span><br></pre></td></tr></table></figure><p>å‘½ä»¤è§£è¯»ï¼š</p><ul><li><code>rabbitmqctl</code> ï¼šRabbitMQçš„å‘½ä»¤è¡Œå·¥å…·</li><li><code>set_policy</code> ï¼šæ·»åŠ ä¸€ä¸ªç­–ç•¥</li><li><code>Lazy</code> ï¼šç­–ç•¥åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰</li><li><code>&quot;^lazy-queue$&quot;</code> ï¼šç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…é˜Ÿåˆ—çš„åå­—</li><li><code>&#39;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#39;</code> ï¼šè®¾ç½®é˜Ÿåˆ—æ¨¡å¼ä¸ºlazyæ¨¡å¼</li><li><code>--apply-to queues</code>ï¼šç­–ç•¥çš„ä½œç”¨å¯¹è±¡ï¼Œæ˜¯æ‰€æœ‰çš„é˜Ÿåˆ—</li></ul><p>ä¹Ÿå¯ä»¥åœ¨æ§åˆ¶å°é…ç½®policyï¼Œè¿›å…¥åœ¨æ§åˆ¶å°çš„<code>Admin</code>é¡µé¢ï¼Œç‚¹å‡»<code>Policies</code>ï¼Œå³å¯æ·»åŠ é…ç½®</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/31/akfY5ndAQl6ScIG.png" alt="ä¿®æ”¹ç­–ç•¥æ¨¡å¼"></p><h2 id="ä¸‰ã€æ¶ˆè´¹è€…çš„å¯é æ€§"><a href="#ä¸‰ã€æ¶ˆè´¹è€…çš„å¯é æ€§" class="headerlink" title="ä¸‰ã€æ¶ˆè´¹è€…çš„å¯é æ€§"></a>ä¸‰ã€æ¶ˆè´¹è€…çš„å¯é æ€§</h2><p>å½“RabbitMQå‘æ¶ˆè´¹è€…æŠ•é€’æ¶ˆæ¯ä»¥åï¼Œéœ€è¦çŸ¥é“æ¶ˆè´¹è€…çš„å¤„ç†çŠ¶æ€å¦‚ä½•ã€‚å› ä¸ºæ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…å¹¶ä¸ä»£è¡¨å°±ä¸€å®šè¢«æ­£ç¡®æ¶ˆè´¹äº†ï¼Œå¯èƒ½å‡ºç°äº†æ•…éšœï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ¶ˆæ¯æŠ•é€’çš„è¿‡ç¨‹ä¸­å‡ºç°äº†ç½‘ç»œæ•…éšœ</li><li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åçªç„¶å®•æœº</li><li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå› å¤„ç†ä¸å½“å¯¼è‡´å¼‚å¸¸</li><li>å…¶ä»–åŸå› <br>ä¸€æ—¦å‘ç”Ÿä¸Šè¿°æƒ…å†µï¼Œæ¶ˆæ¯ä¹Ÿä¼šä¸¢å¤±ã€‚å› æ­¤ï¼ŒRabbitMQå¿…é¡»çŸ¥é“æ¶ˆè´¹è€…çš„å¤„ç†çŠ¶æ€ï¼Œä¸€æ—¦æ¶ˆæ¯å¤„ç†å¤±è´¥éœ€è¦é‡æ–°æŠ•é€’æ¶ˆæ¯ï¼Œä¸”RabbitMQéœ€è¦å¾—çŸ¥æ¶ˆè´¹è€…çš„å¤„ç†çŠ¶æ€</li></ul><h3 id="æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶"><a href="#æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶" class="headerlink" title="æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶"></a>æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶</h3><p>ä¸ºäº†ç¡®è®¤æ¶ˆè´¹è€…æ˜¯å¦æˆåŠŸå¤„ç†ï¼ŒRabbitMQæä¾›äº†æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ã€‚å³ï¼Œå½“æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ç»“æŸåï¼Œåº”è¯¥å‘RabbitMQå‘é€ä¸€ä¸ª&#x3D;&#x3D;å›æ‰§&#x3D;&#x3D;ï¼Œå‘ŠçŸ¥RabbitMQæ¶ˆæ¯çš„å¤„ç†çŠ¶æ€ï¼Œå›æ‰§æœ‰ä¸‰ç§å¯é€‰å€¼ï¼š</p><ul><li>ackï¼šæˆåŠŸå¤„ç†æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯</li><li>nackï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼ŒRabbitMQéœ€è¦å†æ¬¡æŠ•é€’æ¶ˆæ¯</li><li>rejectï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥å¹¶æ‹’ç»è¯¥æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯</li></ul><p>ä¸€èˆ¬rejectæ–¹å¼ç”¨çš„è¾ƒå°‘ï¼Œé™¤éæ˜¯æ¶ˆæ¯æ ¼å¼æœ‰é—®é¢˜ï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹éœ€è¦å°†æ¶ˆæ¯å¤„ç†çš„ä»£ç é€šè¿‡<code>try catch</code>æœºåˆ¶æ•è·ï¼Œæ¶ˆæ¯å¤„ç†æˆåŠŸæ—¶è¿”å›ackï¼Œå¤„ç†å¤±è´¥æ—¶è¿”å›nack</p><p>ç”±äºæ¶ˆæ¯å›æ‰§çš„å¤„ç†ä»£ç æ¯”è¾ƒç»Ÿä¸€ï¼Œå› æ­¤SpringAMQPå¸®æˆ‘ä»¬å®ç°äº†æ¶ˆæ¯ç¡®è®¤ã€‚å¹¶å…è®¸æˆ‘ä»¬é€šè¿‡&#x3D;&#x3D;é…ç½®æ–‡ä»¶è®¾ç½®ACKå¤„ç†&#x3D;&#x3D;æ–¹å¼ï¼š</p><ul><li><code>none</code>ï¼šä¸å¤„ç†ã€‚å³æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…åç«‹åˆ»ackï¼Œæ¶ˆæ¯ä¼šç«‹åˆ»ä»MQåˆ é™¤</li><li><code>manual</code>ï¼šæ‰‹åŠ¨æ¨¡å¼ã€‚éœ€è¦è‡ªå·±åœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨apiï¼Œå‘é€<code>ack</code>æˆ–<code>reject</code>ï¼Œå­˜åœ¨ä¸šåŠ¡å…¥ä¾µï¼Œä½†æ›´çµæ´»</li><li><code>auto</code>ï¼šè‡ªåŠ¨æ¨¡å¼ã€‚SpringAMQPåˆ©ç”¨AOPå¯¹æˆ‘ä»¬çš„æ¶ˆæ¯å¤„ç†é€»è¾‘åšäº†ç¯ç»•å¢å¼ºï¼ˆå‡ºç°å¼‚å¸¸æ—¶è§¦å‘ï¼‰ï¼Œå½“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œæ—¶åˆ™è‡ªåŠ¨è¿”å›<code>ack</code>. å½“ä¸šåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œå†æ ¹æ®å¼‚å¸¸åˆ¤æ–­è¿”å›ä½•ç§ç»“æœï¼š<ul><li>å¦‚æœæ˜¯<strong>ä¸šåŠ¡çš„å¼‚å¸¸</strong>ï¼Œä¼šè‡ªåŠ¨è¿”å›<code>nack</code></li><li>å¦‚æœæ˜¯<strong>æ¶ˆæ¯å¤„ç†æˆ–æ¶ˆæ¯æ ¡éªŒå¼‚å¸¸</strong>ï¼Œè‡ªåŠ¨è¿”å›<code>reject</code><ul><li>è§å®˜ç½‘äº†è§£è¿”å›<code>reject</code>çš„å¸¸è§å¼‚å¸¸</li></ul></li></ul></li></ul><p>é…ç½®æ–‡ä»¶è®¾ç½®SpringAMQPçš„ACKå¤„ç†æ–¹å¼çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment"># ä¸åšå¤„ç†</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><ul><li>ä¿®æ”¹consumeræœåŠ¡çš„SpringRabbitListenerç±»ä¸­çš„æ–¹æ³•ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å¤„ç†å¼‚å¸¸çš„å‘ç”Ÿï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.info(<span class="string">&quot;spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageConversionException</span>(<span class="string">&quot;æ•…æ„çš„&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;æ¶ˆæ¯å¤„ç†å®Œæˆ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å› ä¸ºæ˜¯ACKå¤„ç†è®¾ç½®ä¸ºnoneï¼Œæ‰€ä»¥å½“æ¶ˆæ¯å¤„ç†å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ¶ˆæ¯ä¾ç„¶è¢«RabbitMQåˆ é™¤</li><li>æŠŠç¡®è®¤æœºåˆ¶ä¿®æ”¹ä¸ºautoï¼Œå‘é€æ¶ˆæ¯æµ‹è¯•ï¼Œç”±äºè¿”å›çš„æ˜¯æ¶ˆæ¯è½¬æ¢å¼‚å¸¸ï¼Œå› æ­¤Springä¼šè‡ªåŠ¨è¿”å›<code>reject</code>ï¼Œåˆ é™¤æ¶ˆæ¯</li><li>å°†å¼‚å¸¸æ”¹ä¸ºRuntimeExceptionç±»å‹ï¼Œå†æ¬¡å‘é€æ¶ˆæ¯æµ‹è¯•ï¼Œç”±äºæŠ›å‡ºçš„æ˜¯ä¸šåŠ¡å¼‚å¸¸ï¼Œæ‰€ä»¥Springè¿”å›<code>ack</code>ï¼Œæœ€ç»ˆæ¶ˆæ¯æ¢å¤è‡³<code>Ready</code>çŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«RabbitMQåˆ é™¤ï¼Œå¹¶é‡æ–°æŠ•é€’åˆ°æ¶ˆè´¹è€…<ul><li>ç›´åˆ°æ¶ˆè´¹è€…è¿”å›ackæˆ–è€…rejectæˆ–è€…å…³é—­æ¶ˆè´¹è€…æœåŠ¡</li></ul></li></ul><h3 id="å¤±è´¥é‡è¯•æœºåˆ¶"><a href="#å¤±è´¥é‡è¯•æœºåˆ¶" class="headerlink" title="å¤±è´¥é‡è¯•æœºåˆ¶"></a>å¤±è´¥é‡è¯•æœºåˆ¶</h3><p>å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­requeueï¼ˆé‡å…¥é˜Ÿï¼‰ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ¶ˆè´¹è€…å†æ¬¡æ‰§è¡Œä¾ç„¶å‡ºé”™ï¼Œæ¶ˆæ¯ä¼šå†æ¬¡requeueåˆ°é˜Ÿåˆ—ï¼Œå†æ¬¡æŠ•é€’ï¼Œç›´åˆ°æ¶ˆæ¯å¤„ç†æˆåŠŸä¸ºæ­¢<br>æç«¯æƒ…å†µå°±æ˜¯æ¶ˆè´¹è€…ä¸€ç›´æ— æ³•æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆæ¶ˆæ¯requeueå°±ä¼šæ— é™å¾ªç¯ï¼Œå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›</p><p>ä¸ºäº†åº”å¯¹ä¸Šè¿°æƒ…å†µï¼ŒSpringåˆæä¾›äº†æ¶ˆè´¹è€…å¤±è´¥é‡è¯•æœºåˆ¶ï¼šåœ¨æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸æ—¶å…ˆåˆ©ç”¨&#x3D;&#x3D;æœ¬åœ°é‡è¯•&#x3D;&#x3D;ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„requeueåˆ°mqé˜Ÿåˆ—</p><ul><li>ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ å†…å®¹ï¼š</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment"># trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse</span></span><br></pre></td></tr></table></figure><ul><li>é‡å¯consumeræœåŠ¡ï¼Œé‡å¤ä¹‹å‰çš„æµ‹è¯•ï¼Œå¯ä»¥å‘ç°ï¼š<ul><li>æ¶ˆè´¹è€…åœ¨å¤±è´¥åæ¶ˆæ¯æ²¡æœ‰é‡æ–°å›åˆ°MQè¿›è¡Œæ— é™é‡æ–°æŠ•é€’ï¼Œè€Œæ˜¯åœ¨æœ¬åœ°é‡è¯•äº†3æ¬¡</li><li>æœ¬åœ°é‡è¯•3æ¬¡ä»¥åï¼ŒæŠ›å‡ºäº†<code>AmqpRejectAndDontRequeueException</code>å¼‚å¸¸</li><li>æŸ¥çœ‹RabbitMQæ§åˆ¶å°ï¼Œæ¶ˆæ¯è¢«åˆ é™¤äº†ï¼Œè¯´æ˜æœ€åSpringAMQPè¿”å›äº†<code>reject</code></li></ul></li><li>ç»“è®º<ul><li>å¼€å¯æœ¬åœ°é‡è¯•æ—¶ï¼Œæ¶ˆæ¯å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šrequeueï¼Œè€Œæ˜¯åœ¨æ¶ˆè´¹è€…æœ¬åœ°é‡è¯•</li><li>é‡è¯•è¾¾åˆ°è®¾ç½®çš„æœ€å¤§æ¬¡æ•°åï¼ŒSpringä¼šè¿”å›rejectï¼Œæ¶ˆæ¯ä¼šè¢«åˆ é™¤</li></ul></li><li>æ³¨æ„ï¼šç”Ÿäº§è€…é‡è¯•æœºåˆ¶é…ç½®çš„æ˜¯templateï¼Œè€Œæ¶ˆè´¹è€…æ˜¯listener</li></ul><h3 id="å¤±è´¥å¤„ç†ç­–ç•¥"><a href="#å¤±è´¥å¤„ç†ç­–ç•¥" class="headerlink" title="å¤±è´¥å¤„ç†ç­–ç•¥"></a>å¤±è´¥å¤„ç†ç­–ç•¥</h3><p>åœ¨ä¹‹å‰çš„æµ‹è¯•ä¸­ï¼Œæœ¬åœ°æµ‹è¯•è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒã€‚è¿™åœ¨æŸäº›å¯¹äºæ¶ˆæ¯å¯é æ€§è¦æ±‚è¾ƒé«˜çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œä¸å¤ªåˆé€‚ã€‚å¯æ˜¯é‡å¤æ€§çš„requeueä¸åˆç†ã€‚<br>å› æ­¤Springå…è®¸è‡ªå®šä¹‰<em>é‡è¯•æ¬¡æ•°è€—å°½åçš„æ¶ˆæ¯å¤„ç†ç­–ç•¥</em>ï¼Œè¿™ä¸ªç­–ç•¥ç”±<code>MessageRecovery</code>ï¼ˆæ¶ˆæ¯æ¢å¤ï¼‰æ¥å£æ¥å®šä¹‰ï¼Œå®ƒæœ‰3ä¸ªä¸åŒå®ç°ï¼š</p><ol><li><code>RejectAndDontRequeueRecoverer</code>ï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥<code>reject</code>ï¼Œä¸¢å¼ƒæ¶ˆæ¯ï¼ˆé»˜è®¤ï¼‰</li><li><code>ImmediateRequeueMessageRecoverer</code>ï¼šé‡è¯•è€—å°½åï¼Œè¿”å›<code>nack</code>ï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ</li><li><code>RepublishMessageRecoverer</code>ï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº</li></ol><p>æ¯”è¾ƒå¥½çš„ä¸€ç§å¤„ç†æ–¹æ¡ˆæ˜¯<code>RepublishMessageRecoverer</code>ï¼Œå¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ã€ä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œå¯ä»¥é€šè¿‡é‚®ä»¶æˆ–è€…çŸ­ä¿¡å‘ŠçŸ¥å¼€å‘è€…ï¼Œç”±å¼€å‘è€…äººå·¥å¤„ç†ã€‚</p><p><strong>å®ç°ï¼š</strong></p><ul><li>åœ¨consumeræœåŠ¡ä¸­å®šä¹‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—<ul><li>è¿™é‡Œä½¿ç”¨æ³¨è§£ç›´æ¥å®šä¹‰ä¹Ÿå¯ä»¥</li></ul></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®šä¹‰ä¸€ä¸ªRepublishMessageRecovererå¤±è´¥å¤„ç†ç­–ç•¥ï¼Œå…³è”é˜Ÿåˆ—å’Œäº¤æ¢æœº</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥æŠŠä¸Šè¿°ä»£ç æ”¾äºé…ç½®ç±»</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorMessageConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸šåŠ¡å¹‚ç­‰æ€§"><a href="#ä¸šåŠ¡å¹‚ç­‰æ€§" class="headerlink" title="ä¸šåŠ¡å¹‚ç­‰æ€§"></a>ä¸šåŠ¡å¹‚ç­‰æ€§</h3><blockquote><p>è¿™ä¸ªåœ¨å‰æ–‡æœ‰æåˆ°ï¼š[[#^0100ef]]</p></blockquote><p>æ•°æ®çš„æ›´æ–°å¾€å¾€ä¸æ˜¯å¹‚ç­‰çš„ï¼Œé‡å¤æ‰§è¡Œå¯èƒ½é€ æˆä¸ä¸€æ ·çš„åæœã€‚æ¯”å¦‚ï¼š</p><ul><li>å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜çš„ä¸šåŠ¡ã€‚å¦‚æœå¤šæ¬¡æ¢å¤å°±ä¼šå‡ºç°åº“å­˜é‡å¤å¢åŠ çš„æƒ…å†µ</li><li>é€€æ¬¾ä¸šåŠ¡ã€‚é‡å¤é€€æ¬¾å¯¹å•†å®¶è€Œè¨€ä¼šæœ‰ç»æµæŸå¤±</li></ul><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å°½å¯èƒ½é¿å…ä¸šåŠ¡è¢«é‡å¤æ‰§è¡Œã€‚<br>ç„¶è€Œåœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œç”±äºæ„å¤–ç»å¸¸ä¼šå‡ºç°ä¸šåŠ¡è¢«é‡å¤æ‰§è¡Œçš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š</p><ul><li>é¡µé¢å¡é¡¿æ—¶é¢‘ç¹åˆ·æ–°å¯¼è‡´è¡¨å•é‡å¤æäº¤</li><li>æœåŠ¡é—´è°ƒç”¨çš„é‡è¯•</li><li>MQæ¶ˆæ¯çš„é‡å¤æŠ•é€’</li></ul><p>åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸåä¼šå‘é€MQæ¶ˆæ¯åˆ°äº¤æ˜“æœåŠ¡ï¼Œä¿®æ”¹è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ï¼Œå°±å¯èƒ½å‡ºç°æ¶ˆæ¯é‡å¤æŠ•é€’çš„æƒ…å†µã€‚å¦‚æœæ¶ˆè´¹è€…ä¸åšåˆ¤æ–­ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯è¢«æ¶ˆè´¹å¤šæ¬¡ï¼Œå‡ºç°ä¸šåŠ¡æ•…éšœã€‚<br>ä¸¾ä¾‹ï¼š</p><ol><li>å‡å¦‚ç”¨æˆ·åˆšåˆšæ”¯ä»˜å®Œæˆï¼Œå¹¶ä¸”æŠ•é€’æ¶ˆæ¯åˆ°äº¤æ˜“æœåŠ¡ï¼Œäº¤æ˜“æœåŠ¡æ›´æ”¹è®¢å•ä¸º<strong>å·²æ”¯ä»˜</strong>çŠ¶æ€</li><li>ç”±äºæŸç§åŸå› ï¼Œä¾‹å¦‚ç½‘ç»œæ•…éšœå¯¼è‡´ç”Ÿäº§è€…æ²¡æœ‰å¾—åˆ°ç¡®è®¤ï¼Œéš”äº†ä¸€æ®µæ—¶é—´å<strong>é‡æ–°æŠ•é€’</strong>ç»™äº¤æ˜“æœåŠ¡</li><li>ä½†æ˜¯ï¼Œåœ¨æ–°æŠ•é€’çš„æ¶ˆæ¯è¢«æ¶ˆè´¹ä¹‹å‰ï¼Œç”¨æˆ·é€‰æ‹©äº†é€€æ¬¾ï¼Œå°†è®¢å•çŠ¶æ€æ”¹ä¸ºäº†<strong>å·²é€€æ¬¾</strong>çŠ¶æ€</li><li>é€€æ¬¾å®Œæˆåï¼Œæ–°æŠ•é€’çš„æ¶ˆæ¯æ‰è¢«æ¶ˆè´¹ï¼Œé‚£ä¹ˆè®¢å•çŠ¶æ€ä¼šè¢«å†æ¬¡æ”¹ä¸º<strong>å·²æ”¯ä»˜</strong>ï¼Œå¯¼è‡´ä¸šåŠ¡å¼‚å¸¸</li></ol><p>ä¸¤ç§æ–¹æ¡ˆä¿è¯æ¶ˆæ¯å¤„ç†çš„å¹‚ç­‰æ€§ï¼š</p><ul><li>å”¯ä¸€æ¶ˆæ¯ID</li><li>ä¸šåŠ¡çŠ¶æ€åˆ¤æ–­</li></ul><h4 id="å”¯ä¸€æ¶ˆæ¯ID"><a href="#å”¯ä¸€æ¶ˆæ¯ID" class="headerlink" title="å”¯ä¸€æ¶ˆæ¯ID"></a>å”¯ä¸€æ¶ˆæ¯ID</h4><p>å®ç°æ€è·¯ï¼š</p><ol><li>æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„idï¼Œä¸æ¶ˆæ¯ä¸€èµ·æŠ•é€’ç»™æ¶ˆè´¹è€…ï¼ˆåºåˆ—åŒ–IDï¼‰</li><li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åå¤„ç†è‡ªå·±çš„ä¸šåŠ¡ï¼Œä¸šåŠ¡å¤„ç†æˆåŠŸåå°†æ¶ˆæ¯IDä¿å­˜åˆ°æ•°æ®åº“</li><li>å¦‚æœä¸‹æ¬¡åˆæ”¶åˆ°ç›¸åŒæ¶ˆæ¯ï¼Œå»æ•°æ®åº“æŸ¥è¯¢åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä¸ºé‡å¤æ¶ˆæ¯ï¼Œæ”¾å¼ƒå¤„ç†</li></ol><p>ç»™æ¶ˆæ¯æ·»åŠ å”¯ä¸€IDï¼š</p><ul><li>SpringAMQPçš„MessageConverterè‡ªå¸¦äº†<code>Message ID</code>çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªè¦å¼€å¯è¿™ä¸ªåŠŸèƒ½å³å¯</li><li>é…ç½®Jacksonçš„æ¶ˆæ¯è½¬æ¢å™¨å³å¯ï¼Œå‰æ–‡æœ‰è¿‡é…ç½®ï¼š[[#^9a12b6]]</li></ul><p>é—®é¢˜ï¼š</p><ol><li>ä¼šæ·»åŠ ä¸€äº›ä¸åŸæœ¬ä¸šåŠ¡æ— å…³çš„å¥å£®æ€§åˆ¤æ–­ï¼Œä¸šåŠ¡ä¾µå…¥é—®é¢˜</li><li>è¿™äº›æ•°æ®åº“çš„æ“ä½œä¹Ÿä¼šå½±å“ä¸šåŠ¡åŸæœ¬çš„æ€§èƒ½</li></ol><h4 id="ä¸šåŠ¡åˆ¤æ–­"><a href="#ä¸šåŠ¡åˆ¤æ–­" class="headerlink" title="ä¸šåŠ¡åˆ¤æ–­"></a>ä¸šåŠ¡åˆ¤æ–­</h4><p>ä¸šåŠ¡åˆ¤æ–­å°±æ˜¯åŸºäºä¸šåŠ¡æœ¬èº«çš„é€»è¾‘æˆ–çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤çš„è¯·æ±‚æˆ–æ¶ˆæ¯ï¼Œä¸åŒçš„ä¸šåŠ¡åœºæ™¯åˆ¤æ–­çš„æ€è·¯ä¹Ÿä¸ä¸€æ ·ã€‚</p><p>ä¾‹å¦‚åœ¨æ”¯ä»˜æ¡ˆä¾‹ä¸­ï¼Œå¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘æ˜¯æŠŠè®¢å•çŠ¶æ€ä»æœªæ”¯ä»˜ä¿®æ”¹ä¸ºå·²æ”¯ä»˜ã€‚å› æ­¤æˆ‘ä»¬åœ¨æ‰§è¡Œä¸šåŠ¡æ—¶åˆ¤æ–­è®¢å•çŠ¶æ€æ˜¯å¦æ˜¯æœªæ”¯ä»˜ï¼Œå¦‚æœä¸æ˜¯åˆ™è¯æ˜è®¢å•å·²ç»è¢«å¤„ç†è¿‡ï¼Œæ— éœ€é‡å¤å¤„ç†ã€‚</p><p>ä¸¤ç§æ–¹æ¡ˆå…¶å®æœ¬è´¨éƒ½æ˜¯åœ¨ä¸šåŠ¡å¤„ç†æ—¶æŸ¥è¯¢æ•°æ®åº“åˆ¤æ–­ï¼Œä¸è¿‡æ¶ˆæ¯IDçš„æ–¹æ¡ˆéœ€è¦æ”¹é€ åŸæœ‰çš„æ•°æ®åº“ï¼Œæ›´æ¨èä½¿ç”¨ä¸šåŠ¡åˆ¤æ–­çš„æ–¹æ¡ˆã€‚</p><p>ä¿®æ”¹<code>OrderServiceImpl</code>ä¸­çš„<code>markOrderPaySuccess</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">old</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­è®¢å•çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (old == <span class="literal">null</span> || old.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// è®¢å•ä¸å­˜åœ¨æˆ–è€…è®¢å•çŠ¶æ€ä¸æ˜¯1ï¼Œæ”¾å¼ƒå¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.å°è¯•æ›´æ–°è®¢å•</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setStatus(<span class="number">2</span>);</span><br><span class="line">    order.setPayTime(LocalDateTime.now());</span><br><span class="line">    updateById(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸Šè¿°ä»£ç é€»è¾‘ä¸Šç¬¦åˆäº†å¹‚ç­‰åˆ¤æ–­çš„éœ€æ±‚ï¼Œä½†æ˜¯ç”±äºåˆ¤æ–­å’Œæ›´æ–°æ˜¯ä¸¤æ­¥åŠ¨ä½œï¼Œå› æ­¤åœ¨æå°æ¦‚ç‡ä¸‹å¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜<br>åˆå¹¶ä¸Šè¿°æ“ä½œï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// UPDATE `order` SET status = ? , pay_time = ? WHERE id = ? AND status = 1</span></span><br><span class="line">    lambdaUpdate()</span><br><span class="line">            .set(Order::getStatus, <span class="number">2</span>)</span><br><span class="line">            .set(Order::getPayTime, LocalDateTime.now())</span><br><span class="line">            .eq(Order::getId, orderId)</span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>)</span><br><span class="line">            .update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸Šè¿°ä»£ç ç­‰åŒäºè¿™æ ·çš„SQLè¯­å¥ï¼š<code>UPDATE </code>order<code> SET status = ? , pay_time = ? WHERE id = ? AND status = 1</code></li><li>åœ¨whereæ¡ä»¶ä¸­é™¤äº†åˆ¤æ–­idä»¥å¤–ï¼Œè¿˜åŠ ä¸Šäº†statuså¿…é¡»ä¸º1çš„æ¡ä»¶ã€‚å¦‚æœæ¡ä»¶ä¸ç¬¦ï¼Œåˆ™SQLåŒ¹é…ä¸åˆ°æ•°æ®ï¼Œæ ¹æœ¬ä¸ä¼šæ‰§è¡Œ(ä¹è§‚é”ï¼ŒåŒå•†å“è¶…å–)</li></ul><h3 id="å…œåº•æ–¹æ¡ˆ"><a href="#å…œåº•æ–¹æ¡ˆ" class="headerlink" title="å…œåº•æ–¹æ¡ˆ"></a>å…œåº•æ–¹æ¡ˆ</h3><p>è™½ç„¶æˆ‘ä»¬åˆ©ç”¨å„ç§æœºåˆ¶å°½å¯èƒ½å¢åŠ äº†æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†ä¹Ÿä¸å¥½è¯´èƒ½ä¿è¯æ¶ˆæ¯100%çš„å¯é ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªå…œåº•æ–¹æ¡ˆæ¥ç¡®ä¿æ¶ˆæ¯çš„å¯é æ€§ã€‚</p><p>è§£å†³æ€æƒ³ï¼š</p><ul><li>æ—¢ç„¶MQé€šçŸ¥ä¸ä¸€å®šå‘é€åˆ°äº¤æ˜“æœåŠ¡ï¼Œé‚£ä¹ˆäº¤æ˜“æœåŠ¡å°±å¿…é¡»è‡ªå·±<strong>ä¸»åŠ¨å»æŸ¥è¯¢</strong>æ”¯ä»˜çŠ¶æ€</li><li>å³ä¾¿æ”¯ä»˜æœåŠ¡çš„MQé€šçŸ¥å¤±è´¥ï¼Œä¾ç„¶èƒ½é€šè¿‡ä¸»åŠ¨æŸ¥è¯¢æ¥ä¿è¯è®¢å•çŠ¶æ€çš„ä¸€è‡´</li></ul><p>å…·ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/01/jEyBJbvifhp3xNH.png" alt="æµç¨‹å›¾"></p><ul><li>å›¾ä¸­é»„è‰²çº¿åœˆèµ·æ¥çš„éƒ¨åˆ†å°±æ˜¯MQé€šçŸ¥å¤±è´¥åçš„å…œåº•å¤„ç†æ–¹æ¡ˆï¼Œç”±äº¤æ˜“æœåŠ¡è‡ªå·±ä¸»åŠ¨å»æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</li></ul><p>è¿™é‡Œæœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œäº¤æ˜“æœåŠ¡å¹¶ä¸çŸ¥é“ç”¨æˆ·ä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ”¯ä»˜ï¼Œå¦‚æœæŸ¥è¯¢çš„æ—¶æœºä¸æ­£ç¡®ï¼ˆæ¯”å¦‚æŸ¥è¯¢çš„æ—¶å€™ç”¨æˆ·æ­£åœ¨æ”¯ä»˜ä¸­ï¼‰ï¼Œå¯èƒ½æŸ¥è¯¢åˆ°çš„æ”¯ä»˜çŠ¶æ€ä¹Ÿä¸æ­£ç¡®ã€‚</p><p>ä»€ä¹ˆæ—¶é—´ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å‘¢ï¼Ÿ</p><ul><li>è¿™ä¸ªæ—¶é—´æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œå› æ­¤ï¼Œé€šå¸¸é‡‡å–çš„æªæ–½å°±æ˜¯åˆ©ç”¨<strong>å®šæ—¶ä»»åŠ¡</strong>å®šæœŸæŸ¥è¯¢ï¼Œä¾‹å¦‚æ¯éš”20ç§’å°±æŸ¥è¯¢ä¸€æ¬¡ï¼Œå¹¶åˆ¤æ–­æ”¯ä»˜çŠ¶æ€ã€‚å¦‚æœå‘ç°è®¢å•å·²ç»æ”¯ä»˜ï¼Œåˆ™ç«‹åˆ»æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜å³å¯</li><li>å®šæ—¶ä»»åŠ¡ï¼šä¾‹å¦‚è‹ç©¹å¤–å–ä¸­çš„å®šæ—¶å¤„ç†è®¢å•</li></ul><p>ç»¼ä¸Šï¼Œæ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯ï¼Ÿ</p><ul><li>é¦–å…ˆï¼Œæ”¯ä»˜æœåŠ¡ä¼šæ­£åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸä»¥ååˆ©ç”¨<em>MQæ¶ˆæ¯é€šçŸ¥</em>äº¤æ˜“æœåŠ¡ï¼Œå®Œæˆè®¢å•çŠ¶æ€åŒæ­¥</li><li>å…¶æ¬¡ï¼Œä¸ºäº†ä¿è¯MQæ¶ˆæ¯çš„å¯é æ€§ï¼Œå¯ä»¥é‡‡ç”¨äº†<em>ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ã€æ¶ˆè´¹è€…ç¡®è®¤ã€æ¶ˆè´¹è€…å¤±è´¥é‡è¯•</em>ç­‰ç­–ç•¥ï¼Œç¡®ä¿æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§</li><li>æœ€åï¼Œè¿˜å¯ä»¥äº¤æ˜“æœåŠ¡è®¾ç½®<em>å®šæ—¶ä»»åŠ¡</em>ï¼Œå®šæœŸæŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€ã€‚è¿™æ ·å³ä¾¿MQé€šçŸ¥å¤±è´¥ï¼Œè¿˜å¯ä»¥åˆ©ç”¨å®šæ—¶ä»»åŠ¡ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿è®¢å•æ”¯ä»˜çŠ¶æ€çš„æœ€ç»ˆä¸€è‡´æ€§</li><li>è¿™æ ·ä¸‹æ¥ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘å¤„ç†ä¸€æ¬¡</li></ul><h2 id="å››ã€å»¶è¿Ÿæ¶ˆæ¯"><a href="#å››ã€å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="å››ã€å»¶è¿Ÿæ¶ˆæ¯"></a>å››ã€å»¶è¿Ÿæ¶ˆæ¯</h2><p>åœ¨ç”µå•†çš„æ”¯ä»˜ä¸šåŠ¡ä¸­ï¼Œå¯¹äºä¸€äº›&#x3D;&#x3D;åº“å­˜æœ‰é™&#x3D;&#x3D;çš„å•†å“ï¼Œä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œé€šå¸¸éƒ½ä¼šåœ¨ç”¨æˆ·ä¸‹å•æ—¶ç«‹åˆ»æ‰£å‡å•†å“åº“å­˜ã€‚<br>ä¾‹å¦‚ï¼šç”µå½±é™¢è´­ç¥¨ã€é«˜é“è´­ç¥¨ï¼Œä¸‹å•åå°±ä¼šé”å®šåº§ä½èµ„æºï¼Œå…¶ä»–äººæ— æ³•é‡å¤è´­ä¹°ã€‚</p><p>å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå‡å¦‚ç”¨æˆ·ä¸‹å•åä¸€ç›´ä¸ä»˜æ¬¾ï¼Œå°±ä¼šä¸€ç›´å æœ‰åº“å­˜èµ„æºï¼Œå¯¼è‡´å…¶ä»–å®¢æˆ·æ— æ³•æ­£å¸¸äº¤æ˜“ï¼Œæœ€ç»ˆå¯¼è‡´å•†æˆ·åˆ©ç›Šå—æŸï¼<br>æ‰€ä»¥ï¼Œç”µå•†ä¸­é€šå¸¸çš„åšæ³•å°±æ˜¯ï¼š<strong>å¯¹äºè¶…è¿‡ä¸€å®šæ—¶é—´æœªæ”¯ä»˜çš„è®¢å•ï¼Œåº”è¯¥ç«‹åˆ»å–æ¶ˆè®¢å•å¹¶é‡Šæ”¾å ç”¨çš„åº“å­˜</strong>ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœè®¾ç½®è®¢å•æ”¯ä»˜è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œé‚£ä¹ˆåº”è¯¥åœ¨ç”¨æˆ·ä¸‹å•åçš„ç¬¬30åˆ†é’Ÿæ£€æŸ¥è®¢å•æ”¯ä»˜çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœªæ”¯ä»˜ï¼Œåº”è¯¥ç«‹åˆ»å–æ¶ˆè®¢å•ï¼Œé‡Šæ”¾åº“å­˜ã€‚</p><p>ä½†é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•æ‰èƒ½å‡†ç¡®çš„å®ç°åœ¨ä¸‹å•åç¬¬30åˆ†é’Ÿå»æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å‘¢ï¼Ÿ</p><ol><li>åƒè¿™ç§åœ¨ä¸€æ®µæ—¶é—´ä»¥åæ‰æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>å»¶è¿Ÿä»»åŠ¡</strong>ï¼Œè€Œè¦å®ç°å»¶è¿Ÿä»»åŠ¡ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ©ç”¨MQçš„å»¶è¿Ÿæ¶ˆæ¯äº†</li><li>åœ¨RabbitMQä¸­å®ç°å»¶è¿Ÿæ¶ˆæ¯æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š<ol><li>æ­»ä¿¡äº¤æ¢æœº+TTL</li><li>å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶</li></ol></li></ol><p>ä¸‹é¢åˆ†æä¸¤ç§æ–¹æ¡ˆçš„å®ç°å’Œä¼˜ç¼ºç‚¹</p><h3 id="æ­»ä¿¡äº¤æ¢æœºå’Œå»¶è¿Ÿæ¶ˆæ¯"><a href="#æ­»ä¿¡äº¤æ¢æœºå’Œå»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="æ­»ä¿¡äº¤æ¢æœºå’Œå»¶è¿Ÿæ¶ˆæ¯"></a>æ­»ä¿¡äº¤æ¢æœºå’Œå»¶è¿Ÿæ¶ˆæ¯</h3><h4 id="ä½•ä¸ºæ­»ä¿¡äº¤æ¢æœº"><a href="#ä½•ä¸ºæ­»ä¿¡äº¤æ¢æœº" class="headerlink" title="ä½•ä¸ºæ­»ä¿¡äº¤æ¢æœº"></a>ä½•ä¸ºæ­»ä¿¡äº¤æ¢æœº</h4><p>å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥æˆä¸ºæ­»ä¿¡ï¼ˆdead letterï¼‰ï¼š</p><ul><li>æ¶ˆè´¹è€…ä½¿ç”¨<code>basic.reject</code>æˆ– <code>basic.nack</code>å£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„<code>requeue</code>å‚æ•°è®¾ç½®ä¸ºfalse</li><li>æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹</li><li>è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯æ»¡äº†ï¼Œæ— æ³•æŠ•é€’</li></ul><p>å¦‚æœä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å·²ç»æˆä¸ºæ­»ä¿¡ï¼Œå¹¶ä¸”è¿™ä¸ªé˜Ÿåˆ—é€šè¿‡<code>dead-letter-exchange</code>å±æ€§æŒ‡å®šäº†ä¸€ä¸ªäº¤æ¢æœºï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„æ­»ä¿¡å°±ä¼šæŠ•é€’åˆ°è¿™ä¸ªäº¤æ¢æœºä¸­ï¼Œè€Œè¿™ä¸ªäº¤æ¢æœºå°±ç§°ä¸º<strong>æ­»ä¿¡äº¤æ¢æœº</strong>ï¼ˆDead Letter Exchangeï¼‰ã€‚å¦‚æœæœ‰é˜Ÿåˆ—ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šï¼Œé‚£ä¹ˆæ­»ä¿¡æœ€ç»ˆå°±ä¼šè¢«æŠ•é€’åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­</p><p>æ­»ä¿¡äº¤æ¢æœºçš„ä½œç”¨</p><ol><li>æ”¶é›†é‚£äº›å› å¤„ç†å¤±è´¥è€Œè¢«æ‹’ç»çš„æ¶ˆæ¯</li><li>æ”¶é›†é‚£äº›å› é˜Ÿåˆ—æ»¡äº†è€Œè¢«æ‹’ç»çš„æ¶ˆæ¯</li><li>æ”¶é›†å› TTLï¼ˆæœ‰æ•ˆæœŸï¼‰åˆ°æœŸçš„æ¶ˆæ¯</li></ol><h4 id="ä½•ä¸ºå»¶è¿Ÿæ¶ˆæ¯"><a href="#ä½•ä¸ºå»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="ä½•ä¸ºå»¶è¿Ÿæ¶ˆæ¯"></a>ä½•ä¸ºå»¶è¿Ÿæ¶ˆæ¯</h4><p>å‰é¢ä¸¤ç§ä½œç”¨åœºæ™¯å¯ä»¥çœ‹åšæ˜¯æŠŠæ­»ä¿¡äº¤æ¢æœºå½“åšä¸€ç§æ¶ˆæ¯å¤„ç†çš„æœ€ç»ˆå…œåº•æ–¹æ¡ˆï¼Œä¸æ¶ˆè´¹è€…é‡è¯•ä¸­çš„<code>RepublishMessageRecoverer</code>ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯æŠŠä¸€ä¸ªæ¶ˆæ¯æ”¾å…¥æŒ‡å®šçš„é˜Ÿåˆ—æˆ–äº¤æ¢æœºä¸­ã€‚</p><p>åœºæ™¯å‘ˆç°ï¼š</p><ul><li>å¦‚ä¸‹å›¾ï¼Œæœ‰ä¸€ç»„ç»‘å®šçš„äº¤æ¢æœºï¼ˆ<code>ttl.fanout</code>ï¼‰å’Œé˜Ÿåˆ—ï¼ˆ<code>ttl.queue</code>ï¼‰ã€‚ä½†æ˜¯<code>ttl.queue</code>æ²¡æœ‰æ¶ˆè´¹è€…ç›‘å¬ï¼Œè€Œæ˜¯è®¾å®šäº†æ­»ä¿¡äº¤æ¢æœº<code>hmall.direct</code>,è€Œé˜Ÿåˆ—<code>direct.queue1</code>åˆ™ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šï¼ŒRouting Keyæ˜¯blue<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/01/KOQw4EfJRMimaXp.png" alt="å»¶è¿Ÿæ¶ˆæ¯åœºæ™¯"></li></ul></li><li>å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°<code>ttl.fanout</code>ï¼ŒRouting Keyä¸ºblueï¼Œå¹¶è®¾ç½®æ¶ˆæ¯çš„<strong>æœ‰æ•ˆæœŸ</strong>ä¸º5000æ¯«ç§’</li><li>æ¶ˆæ¯è¢«æŠ•é€’åˆ°<code>ttl.queue</code>ä¹‹åï¼Œç”±äºæ²¡æœ‰æ¶ˆè´¹è€…ï¼Œå› æ­¤æ¶ˆæ¯æ— äººæ¶ˆè´¹ã€‚5ç§’ä¹‹åï¼Œæ¶ˆæ¯çš„æœ‰æ•ˆæœŸåˆ°æœŸï¼Œæˆä¸ºæ­»ä¿¡</li><li>æ­»ä¿¡è¢«å†æ¬¡æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœº<code>hmall.direct</code>ï¼Œå¹¶æ²¿ç”¨ä¹‹å‰çš„Routing Keyï¼Œä¹Ÿå°±æ˜¯<code>blue</code></li><li>å› æ­¤æœ€ç»ˆæ¶ˆæ¯è¢«æˆåŠŸè·¯ç”±åˆ°<code>direct.queue1</code>ï¼Œå¦‚æœæ­¤æ—¶æœ‰æ¶ˆè´¹è€…ä¸<code>direct.queue1</code>ç»‘å®šï¼Œä¹Ÿå°±èƒ½æˆåŠŸæ¶ˆè´¹æ¶ˆæ¯äº†ã€‚è€Œä¸”ä¹Ÿå·²ç»5ç§’é’Ÿä»¥åäº†</li><li>æœ€ç»ˆ<code>publisher</code>å‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯<code>consumer</code>åœ¨5ç§’åæ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå®ç°äº†æ‰€è°“çš„<strong>å»¶è¿Ÿæ¶ˆæ¯</strong></li></ul><p><strong>æ³¨æ„ï¼š</strong></p><ul><li>æ¶ˆæ¯å˜ä¸ºæ­»ä¿¡å¹¶æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºæ—¶ï¼Œä¼šæ²¿ç”¨ä¹‹å‰çš„Routing Key</li><li>RabbitMQçš„æ¶ˆæ¯è¿‡æœŸæ˜¯åŸºäº<strong>è¿½æº¯æ–¹å¼</strong>æ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªæ¶ˆæ¯çš„TTLåˆ°æœŸä»¥åä¸ä¸€å®šä¼šè¢«ç§»é™¤æˆ–æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºï¼Œè€Œæ˜¯åœ¨æ¶ˆæ¯æ°å¥½å¤„äº<strong>é˜Ÿé¦–</strong>æ—¶æ‰ä¼šè¢«å¤„ç†</li><li>å½“é˜Ÿåˆ—ä¸­æ¶ˆæ¯å †ç§¯å¾ˆå¤šçš„æ—¶å€™ï¼Œè¿‡æœŸæ¶ˆæ¯å¯èƒ½ä¸ä¼šè¢«æŒ‰æ—¶å¤„ç†ï¼Œå› æ­¤è®¾ç½®çš„TTLæ—¶é—´ä¸ä¸€å®šå‡†ç¡®</li></ul><h3 id="DelayExchangeæ’ä»¶"><a href="#DelayExchangeæ’ä»¶" class="headerlink" title="DelayExchangeæ’ä»¶"></a>DelayExchangeæ’ä»¶</h3><p>åŸºäºæ­»ä¿¡é˜Ÿåˆ—è™½ç„¶å¯ä»¥å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼Œä½†æ˜¯å¤ªéº»çƒ¦äº†ã€‚å› æ­¤RabbitMQç¤¾åŒºæä¾›äº†ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶æ¥å®ç°ç›¸åŒçš„æ•ˆæœ</p><ul><li><a href="https://www.rabbitmq.com/blog/2015/04/16/scheduling-messages-with-rabbitmq">å®˜æ–¹æ–‡æ¡£è¯´æ˜</a></li></ul><p>æ’ä»¶ä¸‹è½½åœ°å€ï¼š<code>https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</code>ã€‚<br>ç”±äºdockeréƒ¨ç½²çš„RabbitMQ<code>3.8</code>ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸‹è½½æ’ä»¶<code>3.8.17</code>ç‰ˆæœ¬æœ€å¥½</p><ul><li><code>rabbitmq_delayed_message_exchange-3.8.17.8f537ac.ez</code></li></ul><p>å› ä¸ºåŸºäºDockeréƒ¨ç½²MQï¼Œæ‰€ä»¥éœ€è¦å…ˆæŸ¥çœ‹RabbitMQçš„æ’ä»¶ç›®å½•å¯¹åº”çš„æ•°æ®å·ï¼š<code>docker volume inspect mq-plugins</code>ã€‚æ ¹æ®æŸ¥è¯¢ç»“æœï¼Œå°†ä¸‹è½½å¥½çš„æ’ä»¶ä¸Šä¼ åˆ°å¯¹åº”çš„æ’ä»¶ç›®å½•ä¸‹ã€‚</p><p>ç„¶åæ‰§è¡Œå‘½ä»¤ï¼Œå®‰è£…æ’ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure><h4 id="å£°æ˜å»¶è¿Ÿäº¤æ¢æœº"><a href="#å£°æ˜å»¶è¿Ÿäº¤æ¢æœº" class="headerlink" title="å£°æ˜å»¶è¿Ÿäº¤æ¢æœº"></a>å£°æ˜å»¶è¿Ÿäº¤æ¢æœº</h4><p>åŸºäºæ³¨è§£æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = &quot;delay&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;æ¥æ”¶åˆ°delay.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºäº<code>@Bean</code>çš„æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayExchangeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder</span><br><span class="line">                .directExchange(<span class="string">&quot;delay.direct&quot;</span>) <span class="comment">// æŒ‡å®šäº¤æ¢æœºç±»å‹å’Œåç§°</span></span><br><span class="line">                .delayed() <span class="comment">// è®¾ç½®delayçš„å±æ€§ä¸ºtrue</span></span><br><span class="line">                .durable(<span class="literal">true</span>) <span class="comment">// æŒä¹…åŒ–</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayQueueBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayedQueue()).to(delayExchange()).with(<span class="string">&quot;delay&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‘é€å»¶è¿Ÿæ¶ˆæ¯"><a href="#å‘é€å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="å‘é€å»¶è¿Ÿæ¶ˆæ¯"></a>å‘é€å»¶è¿Ÿæ¶ˆæ¯</h4><p>å‘é€æ¶ˆæ¯é€šè¿‡x-delayå±æ€§è®¾å®šå»¶è¿Ÿæ—¶é—´ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherDelayMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºæ¶ˆæ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, delayed message&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.å‘é€æ¶ˆæ¯ï¼Œåˆ©ç”¨æ¶ˆæ¯åç½®å¤„ç†å™¨æ·»åŠ æ¶ˆæ¯å¤´</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;delay.direct&quot;</span>, <span class="string">&quot;delay&quot;</span>, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">// æ·»åŠ å»¶è¿Ÿæ¶ˆæ¯å±æ€§</span></span><br><span class="line">            message.getMessageProperties().setDelay(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong></p><ul><li>å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªæœ¬åœ°æ•°æ®åº“è¡¨ï¼ŒåŒæ—¶ä½¿ç”¨Elang TimersåŠŸèƒ½å®ç°è®¡æ—¶ã€‚å¦‚æœæ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´è®¾ç½®è¾ƒé•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´å †ç§¯çš„å»¶è¿Ÿæ¶ˆæ¯éå¸¸å¤šï¼Œä¼šå¸¦æ¥è¾ƒå¤§çš„CPUå¼€é”€ï¼ŒåŒæ—¶å»¶è¿Ÿæ¶ˆæ¯çš„æ—¶é—´ä¼šå­˜åœ¨è¯¯å·®</li><li>å› æ­¤ï¼Œ<strong>ä¸å»ºè®®è®¾ç½®å»¶è¿Ÿæ—¶é—´è¿‡é•¿çš„å»¶è¿Ÿæ¶ˆæ¯</strong></li></ul><h3 id="è§£å†³è¶…æ—¶è®¢å•é—®é¢˜"><a href="#è§£å†³è¶…æ—¶è®¢å•é—®é¢˜" class="headerlink" title="è§£å†³è¶…æ—¶è®¢å•é—®é¢˜"></a>è§£å†³è¶…æ—¶è®¢å•é—®é¢˜</h3><p>åœ¨äº¤æ˜“æœåŠ¡ä¸­åˆ©ç”¨<em>å»¶è¿Ÿæ¶ˆæ¯</em>å®ç°è®¢å•è¶…æ—¶å–æ¶ˆåŠŸèƒ½ã€‚å…¶å¤§æ¦‚æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/01/GCorfdTbjhkUn8Z.jpg" alt="è¶…æ—¶å¤„ç†"></li></ul><p>ç†è®ºä¸Šåº”è¯¥åœ¨ä¸‹å•æ—¶å‘é€ä¸€æ¡å»¶è¿Ÿæ¶ˆæ¯ï¼Œè®¾ç½®å»¶è¿Ÿæ—¶é—´ä¸º30åˆ†é’Ÿã€‚è¿™æ ·å°±å¯ä»¥åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ£€éªŒè®¢å•æ”¯ä»˜çŠ¶æ€ï¼Œå…³é—­æœªæ”¯ä»˜è®¢å•ã€‚</p><h4 id="å®šä¹‰å¸¸é‡"><a href="#å®šä¹‰å¸¸é‡" class="headerlink" title="å®šä¹‰å¸¸é‡"></a>å®šä¹‰å¸¸é‡</h4><p>æ— è®ºæ˜¯æ¶ˆæ¯å‘é€è¿˜æ˜¯æ¥æ”¶éƒ½æ˜¯åœ¨äº¤æ˜“æœåŠ¡å®Œæˆï¼Œå› æ­¤åœ¨<code>trade-service</code>ä¸­å®šä¹‰ä¸€ä¸ªå¸¸é‡ç±»ï¼Œç”¨äºè®°å½•äº¤æ¢æœºã€é˜Ÿåˆ—ã€Routing Keyç­‰å¸¸é‡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MQConstants</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.direct&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.order.queue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_KEY</span> <span class="operator">=</span> <span class="string">&quot;delay.order.query&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®MQ-1"><a href="#é…ç½®MQ-1" class="headerlink" title="é…ç½®MQ"></a>é…ç½®MQ</h4><p>åœ¨<code>trade-service</code>æ¨¡å—çš„<code>pom.xml</code>ä¸­å¼•å…¥amqpçš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--amqp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>çœ‹çœ‹hm-commonæœåŠ¡æ˜¯å¦å¼•å…¥äº†amqpçš„ä¾èµ–</li></ul><p>åœ¨<code>trade-service</code>çš„<code>application.yaml</code>ä¸­æ·»åŠ MQçš„é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itheima</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br></pre></td></tr></table></figure><h4 id="æ”¹é€ ä¸‹å•ä¸šåŠ¡ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯"><a href="#æ”¹é€ ä¸‹å•ä¸šåŠ¡ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="æ”¹é€ ä¸‹å•ä¸šåŠ¡ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯"></a>æ”¹é€ ä¸‹å•ä¸šåŠ¡ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯</h4><p>å®—æ—¨ï¼šåœ¨ä¸‹å•å®Œæˆåï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</p><ol><li>ä¿®æ”¹<code>trade-service</code>æ¨¡å—çš„<code>OrderServiceImpl</code>ç±»çš„<code>createOrder</code>æ–¹æ³•ï¼Œæ·»åŠ æ¶ˆæ¯å‘é€çš„ä»£ç ï¼š<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/01/86AwDJbVeIxsBP7.png" alt="æ¶ˆæ¯å‘é€"></li></ol><ul><li>å»¶è¿Ÿæ¶ˆæ¯çš„æ—¶é—´è®¾ç½®ä¸º15åˆ†é’Ÿï¼Œä¸è¿‡ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæ”¹æˆ10ç§’ã€‚</li></ul><h4 id="ç¼–å†™æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€æ¥å£"><a href="#ç¼–å†™æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€æ¥å£" class="headerlink" title="ç¼–å†™æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€æ¥å£"></a>ç¼–å†™æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€æ¥å£</h4><p>ç”±äºMQæ¶ˆæ¯å¤„ç†æ—¶éœ€è¦æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ï¼Œå› æ­¤è¦åœ¨<code>pay-service</code>æ¨¡å—å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„æ¥å£ï¼Œå¹¶æä¾›å¯¹åº”çš„<code>FeignClient</code></p><p>åœ¨<code>hm-api</code>æ¨¡å—å®šä¹‰ä¸‰ä¸ªç±»ï¼š</p><ul><li>PayOrderDTOï¼šæ”¯ä»˜å•çš„æ•°æ®ä¼ è¾“å®ä½“<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ”¯ä»˜è®¢å•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;æ”¯ä»˜å•æ•°æ®ä¼ è¾“å®ä½“&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayOrderDTO</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;ä¸šåŠ¡è®¢å•å·&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bizOrderNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜å•å·&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long payOrderNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜ç”¨æˆ·id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bizUserId;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜æ¸ é“ç¼–ç &quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String payChannelCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜é‡‘é¢ï¼Œå•ä½åˆ†&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer amount;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;ä»˜ç±»å‹ï¼Œ1ï¼šh5,2:å°ç¨‹åºï¼Œ3ï¼šå…¬ä¼—å·ï¼Œ4ï¼šæ‰«ç ï¼Œ5ï¼šä½™é¢æ”¯ä»˜&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer payType;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;ä»˜çŠ¶æ€ï¼Œ0ï¼šå¾…æäº¤ï¼Œ1:å¾…æ”¯ä»˜ï¼Œ2ï¼šæ”¯ä»˜è¶…æ—¶æˆ–å–æ¶ˆï¼Œ3ï¼šæ”¯ä»˜æˆåŠŸ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ‹“å±•å­—æ®µï¼Œç”¨äºä¼ é€’ä¸åŒæ¸ é“å•ç‹¬å¤„ç†çš„å­—æ®µ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String expandJson;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;ç¬¬ä¸‰æ–¹è¿”å›ä¸šåŠ¡ç &quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String resultCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;ç¬¬ä¸‰æ–¹è¿”å›æç¤ºä¿¡æ¯&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String resultMsg;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜æˆåŠŸæ—¶é—´&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime paySuccessTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜è¶…æ—¶æ—¶é—´&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime payOverTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ”¯ä»˜äºŒç»´ç é“¾æ¥&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String qrCodeUrl;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;åˆ›å»ºæ—¶é—´&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ›´æ–°æ—¶é—´&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>PayClientï¼šæ”¯ä»˜ç³»ç»Ÿçš„Feignå®¢æˆ·ç«¯<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;pay-service&quot;, fallbackFactory = PayClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PayClient</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®äº¤æ˜“è®¢å•idæŸ¥è¯¢æ”¯ä»˜å•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id ä¸šåŠ¡è®¢å•id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ”¯ä»˜å•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/pay-orders/biz/&#123;id&#125;&quot;)</span></span><br><span class="line">    PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>PayClientFallbackï¼šæ”¯ä»˜ç³»ç»Ÿçš„fallbacké€»è¾‘<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayClientFallback</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;PayClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PayClient <span class="title function_">create</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PayClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><code>fallbackfactory</code>å†™å®Œä¹‹åï¼Œéœ€è¦åœ¨defaultfeignconfigä¸­æ³¨å…¥beanï¼Œå¦åˆ™æ— æ³•æ‰«æåˆ°è¯¥<code>fallbackfactory</code></li><li>æœ€åï¼Œåœ¨<code>pay-service</code>æ¨¡å—çš„<code>PayController</code>ä¸­å®ç°è¯¥æ¥å£ï¼š<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;æ ¹æ®idæŸ¥è¯¢æ”¯ä»˜å•&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/biz/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">payOrder</span> <span class="operator">=</span> payOrderService.lambdaQuery().eq(PayOrder::getBizOrderNo, id).one();</span><br><span class="line">    <span class="keyword">return</span> BeanUtils.copyBean(payOrder, PayOrderDTO.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="ç›‘å¬æ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€"><a href="#ç›‘å¬æ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€" class="headerlink" title="ç›‘å¬æ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€"></a>ç›‘å¬æ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</h4><p>åœ¨<code>trader-service</code>ç¼–å†™ä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å»¶è¿Ÿæ¶ˆæ¯ï¼ŒæŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDelayMessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PayClient payClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = MQConstants.DELAY_ORDER_QUEUE_NAME),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = MQConstants.DELAY_EXCHANGE_NAME, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            key = MQConstants.DELAY_ORDER_KEY</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenOrderDelayMessage</span><span class="params">(Long orderId)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">        <span class="comment">// 2.æ£€æµ‹è®¢å•çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦å·²æ”¯ä»˜</span></span><br><span class="line">        <span class="keyword">if</span>(order == <span class="literal">null</span> || order.getStatus() != <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">// è®¢å•ä¸å­˜åœ¨æˆ–è€…å·²ç»æ”¯ä»˜</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.æœªæ”¯ä»˜ï¼Œéœ€è¦æŸ¥è¯¢æ”¯ä»˜æµæ°´çŠ¶æ€</span></span><br><span class="line">        <span class="type">PayOrderDTO</span> <span class="variable">payOrder</span> <span class="operator">=</span> payClient.queryPayOrderByBizOrderNo(orderId);</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­æ˜¯å¦æ”¯ä»˜</span></span><br><span class="line">        <span class="keyword">if</span>(payOrder != <span class="literal">null</span> &amp;&amp; payOrder.getStatus() == <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">// 4.1.å·²æ”¯ä»˜ï¼Œæ ‡è®°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜</span></span><br><span class="line">            orderService.markOrderPaySuccess(orderId);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 4.2.æœªæ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•ï¼Œå›å¤åº“å­˜</span></span><br><span class="line">            orderService.cancelOrder(orderId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦å®ç°<code>cancelOrder</code>æ–¹æ³•ï¼š</p><ul><li>åœ¨å¤„ç†è¶…æ—¶æœªæ”¯ä»˜è®¢å•æ—¶ï¼Œå¦‚æœå‘ç°è®¢å•ç¡®å®è¶…æ—¶æœªæ”¯ä»˜ï¼Œæœ€ç»ˆéœ€è¦å…³é—­è¯¥è®¢å•</li><li>å…³é—­è®¢å•éœ€è¦å®Œæˆ<ul><li>å°†è®¢å•çŠ¶æ€ä¿®æ”¹ä¸ºå·²å…³é—­</li><li>æ¢å¤è®¢å•ä¸­å·²ç»æ‰£é™¤çš„åº“å­˜</li></ul></li></ul><p>åœ¨<code>IOrderService</code>æ¥å£ä¸­å®šä¹‰<code>cancelOrder</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">cancelOrder</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨<code>OrderServiceImpl</code>ä¸­å®ç°è¯¥æ–¹æ³•ï¼Œå®ç°è¿‡ç¨‹ä¸­è¿˜è¦æ³¨æ„ä¸šåŠ¡å¹‚ç­‰æ€§çš„åˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelOrder</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    <span class="comment">//å°†è®¢å•çŠ¶æ€ä¿®æ”¹ä¸ºå·²å…³é—­  </span></span><br><span class="line">    orderService.lambdaUpdate()  </span><br><span class="line">            .set(Order::getStatus, <span class="number">5</span>)  </span><br><span class="line">            .eq(Order::getId, orderId)  </span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>)  </span><br><span class="line">            .update();  </span><br><span class="line">    <span class="comment">//æ¢å¤è®¢å•ä¸­å·²ç»æ‰£é™¤çš„åº“å­˜  </span></span><br><span class="line">    List&lt;OrderDetail&gt; list = detailService.lambdaQuery()  </span><br><span class="line">            .eq(OrderDetail::getOrderId, orderId)  </span><br><span class="line">            .list();  </span><br><span class="line">    <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty())&#123;  </span><br><span class="line">        <span class="keyword">return</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    List&lt;OrderDetailDTO&gt; items = BeanUtils.copyList(list, OrderDetailDTO.class);  </span><br><span class="line">    itemClient.recoveryStock(items);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€æŠ½å–MQå·¥å…·"><a href="#äº”ã€æŠ½å–MQå·¥å…·" class="headerlink" title="äº”ã€æŠ½å–MQå·¥å…·"></a>äº”ã€æŠ½å–MQå·¥å…·</h2><p>é™¤äº†æ”¶å‘æ¶ˆæ¯ä»¥å¤–ï¼Œæ¶ˆæ¯å¯é æ€§çš„å¤„ç†ã€ç”Ÿäº§è€…ç¡®è®¤ã€æ¶ˆè´¹è€…ç¡®è®¤ã€å»¶è¿Ÿæ¶ˆæ¯ç­‰ç­‰ç¼–ç ç›¸å¯¹æ¯”è¾ƒå¤æ‚ã€‚<br>å› æ­¤ï¼Œæˆ‘ä»¬å°†å¸¸ç”¨çš„æ“ä½œå°è£…ä¸ºå·¥å…·ï¼Œæ–¹ä¾¿åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ã€‚å¦‚ä¸‹ï¼š</p><ul><li>å°†RabbitMQçš„yamlé…ç½®æŠ½å–åˆ°nacosä¸­ï¼Œä½œä¸ºå…±äº«é…ç½®ï¼Œæ›¿æ¢æ‰€æœ‰å¾®æœåŠ¡ä¸­çš„è‡ªå®šä¹‰MQé…ç½®</li><li>åœ¨<code>hm-commom</code>æ¨¡å—ä¸‹ç¼–å†™å‘é€æ¶ˆæ¯çš„å·¥å…·ç±»<code>RabbitMqHelper</code></li><li>å®šä¹‰ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»<code>MqConsumeErrorAutoConfiguration</code>ï¼Œå†…å®¹åŒ…æ‹¬ï¼š<ul><li>å£°æ˜ä¸€ä¸ªäº¤æ¢æœºï¼Œåä¸º<code>error.direct</code>ï¼Œç±»å‹ä¸º<code>direct</code></li><li>å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåä¸ºï¼š<code>å¾®æœåŠ¡å + error.queue</code>ï¼ŒåŠ¨æ€è·å–</li><li>å°†é˜Ÿåˆ—ä¸äº¤æ¢æœºç»‘å®šï¼Œç»‘å®šæ—¶çš„<code>Routing Key</code>å°±æ˜¯<code>å¾®æœåŠ¡å</code></li><li>å£°æ˜<code>RepublishMessageRecoverer</code>ï¼Œæ¶ˆè´¹å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°ä¸Šè¿°äº¤æ¢æœº</li><li>ç»™é…ç½®ç±»æ·»åŠ æ¡ä»¶ï¼Œå½“<code>spring.rabbitmq.listener.simple.retry.enabled</code>ä¸º<code>true</code>æ—¶è§¦å‘</li></ul></li></ul><p>RabbitMqHelperçš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMqHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, Object msg)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayMessage</span><span class="params">(String exchange, String routingKey, Object msg, <span class="type">int</span> delay)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageWithConfirm</span><span class="params">(String exchange, String routingKey, Object msg, <span class="type">int</span> maxRetries)</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> é»‘é©¬å­¦ä¹ è¯¾ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¶ˆæ¯é˜Ÿåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…¨å±€å”¯ä¸€ID</title>
      <link href="/cn/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID/"/>
      <url>/cn/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID/</url>
      
        <content type="html"><![CDATA[<h1 id="å…¨å±€IDï¼ˆåˆ†å¸ƒå¼IDï¼‰"><a href="#å…¨å±€IDï¼ˆåˆ†å¸ƒå¼IDï¼‰" class="headerlink" title="å…¨å±€IDï¼ˆåˆ†å¸ƒå¼IDï¼‰"></a>å…¨å±€IDï¼ˆåˆ†å¸ƒå¼IDï¼‰</h1><blockquote><p>å…¨å±€IDç”Ÿæˆå™¨ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ã€‚</p></blockquote><ul><li>ç‰¹æ€§<ul><li>å”¯ä¸€æ€§</li><li>é«˜å¯ç”¨</li><li>é«˜æ€§èƒ½</li><li>é€’å¢æ€§</li><li>å®‰å…¨æ€§</li></ul></li></ul><h2 id="IDçš„ç»„æˆéƒ¨åˆ†"><a href="#IDçš„ç»„æˆéƒ¨åˆ†" class="headerlink" title="IDçš„ç»„æˆéƒ¨åˆ†"></a>IDçš„ç»„æˆéƒ¨åˆ†</h2><ol><li>ç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0ã€‚</li><li>æ—¶é—´æˆ³ï¼š31bitï¼Œå¯ä»¥ä½¿ç”¨69å¹´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚</li><li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒIDã€‚</li></ol><h2 id="ç”Ÿæˆç­–ç•¥"><a href="#ç”Ÿæˆç­–ç•¥" class="headerlink" title="ç”Ÿæˆç­–ç•¥"></a>ç”Ÿæˆç­–ç•¥</h2><h3 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h3><blockquote><p>UUIDæ˜¯ä¸€ç§ç”±æ—¶é—´æˆ³ã€èŠ‚ç‚¹IDå’Œéšæœºæ•°ç”Ÿæˆçš„128ä½æ ‡è¯†ç¬¦ã€‚</p></blockquote><h4 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><ul><li>å½“å‰æ—¥æœŸå’Œæ—¶é—´</li><li>æ—¶é’Ÿåºåˆ—</li><li>éšæœºæ•°</li><li>å…¨å±€å”¯ä¸€çš„IEEEæœºå™¨è¯†åˆ«å·<ul><li>IEEEæœºå™¨è¯†åˆ«å·æ˜¯ä¸€ç§å…¨å±€å”¯ä¸€çš„è¯†åˆ«ç ï¼Œé€šå¸¸ä»ç½‘ç»œæ¥å£æ§åˆ¶å™¨ï¼ˆNICï¼‰çš„MACåœ°å€è·å–ã€‚</li></ul></li></ul><h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><h5 id="java-util-UUIDç±»"><a href="#java-util-UUIDç±»" class="headerlink" title="java.util.UUIDç±»"></a>java.util.UUIDç±»</h5><ul><li>ç¤ºä¾‹<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUUid</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> java.util.UUID.randomUUID().toString();</span><br><span class="line">    System.out.println(<span class="string">&quot;id = &quot;</span> + id);</span><br><span class="line">    <span class="comment">//id = ee43a4bb-3405-4e8d-a9ca-95aede99001d</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="cn-hutool-core-lang-UUIDç±»"><a href="#cn-hutool-core-lang-UUIDç±»" class="headerlink" title="cn.hutool.core.lang.UUIDç±»"></a>cn.hutool.core.lang.UUIDç±»</h5><ul><li>åŠŸèƒ½æ›´åŠ å®Œå–„</li><li>ç¤ºä¾‹</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUUid</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id1</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>); <span class="comment">// æ²¡æœ‰â€œ-â€</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id2</span> <span class="operator">=</span> UUID.randomUUID().toString(); <span class="comment">// é»˜è®¤false</span></span><br><span class="line">    System.out.println(<span class="string">&quot;id1 = &quot;</span> + id1);</span><br><span class="line">    System.out.println(<span class="string">&quot;id2 = &quot;</span> + id2);</span><br><span class="line">    <span class="comment">//id1 = 82d847deca8c41f5b2ec9171bc3a845a</span></span><br><span class="line">    <span class="comment">//id2 = ee43a4bb-3405-4e8d-a9ca-95aede99001d</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><ul><li>ä¼˜ç‚¹<ul><li>å®ç°ç®€å•ã€‚</li><li>ä¸ä¾èµ–äºæ•°æ®åº“ç­‰å¤–éƒ¨å› ç´ ã€‚</li></ul></li><li>ç¼ºç‚¹<ul><li>å…¶å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæ•°æ®åº“å ç”¨å†…å­˜å¤§ã€‚</li><li>ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é€’å¢æœ‰åºï¼Œæ•°æ®åº“ç´¢å¼•æ€§èƒ½å·®ã€‚</li></ul></li></ul><h3 id="Redisè‡ªå¢"><a href="#Redisè‡ªå¢" class="headerlink" title="Redisè‡ªå¢"></a>Redisè‡ªå¢</h3><ul><li>å¯¹äºå¤§å‹ç³»ç»Ÿæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Redisæ¥ç”ŸæˆIDï¼Œä¸»è¦æ˜¯ä¾èµ–äº Redis æ˜¯<strong>å•çº¿ç¨‹</strong>çš„ï¼Œå› æ­¤å¯ä»¥ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€ID</li><li>è¦å®ç°è¿™ä¸ªåŠŸèƒ½æˆ‘ä»¬å¯ä»¥ç”¨<strong>Redis çš„åŸå­æ“ä½œ INCRå’ŒINCRBY</strong>æ¥å®ç°ï¼›ä¸»è¦æ€æƒ³æ˜¯åˆ©ç”¨Rediså•çº¿ç¨‹ç‰¹æ€§ä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™æ ·è¯»å†™åŒä¸€keyæ—¶ä¸ä¼šå‡ºç°ä¸åŒçš„æ•°æ®</li></ul><h4 id="ç»„æˆ-1"><a href="#ç»„æˆ-1" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><ul><li>ç¬¦å·ä½ï¼ˆ1bitï¼‰ + æ—¶é—´æˆ³  (31bit) + è®¡æ•°å™¨ (32bit)</li></ul><h4 id="Redisè‡ªå¢IDç­–ç•¥"><a href="#Redisè‡ªå¢IDç­–ç•¥" class="headerlink" title="Redisè‡ªå¢IDç­–ç•¥"></a>Redisè‡ªå¢IDç­–ç•¥</h4><ul><li>ç¤ºä¾‹</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisWorker</span> &#123;</span><br><span class="line">    <span class="comment">//åŸå§‹æ—¶é—´æˆ³BASE_TIME</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1704067200L</span>;</span><br><span class="line">    <span class="comment">//ç§»åŠ¨çš„ä½æ•°bit</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BIT</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">//1ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowEpochSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="comment">//æ—¶é—´å·®</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowEpochSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">//2ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">//2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">//2.2.è‡ªå¢é•¿</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line">        <span class="comment">//3æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BIT | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼˜ç¼ºç‚¹-1"><a href="#ä¼˜ç¼ºç‚¹-1" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><ul><li>ä¼˜ç‚¹<ul><li>Redisæ˜¯<strong>åŸºäºå•çº¿ç¨‹</strong>çš„ï¼Œèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚è€Œä¸”Redisæ˜¯åŸºäºå†…å­˜çš„ï¼Œåœ¨<strong>å¹¶å‘æ€§èƒ½</strong>ç›¸æ¯”äºæ•°æ®åº“è¾ƒå¿«ä¸€äº›</li><li>rediså¯ä»¥ä¿è¯IDçš„å”¯ä¸€æ€§</li><li>ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œçµæ´»æ–¹ä¾¿</li></ul></li><li>ç¼ºç‚¹<ul><li>å¯èƒ½æ•°æ®ä¼šä¸¢å¤±</li><li>éœ€è¦ç¼–ç å’Œé…ç½®çš„å·¥ä½œé‡æ¯”è¾ƒå¤§</li></ul></li></ul><h3 id="Snowflakeç®—æ³•"><a href="#Snowflakeç®—æ³•" class="headerlink" title="Snowflakeç®—æ³•"></a>Snowflakeç®—æ³•</h3><blockquote><p>Snowflakeç®—æ³•æ˜¯Twitterå¼€æºçš„ä¸€ç§åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå”¯ä¸€ä¸”æœ‰åºçš„IDã€‚<br>ç”Ÿæˆåæ˜¯ä¸€ä¸ª 64bit çš„ long å‹çš„<strong>æ•°å€¼</strong>ï¼Œç»„æˆéƒ¨åˆ†å¼•å…¥äº†<strong>æ—¶é—´æˆ³</strong>ï¼ŒåŸºæœ¬ä¿æŒäº†<strong>è‡ªå¢</strong></p></blockquote><ul><li><a href="https://github.com/cloudyan/snowflake?tab=readme-ov-file">Snowflake-github</a></li></ul><h4 id="ä½¿ç”¨åŸå› "><a href="#ä½¿ç”¨åŸå› " class="headerlink" title="ä½¿ç”¨åŸå› "></a>ä½¿ç”¨åŸå› </h4><ul><li>ç°åœ¨çš„æœåŠ¡åŸºæœ¬æ˜¯åˆ†å¸ƒå¼ã€å¾®æœåŠ¡å½¢å¼çš„ï¼Œè€Œå¤§æ•°æ®é‡ä¹Ÿå¯¼è‡´<strong>åˆ†åº“åˆ†è¡¨</strong>çš„äº§ç”Ÿï¼Œå¯¹äºæ°´å¹³åˆ†è¡¨å°±éœ€è¦ä¿è¯è¡¨ä¸­ id çš„å…¨å±€å”¯ä¸€æ€§ã€‚</li><li>ç¡®ä¿æ°´å¹³åˆ†è¡¨ä¹‹åçš„ä¸»é”® id å”¯ä¸€æ€§å’Œè‡ªå¢æ€§ã€‚</li></ul><h4 id="ç»„æˆ-2"><a href="#ç»„æˆ-2" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><ul><li>SnowFlakeç®—æ³•ç”Ÿæˆidçš„ç»“æœæ˜¯ä¸€ä¸ª<strong>64bitå¤§å°çš„æ•´æ•°</strong></li><li>1bitï¼Œä¸ä½¿ç”¨ã€‚äºŒè¿›åˆ¶ä¸­æœ€é«˜ä½ä¸º1çš„éƒ½æ˜¯è´Ÿæ•°ï¼Œä½†æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„idä¸€èˆ¬éƒ½ä½¿ç”¨æ•´æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªæœ€é«˜ä½å›ºå®šæ˜¯0</li><li>41bitï¼Œç”¨æ¥è®°å½•æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰<ul><li>41bitå¯ä»¥è¡¨ç¤º <code>2^&#123;41&#125;-1 </code>ä¸ªæ•°å­—</li><li>å¦‚æœåªç”¨æ¥è¡¨ç¤ºæ­£æ•´æ•°ï¼ˆè®¡ç®—æœºä¸­æ­£æ•°åŒ…å«0ï¼‰ï¼Œå¯ä»¥è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´æ˜¯ï¼š0 è‡³ <code>2^&#123;41&#125;-1</code>ï¼Œå‡1æ˜¯å› ä¸ºå¯è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´æ˜¯ä»0å¼€å§‹ç®—çš„ï¼Œè€Œä¸æ˜¯1</li><li>ä¹Ÿå°±æ˜¯è¯´41bitå¯ä»¥è¡¨ç¤º<code>2^&#123;41&#125;-1</code>ä¸ªæ¯«ç§’çš„å€¼ï¼Œè½¬åŒ–æˆå•ä½å¹´åˆ™æ˜¯<code>(2^&#123;41&#125;-1) / (1000 * 60 * 60 * 24 * 365) = 69</code>å¹´</li></ul></li><li>10bitï¼Œç”¨æ¥è®°å½•<strong>å·¥ä½œæœºå™¨id</strong><ul><li>å¯ä»¥éƒ¨ç½²åœ¨<code>2^&#123;10&#125; = 1024</code>ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬5ä½<strong>datacenterId</strong>å’Œ5ä½<strong>workerId</strong></li><li>5ä½ï¼ˆbitï¼‰å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯<code>2^&#123;5&#125;-1 = 31</code>ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€â€¦.31è¿™32ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºä¸åŒçš„datecenterIdæˆ–workerId</li></ul></li><li>12bitï¼Œåºåˆ—å·ï¼Œç”¨æ¥è®°å½•<strong>åŒæ¯«ç§’å†…äº§ç”Ÿçš„ä¸åŒid</strong><ul><li>12ä½ï¼ˆbitï¼‰å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯<code>2^&#123;12&#125;-1 = 4095</code>ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€â€¦.4094è¿™4095ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºåŒä¸€æœºå™¨åŒä¸€æ—¶é—´æˆªï¼ˆæ¯«ç§’)å†…äº§ç”Ÿçš„4095ä¸ªIDåºå·</li></ul></li><li><strong>0 - 41ä½æ—¶é—´æˆ³ - 5ä½æ•°æ®ä¸­å¿ƒæ ‡è¯† - 5ä½æœºå™¨æ ‡è¯† - 12ä½åºåˆ—å·</strong></li></ul><h4 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h4><h5 id="æ–¹æ¡ˆä¸€"><a href="#æ–¹æ¡ˆä¸€" class="headerlink" title="æ–¹æ¡ˆä¸€"></a>æ–¹æ¡ˆä¸€</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowFlake</span>&#123;</span><br><span class="line">    <span class="comment">//èµ·å§‹æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> startTimeStamp;</span><br><span class="line">    <span class="comment">//æœºå™¨ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> workID;</span><br><span class="line">    <span class="comment">//æ•°æ®ä¸­å¿ƒID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span>  dataCenterID;</span><br><span class="line">    <span class="comment">//åºåˆ—å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> sequence;</span><br><span class="line">    <span class="comment">//æ•°æ®ä¸­å¿ƒIDç§»åŠ¨ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> dataCenterIndex;</span><br><span class="line">    <span class="comment">//æœºå™¨IDç§»åŠ¨ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> workIDIndex;</span><br><span class="line">    <span class="comment">//æ—¶é—´æˆ³ç§»åŠ¨ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> timeStampIndex;</span><br><span class="line">    <span class="comment">//è®°å½•ä¸Šä¸€æ¬¡æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> lastTimeStamp;</span><br><span class="line">    <span class="comment">//åºåˆ—å·æ©ç </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> sequenceMask;</span><br><span class="line">    <span class="comment">//åºåˆ—å·é•¿åº¦12ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> sequenceLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–æ•°æ®ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡é…ç½®yamlæ–‡ä»¶å®ç°ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        startTimeStamp = <span class="number">1577808000000L</span>;</span><br><span class="line">        <span class="comment">//è®¾ç½®æœºå™¨ç¼–å· 1</span></span><br><span class="line">        workID = <span class="number">1L</span>;</span><br><span class="line">        <span class="comment">//è®¾ç½®æ•°æ®ä¸­å¿ƒID 1</span></span><br><span class="line">        dataCenterID = <span class="number">1L</span>;</span><br><span class="line">        <span class="comment">//èµ·å§‹åºåˆ—å· 0å¼€å§‹</span></span><br><span class="line">        sequence = <span class="number">0L</span>;</span><br><span class="line">        <span class="comment">//æ•°æ®ä¸­å¿ƒä½ç§»ä½æ•°</span></span><br><span class="line">        dataCenterIndex = <span class="number">12L</span>;</span><br><span class="line">        <span class="comment">//æœºå™¨IDä½ç§»ä½æ•°</span></span><br><span class="line">        workIDIndex = <span class="number">17L</span>;</span><br><span class="line">        <span class="comment">//æ—¶é—´æˆ³ä½ç§»ä½æ•°</span></span><br><span class="line">        timeStampIndex = <span class="number">22L</span>;</span><br><span class="line">        <span class="comment">//è®°å½•ä¸Šæ¬¡æ—¶é—´æˆ³</span></span><br><span class="line">        lastTimeStamp = -<span class="number">1L</span>;</span><br><span class="line">        <span class="comment">//åºåˆ—å·é•¿åº¦</span></span><br><span class="line">        sequenceLength = <span class="number">12L</span>;</span><br><span class="line">        <span class="comment">//åºåˆ—å·æ©ç </span></span><br><span class="line">        sequenceMask = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; sequenceLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”ŸæˆId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//è·å¾—å½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//å½“å‰ç³»ç»Ÿæ—¶é—´å°äºä¸Šä¸€æ¬¡è®°å½•æ—¶é—´</span></span><br><span class="line">        <span class="keyword">if</span> (now &lt; lastTimeStamp)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ—¶é’Ÿå›æ‹¨å¼‚å¸¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç›¸åŒæ—¶é—´ è¦åºåˆ—å·è¿›åˆ¶å¢é‡</span></span><br><span class="line">        <span class="keyword">if</span> (now == lastTimeStamp)&#123;</span><br><span class="line">            <span class="comment">//é˜²æ­¢æº¢å‡º</span></span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; sequenceMask;</span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0L</span>)&#123;</span><br><span class="line">                <span class="comment">//æº¢å‡ºå¤„ç†</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//è·å–ä¸‹ä¸€æ¯«ç§’æ—¶é—´ ï¼ˆæœ‰é”ï¼‰</span></span><br><span class="line">                now = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//ç½®0 ä¹‹å‰åºåˆ—å·åŒä¸€æ—¶é—´å¹¶å‘åè‡ªå¢ åˆ°è¿™é‡Œè¯´æ˜æ—¶é—´ä¸åŒäº† ç‰ˆæœ¬å·æ‰€ä»¥ç½®0</span></span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®°å½•å½“å‰æ—¶é—´</span></span><br><span class="line">        lastTimeStamp = now;</span><br><span class="line">        <span class="comment">//å½“å‰æ—¶é—´å’Œèµ·å§‹æ—¶é—´æ’å€¼ å³ç§» 22ä½</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">handleTimeStamp</span> <span class="operator">=</span> (now - startTimeStamp) &lt;&lt; timeStampIndex;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¸­å¿ƒæ•°å€¼ å³ç§»åŠ¨ 17ä½ å¹¶ä¸” æŒ‰ä½æˆ–</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">handleWorkID</span> <span class="operator">=</span> (dataCenterID &lt;&lt; dataCenterIndex) | handleTimeStamp;</span><br><span class="line">        <span class="comment">// æœºå™¨IDæ•°å€¼ å³ç§»åŠ¨ 12ä½ å¹¶ä¸” æŒ‰ä½æˆ–</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">handleDataCenterID</span> <span class="operator">=</span> (workID &lt;&lt; workIDIndex) | handleWorkID;</span><br><span class="line">        <span class="comment">// åºåˆ—å· æŒ‰ä½æˆ–</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">ID</span> <span class="operator">=</span> handleDataCenterID | sequence;</span><br><span class="line">        <span class="keyword">return</span> ID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="æ–¹æ¡ˆäºŒ"><a href="#æ–¹æ¡ˆäºŒ" class="headerlink" title="æ–¹æ¡ˆäºŒ"></a>æ–¹æ¡ˆäºŒ</h5><ul><li>å¯¼å…¥å®ç°é›ªèŠ±ç®—æ³•çš„ä¾èµ–<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ç¤ºä¾‹</li></ul></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUUid3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Snowflake</span> <span class="variable">snowflake</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Snowflake</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> snowflake.nextId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">iDString</span> <span class="operator">=</span> snowflake.nextIdStr();</span><br><span class="line">    System.out.println(id);</span><br><span class="line">    System.out.println(iDString);</span><br><span class="line">    <span class="comment">//1797601410943664128</span></span><br><span class="line">    <span class="comment">//1797601410943664129</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="æ–¹æ¡ˆä¸‰"><a href="#æ–¹æ¡ˆä¸‰" class="headerlink" title="æ–¹æ¡ˆä¸‰"></a>æ–¹æ¡ˆä¸‰</h5><ul><li>IdGenerator-Java<ul><li>é›ªèŠ±é£˜ç§»ç®—æ³•-Github<code>https://github.com/yitter/idgenerator/tree/master/Java</code></li></ul></li><li>ç»„æˆ<ul><li>ç¬¬1éƒ¨åˆ†ï¼Œæ—¶é—´å·®ï¼Œæ˜¯ç”ŸæˆIDæ—¶çš„ç³»ç»Ÿæ—¶é—´å‡å» BaseTime çš„æ€»æ—¶é—´å·®ï¼ˆæ¯«ç§’å•ä½ï¼‰ã€‚</li><li>ç¬¬2éƒ¨åˆ†ï¼ŒWorkerIdï¼Œæ˜¯åŒºåˆ†ä¸åŒæœºå™¨æˆ–ä¸åŒåº”ç”¨çš„å”¯ä¸€IDï¼Œæœ€å¤§å€¼ç”± WorkerIdBitLengthï¼ˆé»˜è®¤6ï¼‰é™å®šã€‚</li><li>ç¬¬3éƒ¨åˆ†ï¼Œåºåˆ—æ•°ï¼Œæ˜¯æ¯æ¯«ç§’ä¸‹çš„åºåˆ—æ•°ï¼Œç”±å‚æ•°ä¸­çš„ SeqBitLengthï¼ˆé»˜è®¤6ï¼‰é™å®šã€‚</li></ul></li><li>ç¤ºä¾‹<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.yitter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yitter-idgenerator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å…¨å±€ åˆå§‹åŒ–ï¼ˆåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»º IdGeneratorOptions å¯¹è±¡ï¼Œå¯åœ¨æ„é€ å‡½æ•°ä¸­è¾“å…¥ WorkerId(é»˜è®¤ä¸º0)</span></span><br><span class="line">    <span class="type">IdGeneratorOptions</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdGeneratorOptions</span>();</span><br><span class="line">    <span class="comment">// ä¿å­˜å‚æ•°ï¼ˆåŠ¡å¿…è°ƒç”¨ï¼Œå¦åˆ™å‚æ•°è®¾ç½®ä¸ç”Ÿæ•ˆï¼‰ï¼š</span></span><br><span class="line">    YitIdHelper.setIdGenerator(options);</span><br><span class="line">    <span class="comment">// ä»¥ä¸Šè¿‡ç¨‹åªéœ€å…¨å±€ä¸€æ¬¡ï¼Œä¸”åº”åœ¨ç”ŸæˆIDä¹‹å‰å®Œæˆã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–åï¼Œåœ¨ä»»ä½•éœ€è¦ç”ŸæˆIDçš„åœ°æ–¹ï¼Œè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</span></span><br><span class="line"><span class="type">long</span> <span class="variable">newId</span> <span class="operator">=</span> YitIdHelper.nextId();</span><br><span class="line"><span class="comment">//æ²¡æœ‰åˆå§‹åŒ–ä¹Ÿå¯ä»¥ç”Ÿæˆid,ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„DefaultIdGenerator</span></span><br><span class="line"><span class="keyword">if</span> (idGenInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">    idGenInstance = <span class="keyword">new</span> <span class="title class_">DefaultIdGenerator</span>(<span class="keyword">new</span> <span class="title class_">IdGeneratorOptions</span>((<span class="type">short</span>)<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="æ–¹æ¡ˆå››"><a href="#æ–¹æ¡ˆå››" class="headerlink" title="æ–¹æ¡ˆå››"></a>æ–¹æ¡ˆå››</h5><ul><li>å¼€æºåˆ†å¸ƒå¼ ID æ¡†æ¶<ul><li>ç¾å›¢ Leafï¼š<code>https://github.com/Meituan-Dianping/Leaf</code></li><li>ç™¾åº¦ Uidï¼š<code>https://github.com/baidu/uid-generator</code></li></ul></li><li>ç¤ºä¾‹<ul><li>å¼•å…¥ä¾èµ–</li><li>æå®šé…ç½®</li></ul></li></ul><h4 id="ä¼˜ç¼ºç‚¹-2"><a href="#ä¼˜ç¼ºç‚¹-2" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><ul><li>ä¼˜ç‚¹<ul><li>ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨</li><li>å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡ID<ul><li>SnowFlakeç®—æ³•åœ¨åŒä¸€æ¯«ç§’å†…æœ€å¤šå¯ä»¥ç”Ÿæˆå¤šå°‘ä¸ªå…¨å±€å”¯ä¸€IDå‘¢ï¼Ÿ<ul><li>åŒä¸€æ¯«ç§’çš„IDæ•°é‡ &#x3D; 1024 * 4096 &#x3D; 4194304</li></ul></li></ul></li><li><strong>æ‰€æœ‰ç”Ÿæˆçš„idæŒ‰æ—¶é—´è¶‹åŠ¿é€’å¢ï¼Œåç»­æ’å…¥æ•°æ®åº“çš„ç´¢å¼•æ ‘çš„æ—¶å€™ï¼Œæ€§èƒ½è¾ƒé«˜</strong></li><li>æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”Ÿé‡å¤idï¼ˆå› ä¸ºæœ‰ datacenterId å’Œ workerId æ¥åšåŒºåˆ†ï¼‰</li></ul></li><li>ç¼ºç‚¹<ul><li>ä¾èµ–äºç³»ç»Ÿæ—¶é’Ÿçš„ä¸€è‡´æ€§ã€‚å¦‚æœæŸå°æœºå™¨çš„ç³»ç»Ÿ<strong>æ—¶é’Ÿå›æ‹¨</strong>ï¼Œæœ‰å¯èƒ½é€ æˆIDå†²çªï¼Œæˆ–è€…IDä¹±åº<ul><li>æ—¶é’Ÿå›æ‹¨ï¼šç³»ç»Ÿæ—¶é’Ÿå‘åè·³å˜</li></ul></li><li>è¿˜æœ‰ï¼Œåœ¨å¯åŠ¨ä¹‹å‰ï¼Œå¦‚æœè¿™å°æœºå™¨çš„ç³»ç»Ÿ<strong>æ—¶é—´å›æ‹¨è¿‡</strong>ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å‡ºç°IDé‡å¤çš„å±é™©</li></ul></li></ul><h3 id="æ•°æ®åº“è‡ªå¢"><a href="#æ•°æ®åº“è‡ªå¢" class="headerlink" title="æ•°æ®åº“è‡ªå¢"></a>æ•°æ®åº“è‡ªå¢</h3><ul><li>åˆ©ç”¨æ•°æ®åº“æœ¬èº«æ¥è¿›è¡Œè®¾ç½®ï¼Œåœ¨å…¨æ•°æ®åº“å†…ä¿æŒå”¯ä¸€</li></ul><h4 id="ä¼˜ç¼ºç‚¹-3"><a href="#ä¼˜ç¼ºç‚¹-3" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><ul><li>ä¼˜ç‚¹<ul><li>æ“ä½œç®€å•ï¼Œå»ºè¡¨æ—¶è®¾ç½®<code>auto_increment</code>å³å¯</li><li>ç”±äºå…¶é€’å¢æœ‰åºï¼Œç´¢å¼•æ€§èƒ½é«˜</li></ul></li><li>ç¼ºç‚¹<ul><li>å¼ºä¾èµ–DBã€‚ä¸åŒæ•°æ®åº“è¯­æ³•å’Œå®ç°ä¸åŒï¼Œæ•°æ®åº“è¿ç§»çš„æ—¶å€™ã€å¤šæ•°æ®åº“ç‰ˆæœ¬æ”¯æŒçš„æ—¶å€™ã€æˆ–åˆ†è¡¨åˆ†åº“çš„æ—¶å€™éœ€è¦å¤„ç†ï¼ˆé€ æˆ ID ä¸å…¨å±€ç»Ÿä¸€ï¼‰ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ã€‚å½“DBå¼‚å¸¸æ—¶æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ï¼Œå±äºè‡´å‘½é—®é¢˜</li><li>å•ç‚¹æ•…éšœã€‚åœ¨å•ä¸ªæ•°æ®åº“æˆ–è¯»å†™åˆ†ç¦»æˆ–ä¸€ä¸»å¤šä»çš„æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªä¸»åº“å¯ä»¥ç”Ÿæˆã€‚æœ‰å•ç‚¹æ•…éšœçš„é£é™©</li><li>æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚é…ç½®ä¸»ä»å¤åˆ¶å¯ä»¥å°½å¯èƒ½çš„å¢åŠ å¯ç”¨æ€§ï¼Œä½†æ˜¯æ•°æ®ä¸€è‡´æ€§åœ¨ç‰¹æ®Šæƒ…å†µä¸‹éš¾ä»¥ä¿è¯ã€‚ä¸»ä»åˆ‡æ¢æ—¶çš„ä¸ä¸€è‡´å¯èƒ½ä¼šå¯¼è‡´<strong>é‡å¤å‘å·</strong></li><li>éš¾äºæ‰©å±•ã€‚åœ¨æ€§èƒ½è¾¾ä¸åˆ°è¦æ±‚çš„æƒ…å†µä¸‹ï¼Œæ¯”è¾ƒéš¾äºæ‰©å±•ã€‚IDå‘å·æ€§èƒ½ç“¶é¢ˆé™åˆ¶åœ¨å•å°MySQLçš„è¯»å†™æ€§èƒ½</li></ul></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> æ•°æ®åº“å­—æ®µè®¾è®¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud</title>
      <link href="/cn/SpringCloud/"/>
      <url>/cn/SpringCloud/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨æ­¤æ„Ÿè°¢é»‘é©¬ç¨‹åºå‘˜æä¾›çš„2024ç‰ˆSprinCloudå­¦ä¹ è¯¾ç¨‹~~<br><a href="https://www.bilibili.com/video/BV1S142197x7?vd_source=7341c7fca3b496e9108bb1fd49c634ef">2024æœ€æ–°SpringCloudå¾®æœåŠ¡å¼€å‘ä¸å®æˆ˜</a><br><a href="https://b11et3un53m.feishu.cn/wiki/FYNkwb1i6i0qwCk7lF2caEq5nRe">é»‘é©¬æ–‡æ¡£</a></p></blockquote><h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><h2 id="MybatisPlus"><a href="#MybatisPlus" class="headerlink" title="MybatisPlus"></a>MybatisPlus</h2><blockquote><p>å®˜ç½‘<code>https://baomidou.com/</code></p></blockquote><h3 id="ä½¿ç”¨MybatisPlusçš„åŸºæœ¬æ­¥éª¤"><a href="#ä½¿ç”¨MybatisPlusçš„åŸºæœ¬æ­¥éª¤" class="headerlink" title="ä½¿ç”¨MybatisPlusçš„åŸºæœ¬æ­¥éª¤"></a>ä½¿ç”¨MybatisPlusçš„åŸºæœ¬æ­¥éª¤</h3><ol><li>å¼•å…¥MybatisPlusä¾èµ–ï¼Œä»£æ›¿Mybatisä¾èµ–</li><li>å®šä¹‰Mapperæ¥å£å¹¶ç»§æ‰¿BaseMapper</li></ol><h3 id="MybatisPlusæ¦‚å†µ"><a href="#MybatisPlusæ¦‚å†µ" class="headerlink" title="MybatisPlusæ¦‚å†µ"></a>MybatisPlusæ¦‚å†µ</h3><ol><li>MybatisPlusæ˜¯å¦‚ä½•çŸ¥é“æˆ‘ä»¬è¦æŸ¥è¯¢çš„æ˜¯å“ªå¼ è¡¨ï¼Ÿè¡¨ä¸­æœ‰å“ªäº›å­—æ®µå‘¢ï¼Ÿ<ol><li>é¦–å…ˆåŸç†æ˜¯åŸºäºåå°„</li></ol></li><li>çœ‹ä¸‹å›¾<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/04/fOawPhUYWF7K6Np.png" alt="img"></li><li>æ³›å‹ä¸­çš„<code>User</code>å°±æ˜¯ä¸æ•°æ®åº“å¯¹åº”çš„è¡¨</li><li>MybatisPluså°±æ˜¯æ ¹æ®ROJOå®ä½“çš„ä¿¡æ¯æ¥æ¨æ–­å‡ºè¡¨çš„ä¿¡æ¯ï¼Œä»è€Œç”ŸæˆSQL</li><li>é»˜è®¤æƒ…å†µä¸‹<ul><li>MybatisPlusä¼šæŠŠPOJOå®ä½“çš„ç±»å<strong>é©¼å³°è½¬ä¸‹åˆ’çº¿</strong>ä½œä¸ºè¡¨å</li><li>MybatisPlusä¼šæŠŠPOJOå®ä½“çš„æ‰€æœ‰å˜é‡å<strong>é©¼å³°è½¬ä¸‹åˆ’çº¿</strong>ä½œä¸ºè¡¨çš„å­—æ®µåï¼Œå¹¶æ ¹æ®å˜é‡ç±»å‹æ¨æ–­å­—æ®µç±»å‹</li><li>MybatisPlusä¼šæŠŠåä¸ºidçš„å­—æ®µä½œä¸º<strong>ä¸»é”®</strong></li></ul></li></ol></li><li>ä½†å¾ˆå¤šæƒ…å†µä¸‹ï¼Œé»˜è®¤çš„å®ç°ä¸å®é™…åœºæ™¯ä¸ç¬¦ï¼Œå› æ­¤MybatisPlusæä¾›äº†ä¸€äº›<strong>æ³¨è§£</strong>ä¾¿äºæˆ‘ä»¬å£°æ˜è¡¨ä¿¡æ¯</li></ol><h3 id="å¸¸è§æ³¨è§£"><a href="#å¸¸è§æ³¨è§£" class="headerlink" title="å¸¸è§æ³¨è§£"></a>å¸¸è§æ³¨è§£</h3><h4 id="TableName"><a href="#TableName" class="headerlink" title="@TableName"></a>@TableName</h4><ol><li>è¯¥æ³¨è§£ç”¨æ¥æŒ‡å®šè¡¨åï¼Œä½¿ç”¨ä½ç½®åœ¨å®ä½“ç±»</li></ol><h4 id="TableId"><a href="#TableId" class="headerlink" title="@TableId"></a>@TableId</h4><ol><li>è¯¥æ³¨è§£æ ‡æ˜è¡¨çš„ä¸»é”®ä»¥åŠæŒ‡å®š<code>IdType</code>ï¼Œä½¿ç”¨ä½ç½®åœ¨å®ä½“ç±»çš„ä¸»é”®å­—æ®µ</li><li>IdTypeå¸¸è§å¾—ä¸‰ç§ç±»å‹<ol><li><code>AUTO</code>ï¼šåˆ©ç”¨æ•°æ®åº“çš„idè‡ªå¢é•¿</li><li><code>INPUT</code>ï¼šæ‰‹åŠ¨ç”Ÿæˆid</li><li><code>ASSIGN_ID</code>ï¼šé›ªèŠ±ç®—æ³•ç”Ÿæˆ<code>Long</code>ç±»å‹çš„å…¨å±€å”¯ä¸€idï¼Œè¿™æ˜¯é»˜è®¤çš„IDç­–ç•¥ï¼ˆåœ¨è¡¨ä¸­éœ€è¦å–æ¶ˆè‡ªå¢ç­–ç•¥ï¼‰<ol><li>é›ªèŠ±é£˜ç§»ç®—æ³•<code>https://github.com/yitter/idgenerator/tree/master/Java</code>ä¹Ÿå¾ˆå¥½ç”¨</li></ol></li></ol></li></ol><h4 id="TableField"><a href="#TableField" class="headerlink" title="@TableField"></a>@TableField</h4><ol><li>è¯¥æ³¨è§£æŒ‡æ˜è¡¨çš„æ™®é€šå­—æ®µ</li><li>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸éœ€è¦ç»™å­—æ®µæ·»åŠ <code>@TableField</code>æ³¨è§£ï¼Œä¸€äº›ç‰¹æ®Šæƒ…å†µé™¤å¤–ï¼š<ul><li>æˆå‘˜å˜é‡åä¸æ•°æ®åº“å­—æ®µåä¸ä¸€è‡´</li><li>æˆå‘˜å˜é‡æ˜¯ä»¥<code>isXXX</code>å‘½åï¼ŒæŒ‰ç…§<code>JavaBean</code>çš„è§„èŒƒï¼Œ<code>MybatisPlus</code>è¯†åˆ«å­—æ®µæ—¶ä¼šæŠŠ<code>is</code>å»é™¤ï¼Œè¿™å°±å¯¼è‡´ä¸æ•°æ®åº“ä¸ç¬¦</li><li>æˆå‘˜å˜é‡åä¸æ•°æ®åº“ä¸€è‡´ï¼Œä½†æ˜¯ä¸æ•°æ®åº“çš„å…³é”®å­—å†²çªã€‚ä½¿ç”¨<code>@TableField</code>æ³¨è§£ç»™å­—æ®µåæ·»åŠ è½¬ä¹‰å­—ç¬¦ï¼š@TableField(â€œ â€˜orderâ€™ â€œ)</li></ul></li></ol><ul><li>ç¤ºä¾‹</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/04/jvaZEyPbl81Vc4X.png" alt="img"></p><h3 id="å¸¸è§é…ç½®"><a href="#å¸¸è§é…ç½®" class="headerlink" title="å¸¸è§é…ç½®"></a>å¸¸è§é…ç½®</h3><ul><li><p>å¤§å¤šæ•°çš„é…ç½®éƒ½æœ‰é»˜è®¤å€¼ï¼›ä½†è¿˜æœ‰ä¸€äº›æ˜¯æ²¡æœ‰é»˜è®¤å€¼çš„ï¼Œä¾‹å¦‚ï¼š</p><ul><li><p>å®ä½“ç±»çš„åˆ«åæ‰«æåŒ…</p></li><li><p>å…¨å±€idç±»å‹</p></li></ul></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/04/5BGcxrsbzAWoiKk.png" alt="img"></p></li></ul><h3 id="æ ¸å¿ƒåŠŸèƒ½"><a href="#æ ¸å¿ƒåŠŸèƒ½" class="headerlink" title="æ ¸å¿ƒåŠŸèƒ½"></a>æ ¸å¿ƒåŠŸèƒ½</h3><h4 id="æ¡ä»¶æ„é€ å™¨"><a href="#æ¡ä»¶æ„é€ å™¨" class="headerlink" title="æ¡ä»¶æ„é€ å™¨"></a>æ¡ä»¶æ„é€ å™¨</h4><blockquote><p>ä¸ªäººæ„Ÿè§‰MPå¯¹å•è¡¨çš„CRUDæ–¹æ³•å¾ˆå¥½ç”¨ï¼Œä½†æ˜¯å¯¹sqlçš„ç¼–å†™è¿˜æ˜¯åœ¨xmlæ–‡ä»¶ä¸­æ›´èˆ’é€‚</p></blockquote><ol><li>æ„å»ºæŸ¥è¯¢æ¡ä»¶<ol><li>QueryWrapper</li><li>UpdateWrapper</li><li>LambdaQueryWrapper å’Œ LambdaUpdateWrapperï¼ˆæ¨èï¼‰<ol><li>è¿™ä¸¤ç§åŸºäºåå°„å½¢å¼ï¼Œæ²¡æœ‰ç¡¬ç¼–ç ï¼Œè€Œä¸”ç›¸å¯¹æ¥è¯´ä½¿ç”¨èˆ’é€‚</li></ol></li></ol></li></ol><h4 id="è‡ªå®šä¹‰SQL"><a href="#è‡ªå®šä¹‰SQL" class="headerlink" title="è‡ªå®šä¹‰SQL"></a>è‡ªå®šä¹‰SQL</h4><ul><li><p>å¤æ‚çš„whereæ¡ä»¶é€šè¿‡Wrapperç¼–å†™ï¼Œç„¶åè‡ªå®šä¹‰SQLè¯­å¥çš„å‰©ä¸‹éƒ¨åˆ†</p><ul><li>æ„Ÿè§‰è¿˜æ˜¯ä¸å¤ªå‹å¥½ï¼Œç®€å•çš„<code>where</code>ä¸éœ€è¦ï¼Œå¤æ‚çš„<code>where</code>ä¸ä¸€å®šå¥½ï¼Œä»£ç é‡çš„ç¡®å‡å°‘</li><li>è€Œä¸”ï¼Œæ‹¼æ¥èµ·æ¥çš„SQLä¹Ÿéå¸¸å±é™©ï¼Œä¾µå…¥æ€§ä¹Ÿé«˜</li><li>SQLæŠ¥é”™ï¼Œmapperã€serviceéƒ½éœ€è¦çœ‹</li></ul></li><li><p>ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testCustomWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.å‡†å¤‡è‡ªå®šä¹‰æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">    List&lt;Long&gt; ids = List.of(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">4L</span>);</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;().in(<span class="string">&quot;id&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// 2.è°ƒç”¨mapperçš„è‡ªå®šä¹‰æ–¹æ³•ï¼Œç›´æ¥ä¼ é€’Wrapper</span></span><br><span class="line">    userMapper.deductBalanceByIds(<span class="number">200</span>, wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;UPDATE user SET balance = balance - #&#123;money&#125; $&#123;ew.customSqlSegment&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductBalanceByIds</span><span class="params">(<span class="meta">@Param(&quot;money&quot;)</span> <span class="type">int</span> money, <span class="meta">@Param(&quot;ew&quot;)</span> QueryWrapper&lt;User&gt; wrapper)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Serviceæ¥å£"><a href="#Serviceæ¥å£" class="headerlink" title="Serviceæ¥å£"></a>Serviceæ¥å£</h4><ol><li><p>ä½¿ç”¨</p><ol><li>è‡ªå®šä¹‰Serviceæ¥å£ç»§æ‰¿IServiceæ¥å£â€“æ–¹æ³•å£°æ˜</li><li>è‡ªå®šä¹‰å®ç°ç±»ç»§æ‰¿ServiceImpl<code>&lt;xxxMaper,xxx&gt;</code>ç±»â€“æ–¹æ³•å®ç°</li><li>åŸç†å¦‚å›¾ï¼Œè™šçº¿å®ç°ã€å®çº¿ç»§æ‰¿ï¼Œçœ‹æºç å³å¯</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/04/U1qyb92xJ3cgAGQ.png" alt="img"></li></ol></li><li><p>ä½¿ç”¨åœºæ™¯</p><ol><li>å¯¹ä¸€äº›æä¸ºç®€å•çš„CRUDæ“ä½œï¼Œåœ¨Contollerä¸­å°±å¯ä»¥ç›´æ¥å®Œæˆ</li><li>å¯¹å…·æœ‰å¤æ‚ä¸šåŠ¡çš„æ“ä½œä¾ç„¶æ˜¯Contoller-Service-Mapperå½¢å¼å®Œæˆ</li><li>ä¸ªäººè§‰å¾—ï¼Œä»…ä»å®ç°ä¸šåŠ¡çš„è§’åº¦ä¸Šçœ‹ï¼ŒäºŒè€…é…åˆä½¿ç”¨æ•ˆæœæœ€å¥½<ol><li><a href="https://www.zhihu.com/question/314745062/answer/3282783134">MPä½¿ç”¨çœ‹æ³•</a></li></ol></li></ol></li><li><p>Lambdaç”¨æ³•</p><blockquote><p>è¿™ä¸ªç›¸è¾ƒä¸å‰é¢ï¼Œä½¿ç”¨èµ·æ¥ç¡®å®æ›´åŠ èˆ’é€‚</p></blockquote><ol><li><p>åœ¨IServiceä¸­å¯¹<code>LambdaQueryWrapper</code>å’Œ<code>LambdaUpdateWrapper</code>çš„ç”¨æ³•è¿›ä¸€æ­¥åšäº†ç®€åŒ–ï¼›æˆ‘ä»¬æ— éœ€è‡ªå·±é€šè¿‡<code>new</code>çš„æ–¹å¼æ¥åˆ›å»º<code>Wrapper</code>ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨<code>lambdaQuery</code>å’Œ<code>lambdaUpdate</code>æ–¹æ³•</p></li><li><p>åŸºäºLambdaQuery</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;æ ¹æ®idé›†åˆæŸ¥è¯¢ç”¨æˆ·&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title function_">queryUsers</span><span class="params">(UserQuery query)</span>&#123;</span><br><span class="line">    <span class="comment">// 1.ç»„ç»‡æ¡ä»¶</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> query.getName();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> query.getStatus();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">minBalance</span> <span class="operator">=</span> query.getMinBalance();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">maxBalance</span> <span class="operator">=</span> query.getMaxBalance();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    List&lt;User&gt; users = userService.lambdaQuery()</span><br><span class="line">            .like(username != <span class="literal">null</span>, User::getUsername, username)</span><br><span class="line">            .eq(status != <span class="literal">null</span>, User::getStatus, status)</span><br><span class="line">            .ge(minBalance != <span class="literal">null</span>, User::getBalance, minBalance)</span><br><span class="line">            .le(maxBalance != <span class="literal">null</span>, User::getBalance, maxBalance)</span><br><span class="line">            .list();</span><br><span class="line">    <span class="comment">// 3.å¤„ç†vo</span></span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(users, UserVO.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å¯ä»¥å‘ç°LambdaQueryæ–¹æ³•ä¸­é™¤äº†å¯ä»¥æ„å»ºæ¡ä»¶ï¼Œè¿˜éœ€è¦åœ¨é“¾å¼ç¼–ç¨‹çš„æœ€åæ·»åŠ ä¸€ä¸ª<code>list()</code>ï¼Œè¿™æ˜¯åœ¨å‘Šè¯‰MPæˆ‘ä»¬çš„è°ƒç”¨ç»“æœéœ€è¦æ˜¯ä¸€ä¸ªlisté›†åˆã€‚è¿™é‡Œä¸ä»…å¯ä»¥ç”¨<code>list()</code>ï¼Œå¯é€‰çš„æ–¹æ³•æœ‰ï¼š<ul><li><code>.one()</code>ï¼šæœ€å¤š1ä¸ªç»“æœ</li><li><code>.list()</code>ï¼šè¿”å›é›†åˆç»“æœ</li><li><code>.count()</code>ï¼šè¿”å›è®¡æ•°ç»“æœ</li></ul></li></ol></li><li><p>åŸºäºLambdaUpdate</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer money)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">// 2.æ ¡éªŒç”¨æˆ·çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user.getStatus() == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.æ ¡éªŒä½™é¢æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (user.getBalance() &lt; money) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä½™é¢ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.æ‰£å‡ä½™é¢ update tb_user set balance = balance - ?</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">remainBalance</span> <span class="operator">=</span> user.getBalance() - money;</span><br><span class="line">    lambdaUpdate()</span><br><span class="line">            .set(User::getBalance, remainBalance) <span class="comment">// æ›´æ–°ä½™é¢</span></span><br><span class="line">            .set(remainBalance == <span class="number">0</span>, User::getStatus, <span class="number">2</span>) <span class="comment">// åŠ¨æ€åˆ¤æ–­ï¼Œæ˜¯å¦æ›´æ–°status</span></span><br><span class="line">            .eq(User::getId, id)</span><br><span class="line">            .eq(User::getBalance, user.getBalance()) <span class="comment">// ä¹è§‚é”</span></span><br><span class="line">            .update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åŒæ ·ï¼ŒLambdaUpdateæ–¹æ³•ä¸­é™¤äº†å¯ä»¥æ„å»ºæ¡ä»¶ï¼Œè¿˜éœ€è¦åœ¨é“¾å¼ç¼–ç¨‹çš„æœ€åæ·»åŠ ä¸€ä¸ª<code>update()</code>ï¼Œè¡¨ç¤ºæ›´æ–°æ•°æ®</li></ol></li></ol></li><li><p>æ‰¹é‡æ–°å¢</p><ol><li><p>æ¯«æ— ç–‘é—®ï¼Œæ‰¹é‡æ–°å¢æ¯”å¾ªç¯æ–°å¢100000æ•°æ®å¿«çš„å¤š</p><ol><li>è¿™é‡Œæ‰¹é‡æ’å…¥æ›´å¿«çš„åŸå› æ˜¯ç½‘ç»œè¯·æ±‚çš„æ¬¡æ•°å‡å°‘</li></ol></li><li><p>å¦‚æœæƒ³è¦è¿›ä¸€æ­¥æå‡æ‰¹é‡æ’å…¥çš„æ€§èƒ½ï¼Œå¦‚ä½•åšï¼Ÿ</p><ol><li>çœ‹<code>MybatisPlus</code>æºç åˆ†æ</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveBatch</span><span class="params">(Collection&lt;T&gt; entityList, <span class="type">int</span> batchSize)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sqlStatement</span> <span class="operator">=</span> getSqlStatement(SqlMethod.INSERT_ONE);<span class="comment">//é€æ¡æ’å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> executeBatch(entityList, batchSize, (sqlSession, entity) -&gt; sqlSession.insert(sqlStatement, entity));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...SqlHelper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="type">boolean</span> <span class="title function_">executeBatch</span><span class="params">(Class&lt;?&gt; entityClass, Log log, Collection&lt;E&gt; list, <span class="type">int</span> batchSize, BiConsumer&lt;SqlSession, E&gt; consumer)</span> &#123;</span><br><span class="line">    Assert.isFalse(batchSize &lt; <span class="number">1</span>, <span class="string">&quot;batchSize must not be less than one&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> !CollectionUtils.isEmpty(list) &amp;&amp; executeBatch(entityClass, log, sqlSession -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> list.size();</span><br><span class="line">        <span class="type">int</span> <span class="variable">idxLimit</span> <span class="operator">=</span> Math.min(batchSize, size);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (E element : list) &#123;</span><br><span class="line">            consumer.accept(sqlSession, element);</span><br><span class="line">            <span class="keyword">if</span> (i == idxLimit) &#123;</span><br><span class="line">                sqlSession.flushStatements();</span><br><span class="line">                idxLimit = Math.min(idxLimit + batchSize, size);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>å¯ä»¥å‘ç°å…¶å®<code>MybatisPlus</code>çš„æ‰¹å¤„ç†æ˜¯åŸºäº<code>PrepareStatement</code>çš„é¢„ç¼–è¯‘æ¨¡å¼ï¼Œç„¶åæ‰¹é‡æäº¤ï¼Œæœ€ç»ˆåœ¨æ•°æ®åº“æ‰§è¡Œæ—¶è¿˜æ˜¯ä¼šæœ‰å¤šæ¡insertè¯­å¥ï¼Œé€æ¡æ’å…¥æ•°æ®<ol><li>ç®€å•çœ‹çœ‹è¿™ç¯‡ <code>https://blog.csdn.net/qq_71443736/article/details/134728125</code>åšå®¢äº†è§£é¢„ç¼–è¯‘æ¨¡å¼</li></ol></li><li>å®ƒSQLç±»ä¼¼</li></ol><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Preparing: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> ( username, password, phone, info, balance, create_time, update_time ) <span class="keyword">VALUES</span> ( ?, ?, ?, ?, ?, ?, ? )</span><br><span class="line">Parameters: user_1, <span class="number">123</span>, <span class="number">18688190001</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span></span><br><span class="line">Parameters: user_2, <span class="number">123</span>, <span class="number">18688190002</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span></span><br><span class="line">Parameters: user_3, <span class="number">123</span>, <span class="number">18688190003</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span></span><br></pre></td></tr></table></figure><ol start="4"><li>è€Œå¦‚æœæƒ³è¦å¾—åˆ°æœ€ä½³æ€§èƒ½ï¼Œæœ€å¥½æ˜¯å°†å¤šæ¡SQLåˆå¹¶ä¸ºä¸€æ¡ï¼Œåƒè¿™æ ·ï¼š</li></ol><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> ( username, password, phone, info, balance, create_time, update_time )</span><br><span class="line"><span class="keyword">VALUES</span> </span><br><span class="line">(user_1, <span class="number">123</span>, <span class="number">18688190001</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>),</span><br><span class="line">(user_2, <span class="number">123</span>, <span class="number">18688190002</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>),</span><br><span class="line">(user_3, <span class="number">123</span>, <span class="number">18688190003</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>),</span><br><span class="line">(user_4, <span class="number">123</span>, <span class="number">18688190004</span>, &quot;&quot;, <span class="number">2000</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">2023</span><span class="number">-07</span><span class="number">-01</span>);</span><br></pre></td></tr></table></figure><ol start="5"><li><p>MySQLçš„å®¢æˆ·ç«¯è¿æ¥å‚æ•°ä¸­æœ‰è¿™æ ·çš„ä¸€ä¸ªå‚æ•°ï¼š<code>rewriteBatchedStatements</code>ã€‚é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯é‡å†™æ‰¹å¤„ç†çš„<code>statement</code>è¯­å¥ã€‚</p><ol><li>å‚è€ƒæ–‡æ¡£ï¼š<code>https://www.mysql.com/</code></li><li>è¿™ä¸ªå‚æ•°çš„é»˜è®¤å€¼æ˜¯falseï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹è¿æ¥å‚æ•°ï¼Œå°†å…¶é…ç½®ä¸ºtrueã€‚å°±å¯ä»¥å®ç°ä¸Šè¿°SQLè¯­å¥çš„å®ç°</li><li>åœ¨<code>ClientPreparedStatement</code>çš„<code>executeBatchInternal</code>ä¸­ï¼Œä¼šåˆ¤æ–­<code>rewriteBatchedStatements</code>å€¼æ˜¯å¦ä¸ºtrueå¹¶é‡å†™SQLçš„åŠŸèƒ½</li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mp?useUnicode=true&amp;characterEncoding=UTF-8</span>      <span class="string">&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="string">&amp;rewriteBatchedStatements=true</span> </span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">abc123</span></span><br></pre></td></tr></table></figure></li></ol></li></ol></li></ol><h3 id="æ‰©å±•åŠŸèƒ½"><a href="#æ‰©å±•åŠŸèƒ½" class="headerlink" title="æ‰©å±•åŠŸèƒ½"></a>æ‰©å±•åŠŸèƒ½</h3><ol><li><p>ä»£ç ç”Ÿæˆå™¨</p><ul><li>å¸®åŠ©ç”Ÿæˆé€šç”¨ä»£ç æ ¼å¼</li><li>ä¸¤æ¬¾æ’ä»¶ï¼Œå¯¹ç”Ÿæˆä»£ç æ¥è¯´éƒ½å¯ä»¥<ul><li>MyBatis-X</li><li>MyBatisPlus</li></ul></li></ul></li><li><p>é™æ€å·¥å…·</p><ol><li>æœ‰çš„æ—¶å€™Serviceä¹‹é—´ä¹Ÿä¼šç›¸äº’è°ƒç”¨ï¼Œä¸ºäº†é¿å…å‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜ï¼ŒMybatisPlusæä¾›ä¸€ä¸ªé™æ€å·¥å…·ç±»ï¼š<code>Db</code>ï¼Œå…¶ä¸­çš„ä¸€äº›é™æ€æ–¹æ³•ä¸<code>IService</code>ä¸­æ–¹æ³•ç­¾ååŸºæœ¬ä¸€è‡´ï¼Œä¹Ÿå¯ä»¥å®ç°CRUDåŠŸèƒ½<ol><li>ä½•ä¸ºå¾ªç¯ä¾èµ–<code>https://blog.csdn.net/kaka_buka/article/details/139785462</code></li></ol></li></ol></li><li><p>é€»è¾‘åˆ é™¤</p><ol><li>å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé‡‡ç”¨é€»è¾‘åˆ é™¤çš„æ–¹æ¡ˆï¼Œå³ï¼š<ul><li>åœ¨è¡¨ä¸­æ·»åŠ ä¸€ä¸ªå­—æ®µæ ‡è®°æ•°æ®æ˜¯å¦è¢«åˆ é™¤</li><li>å½“åˆ é™¤æ•°æ®æ—¶æŠŠæ ‡è®°ç½®ä¸ºtrue</li><li>æŸ¥è¯¢æ—¶è¿‡æ»¤æ‰æ ‡è®°ä¸ºtrueçš„æ•°æ®</li></ul></li><li>é…ç½®</li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-field:</span> <span class="string">deleted</span> <span class="comment"># å…¨å±€é€»è¾‘åˆ é™¤çš„å®ä½“å­—æ®µå(since 3.3.0,é…ç½®åå¯ä»¥å¿½ç•¥ä¸é…ç½®æ­¥éª¤2)</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># é€»è¾‘å·²åˆ é™¤å€¼(é»˜è®¤ä¸º 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># é€»è¾‘æœªåˆ é™¤å€¼(é»˜è®¤ä¸º 0)</span></span><br></pre></td></tr></table></figure><ol start="3"><li>æ³¨æ„ï¼Œé€»è¾‘åˆ é™¤æœ¬èº«ä¹Ÿæœ‰è‡ªå·±çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š<ul><li>ä¼šå¯¼è‡´æ•°æ®åº“è¡¨åƒåœ¾æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œä»è€Œå½±å“æŸ¥è¯¢æ•ˆç‡</li><li>SQLä¸­å…¨éƒ½éœ€è¦å¯¹é€»è¾‘åˆ é™¤å­—æ®µåšåˆ¤æ–­ï¼Œå½±å“æŸ¥è¯¢æ•ˆç‡</li></ul></li><li>è¿˜æœ‰ä¸€ç§è§£å†³æ˜¯ï¼Œå¦‚æœæ•°æ®ä¸èƒ½åˆ é™¤ï¼Œå¯ä»¥é‡‡ç”¨æŠŠæ•°æ®è¿ç§»åˆ°å…¶å®ƒè¡¨çš„åŠæ³•</li></ol></li><li><p>æšä¸¾å¤„ç†å™¨</p><ol><li><p>å¯¹é™æ€å­—æ®µçš„ä»£æ›¿ï¼Œå¢å¼ºä»£ç çš„å¯é˜…è¯»æ€§</p><ol><li>ä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ç¯‡blog<code>https://blog.csdn.net/qq_45036591/article/details/104159613</code></li></ol></li><li><p>æšä¸¾ç±»å‹ä¸æ•°æ®åº“ç±»å‹çš„ç›¸äº’è½¬æ¢</p><ol><li><p>å‘Šè¯‰<code>MybatisPlus</code>ï¼Œæšä¸¾ä¸­çš„å“ªä¸ªå­—æ®µçš„å€¼ä½œä¸ºæ•°æ®åº“å€¼ï¼›<code>MybatisPlus</code>æä¾›äº†<code>@EnumValue</code>æ³¨è§£æ¥æ ‡è®°æšä¸¾å±æ€§</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/1CNwZcoU3SzPy4i.png" alt="img"></p></li><li><p>é…ç½®ï¼ˆ3.5.2åæ— éœ€é…ç½®ï¼‰</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span>     <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br></pre></td></tr></table></figure></li><li><p>è¿™æ ·æŸ¥è¯¢å‡ºæ¥çš„çŠ¶æ€å­—æ®µæ˜¯æšä¸¾ç±»å‹è€Œä¸æ˜¯å•çº¯çš„0å’Œ1</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/eBSgTyYVUPK3kD5.png" alt="img"></li></ol></li></ol></li><li><p>ä½¿é¡µé¢æŸ¥è¯¢ç»“æœä¹Ÿæ˜¯æšä¸¾æ ¼å¼</p><ol><li>åœ¨UserStatusæšä¸¾ä¸­é€šè¿‡<code>@JsonValue</code>æ³¨è§£æ ‡è®°JSONåºåˆ—åŒ–æ—¶å±•ç¤ºçš„å­—æ®µï¼š<code>desc</code></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/DpVHe96PcWxIRSM.png" alt="img"></li></ol></li></ol></li><li><p>JSONå¤„ç†å™¨</p><ol><li><p>æ•°æ®åº“çš„userè¡¨ä¸­æœ‰ä¸€ä¸ª<code>info</code>å­—æ®µï¼Œæ˜¯JSONç±»å‹</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/ePkSmYw1oALaF7E.png" alt="img"></li><li>è€ŒUserå®ä½“ç±»ä¸­å´æ˜¯<code>String</code>ç±»å‹</li><li>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è¦è¯»å–<code>info</code>ä¸­çš„å±æ€§æ—¶å°±éå¸¸ä¸æ–¹ä¾¿ï¼›å¦‚æœè¦æ–¹ä¾¿è·å–ï¼Œinfoçš„ç±»å‹æœ€å¥½æ˜¯ä¸€ä¸ª<code>Map</code>æˆ–è€…å®ä½“ç±»</li><li>è€Œä¸€æ—¦æˆ‘ä»¬æŠŠ<code>info</code>æ”¹ä¸º<code>å¯¹è±¡</code>ç±»å‹ï¼Œå°±éœ€è¦åœ¨å†™å…¥æ•°æ®åº“æ—¶æ‰‹åŠ¨è½¬ä¸º<code>String</code>ï¼Œå†è¯»å–æ•°æ®åº“æ—¶ï¼Œæ‰‹åŠ¨è½¬æ¢ä¸º<code>å¯¹è±¡</code>ï¼Œè¿™ä¼šéå¸¸éº»çƒ¦</li></ol></li><li><p>MybatisPlusæä¾›äº†å¾ˆå¤šç‰¹æ®Šç±»å‹å­—æ®µçš„ç±»å‹å¤„ç†å™¨ï¼ˆTypeHandlerï¼‰ï¼Œè§£å†³ç‰¹æ®Šå­—æ®µç±»å‹ä¸æ•°æ®åº“ç±»å‹è½¬æ¢çš„é—®é¢˜</p><ol><li>ä¾‹å¦‚å¤„ç†JSONå°±å¯ä»¥ä½¿ç”¨<code>JacksonTypeHandler</code>å¤„ç†å™¨</li></ol></li><li><p>ä½¿ç”¨Jsonå¤„ç†å™¨å®ŒæˆJSONå­—æ®µä¸å¯¹è±¡é—´çš„è½¬æ¢</p><ol><li><p>å®šä¹‰ä¸€ä¸ªå•ç‹¬å®ä½“ç±»æ¥ä¸infoå­—æ®µçš„å±æ€§åŒ¹é…</p></li><li><p>å°†Userç±»çš„infoå­—æ®µä¿®æ”¹ä¸ºUserInfoç±»å‹ï¼Œå¹¶å£°æ˜ç±»å‹å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableField(typeHandler = JacksonTypeHandler.class)</span></span><br><span class="line"><span class="keyword">private</span> UserInfo info;</span><br></pre></td></tr></table></figure></li><li><p>å¼€å¯ç»“æœé›†æ˜ å°„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(autoResultMap = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;...&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ol></li></ol><h3 id="æ’ä»¶åŠŸèƒ½"><a href="#æ’ä»¶åŠŸèƒ½" class="headerlink" title="æ’ä»¶åŠŸèƒ½"></a>æ’ä»¶åŠŸèƒ½</h3><ul><li>MPæä¾›å¾ˆå¤šæ’ä»¶ï¼Œåˆ†é¡µæ’ä»¶æœ€ä¸ºå¸¸ç”¨</li></ul><h4 id="åˆ†é¡µæ’ä»¶"><a href="#åˆ†é¡µæ’ä»¶" class="headerlink" title="åˆ†é¡µæ’ä»¶"></a>åˆ†é¡µæ’ä»¶</h4><ul><li><p>åœ¨æœªå¼•å…¥åˆ†é¡µæ’ä»¶çš„æƒ…å†µä¸‹ï¼Œ<code>MybatisPlus</code>æ˜¯ä¸æ”¯æŒåˆ†é¡µåŠŸèƒ½çš„ï¼Œ<code>IService</code>å’Œ<code>BaseMapper</code>ä¸­çš„åˆ†é¡µæ–¹æ³•éƒ½æ— æ³•æ­£å¸¸èµ·æ•ˆ</p></li><li><p>é¦–å…ˆéœ€è¦é…ç½®åˆ†é¡µæ’ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æ ¸å¿ƒæ’ä»¶</span></span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">// åˆ›å»ºåˆ†é¡µæ’ä»¶</span></span><br><span class="line">        <span class="type">PaginationInnerInterceptor</span> <span class="variable">paginationInnerInterceptor</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MysQL);</span><br><span class="line">        paginationInnerInterceptor.setMaxLimit(<span class="number">1000L</span>);</span><br><span class="line">        <span class="comment">//2.æ·»åŠ åˆ†é¡µæ’ä»¶</span></span><br><span class="line">        interceptor.addInnerInterceptor(paginationInnerInterceptor);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨</p><blockquote><p>ç‰ˆæœ¬ä¸åŒå¯èƒ½APIä¼šæœ‰æ”¹å˜</p></blockquote><ul><li>å½“å‰é¡µpageNoï¼ŒæŸ¥è¯¢æ¡æ•°pagesize<ul><li><code>Page&lt;User&gt; page = Page.of(pageNo, pagesize);</code></li></ul></li><li>æ’åºæ¡ä»¶<ul><li><code>page.addorder(new OrderItem(column: &quot;balance&quot;,asc:true));</code></li></ul></li><li>é€šè¿‡xxxServiceæˆ–xxxMapperè°ƒç”¨åˆ†é¡µæŸ¥è¯¢<ul><li><code>Page&lt;User&gt; p = userService.page(page);</code></li></ul></li><li>è¿”å›ç»“æœ<ul><li>æ€»æ•°æ®<code>List&lt;User&gt; records = p.getRecords();</code></li><li>æ€»æ¡æ•°<code>long total = p.getTotal()</code></li><li>æ€»é¡µæ•°<code>long pages = p.getPages()</code></li></ul></li></ul></li></ul><h4 id="é€šç”¨åˆ†é¡µå®ä½“"><a href="#é€šç”¨åˆ†é¡µå®ä½“" class="headerlink" title="é€šç”¨åˆ†é¡µå®ä½“"></a>é€šç”¨åˆ†é¡µå®ä½“</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;åˆ†é¡µæŸ¥è¯¢å®ä½“&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;é¡µç &quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;é¡µç &quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pageSize;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ’åºå­—æ®µ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;æ˜¯å¦å‡åº&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAsc;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ³›å‹æ–¹æ³•,ç”¨æ¥ç›´æ¥è¿”å›Page&lt;T&gt;</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(OrderItem ... orders)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.åˆ†é¡µæ¡ä»¶</span></span><br><span class="line">        Page&lt;T&gt; p = Page.of(pageNo, pageSize);</span><br><span class="line">        <span class="comment">// 2.æ’åºæ¡ä»¶</span></span><br><span class="line">        <span class="comment">// 2.1.å…ˆçœ‹å‰ç«¯æœ‰æ²¡æœ‰ä¼ æ’åºå­—æ®µ</span></span><br><span class="line">        <span class="keyword">if</span> (sortBy != <span class="literal">null</span>) &#123;</span><br><span class="line">            p.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(sortBy, isAsc));</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2.å†çœ‹æœ‰æ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šæ’åºå­—æ®µ</span></span><br><span class="line">        <span class="keyword">if</span>(orders != <span class="literal">null</span>)&#123;</span><br><span class="line">            p.addOrder(orders);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä»<code>PageQuery</code>åˆ°<code>MybatisPlus</code>çš„<code>Page</code>ä¹‹é—´è½¬æ¢çš„è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼›åœ¨<code>PageQuery</code>è¿™ä¸ªå®ä½“ä¸­å®šä¹‰å·¥å…·æ–¹æ³•ï¼Œæ¥ç®€åŒ–å¼€å‘</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="keyword">private</span> List&lt;V&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›ç©ºåˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlusçš„åˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; ç›®æ ‡VOç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; åŸå§‹POç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VOçš„åˆ†é¡µå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">empty</span><span class="params">(Page&lt;P&gt; p)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†MybatisPlusåˆ†é¡µç»“æœè½¬ä¸º VOåˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlusçš„åˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voClass ç›®æ ‡VOç±»å‹çš„å­—èŠ‚ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; ç›®æ ‡VOç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; åŸå§‹POç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VOçš„åˆ†é¡µå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">of</span><span class="params">(Page&lt;P&gt; p, Class&lt;V&gt; voClass)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.éç©ºæ ¡éªŒ</span></span><br><span class="line">        List&lt;P&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// æ— æ•°æ®ï¼Œè¿”å›ç©ºç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> empty(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.æ•°æ®è½¬æ¢</span></span><br><span class="line">        List&lt;V&gt; vos = BeanUtil.copyToList(records, voClass);</span><br><span class="line">        <span class="comment">// 3.å°è£…è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), vos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†MybatisPlusåˆ†é¡µç»“æœè½¬ä¸º VOåˆ†é¡µç»“æœï¼Œå…è®¸ç”¨æˆ·è‡ªå®šä¹‰POåˆ°VOçš„è½¬æ¢æ–¹å¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p MybatisPlusçš„åˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> convertor POåˆ°VOçš„è½¬æ¢å‡½æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt; ç›®æ ‡VOç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;P&gt; åŸå§‹POç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> VOçš„åˆ†é¡µå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V, P&gt; PageDTO&lt;V&gt; <span class="title function_">of</span><span class="params">(Page&lt;P&gt; p, Function&lt;P, V&gt; convertor)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.éç©ºæ ¡éªŒ</span></span><br><span class="line">        List&lt;P&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span> (records == <span class="literal">null</span> || records.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// æ— æ•°æ®ï¼Œè¿”å›ç©ºç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> empty(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.æ•°æ®è½¬æ¢</span></span><br><span class="line">        List&lt;V&gt; vos = records.stream().map(convertor).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 3.å°è£…è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;(p.getTotal(), p.getPages(), vos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç±»çš„æ³›å‹å‚æ•°æ˜¯åœ¨<strong>ç±»å®ä¾‹åŒ–</strong>æ—¶ç¡®å®šçš„ï¼Œè€Œé™æ€æ–¹æ³•åœ¨å®ä¾‹åŒ–ä¹‹å‰å°±å¯ä»¥è¢«è°ƒç”¨ï¼Œå› æ­¤æ— æ³•ç›´æ¥å¼•ç”¨ç±»çš„æ³›å‹å‚æ•°ï¼Œè€Œéœ€è¦é‡æ–°å®šä¹‰æ³›å‹</li><li>æ³›å‹æ²¡æœ‰å­—èŠ‚ç ï¼Œæ‰€ä»¥å‡½æ•°è°ƒç”¨è€…åº”è¯¥ä¼ å‚æ•°<code> Class&lt;V&gt; voClass</code></li><li>è°ƒç”¨è€…è‡ªå®šä¹‰POåˆ°VOçš„è½¬æ¢æ–¹å¼ï¼Œè¿™å°±éœ€è¦ä¼ é€’ä¸€ä¸ªè¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯å‡½æ•°å¼æ¥å£<ul><li>å‡½æ•°å¼ç¼–ç¨‹</li><li>Lambdaè¡¨è¾¾å¼çš„ä½¿ç”¨</li><li>Streamæµçš„ä½¿ç”¨</li></ul></li><li>è‡ªå®šä¹‰å·¥å…·ç±»å®Œæˆå¯¹MPçš„è½¬æ¢ï¼Œè€Œä¸æ˜¯æŠŠæ–¹æ³•æ”¾åœ¨å®ä½“ä¸­ï¼Œå®Œæˆè§£è€¦åˆ</li></ul><hr><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><blockquote><p>å¿«é€Ÿæ„å»ºã€è¿è¡Œã€ç®¡ç†åº”ç”¨çš„å·¥å…·</p></blockquote><h3 id="Dockerå®‰è£…"><a href="#Dockerå®‰è£…" class="headerlink" title="Dockerå®‰è£…"></a>Dockerå®‰è£…</h3><blockquote><p>è™šæ‹ŸæœºVMwareï¼›ç³»ç»ŸCentos-7ï¼›è¿œç¨‹è¿æ¥å·¥å…· MobaXterm<br>è¯¦ç»†å®‰è£…<code>https://b11et3un53m.feishu.cn/wiki/FJAnwOhpIihMkLkOKQocdWZ7nUc</code><br>dockerå®˜æ–¹äº¤æµç¤¾åŒº<code>https://hub.docker.com</code><br>ä¸€ä¸ªä¸é”™çš„dockerå®¹å™¨ç®¡ç†UI <code>https://mp.weixin.qq.com/s/daB65RX41d4KgXQzGKtYOA</code></p></blockquote><ol><li><p>å¼€å¯è™šæ‹Ÿæœºï¼Œè¿œç¨‹è¿æ¥</p></li><li><p>å¸è½½æ—§ç‰ˆDocker</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">    docker<span class="literal">-client</span> \</span><br><span class="line">    docker<span class="literal">-client-latest</span> \</span><br><span class="line">    docker<span class="literal">-common</span> \</span><br><span class="line">    docker<span class="literal">-latest</span> \</span><br><span class="line">    docker<span class="literal">-latest-logrotate</span> \</span><br><span class="line">    docker<span class="literal">-logrotate</span> \</span><br><span class="line">    docker<span class="literal">-engine</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®Dockerçš„yumåº“</p><ol><li>å®‰è£…yumå·¥å…· <code>yum install -y yum-utils</code></li><li>å®‰è£…æˆåŠŸåï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œé…ç½®Dockerçš„yumæº(é˜¿é‡Œäº‘é•œåƒ)<ol><li><code>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></li></ol></li></ol></li><li><p>å¼€å§‹å®‰è£…Docker</p><ol><li><code>yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></li></ol></li><li><p>æ ¡éªŒæ˜¯å¦å®‰è£…æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæœ¬æŸ¥çœ‹</span></span><br><span class="line">docker -v</span><br><span class="line"><span class="comment"># å¯åŠ¨Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># åœæ­¢Docker</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="comment"># é‡å¯</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># æŸ¥çœ‹dockerçŠ¶æ€</span></span><br><span class="line">systemctl status docker</span><br><span class="line"><span class="comment"># æ‰§è¡Œdocker pså‘½ä»¤ï¼Œå¦‚æœä¸æŠ¥é”™ï¼Œè¯´æ˜å®‰è£…å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure></li></ol><h3 id="é…ç½®é•œåƒåŠ é€Ÿå™¨"><a href="#é…ç½®é•œåƒåŠ é€Ÿå™¨" class="headerlink" title="é…ç½®é•œåƒåŠ é€Ÿå™¨"></a>é…ç½®é•œåƒåŠ é€Ÿå™¨</h3><ol><li>ä½¿ç”¨é˜¿é‡Œäº‘çš„<strong>å®¹å™¨é•œåƒæœåŠ¡</strong>æˆ–å…¶ä»–é•œåƒåŠ é€Ÿå™¨<ol><li>æ‰“å¼€aliyunï¼Œå¾—åˆ°é•œåƒåŠ é€Ÿåœ°å€<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/06/fxRykNFotOMZi72.png" alt="img"></li></ol></li><li>å…·ä½“å‘½ä»¤</li></ol></li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="comment"># å¤åˆ¶å†…å®¹ï¼Œæ³¨æ„æŠŠå…¶ä¸­çš„é•œåƒåŠ é€Ÿåœ°å€æ”¹æˆè‡ªå·±çš„</span></span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://xxxx.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># é‡æ–°åŠ è½½é…ç½®</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="comment"># é‡å¯Docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><ol start="3"><li>æˆåŠŸï¼Œåœ¨&#x2F;etc&#x2F;dockeræ–‡ä»¶å¤¹ä¸­æœ‰ä¸€ä¸ªdaemon.jsonæ–‡ä»¶ï¼Œåç»­ç›´æ¥é€šè¿‡VScodeä¿®æ”¹</li></ol><h3 id="å¿«é€Ÿå…¥é—¨-éƒ¨ç½²MySQL"><a href="#å¿«é€Ÿå…¥é—¨-éƒ¨ç½²MySQL" class="headerlink" title="å¿«é€Ÿå…¥é—¨-éƒ¨ç½²MySQL"></a>å¿«é€Ÿå…¥é—¨-éƒ¨ç½²MySQL</h3><ul><li><p>å¦‚æœä¹‹å‰å·²ç»éƒ¨ç½²è¿‡MySQLï¼Œå»ºè®®å…ˆåˆ é™¤</p><ul><li>å…·ä½“æ–‡æ¡£<code>https://www.jb51.net/article/179020.html</code></li><li>åˆ é™¤å‰å…ˆå…³é—­MySQLçš„æœåŠ¡  <code>systemctl stop mysql æˆ–è€… service mysql stop</code><ol><li>å…³é—­åï¼Œ<code>systemctl status mysql</code> æŸ¥çœ‹æ˜¯å¦å…³é—­</li></ol></li><li>ä½¿ç”¨ rpm å‘½ä»¤æŸ¥çœ‹å·²å®‰è£…çš„MySQL<ol><li><code>rpm -qa|grep mysql</code></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/06/QfH5t7LzPC4UA9k.png" alt="img"></li></ol></li><li>ä½¿ç”¨yumå®‰è£…çš„è¯ï¼Œéœ€è¦æ¸…é™¤æœåŠ¡<code>yum remove mysql mysql-server mysql-libs mysql-server</code></li><li>å†æ¬¡æŸ¥è¯¢<ol><li><code>rpm -qa|grep mysql</code></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/06/8nGDXKVCPJWLQk2.png" alt="img"></li><li>é€šè¿‡ <code>rpm -ev + å¯¹åº”æ–‡ä»¶å</code> åˆ é™¤</li></ol></li><li>æŸ¥æ‰¾MySQLç›¸å…³çš„ç›®å½•æ–‡ä»¶å¹¶å¯¹åº”åˆ é™¤<ol><li><code> find / -name mysql</code></li><li>ä½¿ç”¨<code>rm -rf + æŸ¥è¯¢å‡ºæ¥çš„ç›®å½•æˆ–æ–‡ä»¶å</code></li></ol></li><li>å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼<ol><li><code>rpm -qa|grep mysql</code></li><li><code>find / -name mysql</code></li></ol></li><li>æ³¨æ„<ol><li><code>rpm -ev</code>æ˜¯è½¯ä»¶åŒ…ç®¡ç†å™¨ï¼Œåˆ é™¤çš„æ˜¯ä¸€ä¸ªè½¯ä»¶åŒ…</li><li><code>rm -rf</code>æ˜¯åˆ é™¤æŸä¸ªç›®å½•æˆ–æ–‡ä»¶</li></ol></li></ul></li><li><p>å¦‚æœæ˜¯åˆ©ç”¨ä¼ ç»Ÿæ–¹å¼éƒ¨ç½²MySQLï¼Œå¤§æ¦‚çš„æ­¥éª¤æœ‰ï¼š</p><ul><li>æœç´¢å¹¶ä¸‹è½½MySQLå®‰è£…åŒ…</li><li>ä¸Šä¼ è‡³Linuxç¯å¢ƒ</li><li>ç¼–è¯‘å’Œé…ç½®ç¯å¢ƒ</li><li>å®‰è£…</li></ul></li><li><p>æˆ‘ä»¬åˆ©ç”¨Dockeræ¥éƒ¨ç½²MySQL</p><ul><li><p>ä¸€æ­¥å³å¯</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/11/5UjOryd3Atzpib9.png" alt="img"></p></li><li><p>éƒ¨ç½²å®Œæ¯•åï¼Œé€šè¿‡ä»»æ„å®¢æˆ·ç«¯å·¥å…·è¿æ¥MySQL</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/HcoW7NZfAemkF3J.png" alt="img"></li></ul></li><li><p>å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤åï¼ŒDockeråšçš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œæ˜¯å»è‡ªåŠ¨æœç´¢å¹¶ä¸‹è½½äº†MySQLï¼Œç„¶åä¼šè‡ªåŠ¨è¿è¡ŒMySQLï¼Œæˆ‘ä»¬å®Œå…¨ä¸ç”¨æ’æ‰‹</p></li><li><p>è¿™ç§å®‰è£…æ–¹å¼ä½ å®Œå…¨ä¸ç”¨è€ƒè™‘è¿è¡Œçš„æ“ä½œç³»ç»Ÿç¯å¢ƒï¼Œå®ƒä¸ä»…ä»…åœ¨CentOSç³»ç»Ÿæ˜¯è¿™æ ·ï¼Œåœ¨Ubuntuç³»ç»Ÿã€macOSç³»ç»Ÿã€ç”šè‡³æ˜¯è£…äº†WSLçš„Windowsä¸‹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤æ¥å®‰è£…MySQLã€‚è¦çŸ¥é“ï¼Œ<strong>ä¸åŒæ“ä½œç³»ç»Ÿä¸‹å…¶å®‰è£…åŒ…ã€è¿è¡Œç¯å¢ƒæ˜¯éƒ½ä¸ç›¸åŒçš„</strong>ï¼å¦‚æœæ˜¯<strong>æ‰‹åŠ¨å®‰è£…ï¼Œå¿…é¡»æ‰‹åŠ¨è§£å†³å®‰è£…åŒ…ä¸åŒã€ç¯å¢ƒä¸åŒçš„ã€é…ç½®ä¸åŒçš„é—®é¢˜</strong>ï¼</p></li><li><p>ä½¿ç”¨Dockerï¼Œè¿™äº›å®Œå…¨ä¸ç”¨è€ƒè™‘ã€‚å°±æ˜¯å› ä¸ºDockerä¼šè‡ªåŠ¨æœç´¢å¹¶ä¸‹è½½MySQL</p><ul><li>æ³¨æ„ï¼šè¿™é‡Œä¸‹è½½çš„ä¸æ˜¯å®‰è£…åŒ…ï¼Œè€Œæ˜¯é•œåƒã€‚é•œåƒä¸­ä¸ä»…åŒ…å«äº†MySQLæœ¬èº«ï¼Œè¿˜åŒ…å«äº†å…¶è¿è¡Œæ‰€éœ€è¦çš„ç¯å¢ƒã€é…ç½®ã€ç³»ç»Ÿçº§å‡½æ•°åº“ã€‚å› æ­¤å®ƒåœ¨è¿è¡Œæ—¶å°±æœ‰è‡ªå·±ç‹¬ç«‹çš„ç¯å¢ƒï¼Œå°±å¯ä»¥è·¨ç³»ç»Ÿè¿è¡Œï¼Œä¹Ÿä¸éœ€è¦æ‰‹åŠ¨å†æ¬¡é…ç½®ç¯å¢ƒäº†ã€‚è¿™å¥—ç‹¬ç«‹è¿è¡Œçš„éš”ç¦»ç¯å¢ƒæˆ‘ä»¬ç§°ä¸º<strong>å®¹å™¨</strong></li><li>é•œåƒçš„è‹±æ–‡æ˜¯<code>image</code>ã€å®¹å™¨çš„è‹±æ–‡æ˜¯<code>container</code></li></ul></li><li><p>å› æ­¤ï¼ŒDockerå®‰è£…è½¯ä»¶çš„è¿‡ç¨‹ï¼Œå°±æ˜¯è‡ªåŠ¨æœç´¢ä¸‹è½½é•œåƒï¼Œç„¶ååˆ›å»ºå¹¶è¿è¡Œå®¹å™¨çš„è¿‡ç¨‹</p></li></ul></li><li><p>Dockerä¼šæ ¹æ®å‘½ä»¤ä¸­çš„é•œåƒåç§°è‡ªåŠ¨æœç´¢å¹¶ä¸‹è½½é•œåƒï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå®ƒæ˜¯å»å“ªé‡Œæœç´¢å’Œä¸‹è½½é•œåƒçš„å‘¢ï¼Ÿè¿™äº›é•œåƒåˆæ˜¯è°åˆ¶ä½œçš„å‘¢ï¼Ÿ</p><ul><li>Dockerå®˜æ–¹æä¾›äº†ä¸€ä¸ªä¸“é—¨ç®¡ç†ã€å­˜å‚¨é•œåƒçš„ç½‘ç«™ï¼Œå¹¶å¯¹å¤–å¼€æ”¾äº†é•œåƒä¸Šä¼ ã€ä¸‹è½½çš„æƒåˆ©</li><li>Dockerå®˜æ–¹æä¾›äº†ä¸€äº›åŸºç¡€é•œåƒï¼Œç„¶åå„å¤§è½¯ä»¶å…¬å¸åˆåœ¨åŸºç¡€é•œåƒåŸºç¡€ä¸Šï¼Œåˆ¶ä½œäº†è‡ªå®¶è½¯ä»¶çš„é•œåƒï¼Œå…¨éƒ¨éƒ½å­˜æ”¾åœ¨è¿™ä¸ªç½‘ç«™ï¼Œè¿™ä¸ªç½‘ç«™å°±æˆäº†Dockeré•œåƒäº¤æµçš„ç¤¾åŒº<code>https://hub.docker.com</code></li><li>åŸºæœ¬ä¸Šæˆ‘ä»¬å¸¸ç”¨çš„å„ç§è½¯ä»¶éƒ½èƒ½åœ¨è¿™ä¸ªç½‘ç«™ä¸Šæ‰¾åˆ°</li></ul></li><li><p>åƒè¿™ç§æä¾›å­˜å‚¨ã€ç®¡ç†Dockeré•œåƒçš„æœåŠ¡å™¨ï¼Œè¢«ç§°ä¸º<strong>DockerRegistry</strong>ï¼Œå¯ä»¥ç¿»è¯‘ä¸ºé•œåƒä»“åº“</p><ul><li><strong>DockerHub</strong>ç½‘ç«™æ˜¯å®˜æ–¹ä»“åº“ï¼Œé˜¿é‡Œäº‘ã€åä¸ºäº‘ä¼šæä¾›ä¸€äº›ç¬¬ä¸‰æ–¹ä»“åº“ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ­å»ºç§æœ‰çš„é•œåƒä»“åº“</li><li>å®˜æ–¹ä»“åº“åœ¨å›½å¤–ï¼Œä¸‹è½½é€Ÿåº¦è¾ƒæ…¢ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹ä»“åº“æä¾›çš„é•œåƒåŠ é€ŸåŠŸèƒ½ï¼Œæé«˜ä¸‹è½½é€Ÿåº¦</li><li>ä¼ä¸šå†…éƒ¨çš„æœºå¯†é¡¹ç›®ï¼Œå¾€å¾€ä¼šé‡‡ç”¨ç§æœ‰é•œåƒä»“åº“</li><li>é•œåƒçš„æ¥æºæœ‰ä¸¤ç§<ul><li>åŸºäºå®˜æ–¹åŸºç¡€é•œåƒè‡ªå·±åˆ¶ä½œ</li><li>ç›´æ¥å»DockerRegistryä¸‹è½½</li></ul></li></ul></li><li><p>æ€»ç»“</p><ul><li>Dockeræœ¬èº«åŒ…å«ä¸€ä¸ªåå°æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Dockerå‘½ä»¤å‘Šè¯‰DockeræœåŠ¡ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿéƒ¨ç½²æŒ‡å®šçš„åº”ç”¨</li><li>DockeræœåŠ¡éƒ¨ç½²åº”ç”¨æ—¶ï¼Œé¦–å…ˆè¦å»æœç´¢å¹¶ä¸‹è½½åº”ç”¨å¯¹åº”çš„é•œåƒï¼Œç„¶åæ ¹æ®é•œåƒåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼Œåº”ç”¨å°±éƒ¨ç½²å®Œæˆäº†</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/06/lBtPNbYkMHxFoO4.png" alt="img"></li></ul></li></ul><h3 id="å‘½ä»¤è§£è¯»"><a href="#å‘½ä»¤è§£è¯»" class="headerlink" title="å‘½ä»¤è§£è¯»"></a>å‘½ä»¤è§£è¯»</h3><ul><li>ä»¥ä¸‹æ˜¯éƒ¨ç½²mysqlæ—¶çš„å‘½ä»¤ï¼Œä»–ä»¬æœ‰ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿ</li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure><ul><li><p>è§£è¯»</p><ul><li><p><code>docker run -d</code> ï¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œ<code>-d</code>åˆ™æ˜¯è®©å®¹å™¨é‡Œçš„è¿›ç¨‹åœ¨åå°è¿è¡Œ</p></li><li><p><code>--name mysql </code> : ç»™å®¹å™¨èµ·ä¸ªåå­—å«<code>mysql</code> ï¼Œå…¨å±€å”¯ä¸€</p></li><li><p><code>-p 3306:3306</code> : è®¾ç½®ç«¯å£æ˜ å°„</p><ul><li>å®¹å™¨å…¶å®å°±æ˜¯ä¸€ä¸ªå°å‹çš„æœåŠ¡ï¼Œä¹Ÿæœ‰ipåœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•pingé€šï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥pingé€šè™šæ‹Ÿæœºçš„ip</li><li><strong>å®¹å™¨æ˜¯éš”ç¦»ç¯å¢ƒ</strong>ï¼Œå¤–ç•Œä¸å¯è®¿é—®ï¼Œä½†æ˜¯å¯ä»¥å°†<strong>å®¿ä¸»æœºï¼ˆè™šæ‹Ÿæœºï¼‰ç«¯å£æ˜ å°„å®¹å™¨å†…åˆ°ç«¯å£</strong>ï¼Œå½“è®¿é—®å®¿ä¸»æœºæŒ‡å®šç«¯å£æ—¶ï¼Œå°±æ˜¯åœ¨è®¿é—®å®¹å™¨å†…çš„ç«¯å£äº†</li><li>å®¹å™¨å†…ç«¯å£å¾€å¾€æ˜¯ç”±å®¹å™¨å†…çš„è¿›ç¨‹å†³å®šï¼Œä¾‹å¦‚MySQLè¿›ç¨‹é»˜è®¤ç«¯å£æ˜¯3306ï¼Œå› æ­¤å®¹å™¨å†…ç«¯å£ä¸€å®šæ˜¯3306ï¼›è€Œå®¿ä¸»æœºç«¯å£åˆ™å¯ä»¥ä»»æ„æŒ‡å®šï¼Œä¸€èˆ¬ä¸å®¹å™¨å†…ä¿æŒä¸€è‡´</li><li>æ ¼å¼ï¼š <code>-p å®¿ä¸»æœºç«¯å£:å®¹å™¨å†…ç«¯å£</code>ï¼Œç¤ºä¾‹ä¸­å°±æ˜¯å°†å®¿ä¸»æœºçš„3306æ˜ å°„åˆ°å®¹å™¨å†…çš„3306ç«¯å£</li></ul></li><li><p><code>-e TZ=Asia/Shanghai</code> : é…ç½®å®¹å™¨å†…è¿›ç¨‹è¿è¡Œæ—¶çš„ä¸€äº›å‚æ•°ï¼ˆé…ç½®å®¹å™¨è¿è¡Œæ—¶éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼‰</p><ul><li>æ ¼å¼ï¼š<code>-e KEY=VALUE</code>ï¼ŒKEYå’ŒVALUEéƒ½ç”±å®¹å™¨å†…è¿›ç¨‹å†³å®š</li><li>æ¡ˆä¾‹ä¸­ï¼Œ<code>TZ=Asia/Shanghai</code>æ˜¯è®¾ç½®æ—¶åŒºï¼›<code>MYSQL_ROOT_PASSWORD=123</code>æ˜¯è®¾ç½®MySQLé»˜è®¤å¯†ç </li></ul></li><li><p><code>mysql</code> : <strong>é•œåƒ</strong>åç§°ï¼ˆREPOSITORYï¼‰ï¼ŒDockerä¼šæ ¹æ®è¿™ä¸ªåå­—æœç´¢å¹¶ä¸‹è½½é•œåƒ</p><ul><li><p>æ ¼å¼ï¼š<code>REPOSITORY:TAG</code>ï¼Œä¾‹å¦‚<code>mysql:8.0</code>ï¼Œå…¶ä¸­<code>REPOSITORY</code>å¯ä»¥ç†è§£ä¸ºé•œåƒåï¼Œ<code>TAG</code>æ˜¯ç‰ˆæœ¬å·</p></li><li><p>åœ¨æœªæŒ‡å®š<code>TAG</code>çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯<code>mysql:latest</code></p></li></ul></li></ul></li><li><p>é•œåƒçš„åç§°ä¸æ˜¯éšæ„çš„ï¼Œè€Œæ˜¯è¦åˆ°DockerRegistryä¸­å¯»æ‰¾ï¼Œé•œåƒè¿è¡Œæ—¶çš„é…ç½®ä¹Ÿä¸æ˜¯éšæ„çš„ï¼Œè¦å‚è€ƒé•œåƒçš„å¸®åŠ©æ–‡æ¡£ï¼Œè¿™äº›åœ¨DockerHubç½‘ç«™æˆ–è€…è½¯ä»¶çš„å®˜æ–¹ç½‘ç«™ä¸­éƒ½èƒ½æ‰¾åˆ°</p></li><li><p>å¦‚æœæˆ‘ä»¬è¦å®‰è£…å…¶å®ƒè½¯ä»¶ï¼Œä¹Ÿå¯ä»¥åˆ°<a href="https://hub.docker.com/">DockerRegistry</a>ä¸­å¯»æ‰¾å¯¹åº”çš„é•œåƒåç§°å’Œç‰ˆæœ¬ï¼Œé˜…è¯»ç›¸å…³é…ç½®å³å¯</p></li></ul><h3 id="DockeråŸºç¡€"><a href="#DockeråŸºç¡€" class="headerlink" title="DockeråŸºç¡€"></a>DockeråŸºç¡€</h3><h4 id="Dockerå¸¸è§å‘½ä»¤"><a href="#Dockerå¸¸è§å‘½ä»¤" class="headerlink" title="Dockerå¸¸è§å‘½ä»¤"></a>Dockerå¸¸è§å‘½ä»¤</h4><blockquote><p>å®˜æ–¹æ–‡æ¡£<code>https://docs.docker.com/</code></p></blockquote><ul><li><p>å¸¸è§çš„å‘½ä»¤æœ‰</p><ul><li><table><thead><tr><th align="center"><strong>å‘½ä»¤</strong></th><th align="center"><strong>è¯´æ˜</strong></th><th align="center"><strong>æ–‡æ¡£åœ°å€</strong></th></tr></thead><tbody><tr><td align="center">docker pull</td><td align="center">æ‹‰å–é•œåƒ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/pull/">docker pull</a></td></tr><tr><td align="center">docker push</td><td align="center">æ¨é€é•œåƒåˆ°DockerRegistry</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/push/">docker push</a></td></tr><tr><td align="center">docker images</td><td align="center">æŸ¥çœ‹æœ¬åœ°é•œåƒ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td></tr><tr><td align="center">docker rmi</td><td align="center">åˆ é™¤æœ¬åœ°é•œåƒ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td></tr><tr><td align="center">docker run</td><td align="center">åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼ˆä¸èƒ½é‡å¤åˆ›å»ºï¼‰</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td></tr><tr><td align="center">docker stop</td><td align="center">åœæ­¢æŒ‡å®šå®¹å™¨</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td></tr><tr><td align="center">docker start</td><td align="center">å¯åŠ¨æŒ‡å®šå®¹å™¨</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td></tr><tr><td align="center">docker restart</td><td align="center">é‡æ–°å¯åŠ¨å®¹å™¨</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td></tr><tr><td align="center">docker rm</td><td align="center">åˆ é™¤æŒ‡å®šå®¹å™¨</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td></tr><tr><td align="center">docker ps</td><td align="center">æŸ¥çœ‹å®¹å™¨</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td></tr><tr><td align="center">docker logs</td><td align="center">æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¥å¿—</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td></tr><tr><td align="center">docker exec</td><td align="center">è¿›å…¥å®¹å™¨</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td></tr><tr><td align="center">docker save</td><td align="center">ä¿å­˜é•œåƒåˆ°æœ¬åœ°å‹ç¼©æ–‡ä»¶</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td></tr><tr><td align="center">docker load</td><td align="center">åŠ è½½æœ¬åœ°å‹ç¼©æ–‡ä»¶åˆ°é•œåƒ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td></tr><tr><td align="center">docker inspect</td><td align="center">æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td></tr></tbody></table></li><li><p><code>docker command --help</code>æŸ¥çœ‹å½“å‰å‘½ä»¤çš„å¸®åŠ©æ–‡æ¡£</p></li></ul></li><li><p>è¡¥å……</p><ul><li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¬¡é‡å¯è™šæ‹Ÿæœºæˆ‘ä»¬éƒ½éœ€è¦æ‰‹åŠ¨å¯åŠ¨Dockerå’ŒDockerä¸­çš„å®¹å™¨ï¼›é€šè¿‡å‘½ä»¤å¯ä»¥å®ç°å¼€æœºè‡ªå¯</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Dockerå¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl enable docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dockerå®¹å™¨å¼€æœºè‡ªå¯</span></span><br><span class="line">docker update <span class="literal">--restart</span>=always [å®¹å™¨å/å®¹å™¨<span class="type">id</span>]</span><br></pre></td></tr></table></figure></li></ul></li><li><p>å‘½ä»¤ä¹‹é—´çš„å…³ç³»</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/08/bSWLIyFfZn69X2O.png" alt="img"></li></ul></li><li><p>æ¡ˆä¾‹</p><ul><li>éœ€æ±‚ï¼šæŸ¥çœ‹DockerHubï¼Œæ‹‰å–Nginxé•œåƒï¼Œåˆ›å»ºå¹¶è¿è¡ŒNginxå®¹å™¨<ul><li><p>æŸ¥çœ‹DockerHub</p><ul><li><code>https://hub.docker.com/nginx</code></li></ul></li><li><p>æ‹‰å–Nginxé•œåƒ</p><ul><li><code>docker pull nginx</code></li></ul></li><li><p>æŸ¥çœ‹æœ¬åœ°é•œåƒåˆ—è¡¨</p><ul><li><code>docker images</code></li></ul></li><li><p>åˆ›å»ºå¹¶è¿è¡ŒNginxå®¹å™¨</p><ul><li><code>dokcer run -d --name nginx -p 81:80 nginx</code></li></ul></li><li><p>æŸ¥çœ‹å®¹å™¨</p><ul><li><code>docker ps -a</code></li><li>æ ¼å¼åŒ–æŸ¥è¯¢<code>docker ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</code></li></ul></li><li><p>æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¥å¿—</p><ul><li><code>docker logs nginx</code></li></ul></li><li><p>åœæ­¢å®¹å™¨</p><ul><li><code>docker stop nginx</code></li></ul></li><li><p>å†æ¬¡å¯åŠ¨å®¹å™¨</p><ul><li><code>docker start nginx</code></li></ul></li><li><p>è¿›å…¥Nginxå®¹å™¨</p><ul><li><code>docker exec -it nginx bash</code></li></ul></li><li><p>åˆ é™¤å®¹å™¨</p><ul><li><code>docker rm nginx</code>ï¼Œéœ€è¦å…ˆå…³é—­nginxå®¹å™¨</li><li>å¼ºåˆ¶åˆ é™¤<code>docker rm -f nginx</code></li></ul></li></ul></li></ul></li><li><p>å‘½ä»¤åˆ«å</p><ul><li><p>ç»™å¸¸ç”¨Dockerå‘½ä»¤èµ·åˆ«åï¼Œæ–¹ä¾¿è®¿é—®</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹/root/.bashrcæ–‡ä»¶</span></span><br><span class="line">vim /root/.bashrc</span><br><span class="line">å†…å®¹å¦‚ä¸‹ï¼š</span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line">alias <span class="built_in">rm</span>=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line">alias <span class="built_in">cp</span>=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line">alias <span class="built_in">mv</span>=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line">alias dps=<span class="string">&#x27;docker ps --format &quot;table&#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;&#x27;</span></span><br><span class="line">alias dis=<span class="string">&#x27;docker images&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -<span class="type">f</span> /<span class="type">etc</span>/<span class="type">bashrc</span> ]; then</span><br><span class="line">        . /etc/bashrc</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®ç”Ÿæ•ˆ</p><ul><li><code>source /root/.bashrc</code></li></ul></li></ul></li></ul><h4 id="æ•°æ®å·ï¼ˆvolumeï¼‰"><a href="#æ•°æ®å·ï¼ˆvolumeï¼‰" class="headerlink" title="æ•°æ®å·ï¼ˆvolumeï¼‰"></a>æ•°æ®å·ï¼ˆvolumeï¼‰</h4><ul><li><p>å®¹å™¨æ˜¯éš”ç¦»ç¯å¢ƒï¼Œå®¹å™¨å†…ç¨‹åºçš„æ–‡ä»¶ã€é…ç½®ã€è¿è¡Œæ—¶äº§ç”Ÿçš„å®¹å™¨éƒ½åœ¨å®¹å™¨å†…éƒ¨ï¼Œæˆ‘ä»¬è¦è¯»å†™å®¹å™¨å†…çš„æ–‡ä»¶éå¸¸ä¸æ–¹ä¾¿ï¼Œè€Œä»¥ä¸‹é—®é¢˜çš„è§£å†³å°±ä¾èµ–äºæ•°æ®å·</p><ul><li>å¦‚æœè¦å‡çº§MySQLç‰ˆæœ¬ï¼Œéœ€è¦é”€æ¯æ—§å®¹å™¨ï¼Œé‚£ä¹ˆæ•°æ®å²‚ä¸æ˜¯è·Ÿç€è¢«é”€æ¯äº†ï¼Ÿ</li><li>MySQLã€Nginxå®¹å™¨è¿è¡Œåï¼Œå¦‚æœæˆ‘è¦ä¿®æ”¹å…¶ä¸­çš„æŸäº›é…ç½®è¯¥æ€ä¹ˆåŠï¼Ÿ</li><li>æˆ‘æƒ³è¦è®©Nginxä»£ç†æˆ‘çš„é™æ€èµ„æºæ€ä¹ˆåŠï¼Ÿ</li></ul></li><li><p>å› æ­¤ï¼Œå®¹å™¨æä¾›ç¨‹åºçš„è¿è¡Œç¯å¢ƒï¼Œä½†æ˜¯<strong>ç¨‹åºè¿è¡Œäº§ç”Ÿçš„æ•°æ®ã€ç¨‹åºè¿è¡Œä¾èµ–çš„é…ç½®éƒ½åº”è¯¥ä¸å®¹å™¨</strong>è§£è€¦ã€‚</p></li><li><p>ä½•ä¸ºæ•°æ®å·ï¼Ÿ</p><ul><li><strong>æ•°æ®å·</strong>æ˜¯ä¸€ä¸ªè™šæ‹Ÿç›®å½•ï¼Œæ˜¯<strong>å®¹å™¨å†…ç›®å½•</strong>ä¸<strong>å®¿ä¸»æœº</strong>ç›®å½•ä¹‹é—´æ˜ å°„çš„æ¡¥æ¢</li></ul></li><li><p>æ¡ˆä¾‹1-åˆ©ç”¨Nginxå®¹å™¨éƒ¨ç½²é™æ€èµ„æº</p><ul><li><p>ä»¥Nginxä¸ºä¾‹ï¼Œæˆ‘ä»¬çŸ¥é“Nginxä¸­æœ‰ä¸¤ä¸ªå…³é”®çš„ç›®å½•</p><ul><li><code>html</code>ï¼šæ”¾ç½®ä¸€äº›é™æ€èµ„æº</li><li><code>conf</code>ï¼šæ”¾ç½®é…ç½®æ–‡ä»¶</li><li>å¦‚æœæˆ‘ä»¬è¦è®©Nginxä»£ç†æˆ‘ä»¬çš„é™æ€èµ„æºï¼Œæœ€å¥½æ˜¯æ”¾åˆ°<code>html</code>ç›®å½•ï¼›å¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹Nginxçš„é…ç½®ï¼Œæœ€å¥½æ˜¯æ‰¾åˆ°<code>conf</code>ä¸‹çš„<code>nginx.conf</code>æ–‡ä»¶</li><li>ä½†é—æ†¾çš„æ˜¯ï¼Œå®¹å™¨è¿è¡Œçš„Nginxæ‰€æœ‰çš„æ–‡ä»¶éƒ½åœ¨å®¹å™¨å†…éƒ¨ã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»åˆ©ç”¨æ•°æ®å·å°†ä¸¤ä¸ªç›®å½•ä¸å®¿ä¸»æœºç›®å½•å…³è”ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œ</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/12/cwC6Kz8iNFd9kft.png" alt="img"></li><li>åœ¨ä¸Šå›¾ä¸­<ul><li>æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®å·ï¼š<code>conf</code>ã€<code>html</code></li><li>Nginxå®¹å™¨å†…éƒ¨çš„<code>conf</code>ç›®å½•å’Œ<code>html</code>ç›®å½•åˆ†åˆ«ä¸ä¸¤ä¸ªæ•°æ®å·å…³è”ã€‚</li><li>è€Œæ•°æ®å·confå’Œhtmlåˆ†åˆ«æŒ‡å‘äº†å®¿ä¸»æœºçš„<code>/var/lib/docker/volumes/conf/_data</code>ç›®å½•å’Œ<code>/var/lib/docker/volumes/html/_data</code>ç›®å½•</li><li>è¿™æ ·ä»¥æ¥ï¼Œå®¹å™¨å†…çš„<code>conf</code>å’Œ<code>html</code>ç›®å½•å°± ä¸å®¿ä¸»æœºçš„<code>conf</code>å’Œ<code>html</code>ç›®å½•å…³è”èµ·æ¥ï¼Œæˆ‘ä»¬ç§°ä¸º<strong>æŒ‚è½½</strong></li><li>æ­¤æ—¶ï¼Œæˆ‘ä»¬æ“ä½œå®¿ä¸»æœºçš„<code>/var/lib/docker/volumes/html/_data</code>å°±æ˜¯åœ¨æ“ä½œå®¹å™¨å†…éƒ¨çš„<code>/usr/share/nginx/html/_data</code>ç›®å½•ï¼›åªè¦æˆ‘ä»¬å°†é™æ€èµ„æºæ”¾å…¥å®¿ä¸»æœºå¯¹åº”ç›®å½•ï¼Œå°±å¯ä»¥è¢«Nginxä»£ç†äº†</li></ul></li></ul></li><li><p><strong>å°æç¤º</strong></p><ul><li><p><code>/var/lib/docker/volumes</code>è¿™ä¸ªç›®å½•å°±æ˜¯é»˜è®¤çš„å­˜æ”¾æ‰€æœ‰å®¹å™¨æ•°æ®å·çš„ç›®å½•ï¼Œå…¶ä¸‹å†æ ¹æ®æ•°æ®å·åç§°åˆ›å»ºæ–°ç›®å½•ï¼Œæ ¼å¼ä¸º<code>/æ•°æ®å·å/_data</code></p></li><li><p>ä¸ºä»€ä¹ˆä¸è®©å®¹å™¨ç›®å½•ç›´æ¥æŒ‡å‘å®¿ä¸»æœºç›®å½•å‘¢ï¼Ÿ</p><ul><li>å› ä¸ºç›´æ¥æŒ‡å‘å®¿ä¸»æœºç›®å½•å°±ä¸å®¿ä¸»æœºå¼ºè€¦åˆäº†ï¼Œå¦‚æœåˆ‡æ¢äº†ç¯å¢ƒï¼Œå®¿ä¸»æœºç›®å½•å°±å¯èƒ½å‘ç”Ÿæ”¹å˜ã€‚ç”±äºå®¹å™¨ä¸€æ—¦åˆ›å»ºï¼Œç›®å½•æŒ‚è½½å°±æ— æ³•ä¿®æ”¹ï¼Œè¿™æ ·å®¹å™¨å°±æ— æ³•æ­£å¸¸å·¥ä½œäº†</li></ul></li><li><p>ä½†æ˜¯å®¹å™¨æŒ‡å‘æ•°æ®å·ï¼Œä¸€ä¸ªé€»è¾‘åç§°ï¼Œè€Œæ•°æ®å·å†æŒ‡å‘å®¿ä¸»æœºç›®å½•ï¼Œå°±ä¸å­˜åœ¨å¼ºè€¦åˆã€‚å¦‚æœå®¿ä¸»æœºç›®å½•å‘ç”Ÿæ”¹å˜ï¼Œåªè¦æ”¹å˜æ•°æ®å·ä¸å®¿ä¸»æœºç›®å½•ä¹‹é—´çš„æ˜ å°„å…³ç³»å³å¯</p></li><li><p>ä¸è¿‡ï¼Œæˆ‘ä»¬é€šè¿‡ç”±äºæ•°æ®å·ç›®å½•æ¯”è¾ƒæ·±ï¼Œä¸å¥½å¯»æ‰¾ï¼Œé€šå¸¸æˆ‘ä»¬ä¹Ÿ<strong>å…è®¸è®©å®¹å™¨ç›´æ¥ä¸å®¿ä¸»æœºç›®å½•æŒ‚è½½</strong>è€Œä¸ä½¿ç”¨æ•°æ®å·</p></li></ul></li></ul></li><li><p>æ•°æ®å·çš„ç›¸å…³å‘½ä»¤</p><ul><li><table><thead><tr><th align="center"><strong>å‘½ä»¤</strong></th><th align="center"><strong>è¯´æ˜</strong></th><th align="center"><strong>æ–‡æ¡£åœ°å€</strong></th></tr></thead><tbody><tr><td align="center">docker volume create</td><td align="center">åˆ›å»ºæ•°æ®å·</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_create/">docker volume create</a></td></tr><tr><td align="center">docker volume ls</td><td align="center">æŸ¥çœ‹æ‰€æœ‰æ•°æ®å·</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_ls/">docs.docker.com</a></td></tr><tr><td align="center">docker volume rm</td><td align="center">åˆ é™¤æŒ‡å®šæ•°æ®å·</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docs.docker.com</a></td></tr><tr><td align="center">docker volume inspect</td><td align="center">æŸ¥çœ‹æŸä¸ªæ•°æ®å·çš„è¯¦æƒ…</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_inspect/">docs.docker.com</a></td></tr><tr><td align="center">docker volume prune</td><td align="center">æ¸…é™¤æ•°æ®å·</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docker volume prune</a></td></tr></tbody></table></li><li><p>æ³¨æ„</p><ul><li>å®¹å™¨ä¸æ•°æ®å·çš„æŒ‚è½½è¦åœ¨<strong>åˆ›å»ºå®¹å™¨æ—¶é…ç½®</strong>ï¼Œå¯¹äºåˆ›å»ºå¥½çš„å®¹å™¨ï¼Œæ˜¯ä¸èƒ½è®¾ç½®æ•°æ®å·çš„</li><li><strong>åˆ›å»ºå®¹å™¨çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®å·ä¼šè‡ªåŠ¨åˆ›å»º</strong></li></ul></li></ul></li><li><p>Nginxçš„htmlç›®å½•æŒ‚è½½</p><ul><li>é¦–å…ˆåˆ›å»ºå®¹å™¨å¹¶æŒ‡å®šæ•°æ®å·ï¼Œæ³¨æ„é€šè¿‡ -v å‚æ•°æ¥æŒ‡å®šæ•°æ®å·<ul><li><code>docker run -d --name nginx -p 81:80 -v html(æ•°æ®å·å):/usr/share/nginx/html(å®¹å™¨å†…ç›®å½•) nginx</code></li></ul></li><li>æŸ¥çœ‹æ•°æ®å·<ul><li><code>docker volume ls</code></li></ul></li><li>æŸ¥çœ‹æ•°æ®å·å…·ä½“ä¿¡æ¯<ul><li><code>docker volume inspect html(æ•°æ®å·å)</code></li><li>å¾—åˆ°å®¿ä¸»æœºç›®å½•ï¼Œå¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹</li></ul></li><li>è¿›å…¥å®¹å™¨å†…éƒ¨ï¼ŒæŸ¥çœ‹å®¹å™¨å†…ç›®å½•å†…çš„æ–‡ä»¶æ˜¯å¦å˜åŒ–<ul><li><code>docker exec -it nginx bash</code></li><li><code>cd /usr/share/nginx/html(å®¹å™¨å†…ç›®å½•)</code></li></ul></li></ul></li><li><p>æœ¬åœ°ç›®å½•&#x2F;æ–‡ä»¶æŒ‚è½½</p><ul><li><p>æ¡ˆä¾‹2-mysqlå®¹å™¨çš„æ•°æ®æŒ‚è½½</p><ul><li>éœ€æ±‚<ul><li>æŸ¥çœ‹mysqlå®¹å™¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®å·æŒ‚è½½</li><li>åŸºäºå®¿ä¸»æœºç›®å½•å®ç°MySQLæ•°æ®ç›®å½•ã€é…ç½®æ–‡ä»¶ã€åˆå§‹åŒ–è„šæœ¬çš„æŒ‚è½½ï¼ˆæŸ¥é˜…å®˜æ–¹é•œåƒæ–‡æ¡£ï¼‰</li></ul></li></ul></li><li><p>æŸ¥çœ‹å®¹å™¨æ˜¯å¦æŒ‚è½½</p><ul><li><code>docker inspect å®¹å™¨å</code></li></ul></li><li><p>åŒ¿åæ•°æ®å·</p><ul><li><p>ä½¿ç”¨<code>docker inspect å®¹å™¨å</code>åï¼Œå…³æ³¨</p><ul><li><p><code>.Config.Volumes</code></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;/var/lib/mysql&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥å‘ç°è¿™ä¸ªå®¹å™¨å£°æ˜äº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œéœ€è¦æŒ‚è½½æ•°æ®å·ï¼Œä½†æ˜¯<strong>æ•°æ®å·æœªå®šä¹‰</strong>ï¼›è¿™å°±æ˜¯åŒ¿åå·ã€‚</p></li><li><p><code>.Mounts</code></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;volume&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>Nameï¼šæ•°æ®å·åç§°ã€‚ç”±äºå®šä¹‰å®¹å™¨æœªè®¾ç½®å®¹å™¨åï¼Œè¿™é‡Œçš„å°±æ˜¯åŒ¿åå·è‡ªåŠ¨ç”Ÿæˆçš„åå­—ï¼Œä¸€ä¸²hashå€¼ã€‚</li><li>Sourceï¼šå®¿ä¸»æœºç›®å½•</li><li>Destination : å®¹å™¨å†…çš„ç›®å½•</li><li>ä¸Šè¿°é…ç½®æ˜¯å°†å®¹å™¨å†…çš„<code>/var/lib/mysql</code>è¿™ä¸ªç›®å½•ï¼Œä¸æ•°æ®å·<code>29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f</code>æŒ‚è½½ã€‚äºæ˜¯åœ¨å®¿ä¸»æœºä¸­å°±æœ‰äº†<code>/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</code>è¿™ä¸ªç›®å½•ã€‚è¿™å°±æ˜¯åŒ¿åæ•°æ®å·å¯¹åº”çš„ç›®å½•ï¼Œå…¶ä½¿ç”¨æ–¹å¼ä¸æ™®é€šæ•°æ®å·æ²¡æœ‰å·®åˆ«</li></ul></li></ul></li><li><p>å¯ä»¥å‘ç°ï¼Œæ•°æ®å·çš„ç›®å½•ç»“æ„è¾ƒæ·±ï¼Œå¦‚æœæˆ‘ä»¬å»æ“ä½œæ•°æ®å·ç›®å½•ä¼šä¸å¤ªæ–¹ä¾¿ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šç›´æ¥å°†å®¹å™¨ç›®å½•ä¸å®¿ä¸»æœºæŒ‡å®šç›®å½•æŒ‚è½½</p></li></ul></li><li><p>å®ç°æœ¬åœ°ç›®å½•æŒ‚è½½</p><ul><li><p>æŸ¥çœ‹docker-mysqlå®˜æ–¹é•œåƒè·å–å„ä¸ªè·¯å¾„</p><ul><li>mysqlçš„æ•°æ®ç›®å½•è·¯å¾„<code>/var/lib/mysql</code></li><li>é…ç½®æ–‡ä»¶è·¯å¾„<code>/etc/mysql/my.cnf</code></li><li>åˆå§‹åŒ–è„šæœ¬è·¯å¾„<code>/docker-entrypoint-initdb.d</code></li></ul></li><li><p>è®¾è®¡æœ¬åœ°æŒ‚è½½ç›®å½•</p><ul><li><code>/root/mysql/init</code>-&gt; <code>/docker-entrypoint-initdb.d</code></li><li><code>/root/mysql/data</code>-&gt; <code>/var/lib/mysql</code></li><li><code>/root/mysql/conf</code>-&gt;<code>/etc/mysql/my.cnf</code></li><li>æ³¨æ„ï¼šæœ¬åœ°ç›®å½•éœ€è¦ç»å¯¹è·¯å¾„ï¼ˆ&#x2F; æˆ–.&#x2F; å¼€å¤´ï¼‰ï¼Œå¦åˆ™ä¼šä»¥ä¸ºæ˜¯æ•°æ®å·æŒ‚è½½</li></ul></li><li><p>åˆ›å»ºæœ¬åœ°ç›®å½•mysql</p><ul><li><code>mkdir data | mkdir init | mkdir conf</code></li><li>å¯¼å…¥é»‘é©¬çš„sqlå’Œé…ç½®æ–‡ä»¶</li></ul></li><li><p>å‘½ä»¤è„šæœ¬</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3306</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line">  <span class="literal">-v</span> ./mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line">  <span class="literal">-v</span> ./mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">  <span class="literal">-v</span> ./mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡Navicatç­‰è¿æ¥mysqlæŸ¥çœ‹æ˜¯å¦æœ‰hmallæ•°æ®åº“</p></li></ul></li></ul></li></ul><h4 id="è‡ªå®šä¹‰é•œåƒ"><a href="#è‡ªå®šä¹‰é•œåƒ" class="headerlink" title="è‡ªå®šä¹‰é•œåƒ"></a>è‡ªå®šä¹‰é•œåƒ</h4><ul><li><p>é•œåƒç»“æ„</p><ul><li>é•œåƒä¹‹æ‰€ä»¥èƒ½è®©æˆ‘ä»¬å¿«é€Ÿè·¨æ“ä½œç³»ç»Ÿéƒ¨ç½²åº”ç”¨è€Œå¿½ç•¥å…¶è¿è¡Œç¯å¢ƒã€é…ç½®ï¼Œå°±æ˜¯å› ä¸ºé•œåƒä¸­åŒ…å«äº†ç¨‹åºè¿è¡Œéœ€è¦çš„ç³»ç»Ÿå‡½æ•°åº“ã€ç¯å¢ƒã€é…ç½®ã€ä¾èµ–</li><li>å› æ­¤ï¼Œè‡ªå®šä¹‰é•œåƒæœ¬è´¨å°±æ˜¯ä¾æ¬¡å‡†å¤‡å¥½ç¨‹åºè¿è¡Œçš„<strong>åŸºç¡€ç¯å¢ƒã€ä¾èµ–ã€åº”ç”¨æœ¬èº«ã€è¿è¡Œé…ç½®</strong>ç­‰æ–‡ä»¶ï¼Œåˆ†æˆæ‰“åŒ…</li><li>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è¦ä»0éƒ¨ç½²ä¸€ä¸ªJavaåº”ç”¨ï¼Œå¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·ï¼š<ul><li>å‡†å¤‡ä¸€ä¸ªlinuxæœåŠ¡ï¼ˆCentOSæˆ–è€…Ubuntuå‡å¯ï¼‰</li><li>å®‰è£…å¹¶é…ç½®JDK</li><li>ä¸Šä¼ JaråŒ…</li><li>è¿è¡ŒJaråŒ…</li></ul></li><li>é‚£å› æ­¤ï¼Œæˆ‘ä»¬æ‰“åŒ…é•œåƒä¹Ÿæ˜¯åˆ†æˆè¿™ä¹ˆå‡ æ­¥ï¼š<ul><li>å‡†å¤‡Linuxè¿è¡Œç¯å¢ƒï¼ˆjavaé¡¹ç›®å¹¶ä¸éœ€è¦å®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œä»…ä»…æ˜¯åŸºç¡€è¿è¡Œç¯å¢ƒå³å¯ï¼‰</li><li>å®‰è£…å¹¶é…ç½®JDK</li><li>æ‹·è´jaråŒ…</li><li>é…ç½®å¯åŠ¨è„šæœ¬</li><li>ä¸Šè¿°æ­¥éª¤ä¸­çš„æ¯ä¸€æ¬¡æ“ä½œå…¶å®éƒ½æ˜¯åœ¨ç”Ÿäº§ä¸€äº›æ–‡ä»¶ï¼ˆç³»ç»Ÿè¿è¡Œç¯å¢ƒã€å‡½æ•°åº“ã€é…ç½®æœ€ç»ˆéƒ½æ˜¯ç£ç›˜æ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥<strong>é•œåƒå°±æ˜¯ä¸€å †æ–‡ä»¶çš„é›†åˆ</strong></li><li>é•œåƒæ–‡ä»¶ä¸æ˜¯éšæ„å †æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§æ“ä½œçš„æ­¥éª¤åˆ†å±‚å åŠ è€Œæˆï¼Œæ¯ä¸€å±‚å½¢æˆçš„æ–‡ä»¶éƒ½ä¼šå•ç‹¬æ‰“åŒ…å¹¶æ ‡è®°ä¸€ä¸ªå”¯ä¸€idï¼Œç§°ä¸º<strong>Layer</strong>ï¼ˆ<strong>å±‚</strong>ï¼‰ã€‚è¿™æ ·ï¼Œå¦‚æœæˆ‘ä»¬æ„å»ºæ—¶ç”¨åˆ°çš„æŸäº›å±‚å…¶ä»–äººå·²ç»åˆ¶ä½œè¿‡ï¼Œå°±å¯ä»¥ç›´æ¥æ‹·è´ä½¿ç”¨è¿™äº›å±‚ï¼Œè€Œä¸ç”¨é‡å¤åˆ¶ä½œ</li><li>ä¾‹å¦‚ï¼Œç¬¬ä¸€æ­¥ä¸­éœ€è¦çš„Linuxè¿è¡Œç¯å¢ƒï¼Œé€šç”¨æ€§å°±å¾ˆå¼ºï¼Œæ‰€ä»¥Dockerå®˜æ–¹å°±åˆ¶ä½œäº†è¿™æ ·çš„åªåŒ…å«Linuxè¿è¡Œç¯å¢ƒçš„é•œåƒã€‚æˆ‘ä»¬åœ¨åˆ¶ä½œjavaé•œåƒæ—¶ï¼Œå°±æ— éœ€é‡å¤åˆ¶ä½œï¼Œç›´æ¥ä½¿ç”¨Dockerå®˜æ–¹æä¾›çš„CentOSæˆ–Ubuntué•œåƒä½œä¸ºåŸºç¡€é•œåƒï¼›ç„¶åå†æ­å»ºå…¶å®ƒå±‚å³å¯</li><li>æœ€ç»ˆæ•´ä¸ªJavaé¡¹ç›®çš„é•œåƒç»“æ„å¦‚å›¾æ‰€ç¤º<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/13/oPfvIlQ2eBN8aRS.png" alt="img"></li></ul></li></ul></li></ul></li><li><p><strong>DockerFile</strong></p><ul><li><p>è®°å½•é•œåƒç»“æ„çš„æ–‡ä»¶</p></li><li><p>ç”±äºåˆ¶ä½œé•œåƒçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦é€å±‚å¤„ç†å’Œæ‰“åŒ…ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥Dockerå°±æä¾›äº†è‡ªåŠ¨æ‰“åŒ…é•œåƒçš„åŠŸèƒ½ã€‚æˆ‘ä»¬åªéœ€è¦å°†æ‰“åŒ…çš„è¿‡ç¨‹ï¼Œæ¯ä¸€å±‚è¦åšçš„äº‹æƒ…ç”¨å›ºå®šçš„è¯­æ³•å†™ä¸‹æ¥ï¼Œäº¤ç»™Dockerå»æ‰§è¡Œå³å¯</p></li><li><p>å¯¹åº”è¯­æ³•</p><ul><li><table><thead><tr><th align="center"><strong>æŒ‡ä»¤</strong></th><th align="center"><strong>è¯´æ˜</strong></th><th align="center"><strong>ç¤ºä¾‹</strong></th></tr></thead><tbody><tr><td align="center"><strong>FROM</strong></td><td align="center">æŒ‡å®šåŸºç¡€é•œåƒ</td><td align="center"><code>FROM centos:6</code></td></tr><tr><td align="center"><strong>ENV</strong></td><td align="center">è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¯åœ¨åé¢æŒ‡ä»¤ä½¿ç”¨</td><td align="center"><code>ENV key value</code></td></tr><tr><td align="center"><strong>COPY</strong></td><td align="center">æ‹·è´æœ¬åœ°æ–‡ä»¶åˆ°é•œåƒçš„æŒ‡å®šç›®å½•</td><td align="center"><code>COPY ./xx.jar /tmp/app.jar</code></td></tr><tr><td align="center"><strong>RUN</strong></td><td align="center">æ‰§è¡ŒLinuxçš„shellå‘½ä»¤ï¼Œä¸€èˆ¬æ˜¯å®‰è£…è¿‡ç¨‹çš„å‘½ä»¤</td><td align="center"><code>RUN yum install gcc</code></td></tr><tr><td align="center"><strong>EXPOSE</strong></td><td align="center">æŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£ï¼Œæ˜¯ç»™é•œåƒä½¿ç”¨è€…çœ‹çš„</td><td align="center">EXPOSE 8080</td></tr><tr><td align="center"><strong>ENTRYPOINT</strong></td><td align="center">é•œåƒä¸­åº”ç”¨çš„å¯åŠ¨å‘½ä»¤ï¼Œå®¹å™¨è¿è¡Œæ—¶è°ƒç”¨</td><td align="center">ENTRYPOINT java -jar xx.jar</td></tr></tbody></table></li><li><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šåŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span></span><br><span class="line"><span class="comment"># é…ç½®ç¯å¢ƒå˜é‡ï¼ŒJDKçš„å®‰è£…ç›®å½•ã€å®¹å™¨å†…æ—¶åŒº</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_DIR=/usr/local</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># æ‹·è´jdkå’Œjavaé¡¹ç›®çš„åŒ…</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./jdk8.tar.gz <span class="variable">$JAVA_DIR</span>/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./docker-demo.jar /tmp/app.jar</span></span><br><span class="line"><span class="comment"># è®¾å®šæ—¶åŒº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># å®‰è£…JDK</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> <span class="variable">$JAVA_DIR</span> \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; tar -xf ./jdk8.tar.gz \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; <span class="built_in">mv</span> ./jdk1.8.0_144 ./java8</span></span><br><span class="line"><span class="comment"># é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=$JAVA_DIR/java8</span><br><span class="line"><span class="keyword">ENV</span> PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"><span class="comment"># æŒ‡å®šé¡¹ç›®ç›‘å¬çš„ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># å…¥å£ï¼Œjavaé¡¹ç›®çš„å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure></li><li><p>é—®é¢˜</p><ul><li>ä»¥åä¼šæœ‰å¾ˆå¤šå¾ˆå¤šjavaé¡¹ç›®éœ€è¦æ‰“åŒ…ä¸ºé•œåƒï¼Œä»–ä»¬éƒ½éœ€è¦Linuxç³»ç»Ÿç¯å¢ƒã€JDKç¯å¢ƒè¿™ä¸¤å±‚ï¼Œåªæœ‰ä¸Šé¢çš„3å±‚ä¸åŒï¼ˆå› ä¸ºjaråŒ…ä¸åŒï¼‰ã€‚å¦‚æœæ¯æ¬¡åˆ¶ä½œjavaé•œåƒéƒ½é‡å¤åˆ¶ä½œå‰ä¸¤å±‚é•œåƒï¼Œæå…¶éº»çƒ¦</li><li>æ‰€ä»¥ï¼Œå°±æœ‰äººæä¾›äº†åŸºç¡€çš„ç³»ç»Ÿ+JDKç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šåˆ¶ä½œjavaé•œåƒï¼Œå°±å¯ä»¥çœå»JDKçš„é…ç½®</li></ul><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11.0</span>-jre-buster</span><br><span class="line"><span class="comment"># è®¾å®šæ—¶åŒº</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># æ‹·è´jaråŒ…</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker-demo.jar /app.jar</span></span><br><span class="line"><span class="comment"># å…¥å£</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>æ„å»ºé•œåƒ</p><ul><li><p>å½“Dockerfileæ–‡ä»¶å†™å¥½ä»¥åï¼Œå°±å¯ä»¥åˆ©ç”¨å‘½ä»¤æ¥æ„å»ºé•œåƒäº†</p></li><li><p>å¯¼å…¥hmèµ„æ–™ä¸­çš„demoé¡¹ç›®åŠå¯¹åº”çš„Dockerfile</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/13/ErTV7nvMLJA2lRj.png" alt="img"></li></ul></li><li><p>å°†<code>docker-demo.jar</code>åŒ…ä»¥åŠ<code>Dockerfile</code>æ‹·è´åˆ°è™šæ‹Ÿæœºçš„<code>/root/demo</code>ç›®å½•</p></li><li><p>æ„å»ºå‘½ä»¤</p><ul><li>è¿›å…¥demoç›®å½•<code>cd /root/demo</code></li><li><code>docker build -t docker-demo:1.0 .</code></li></ul></li><li><p>å‘½ä»¤è¯´æ˜</p><ul><li><code>docker build </code>: å°±æ˜¯æ„å»ºä¸€ä¸ªdockeré•œåƒ</li><li><code>-t docker-demo:1.0ï¼ˆç‰ˆæœ¬å·ï¼‰</code> ï¼š<code>-t</code>å‚æ•°æ˜¯æŒ‡å®šé•œåƒçš„åç§°ï¼ˆ<code>repository</code>å’Œ<code>tag</code>ï¼‰</li><li><code>.</code> : æœ€åçš„ç‚¹æ˜¯æŒ‡æ„å»ºæ—¶Dockerfileæ‰€åœ¨è·¯å¾„ï¼Œç”±äºæˆ‘ä»¬è¿›å…¥äº†demoç›®å½•ï¼Œæ‰€ä»¥æŒ‡å®šçš„æ˜¯<code>.</code>ä»£è¡¨å½“å‰ç›®å½•ï¼Œ</li><li>ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šDockerfileç›®å½• <code>docker build -t docker-demo:1.0 /root/demo</code></li></ul></li><li><p>æŸ¥çœ‹é•œåƒåˆ—è¡¨<code>docker images</code></p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/13/BS9rsWhfMTNHzLj.png" alt="img"></li></ul></li><li><p>ç„¶åå°è¯•è¿è¡Œè¯¥é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨</span></span><br><span class="line">docker run --name <span class="built_in">dd</span> -p 8080:8080 -d docker-demo:1.0</span><br><span class="line"><span class="comment"># 2.æŸ¥çœ‹å®¹å™¨</span></span><br><span class="line">docker ps -a </span><br><span class="line"><span class="comment"># 3.æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¥å¿—</span></span><br><span class="line">docker logs -f <span class="built_in">dd</span></span><br><span class="line"><span class="comment"># 3.è®¿é—®</span></span><br><span class="line">è™šæ‹Ÿæœºåœ°å€:8080/hello/count</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h4><ul><li><p>Javaé¡¹ç›®å¾€å¾€éœ€è¦è®¿é—®å…¶å®ƒå„ç§ä¸­é—´ä»¶ï¼Œä¾‹å¦‚MySQLã€Redisç­‰</p><ul><li>åœ¨ä»¥å¾€çš„çš„å•ä½“é¡¹ç›®ä¸­éƒ½æ˜¯é€šè¿‡å¯¼å…¥ä¾èµ–ã€é…ç½®æ–‡ä»¶è¿›è¡Œè®¿é—®</li></ul></li><li><p>é‚£å®¹å™¨ä¹‹é—´èƒ½å¦äº’ç›¸è®¿é—®å—ï¼Ÿ</p><ol><li>è¿›å…¥ddå®¹å™¨<code>docker exec -it dd bash</code></li><li><code>ping ipåœ°å€(å…¶ä»–å®¹å™¨)</code></li><li>ç»“æœï¼šå¯ä»¥pingé€šï¼Œè¯´æ˜å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ipåœ°å€äº’ç›¸è®¿é—®</li></ol></li><li><p>å®¹å™¨çš„ipä»ä½•è€Œæ¥ï¼Ÿ</p><ol><li><p>åœ¨å®‰è£…dockeræ—¶ï¼Œdockerä¼šåœ¨è™šæ‹Ÿæœºåˆ›å»ºä¸€å¼ ç½‘å¡<code>docker0</code>ï¼Œè¯¥ç½‘å¡ä¼šåˆ›å»ºè™šæ‹Ÿç½‘æ¡¥<code>172.17.0.1/16</code></p></li><li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å®¹å™¨éƒ½æ˜¯ä»¥â€œæ¡¥æ¥â€æ–¹å¼è¿æ¥åˆ°Dockerçš„ä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥ä¸Šï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªip</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/13/bdXyZKP5Qe4JmiI.png" alt="img"></li></ol></li></ol></li><li><p>ä½†æ˜¯ï¼Œå®¹å™¨çš„ç½‘ç»œIPå…¶å®æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„IPï¼Œå…¶å€¼å¹¶ä¸å›ºå®šä¸æŸä¸€ä¸ªå®¹å™¨ç»‘å®šï¼Œå¦‚æœæˆ‘ä»¬åœ¨å¼€å‘æ—¶å†™æ­»æŸä¸ªIPï¼Œè€Œåœ¨éƒ¨ç½²æ—¶å¾ˆå¯èƒ½MySQLå®¹å™¨çš„IPä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿æ¥å¤±è´¥</p></li><li><p><strong>è‡ªå®šä¹‰ç½‘ç»œ</strong></p><ul><li><p>dockerçš„ç½‘ç»œåŠŸèƒ½</p><ul><li>åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼Œå½¢æˆæ–°çš„ç½‘æ¡¥ï¼ŒåŠ å…¥è¯¥ç½‘æ¡¥çš„å®¹å™¨å¯ä»¥äº’è”ï¼Œä¸”åŠ å…¥è‡ªå®šä¹‰ç½‘ç»œçš„å®¹å™¨å¯ä»¥é€šè¿‡å®¹å™¨åäº’ç›¸è®¿é—®</li></ul></li><li><p>å¸¸è§å‘½ä»¤</p><ul><li><table><thead><tr><th align="center"><strong>å‘½ä»¤</strong></th><th align="center"><strong>è¯´æ˜</strong></th><th align="center"><strong>æ–‡æ¡£åœ°å€</strong></th></tr></thead><tbody><tr><td align="center">docker network create</td><td align="center">åˆ›å»ºä¸€ä¸ªç½‘ç»œ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_create/">docker network create</a></td></tr><tr><td align="center">docker network ls</td><td align="center">æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_ls/">docs.docker.com</a></td></tr><tr><td align="center">docker network rm</td><td align="center">åˆ é™¤æŒ‡å®šç½‘ç»œ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_rm/">docs.docker.com</a></td></tr><tr><td align="center">docker network prune</td><td align="center">æ¸…é™¤æœªä½¿ç”¨çš„ç½‘ç»œ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_prune/">docs.docker.com</a></td></tr><tr><td align="center">docker network connect</td><td align="center">ä½¿æŒ‡å®šå®¹å™¨è¿æ¥åŠ å…¥æŸç½‘ç»œ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_connect/">docs.docker.com</a></td></tr><tr><td align="center">docker network disconnect</td><td align="center">ä½¿æŒ‡å®šå®¹å™¨è¿æ¥ç¦»å¼€æŸç½‘ç»œ</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_disconnect/">docker network disconnect</a></td></tr><tr><td align="center">docker network inspect</td><td align="center">æŸ¥çœ‹ç½‘ç»œè¯¦ç»†ä¿¡æ¯</td><td align="center"><a href="https://docs.docker.com/engine/reference/commandline/network_inspect/">docker network inspect</a></td></tr></tbody></table></li><li><p><code>docker network --help</code></p></li></ul></li><li><p>ç¤ºä¾‹</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1åˆ›å»ºæ–°ç½‘ç»œ</span></span><br><span class="line">docker network create heima</span><br><span class="line"><span class="comment">#2ä½¿æŒ‡å®šå®¹å™¨è¿æ¥åŠ å…¥ç½‘ç»œ</span></span><br><span class="line">docker network connect ç½‘ç»œå å®¹å™¨å</span><br><span class="line"><span class="comment">#2(2)ä½¿æŒ‡å®šå®¹å™¨è¿æ¥åŠ å…¥ç½‘ç»œ,åœ¨å®¹å™¨åˆ›å»ºæ—¶å°±åŠ å…¥</span></span><br><span class="line">docker run <span class="literal">--name</span> dd <span class="literal">-p</span> <span class="number">8080</span>:<span class="number">8080</span> <span class="literal">--network</span> heima <span class="literal">-d</span> docker<span class="literal">-demo</span></span><br><span class="line"><span class="comment">#3è¿›å…¥ddå®¹å™¨ä¸­</span></span><br><span class="line">ping åŠ å…¥è¯¥ç½‘ç»œçš„å®¹å™¨å</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="é¡¹ç›®éƒ¨ç½²"><a href="#é¡¹ç›®éƒ¨ç½²" class="headerlink" title="é¡¹ç›®éƒ¨ç½²"></a>é¡¹ç›®éƒ¨ç½²</h3><ul><li><p>éƒ¨ç½²Javaé¡¹ç›®</p><ol><li>å°†é¡¹ç›®æ‰“åŒ…</li><li>å°†é¡¹ç›®çš„hm-service.jaråŒ…å’Œdockerfileæ–‡ä»¶ä¸Šä¼ è‡³<code>/root/</code>ä¸‹ï¼Œæ„å»ºé•œåƒ<code>docker build -t hmall:1.0 /root </code></li><li>åˆ›å»ºå®¹å™¨<code>docker run -d --name hmall --network heima -p 8080:8080 hmall</code></li><li>æµ‹è¯•ï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š<code>http://ä½ çš„è™šæ‹Ÿæœºåœ°å€:8080/search/list</code></li></ol></li><li><p>éƒ¨ç½²å‰ç«¯</p><ol><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/13/w1IveckyO24Q6t7.png" alt="ing"></p></li><li><p>æŠŠnginxç›®å½•ä¸Šä¼ åˆ°è™šæ‹Ÿæœºçš„<code>/root</code>ç›®å½•ä¸‹</p></li><li><p>å®ç°æœ¬åœ°ç›®å½•æŒ‚è½½</p><ol><li><code>/root/nginx/nginx.conf</code>æŒ‚è½½åˆ°<code>/etc/nginx/nginx.conf</code></li><li><code>/root/nginx/html</code>æŒ‚è½½åˆ°<code>/usr/share/nginx/html</code></li></ol></li><li><p>åˆ›å»ºnginxå®¹å™¨</p><ol><li><p>ç”±äºéœ€è¦è®©nginxåŒæ—¶ä»£ç†hmall-portalå’Œhmall-adminä¸¤å¥—å‰ç«¯èµ„æºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æš´éœ²ä¸¤ä¸ªç«¯å£</p><ol><li>18080ï¼šå¯¹åº”hmall-portal</li><li>18081ï¼šå¯¹åº”hmall-admin</li></ol></li><li><p>å‘½ä»¤å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name nginx \</span><br><span class="line">  -p 18080:18080 \</span><br><span class="line">  -p 18081:18081 \</span><br><span class="line">  -v /root/nginx/html:/usr/share/nginx/html \</span><br><span class="line">  -v /root/nginx/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">  --network hmall \</span><br><span class="line">  nginx</span><br></pre></td></tr></table></figure></li></ol></li><li><p>æµ‹è¯•ï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š<code>http://ä½ çš„è™šæ‹Ÿæœºip:18080</code></p></li></ol></li><li><p><strong>DockerCompose</strong></p><ul><li><p>ç¨å¾®å¤æ‚çš„é¡¹ç›®ï¼Œå…¶ä¸­è¿˜æœ‰å„ç§å„æ ·çš„å…¶å®ƒä¸­é—´ä»¶ï¼Œéœ€è¦éƒ¨ç½²çš„ä¸œè¥¿è¿œä¸æ­¢3ä¸ªï¼›å¦‚æœè¿˜åƒä¹‹å‰é‚£æ ·æ‰‹åŠ¨çš„é€ä¸€éƒ¨ç½²ï¼Œå°±å¤ªéº»çƒ¦</p></li><li><p>è€ŒDocker Composeå°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°<strong>å¤šä¸ªç›¸äº’å…³è”çš„Dockerå®¹å™¨çš„å¿«é€Ÿéƒ¨ç½²</strong>ï¼›å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ docker-compose.yml æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨</p></li><li><p>docker-composeæ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰å¤šä¸ªç›¸äº’å…³è”çš„åº”ç”¨å®¹å™¨ï¼Œæ¯ä¸€ä¸ªåº”ç”¨å®¹å™¨è¢«ç§°ä¸ºä¸€ä¸ªæœåŠ¡ï¼ˆserviceï¼‰ï¼›ç”±äºserviceå°±æ˜¯åœ¨å®šä¹‰æŸä¸ªåº”ç”¨çš„è¿è¡Œæ—¶å‚æ•°ï¼Œå› æ­¤ä¸<code>docker run</code>å‚æ•°éå¸¸ç›¸ä¼¼</p><ul><li><p>ç”¨docker runéƒ¨ç½²MySQLçš„å‘½ä»¤å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name mysql \</span><br><span class="line">  -p 3306:3306 \</span><br><span class="line">  -e TZ=Asia/Shanghai \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">  -v ./mysql/data:/var/lib/mysql \</span><br><span class="line">  -v ./mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">  -v ./mysql/init:/docker-entrypoint-initdb.d \</span><br><span class="line">  --network hmall</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœç”¨<code>docker-compose.yml</code>æ–‡ä»¶æ¥å®šä¹‰</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="comment">#å¤šæœåŠ¡</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># mysqlæœåŠ¡</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">new</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">new:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hmall</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>é»‘é©¬å•†åŸçš„éƒ¨ç½²æ–‡ä»¶</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/init:/docker-entrypoint-initdb.d&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hm-net</span></span><br><span class="line">  <span class="attr">hmall:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hm-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18080:18080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18081:18081&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./nginx/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./nginx/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">    <span class="comment"># ä¾èµ–</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hm-net</span></span><br><span class="line"><span class="comment">#ç½‘ç»œåˆ›å»º</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">hm-net:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hmall</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>docker composeçš„å‘½ä»¤</p><ul><li>å‘½ä»¤æ ¼å¼<code>docker compose [OPTIONS] [COMMAND]</code></li><li>å…¶ä¸­ï¼ŒOPTIONSå’ŒCOMMANDéƒ½æ˜¯å¯é€‰å‚æ•°ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/13/qXnR24BC8OFmM1h.png" alt="img"></li></ul></li></ul></li></ul><hr><h1 id="å¾®æœåŠ¡"><a href="#å¾®æœåŠ¡" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h1><ul><li>æ ¹æ®é»‘é©¬è¯¾ç¨‹ï¼Œå¯¼å…¥é»‘é©¬å•†åŸ</li></ul><h2 id="è®¤è¯†å¾®æœåŠ¡"><a href="#è®¤è¯†å¾®æœåŠ¡" class="headerlink" title="è®¤è¯†å¾®æœåŠ¡"></a>è®¤è¯†å¾®æœåŠ¡</h2><h3 id="å•ä½“æ¶æ„"><a href="#å•ä½“æ¶æ„" class="headerlink" title="å•ä½“æ¶æ„"></a>å•ä½“æ¶æ„</h3><ul><li>å•ä½“æ¶æ„ï¼šé¡¾åæ€ä¹‰ï¼Œæ•´ä¸ªé¡¹ç›®ä¸­æ‰€æœ‰åŠŸèƒ½æ¨¡å—éƒ½åœ¨ä¸€ä¸ªå·¥ç¨‹ä¸­å¼€å‘ï¼›é¡¹ç›®éƒ¨ç½²æ—¶éœ€è¦å¯¹æ‰€æœ‰æ¨¡å—ä¸€èµ·ç¼–è¯‘ã€æ‰“åŒ…ï¼›é¡¹ç›®çš„æ¶æ„è®¾è®¡ã€å¼€å‘æ¨¡å¼éƒ½éå¸¸ç®€å•<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/14/cCZJiLBnTauj1Ef.jpg" alt="ing"></li></ul></li><li>ä¼˜ç‚¹<ul><li>æ¶æ„ç®€å•</li><li>éƒ¨ç½²æˆæœ¬ä½</li></ul></li><li>ç¼ºç‚¹<ul><li>å›¢é˜Ÿåä½œæˆæœ¬é«˜<ul><li>è¯•æƒ³ä¸€ä¸‹ï¼Œä½ ä»¬å›¢é˜Ÿæ•°åä¸ªäººåŒæ—¶åä½œå¼€å‘åŒä¸€ä¸ªé¡¹ç›®ï¼Œç”±äºæ‰€æœ‰æ¨¡å—éƒ½åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œä¸åŒæ¨¡å—çš„ä»£ç ä¹‹é—´ç‰©ç†è¾¹ç•Œè¶Šæ¥è¶Šæ¨¡ç³Šï¼›æœ€ç»ˆè¦æŠŠåŠŸèƒ½åˆå¹¶åˆ°ä¸€ä¸ªåˆ†æ”¯ï¼Œä½ ç»å¯¹ä¼šé™·å…¥åˆ°è§£å†³å†²çªçš„æ³¥æ½­ä¹‹ä¸­</li></ul></li><li>ç³»ç»Ÿå‘å¸ƒæ•ˆç‡ä½<ul><li>ä»»ä½•æ¨¡å—å˜æ›´éƒ½éœ€è¦å‘å¸ƒæ•´ä¸ªç³»ç»Ÿï¼Œè€Œç³»ç»Ÿå‘å¸ƒè¿‡ç¨‹ä¸­éœ€è¦å¤šä¸ªæ¨¡å—ä¹‹é—´åˆ¶çº¦è¾ƒå¤šï¼Œéœ€è¦å¯¹æ¯”å„ç§æ–‡ä»¶ï¼Œä»»ä½•ä¸€å¤„å‡ºç°é—®é¢˜éƒ½ä¼šå¯¼è‡´å‘å¸ƒå¤±è´¥ï¼Œå¾€å¾€ä¸€æ¬¡å‘å¸ƒéœ€è¦æ•°ååˆ†é’Ÿç”šè‡³æ•°å°æ—¶</li></ul></li><li>ç³»ç»Ÿå¯ç”¨æ€§å·®<ul><li>å•ä½“æ¶æ„å„ä¸ªåŠŸèƒ½æ¨¡å—æ˜¯ä½œä¸ºä¸€ä¸ªæœåŠ¡éƒ¨ç½²ï¼Œç›¸äº’ä¹‹é—´ä¼šäº’ç›¸å½±å“ï¼Œä¸€äº›çƒ­ç‚¹åŠŸèƒ½ä¼šè€—å°½ç³»ç»Ÿèµ„æºï¼Œå¯¼è‡´å…¶å®ƒæœåŠ¡ä½å¯ç”¨</li><li>å½“æŸä¸€ä¸ªæ¥å£é«˜å¹¶å‘æ—¶ï¼Œå¯¹tomcatçš„èµ„æºå ç”¨æå¤§ï¼Œå¯¼è‡´å…¶ä»–æ¥å£è¯·æ±‚é€Ÿåº¦é™æ…¢</li></ul></li></ul></li><li>æ€»ç»“<ul><li>å•ä½“æ¶æ„å¯ç”¨æ€§æ˜¯æ¯”è¾ƒå·®çš„ï¼ŒåŠŸèƒ½ä¹‹é—´ç›¸äº’å½±å“æ¯”è¾ƒå¤§ï¼Œé€‚åˆå¼€å‘åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼Œè§„æ¨¡è¾ƒå°çš„é¡¹ç›®</li></ul></li></ul><h3 id="å¾®æœåŠ¡-1"><a href="#å¾®æœåŠ¡-1" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h3><ul><li>å¾®æœåŠ¡æ¶æ„ï¼Œé¦–å…ˆæ˜¯æœåŠ¡åŒ–ï¼Œå°±æ˜¯å°†å•ä½“æ¶æ„ä¸­çš„åŠŸèƒ½æ¨¡å—ä»å•ä½“åº”ç”¨ä¸­æ‹†åˆ†å‡ºæ¥ï¼Œç‹¬ç«‹éƒ¨ç½²ä¸ºå¤šä¸ªæœåŠ¡ã€‚åŒæ—¶è¦æ»¡è¶³ä¸‹é¢çš„ä¸€äº›ç‰¹ç‚¹<ul><li><strong>å•ä¸€èŒè´£</strong>ï¼šä¸€ä¸ªå¾®æœåŠ¡è´Ÿè´£ä¸€éƒ¨åˆ†ä¸šåŠ¡åŠŸèƒ½ï¼Œå¹¶ä¸”å…¶æ ¸å¿ƒæ•°æ®ä¸ä¾èµ–äºå…¶å®ƒæ¨¡å—</li><li><strong>å›¢é˜Ÿè‡ªæ²»</strong>ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å¼€å‘ã€æµ‹è¯•ã€å‘å¸ƒã€è¿ç»´äººå‘˜ï¼Œå›¢é˜Ÿäººå‘˜è§„æ¨¡ä¸è¶…è¿‡10äººï¼ˆ2å¼ æŠ«è¨èƒ½å–‚é¥±ï¼‰</li><li><strong>æœåŠ¡è‡ªæ²»</strong>ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½ç‹¬ç«‹æ‰“åŒ…éƒ¨ç½²ï¼Œè®¿é—®è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“ã€‚å¹¶ä¸”è¦åšå¥½æœåŠ¡éš”ç¦»ï¼Œé¿å…å¯¹å…¶å®ƒæœåŠ¡äº§ç”Ÿå½±å“</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/14/vfd8lWwXqH7SDgn.jpg" alt="img"></li></ul></li><li>å¾®æœåŠ¡è§£å†³äº†å“ªäº›å•ä½“é¡¹ç›®çš„é—®é¢˜<ol><li>é™ä½å›¢é˜Ÿåä½œæˆæœ¬<ul><li>ç”±äºæœåŠ¡æ‹†åˆ†ï¼Œæ¯ä¸ªæœåŠ¡ä»£ç é‡å¤§å¤§å‡å°‘ï¼Œå‚ä¸å¼€å‘çš„åå°äººå‘˜åœ¨1~3åï¼Œåä½œæˆæœ¬å¤§å¤§é™ä½</li></ul></li><li>æé«˜ç³»ç»Ÿå‘å¸ƒæ•ˆç‡<ul><li>æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹éƒ¨ç½²ï¼Œå½“æœ‰æŸä¸ªæœåŠ¡æœ‰ä»£ç å˜æ›´æ—¶ï¼Œåªéœ€è¦æ‰“åŒ…éƒ¨ç½²è¯¥æœåŠ¡å³å¯</li></ul></li><li>æé«˜ç³»ç»Ÿå¯ç”¨æ€§<ul><li>æ¯ä¸ªæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œå¹¶ä¸”åšå¥½æœåŠ¡éš”ç¦»ï¼Œä½¿ç”¨è‡ªå·±çš„æœåŠ¡å™¨èµ„æºï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒæœåŠ¡</li><li>ä¸ä¼šå› ä¸ºæŸä¸€ä¸ªé«˜å¹¶å‘åŠŸèƒ½è€Œå½±å“å…¶ä»–æ¥å£</li></ul></li><li>ç»¼ä¸Šæ‰€è¿°ï¼Œå¾®æœåŠ¡æ¶æ„è§£å†³äº†å•ä½“æ¶æ„å­˜åœ¨çš„é—®é¢˜ï¼Œç‰¹åˆ«é€‚åˆå¤§å‹äº’è”ç½‘é¡¹ç›®çš„å¼€å‘ï¼Œå› æ­¤è¢«å„å¤§äº’è”ç½‘å…¬å¸æ™®éé‡‡ç”¨ã€‚å¤§å®¶ä»¥å‰å¯èƒ½å¬è¯´è¿‡<strong>åˆ†å¸ƒå¼æ¶æ„</strong>ï¼Œåˆ†å¸ƒå¼å°±æ˜¯æœåŠ¡æ‹†åˆ†çš„è¿‡ç¨‹ï¼Œå…¶å®å¾®æœåŠ¡æ¶æ„æ­£æ˜¯åˆ†å¸ƒå¼æ¶æ„çš„ä¸€ç§æœ€ä½³å®è·µçš„æ–¹æ¡ˆ</li></ol></li><li>å¾®æœåŠ¡æ¶æ„(æ‹†åˆ†çš„è¿‡ç¨‹ä¸­)å­˜åœ¨çš„é—®é¢˜<ol><li>å¦‚æœå‡ºç°è·¨æœåŠ¡çš„ä¸šåŠ¡è¯¥å¦‚ä½•å¤„ç†?</li><li>é¡µé¢è¯·æ±‚åˆ°åº•è¯¥è®¿é—®å“ªä¸ªæœåŠ¡ï¼Ÿ</li><li>å¦‚ä½•å®ç°å„ä¸ªæœåŠ¡ä¹‹é—´çš„æœåŠ¡éš”ç¦»ï¼Ÿ</li></ol></li></ul><h3 id="SpringCloud-å¾®æœåŠ¡æ¡†æ¶"><a href="#SpringCloud-å¾®æœåŠ¡æ¡†æ¶" class="headerlink" title="SpringCloud(å¾®æœåŠ¡æ¡†æ¶)"></a>SpringCloud(å¾®æœåŠ¡æ¡†æ¶)</h3><ul><li>å¾®æœåŠ¡æ‹†åˆ†ç¢°åˆ°çš„å„ç§é—®é¢˜éƒ½æœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆå’Œå¾®æœåŠ¡ç»„ä»¶ï¼Œè€ŒSpringCloudæ¡†æ¶å¯ä»¥è¯´æ˜¯ç›®å‰Javaé¢†åŸŸæœ€å…¨é¢çš„å¾®æœåŠ¡ç»„ä»¶çš„é›†åˆ<ul><li>å®˜æ–¹é“¾æ¥<code>https://spring.io/projects/spring-cloud/#overview</code></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/14/rTHBYRNG1fSzlDx.png" alt="img"></li></ul></li><li>SpringCloudä¾æ‰˜äºSpringBootçš„è‡ªåŠ¨è£…é…èƒ½åŠ›ï¼Œå¤§å¤§é™ä½äº†å…¶é¡¹ç›®æ­å»ºã€ç»„ä»¶ä½¿ç”¨çš„æˆæœ¬ã€‚å¯¹äºæ²¡æœ‰è‡ªç ”å¾®æœåŠ¡ç»„ä»¶èƒ½åŠ›çš„ä¸­å°å‹ä¼ä¸šï¼Œä½¿ç”¨SpringCloudå…¨å®¶æ¡¶æ¥å®ç°å¾®æœåŠ¡å¼€å‘å¯ä»¥è¯´æ˜¯æœ€åˆé€‚çš„é€‰æ‹©</li><li>SpringCloudç‰ˆæœ¬ã€SpringBootç‰ˆæœ¬ä»¥åŠJDKç‰ˆæœ¬éœ€è¦å¯¹åº”</li></ul><h2 id="å¾®æœåŠ¡æ‹†åˆ†"><a href="#å¾®æœåŠ¡æ‹†åˆ†" class="headerlink" title="å¾®æœåŠ¡æ‹†åˆ†"></a>å¾®æœåŠ¡æ‹†åˆ†</h2><h3 id="å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™"><a href="#å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™" class="headerlink" title="å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™"></a>å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™</h3><ul><li>ä»€ä¹ˆæ—¶å€™æ‹†<ul><li>å¯¹äº<strong>å¤§å¤šæ•°å°å‹é¡¹ç›®æ¥è¯´ï¼Œä¸€èˆ¬æ˜¯å…ˆé‡‡ç”¨å•ä½“æ¶æ„</strong>ï¼Œéšç€ç”¨æˆ·è§„æ¨¡æ‰©å¤§ã€ä¸šåŠ¡å¤æ‚å<strong>å†é€æ¸æ‹†åˆ†ä¸º</strong>å¾®æœåŠ¡æ¶æ„ã€‚è¿™æ ·åˆæœŸæˆæœ¬ä¼šæ¯”è¾ƒä½ï¼Œå¯ä»¥å¿«é€Ÿè¯•é”™ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆåšçš„é—®é¢˜å°±åœ¨äºåæœŸåšæœåŠ¡æ‹†åˆ†æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šä»£ç è€¦åˆå¸¦æ¥çš„é—®é¢˜ï¼Œæ‹†åˆ†æ¯”è¾ƒå›°éš¾ï¼ˆ<strong>å‰æ˜“åéš¾</strong>ï¼‰</li><li>è€Œå¯¹äºä¸€äº›å¤§å‹é¡¹ç›®ï¼Œåœ¨ç«‹é¡¹ä¹‹åˆç›®çš„å°±å¾ˆæ˜ç¡®ï¼Œä¸ºäº†é•¿è¿œè€ƒè™‘ï¼Œåœ¨æ¶æ„è®¾è®¡æ—¶å°±ç›´æ¥é€‰æ‹©å¾®æœåŠ¡æ¶æ„ã€‚è™½ç„¶å‰æœŸæŠ•å…¥è¾ƒå¤šï¼Œä½†åæœŸå°±å°‘äº†æ‹†åˆ†æœåŠ¡çš„çƒ¦æ¼ï¼ˆ<strong>å‰éš¾åæ˜“</strong>ï¼‰</li></ul></li><li>å¦‚ä½•æ‹†<ul><li>å¾®æœåŠ¡æ‹†åˆ†æ—¶<strong>ç²’åº¦è¦å°</strong>ï¼Œè¿™å…¶å®æ˜¯æ‹†åˆ†çš„ç›®æ ‡ã€‚å…·ä½“å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦æ¥åˆ†æ<ul><li><strong>é«˜å†…èš</strong>ï¼šæ¯ä¸ªå¾®æœåŠ¡çš„èŒè´£è¦å°½é‡å•ä¸€ï¼ŒåŒ…å«çš„ä¸šåŠ¡ç›¸äº’å…³è”åº¦é«˜ã€å®Œæ•´åº¦é«˜</li><li><strong>ä½è€¦åˆ</strong>ï¼šæ¯ä¸ªå¾®æœåŠ¡çš„åŠŸèƒ½è¦ç›¸å¯¹ç‹¬ç«‹ï¼Œå°½é‡å‡å°‘å¯¹å…¶å®ƒå¾®æœåŠ¡çš„ä¾èµ–ï¼Œæˆ–è€…ä¾èµ–æ¥å£çš„ç¨³å®šæ€§è¦å¼º</li></ul></li><li>æ˜ç¡®äº†æ‹†åˆ†ç›®æ ‡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‹†åˆ†æ–¹å¼äº†ã€‚æˆ‘ä»¬åœ¨åšæœåŠ¡æ‹†åˆ†æ—¶ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼<ul><li><strong>çºµå‘</strong>æ‹†åˆ†<ul><li>æ‰€è°“<strong>çºµå‘æ‹†åˆ†</strong>ï¼Œå°±æ˜¯æŒ‰ç…§é¡¹ç›®çš„åŠŸèƒ½æ¨¡å—æ¥æ‹†åˆ†ã€‚ä¾‹å¦‚é»‘é©¬å•†åŸä¸­ï¼Œå°±æœ‰ç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€è®¢å•ç®¡ç†åŠŸèƒ½ã€è´­ç‰©è½¦åŠŸèƒ½ã€å•†å“ç®¡ç†åŠŸèƒ½ã€æ”¯ä»˜åŠŸèƒ½ç­‰ã€‚é‚£ä¹ˆæŒ‰ç…§åŠŸèƒ½æ¨¡å—å°†ä»–ä»¬æ‹†åˆ†ä¸ºä¸€ä¸ªä¸ªæœåŠ¡ï¼Œå°±å±äºçºµå‘æ‹†åˆ†ã€‚è¿™ç§æ‹†åˆ†æ¨¡å¼å¯ä»¥å°½å¯èƒ½æé«˜æœåŠ¡çš„å†…èšæ€§</li></ul></li><li><strong>æ¨ªå‘</strong>æ‹†åˆ†<ul><li>è€Œ<strong>æ¨ªå‘æ‹†åˆ†</strong>ï¼Œæ˜¯çœ‹å„ä¸ªåŠŸèƒ½æ¨¡å—ä¹‹é—´æœ‰æ²¡æœ‰å…¬å…±çš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œå¦‚æœæœ‰å°†å…¶æŠ½å–å‡ºæ¥ä½œä¸ºé€šç”¨æœåŠ¡ã€‚ä¾‹å¦‚ç”¨æˆ·ç™»å½•æ˜¯éœ€è¦å‘é€æ¶ˆæ¯é€šçŸ¥ï¼Œè®°å½•é£æ§æ•°æ®ï¼Œä¸‹å•æ—¶ä¹Ÿè¦å‘é€çŸ­ä¿¡ï¼Œè®°å½•é£æ§æ•°æ®ã€‚å› æ­¤æ¶ˆæ¯å‘é€ã€é£æ§æ•°æ®è®°å½•å°±æ˜¯é€šç”¨çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå› æ­¤å¯ä»¥å°†ä»–ä»¬åˆ†åˆ«æŠ½å–ä¸ºå…¬å…±æœåŠ¡ï¼šæ¶ˆæ¯ä¸­å¿ƒæœåŠ¡ã€é£æ§ç®¡ç†æœåŠ¡ã€‚è¿™æ ·å¯ä»¥æé«˜ä¸šåŠ¡çš„å¤ç”¨æ€§ï¼Œé¿å…é‡å¤å¼€å‘ã€‚åŒæ—¶é€šç”¨ä¸šåŠ¡ä¸€èˆ¬æ¥å£ç¨³å®šæ€§è¾ƒå¼ºï¼Œä¹Ÿä¸ä¼šä½¿æœåŠ¡ä¹‹é—´è¿‡åˆ†è€¦åˆ</li></ul></li></ul></li><li>è¿™é‡Œé‡‡ç”¨çš„æ˜¯<strong>çºµå‘</strong>æ‹†åˆ†çš„æ–¹å¼<ul><li>ç”¨æˆ·æœåŠ¡</li><li>å•†å“æœåŠ¡</li><li>è®¢å•æœåŠ¡</li><li>è´­ç‰©è½¦æœåŠ¡</li><li>æ”¯ä»˜æœåŠ¡</li></ul></li></ul></li></ul><h3 id="æ‹†åˆ†æœåŠ¡"><a href="#æ‹†åˆ†æœåŠ¡" class="headerlink" title="æ‹†åˆ†æœåŠ¡"></a>æ‹†åˆ†æœåŠ¡</h3><ul><li><p>å·¥ç¨‹ç»“æ„</p><ul><li>ç‹¬ç«‹Project<ul><li>å¤šä¸ªproject</li></ul></li><li>Mavenèšåˆ<ul><li>ä¸€ä¸ªå·¥ç¨‹ï¼Œå¤šä¸ªå­module</li></ul></li><li>è¿™é‡Œé»‘é©¬å•†åŸé‡‡ç”¨çš„æ˜¯Mavenèšåˆçš„æ–¹å¼</li></ul></li><li><p>éœ€æ±‚</p><ol><li>å°†hm-serviceä¸­ä¸å•†å“ç®¡ç†ç›¸å…³åŠŸèƒ½æ‹†åˆ†åˆ°ä¸€ä¸ªå¾®æœåŠ¡moduleä¸­ï¼Œå‘½åä¸ºitem-service</li><li>å°†hm-serviceä¸­ä¸è´­ç‰©è½¦æœ‰å…³çš„åŠŸèƒ½æ‹†åˆ†åˆ°ä¸€ä¸ªå¾®æœåŠ¡moduleä¸­ï¼Œå‘½åä¸ºcart-service</li><li>å°†hm-serviceä¸­ä¸ç”¨æˆ·æœ‰å…³çš„åŠŸèƒ½æ‹†åˆ†åˆ°ä¸€ä¸ªå¾®æœåŠ¡moduleä¸­ï¼Œå‘½åä¸ºuser-service</li><li>å°†hm-serviceä¸­ä¸äº¤æ˜“æœ‰å…³çš„åŠŸèƒ½æ‹†åˆ†åˆ°ä¸€ä¸ªå¾®æœåŠ¡moduleä¸­ï¼Œå‘½åä¸ºtrade-service</li><li>å°†hm-serviceä¸­ä¸æ”¯ä»˜æœ‰å…³çš„åŠŸèƒ½æ‹†åˆ†åˆ°ä¸€ä¸ªå¾®æœåŠ¡moduleä¸­ï¼Œå‘½åä¸ºpay-service</li></ol></li><li><p>éœ€æ±‚å®ç°</p><ol><li>åœ¨hmallå·¥ç¨‹ä¸­æ–°å»ºå¯¹åº”çš„item-serviceæ¨¡å—</li><li>æ–°å»º<code>com.hmall.item</code>åŒ…</li><li>æ–°å»º<code>ItemApplication</code>å¯åŠ¨ç±»åœ¨<code>com.hmall.item</code>åŒ…ä¸‹</li><li>åœ¨<code>com.hmall.item</code>åŒ…æ–°å»º<code>domainã€mapperã€serviceã€controller</code>åŒ…</li><li>åœ¨<code>hmall-service</code>ä¸­æ‹·è´é…ç½®æ–‡ä»¶åˆ°<code>item-service</code>çš„Resourcesä¸­ï¼Œä¿®æ”¹å…¶ä¸­çš„ç«¯å£ã€ä»¥åŠä¸€äº›å…³äº<code>item</code>çš„é…ç½®</li><li>å°†<code>hmall-service</code>ä¸­å„ä¸ªæœ‰å…³<code>item</code>çš„ç±»å¤åˆ¶åˆ°<code>item-service</code>ä¸­ï¼Œä¿®æ”¹å¼‚å¸¸</li><li>æµ‹è¯•å®ç°ï¼Œåœ¨Serviceä¸­å¯åŠ¨<code>item-service</code>ï¼Œé€šè¿‡docæ–‡æ¡£éªŒè¯æ¥å£æ˜¯å¦æ­£ç¡®</li></ol></li><li><p>å…¶ä»–éœ€æ±‚çš„å®ç°åŸºæœ¬åŒä¸Šï¼Œå¯èƒ½éœ€è¦è¡¥å……å…¶ä»–package</p></li></ul><h3 id="è¿œç¨‹è°ƒç”¨"><a href="#è¿œç¨‹è°ƒç”¨" class="headerlink" title="è¿œç¨‹è°ƒç”¨"></a>è¿œç¨‹è°ƒç”¨</h3><ul><li><p>åœ¨æ‹†åˆ†çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªé—®é¢˜ï¼šå°±æ˜¯è´­ç‰©è½¦ä¸šåŠ¡ä¸­éœ€è¦æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œä½†å•†å“ä¿¡æ¯æŸ¥è¯¢çš„é€»è¾‘å…¨éƒ¨è¿ç§»åˆ°äº†<code>item-service</code>æœåŠ¡ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•æŸ¥è¯¢</p></li><li><p>æœ€ç»ˆç»“æœå°±æ˜¯æŸ¥è¯¢åˆ°çš„è´­ç‰©è½¦æ•°æ®ä¸å®Œæ•´ï¼Œå› æ­¤è¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¿…é¡»æ”¹é€ å…¶ä¸­çš„ä»£ç ï¼ŒæŠŠåŸæœ¬æœ¬åœ°æ–¹æ³•è°ƒç”¨ï¼Œæ”¹é€ æˆè·¨å¾®æœåŠ¡çš„è¿œç¨‹è°ƒç”¨ï¼ˆRPCï¼Œå³<strong>R</strong>emote <strong>P</strong>roduce <strong>C</strong>allï¼‰</p></li><li><p>å› æ­¤ï¼Œç°åœ¨æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨çš„æµç¨‹å˜æˆäº†è¿™æ ·</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/15/lMZ8hJVdrLKnf4i.png" alt="img"></li></ul></li><li><p>RPCçš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚</p><ul><li>åŸºäºHttpåè®®</li><li>åŸºäºDubboåè®®</li><li>hmä¸­ä½¿ç”¨çš„æ˜¯Httpæ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸å…³å¿ƒæœåŠ¡æä¾›è€…çš„å…·ä½“æŠ€æœ¯å®ç°ï¼Œåªè¦å¯¹å¤–æš´éœ²Httpæ¥å£å³å¯ï¼Œæ›´ç¬¦åˆå¾®æœåŠ¡çš„éœ€è¦</li></ul></li><li><p>é—®é¢˜æ˜¯å¦‚ä½•å®ç°è·¨æœåŠ¡è°ƒç”¨å‘¢ï¼Ÿ</p><ol><li>æµè§ˆå™¨åˆ°è´­ç‰©è½¦æ˜¯é€šè¿‡ä¸€ä¸ªhttpè¯·æ±‚ï¼Œæ‰€ä»¥åœ¨ä¸¤ä¸ªJavaé¡¹ç›®ä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªhttpè¯·æ±‚æ¥å®ç°æœåŠ¡è°ƒç”¨è·å–å•†å“ä¿¡æ¯</li><li>Springæä¾›äº†ä¸€ä¸ªRestTemplateçš„APIï¼Œå¯ä»¥æ–¹ä¾¿çš„å®ç°Httpè¯·æ±‚çš„å‘é€<ol><li>å…¶æ”¯æŒå¸¸è§çš„Getã€Postã€Putã€Deleteè¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚å‚æ•°æ¯”è¾ƒå¤æ‚ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>exchange()</code>æ–¹æ³•æ¥æ„é€ è¯·æ±‚</li></ol></li><li>ä½¿ç”¨RestTemplateå‘é€httpè¯·æ±‚åªéœ€è¦æ³¨æ„ä»¥ä¸‹å››ç‚¹<ol><li>è¯·æ±‚æ–¹å¼</li><li>è¯·æ±‚è·¯å¾„</li><li>è¯·æ±‚å‚æ•°</li><li>è¿”å›å€¼ç±»å‹</li></ol></li></ol></li><li><p>å…·ä½“æ˜¯å®ç°</p><ol><li><p>é¦–å…ˆéœ€è¦è®¾ç½®RestTemplateçš„é…ç½®ç±»ï¼Œå°†RestTemplateä½œä¸ºä¸€ä¸ªBean</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹<code>cart-service</code>ä¸­æŸ¥è¯¢å•†å“çš„æ–¹æ³•</p><ol><li>å…¶ä¸­çš„æš‚æ—¶<code>itemDto</code>ä»<code>item-service</code>å¤åˆ¶åˆ°<code>cart-service</code>ä¸­</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2.æŸ¥è¯¢å•†å“</span></span><br><span class="line">ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">        <span class="string">&quot;http://localhost:8081/items?ids=&#123;ids&#125;&quot;</span>,</span><br><span class="line">        HttpMethod.GET,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        Map.of(<span class="string">&quot;ids&quot;</span>, CollUtil.join(itemIds, <span class="string">&quot;,&quot;</span>))</span><br><span class="line">);</span><br><span class="line"><span class="comment">//è§£æå“åº”</span></span><br><span class="line"><span class="keyword">if</span> (!responseEntity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢å¤±è´¥</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">List&lt;ItemDTO&gt; items = responseEntity.getBody();</span><br></pre></td></tr></table></figure></li></ol></li><li><p>é‡å¯ä¸¤ä¸ªæœåŠ¡ï¼Œé€šè¿‡æ¥å£æ–‡æ¡£è°ƒç”¨â€æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨â€œæ¥å£ï¼Œè´­ç‰©è½¦ä¿¡æ¯åº”è¯¥å®Œæ•´</p></li><li><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ<code>item-service</code>æä¾›äº†æŸ¥è¯¢æ¥å£ï¼Œ<code>cart-service</code>åˆ©ç”¨Httpè¯·æ±‚è°ƒç”¨è¯¥æ¥å£ã€‚å› æ­¤<code>item-service</code>å¯ä»¥ç§°ä¸ºæœåŠ¡çš„æä¾›è€…ï¼Œè€Œ<code>cart-service</code>åˆ™ç§°ä¸ºæœåŠ¡çš„æ¶ˆè´¹è€…æˆ–æœåŠ¡è°ƒç”¨è€…</p></li><li><p>é€šè¿‡RestTemplateæ‰‹åŠ¨å®ç°æ¥å£è°ƒç”¨çš„æ–¹å¼ä»ç„¶å­˜åœ¨é—®é¢˜</p></li></ul><h2 id="æœåŠ¡æ²»ç†"><a href="#æœåŠ¡æ²»ç†" class="headerlink" title="æœåŠ¡æ²»ç†"></a>æœåŠ¡æ²»ç†</h2><ul><li>æœåŠ¡è°ƒç”¨æ—¶å­˜åœ¨çš„é—®é¢˜<ol><li>item-serviceè¿™ä¹ˆå¤šå®ä¾‹ï¼Œcart-serviceå¦‚ä½•çŸ¥é“æ¯ä¸€ä¸ªå®ä¾‹çš„åœ°å€ï¼Ÿ</li><li>httpè¯·æ±‚è¦å†™urlåœ°å€ï¼Œ<code>cart-service</code>æœåŠ¡åˆ°åº•è¯¥è°ƒç”¨å“ªä¸ªå®ä¾‹å‘¢ï¼Ÿ</li><li>å¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŸä¸€ä¸ª<code>item-service</code>å®ä¾‹å®•æœºï¼Œ<code>cart-service</code>ä¾ç„¶åœ¨è°ƒç”¨è¯¥æ€ä¹ˆåŠï¼Ÿ</li><li>å¦‚æœå¹¶å‘å¤ªé«˜ï¼Œ<code>item-service</code>ä¸´æ—¶å¤šéƒ¨ç½²äº†Nå°å®ä¾‹ï¼Œ<code>cart-service</code>å¦‚ä½•çŸ¥é“æ–°å®ä¾‹çš„åœ°å€ï¼Ÿ</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/16/1lrZPSVAy4bd8kN.png" alt="img"></li></ol></li><li>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå°±å¿…é¡»å¼•å…¥æ³¨å†Œä¸­å¿ƒçš„æ¦‚å¿µ</li></ul><h3 id="æ³¨å†Œä¸­å¿ƒåŸç†"><a href="#æ³¨å†Œä¸­å¿ƒåŸç†" class="headerlink" title="æ³¨å†Œä¸­å¿ƒåŸç†"></a>æ³¨å†Œä¸­å¿ƒåŸç†</h3><ol><li>åœ¨å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªè§’è‰²<ul><li>æœåŠ¡æä¾›è€…ï¼šæä¾›æ¥å£ä¾›å…¶å®ƒå¾®æœåŠ¡è®¿é—®ï¼Œæ¯”å¦‚<code>item-service</code></li><li>æœåŠ¡æ¶ˆè´¹è€…ï¼šè°ƒç”¨å…¶å®ƒå¾®æœåŠ¡æä¾›çš„æ¥å£ï¼Œæ¯”å¦‚<code>cart-service</code></li></ul></li><li>åœ¨å¤§å‹å¾®æœåŠ¡é¡¹ç›®ä¸­ï¼ŒæœåŠ¡æä¾›è€…çš„æ•°é‡ä¼šéå¸¸å¤šï¼Œä¸ºäº†ç®¡ç†è¿™äº›æœåŠ¡å°±å¼•å…¥äº†<strong>æ³¨å†Œä¸­å¿ƒ</strong>çš„æ¦‚å¿µã€‚æ³¨å†Œä¸­å¿ƒã€æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ä¸‰è€…é—´å…³ç³»å¦‚ä¸‹ï¼š<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/16/6GnOrhqJyIW51QN.jpg" alt="img"></li></ol></li><li>æµç¨‹å¦‚ä¸‹<ul><li>æœåŠ¡å¯åŠ¨æ—¶å°±ä¼šæ³¨å†Œè‡ªå·±çš„æœåŠ¡ä¿¡æ¯ï¼ˆæœåŠ¡åã€IPã€ç«¯å£ï¼‰åˆ°æ³¨å†Œä¸­å¿ƒ</li><li>è°ƒç”¨è€…å¯ä»¥ä»æ³¨å†Œä¸­å¿ƒè®¢é˜…æƒ³è¦çš„æœåŠ¡ï¼Œè·å–æœåŠ¡å¯¹åº”çš„å®ä¾‹åˆ—è¡¨ï¼ˆ1ä¸ªæœåŠ¡å¯èƒ½å¤šå®ä¾‹éƒ¨ç½²ï¼‰</li><li>è°ƒç”¨è€…è‡ªå·±å¯¹å®ä¾‹åˆ—è¡¨è´Ÿè½½å‡è¡¡ï¼ˆéšæœºã€è½®è¯¢ç®—æ³•ï¼‰ï¼ŒæŒ‘é€‰ä¸€ä¸ªå®ä¾‹</li><li>è°ƒç”¨è€…å‘è¯¥å®ä¾‹å‘èµ·è¿œç¨‹è°ƒç”¨</li></ul></li><li>å½“æœåŠ¡æä¾›è€…çš„å®ä¾‹å®•æœºæˆ–è€…å¯åŠ¨æ–°å®ä¾‹æ—¶ï¼Œè°ƒç”¨è€…å¦‚ä½•å¾—çŸ¥å‘¢ï¼Ÿ<ul><li>æœåŠ¡æä¾›è€…ä¼šå®šæœŸå‘æ³¨å†Œä¸­å¿ƒå‘é€è¯·æ±‚ï¼ŒæŠ¥å‘Šè‡ªå·±çš„å¥åº·çŠ¶æ€ï¼ˆå¿ƒè·³è¯·æ±‚æ£€æµ‹ï¼‰</li><li>å½“æ³¨å†Œä¸­å¿ƒé•¿æ—¶é—´æ”¶ä¸åˆ°æä¾›è€…çš„å¿ƒè·³æ—¶ï¼Œä¼šè®¤ä¸ºè¯¥å®ä¾‹å®•æœºï¼Œå°†å…¶ä»æœåŠ¡çš„å®ä¾‹åˆ—è¡¨ä¸­å‰”é™¤</li><li>å½“æœåŠ¡æœ‰æ–°å®ä¾‹å¯åŠ¨æ—¶ï¼Œä¼šå‘é€æ³¨å†ŒæœåŠ¡è¯·æ±‚ï¼Œå…¶ä¿¡æ¯ä¼šè¢«è®°å½•åœ¨æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å®ä¾‹åˆ—è¡¨</li><li>å½“æ³¨å†Œä¸­å¿ƒæœåŠ¡åˆ—è¡¨å˜æ›´æ—¶ï¼Œä¼šä¸»åŠ¨é€šçŸ¥å¾®æœåŠ¡ï¼Œæ›´æ–°æœ¬åœ°æœåŠ¡åˆ—è¡¨ï¼ˆæ¨é€å˜æ›´ï¼‰</li></ul></li><li>æ³¨å†Œä¸­å¿ƒï¼Œè§£å†³äº†æœåŠ¡è°ƒç”¨æ—¶å­˜åœ¨çš„é—®é¢˜ï¼Œä½†å…¶å®ç°è¾ƒä¸ºå¤æ‚ï¼Œä¸è¿‡æœ‰è®¸å¤šå¼€æºæ¡†æ¶å¯ä»¥ä½¿ç”¨</li></ol><h3 id="Nacosæ³¨å†Œä¸­å¿ƒ"><a href="#Nacosæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Nacosæ³¨å†Œä¸­å¿ƒ"></a>Nacosæ³¨å†Œä¸­å¿ƒ</h3><ul><li><p>ç›®å‰å¼€æºçš„æ³¨å†Œä¸­å¿ƒæ¡†æ¶æœ‰å¾ˆå¤šï¼Œå›½å†…æ¯”è¾ƒå¸¸è§çš„æœ‰ï¼š</p><ul><li><strong>Eureka</strong>ï¼šNetflixå…¬å¸å‡ºå“ï¼Œç›®å‰è¢«é›†æˆåœ¨SpringCloudå½“ä¸­ï¼Œä¸€èˆ¬ç”¨äºJavaåº”ç”¨</li><li><strong>Nacos</strong>ï¼šAlibabaå…¬å¸å‡ºå“ï¼Œç›®å‰è¢«é›†æˆåœ¨SpringCloudAlibabaä¸­ï¼Œä¸€èˆ¬ç”¨äºJavaåº”ç”¨<ul><li>å®˜ç½‘<code>https://nacos.io/zh-cn/</code></li></ul></li><li><strong>Consul</strong>ï¼šHashiCorpå…¬å¸å‡ºå“ï¼Œç›®å‰é›†æˆåœ¨SpringCloudä¸­ï¼Œä¸é™åˆ¶å¾®æœåŠ¡è¯­è¨€</li></ul></li><li><p><strong>åŸºäºDockeræ¥éƒ¨ç½²Nacosçš„æ³¨å†Œä¸­å¿ƒ</strong></p><ol><li><p>å‡†å¤‡MySQLæ•°æ®åº“è¡¨ï¼Œç”¨æ¥å­˜å‚¨Nacosçš„æ•°æ®</p></li><li><p>ç”±äºæ˜¯Dockeréƒ¨ç½²ï¼Œå°†èµ„æ–™ä¸­çš„SQLæ–‡ä»¶å¯¼å…¥åˆ°<strong>Dockerä¸­çš„MySQLå®¹å™¨</strong></p></li><li><p>ä¿®æ”¹é»‘é©¬èµ„æ–™ä¸­<code>nacos/custom.env</code>æ–‡ä»¶ï¼Œæœ‰ä¸€ä¸ªMYSQL_SERVICE_HOSTä¹Ÿå°±æ˜¯mysqlåœ°å€ï¼Œéœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±çš„è™šæ‹ŸæœºIPåœ°å€</p></li><li><p>å°†èµ„æ–™ä¸­çš„<code>nacos</code>å’Œ<code>nacos.tar</code>ç›®å½•ä¸Šä¼ è‡³è™šæ‹Ÿæœºçš„<code>/root</code>ç›®å½•</p></li><li><p>dockeræ‹‰å–é•œåƒ&amp;åˆ›å»ºå®¹å™¨</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#åŠ è½½image</span></span><br><span class="line">docker load <span class="literal">-i</span> nacos.tar</span><br><span class="line"><span class="comment">#åˆ›å»ºå®¹å™¨</span></span><br><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nacos \</span><br><span class="line"><span class="literal">--env-file</span> ./nacos/custom.env \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8848</span>:<span class="number">8848</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">9848</span>:<span class="number">9848</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">9849</span>:<span class="number">9849</span> \</span><br><span class="line"><span class="literal">--restart</span>=always \</span><br><span class="line">nacos/nacos<span class="literal">-server</span>:v2.<span class="number">1.0</span><span class="literal">-slim</span></span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—®ä¸‹é¢åœ°å€ï¼šhttp:&#x2F;&#x2F;è™šæ‹ŸæœºIPåœ°å€:8848&#x2F;nacos</p></li><li><p>é¦–æ¬¡è®¿é—®ä¼šè·³è½¬åˆ°ç™»å½•é¡µï¼Œ<strong>è´¦å·å¯†ç éƒ½æ˜¯nacos</strong></p></li></ol></li></ul><h3 id="åŸºäºNacoså®ç°æœåŠ¡æ³¨å†Œ"><a href="#åŸºäºNacoså®ç°æœåŠ¡æ³¨å†Œ" class="headerlink" title="åŸºäºNacoså®ç°æœåŠ¡æ³¨å†Œ"></a>åŸºäºNacoså®ç°æœåŠ¡æ³¨å†Œ</h3><ul><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos æœåŠ¡æ³¨å†Œå‘ç°--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®ä¿¡æ¯</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">  <span class="comment">#æœåŠ¡å</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">item-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="comment">#æœåŠ¡åœ°å€</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨å¤šä¸ªæœåŠ¡ï¼ŒæŸ¥çœ‹nacoså³å¯</p></li></ul><h3 id="åŸºäºNacoså®ç°æœåŠ¡å‘ç°"><a href="#åŸºäºNacoså®ç°æœåŠ¡å‘ç°" class="headerlink" title="åŸºäºNacoså®ç°æœåŠ¡å‘ç°"></a>åŸºäºNacoså®ç°æœåŠ¡å‘ç°</h3><ul><li><p>å¼•å…¥ä¾èµ–ã€é…ç½®ä¿¡æ¯ä¸å‰æ–‡ä¸€è‡´ï¼ˆæœåŠ¡è°ƒç”¨è€…ä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æä¾›è€…ï¼‰</p></li><li><p>æ¥ä¸‹æ¥ï¼ŒæœåŠ¡è°ƒç”¨è€…<code>cart-service</code>è®¢é˜…<code>item-service</code>æœåŠ¡äº†</p><ul><li><p><code>item-service</code>æœ‰å¤šä¸ªå®ä¾‹ï¼Œè€ŒçœŸæ­£å‘èµ·è°ƒç”¨æ—¶åªéœ€è¦çŸ¥é“ä¸€ä¸ªå®ä¾‹çš„åœ°å€ï¼›å› æ­¤ï¼ŒæœåŠ¡è°ƒç”¨è€…å¿…é¡»åˆ©ç”¨è´Ÿè½½å‡è¡¡çš„ç®—æ³•ï¼Œä»å¤šä¸ªå®ä¾‹ä¸­æŒ‘é€‰ä¸€ä¸ªå»è®¿é—®â€˜ï¼›å¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰</p><ul><li><p>éšæœº</p></li><li><p>è½®è¯¢</p></li><li><p>IPçš„hash</p></li><li><p>æœ€è¿‘æœ€å°‘è®¿é—®</p></li></ul></li></ul></li><li><p>è¿™é‡ŒåŸºäºéšæœºç®—æ³•å®ç°è´Ÿè½½å‡è¡¡</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è·å–discoveryClientå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</span><br><span class="line"><span class="comment">//ä»£ç </span></span><br><span class="line"><span class="comment">//é€šè¿‡æ³¨å†Œä¸­å¿ƒè·å–å•†å“å®ä¾‹</span></span><br><span class="line">List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;item-service&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (instances == <span class="literal">null</span> || instances.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> instances.get(RandomUtil.randomInt(instances.size()));</span><br><span class="line"><span class="comment">//å®ä¾‹çš„ipå’Œç«¯å£</span></span><br><span class="line"><span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serviceInstance.getUri();</span><br><span class="line"><span class="comment">// 2.æŸ¥è¯¢å•†å“</span></span><br><span class="line">ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">        uri + <span class="string">&quot;/items?ids=&#123;ids&#125;&quot;</span>,</span><br><span class="line">        HttpMethod.GET,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        Map.of(<span class="string">&quot;ids&quot;</span>, CollUtil.join(itemIds, <span class="string">&quot;,&quot;</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡swaggeræ–‡æ¡£æµ‹è¯•ï¼Œå®ç°è¿œç¨‹è°ƒç”¨ï¼Œå¦‚å•†å“å®ä¾‹æ§åˆ¶å°åˆ†åˆ«è¾“å‡ºï¼ˆå…ˆå…¨éƒ¨æ¸…ç©ºï¼‰</li></ul><h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><ul><li>åˆ©ç”¨Nacoså®ç°äº†æœåŠ¡çš„æ²»ç†ï¼Œåˆ©ç”¨RestTemplateå®ç°äº†æœåŠ¡çš„è¿œç¨‹è°ƒç”¨ï¼Œä½†æ˜¯è¿œç¨‹è°ƒç”¨çš„ä»£ç å¤ªå¤æ‚äº†</li><li>è¿œç¨‹è°ƒç”¨çš„å…³é”®ç‚¹å°±åœ¨äºå››ä¸ªå‚æ•°<ul><li>è¯·æ±‚æ–¹å¼</li><li>è¯·æ±‚è·¯å¾„</li><li>è¯·æ±‚å‚æ•°</li><li>è¿”å›å€¼ç±»å‹</li></ul></li><li><strong>OpenFeign</strong>åˆ©ç”¨SpringMVCçš„ç›¸å…³æ³¨è§£æ¥å£°æ˜ä»¥ä¸Š4ä¸ªå‚æ•°ï¼Œç„¶ååŸºäºåŠ¨æ€ä»£ç†å¸®æˆ‘ä»¬ç”Ÿæˆè¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼Œæ›¿æ¢æ‰RestTemplate</li><li>å¼•å…¥ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--openFeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--è´Ÿè½½å‡è¡¡å™¨ æ—§ç‰ˆä¸­`ribbon`æ˜¯ä¸€ç§è´Ÿè½½å‡è¡¡å™¨ï¼Œä½†ä¸€èˆ¬éƒ½æ˜¯ç”¨nginxè¿™ç§ç½‘å…³æ¥åšåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨<code>cart-service</code>å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£<code>@EnableFeignClients</code>ï¼Œå¯åŠ¨OpenFeignåŠŸèƒ½</li><li>ç¼–å†™Feignå®¢æˆ·ç«¯</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;item-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/items&quot;)</span></span><br><span class="line">    List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å®¢æˆ·ç«¯è¯¦æƒ…</p><ul><li>å£°æ˜æ¥å£ï¼Œæ— éœ€å®ç°æ–¹æ³•ï¼›æ¥å£ä¸­çš„å‡ ä¸ªå…³é”®ä¿¡æ¯<ul><li><code>@FeignClient(&quot;item-service&quot;)</code> ï¼šå£°æ˜æœåŠ¡çš„åç§°</li><li><code>@GetMapping</code> ï¼šå£°æ˜è¯·æ±‚æ–¹å¼</li><li><code>@GetMapping(&quot;/items&quot;)</code> ï¼šå£°æ˜è¯·æ±‚è·¯å¾„</li><li><code>@RequestParam(&quot;ids&quot;) Collection&lt;Long&gt; ids</code> ï¼šå£°æ˜è¯·æ±‚å‚æ•°</li><li><code>List&lt;ItemDTO&gt;</code> ï¼šè¿”å›å€¼ç±»å‹</li></ul></li><li>æœ‰äº†ä¸Šè¿°ä¿¡æ¯ï¼ŒOpenFeignå°±å¯ä»¥åˆ©ç”¨åŠ¨æ€ä»£ç†å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”å‘<code>http://item-service/items</code>å‘é€ä¸€ä¸ª<code>GET</code>è¯·æ±‚ï¼Œæºå¸¦idsä¸ºè¯·æ±‚å‚æ•°ï¼Œå¹¶è‡ªåŠ¨å°†è¿”å›å€¼å¤„ç†ä¸º<code>List&lt;ItemDTO&gt;</code></li></ul></li><li><p>è·å–å•†å“ä¿¡æ¯ä»£ç å°±å¯ç®€åŒ–ä¸º</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è·å–itemClientå®ç°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ItemClient itemClient;</span><br><span class="line"><span class="comment">//ç›´æ¥è°ƒç”¨æ¥å£å³å¯</span></span><br><span class="line">List&lt;ItemDTO&gt; items = itemClient.queryItemByIds(itemIds);</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡Swaggeræ–‡æ¡£è°ƒå¼</li></ul><h3 id="è¿æ¥æ± "><a href="#è¿æ¥æ± " class="headerlink" title="è¿æ¥æ± "></a>è¿æ¥æ± </h3><ul><li><p>åŸç†ï¼Œè§‚çœ‹hmè§†é¢‘</p><ul><li>OpenFeignåº•å±‚å‘èµ·httpè¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚æ”¯æŒçš„httpå®¢æˆ·ç«¯å®ç°åŒ…æ‹¬ï¼š<ul><li>HttpURLConnectionï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± </li><li>Apache HttpClient ï¼šæ”¯æŒè¿æ¥æ± ï¼ˆè‹ç©¹å¤–å–å®ç°è¿‡ï¼‰</li><li>OKHttpï¼šæ”¯æŒè¿æ¥æ± </li></ul></li><li>é€šå¸¸ä¼šä½¿ç”¨å¸¦æœ‰è¿æ¥æ± çš„å®¢æˆ·ç«¯æ¥ä»£æ›¿é»˜è®¤çš„HttpURLConnectionã€‚æ¯”å¦‚ï¼Œä½¿ç”¨OK Http</li></ul></li><li><p>ä½¿ç”¨OKHttpè¿æ¥æ± </p><ul><li>å¼•ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--OK http çš„ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨<code>cart-service</code>çš„<code>application.yml</code>é…ç½®æ–‡ä»¶ä¸­å¼€å¯Feignçš„è¿æ¥æ± åŠŸèƒ½</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯OKHttpåŠŸèƒ½</span></span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ï¼Œåœ¨<code>org.springframework.cloud.openfeign.loadbalancer.FeignBlockingLoadBalancerClient</code>ä¸­çš„<code>execute</code>æ–¹æ³•ä¸­æ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹<code>delegate</code></p></li></ul><h3 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h3><ul><li>é¢å¯¹çš„é—®é¢˜<ul><li>å½“æ›´å¤šå…¶å®ƒçš„æœåŠ¡éœ€è¦<code>item-service</code>è¶Šæ¥è¶Šå¤šæ—¶ï¼ŒæŒ‰ç…§å‰æ–‡çš„å®ç°ï¼Œå°±ä¼šåˆ›å»ºé‡å¤çš„ä»£ç <code>ItemClent</code></li><li>ä»¥åŠ<code>ItemDto</code>ä¹Ÿä¼šé‡å¤å¯¼å…¥å…¶ä»–æœåŠ¡çš„dtoåŒ…ä¸­</li></ul></li><li>è§£å†³æ–¹æ¡ˆ<ul><li>é¿å…é‡å¤ç¼–ç çš„åŠæ³•å°±æ˜¯<strong>æŠ½å–</strong>ã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸¤ç§æŠ½å–æ€è·¯ï¼š<ul><li>æ€è·¯1ï¼šæŠ½å–åˆ°å¾®æœåŠ¡ä¹‹å¤–çš„å…¬å…±module</li><li>æ€è·¯2ï¼šæ¯ä¸ªå¾®æœåŠ¡è‡ªå·±æŠ½å–ä¸€ä¸ªmodule</li></ul></li><li>å¦‚å›¾<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/KyqLjRZO8AeCrdo.jpg" alt="imag"></li></ul></li><li>æ–¹æ¡ˆ1æŠ½å–æ›´åŠ ç®€å•ï¼Œå·¥ç¨‹ç»“æ„ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œä½†ç¼ºç‚¹æ˜¯æ•´ä¸ªé¡¹ç›®è€¦åˆåº¦åé«˜ã€‚æ–¹æ¡ˆ2æŠ½å–ç›¸å¯¹éº»çƒ¦ï¼Œå·¥ç¨‹ç»“æ„ç›¸å¯¹æ›´å¤æ‚ï¼Œä½†æœåŠ¡ä¹‹é—´è€¦åˆåº¦é™ä½</li></ul></li><li>è¿™é‡Œä½¿ç”¨æ–¹æ¡ˆ1<ol><li>å®šä¹‰å…¬å…±moduleï¼š<code>hm-api</code></li><li>å¼•å…¥å…¬å…±ä¾èµ–</li><li>å®šä¹‰<code>clientå’Œdto</code>åŒ…ç»“æ„ä»¥åŠå¯¼å…¥ç›¸å…³åŒ…</li><li>è§£å†³<code>private final ItemClient itemClient;</code>æ— æ³•æ‰¾åˆ°beanæŠ¥é”™<ul><li>å› ä¸º<code>ItemClient</code>ç°åœ¨å®šä¹‰åˆ°äº†<code>com.hmall.api.client</code>åŒ…ä¸‹ï¼Œè€Œ<code>cart-service</code>çš„å¯åŠ¨ç±»å®šä¹‰åœ¨<code>com.hmall.cart</code>åŒ…ä¸‹ï¼Œæ‰«æä¸åˆ°<code>ItemClient</code>ï¼Œæ‰€ä»¥æŠ¥é”™</li><li>è§£å†³ï¼šåœ¨<code>cart-service</code>çš„å¯åŠ¨ç±»ä¸Šæ·»åŠ å£°æ˜å³å¯<ol><li>å£°æ˜æ‰«æåŒ…<code>@EnableFeignClients(basePackages = &quot;com.hmall.api.clients&quot;)</code>ï¼ˆèŒƒå›´å¹¿ï¼‰</li><li>å£°æ˜è¦ç”¨çš„FeignClient <code>@EnableFeignClients(clients = &#123;ItemClient.class&#125;)</code>(æ›´å…·ä½“)</li></ol></li></ul></li></ol></li><li>é€šè¿‡swaggeræ–‡æ¡£æŸ¥è¯¢æµ‹è¯•</li></ul><h3 id="æ—¥å¿—é…ç½®"><a href="#æ—¥å¿—é…ç½®" class="headerlink" title="æ—¥å¿—é…ç½®"></a>æ—¥å¿—é…ç½®</h3><ul><li><p>OpenFeignåªä¼šåœ¨FeignClientæ‰€åœ¨åŒ…çš„æ—¥å¿—çº§åˆ«ä¸º<strong>DEBUG</strong>æ—¶ï¼Œæ‰ä¼šè¾“å‡ºæ—¥å¿—ã€‚è€Œä¸”å…¶æ—¥å¿—çº§åˆ«æœ‰4çº§ï¼š</p><ul><li><strong>NONE</strong>ï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚</li><li><strong>BASIC</strong>ï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´</li><li><strong>HEADERS</strong>ï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯</li><li><strong>FULL</strong>ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®</li></ul></li><li><p>Feigné»˜è®¤çš„æ—¥å¿—çº§åˆ«å°±æ˜¯NONEï¼Œæ‰€ä»¥é»˜è®¤æˆ‘ä»¬çœ‹ä¸åˆ°è¯·æ±‚æ—¥å¿—</p></li><li><p>å®ç°</p><ol><li><p>å®šä¹‰ä¸€ä¸ªé…ç½®ç±»ï¼Œåœ¨<code>hm-api</code>ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultFeignConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®ç”Ÿæ•ˆ</p><ol><li>å±€éƒ¨ç”Ÿæ•ˆï¼š<code>@FeignClient(value = &quot;item-service&quot;, configuration = DefaultFeignConfig.class)</code></li><li>å…¨å±€ç”Ÿæ•ˆï¼š<code>@EnableFeignClients(defaultConfiguration = DefaultFeignConfig.class)</code></li></ol></li></ol></li></ul><h2 id="ä½œä¸š"><a href="#ä½œä¸š" class="headerlink" title="ä½œä¸š"></a>ä½œä¸š</h2><p>å°†hm-serviceä¸­çš„å…¶å®ƒä¸šåŠ¡ä¹Ÿéƒ½æ‹†åˆ†ä¸ºå¾®æœåŠ¡ï¼Œå¹¶åŸºäºOpenFeignå®Œå–„åŠŸèƒ½</p><ul><li>user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼ŒåŒ…å«ç”¨æˆ·ç™»å½•ã€ç®¡ç†ç­‰åŠŸèƒ½</li><li>trade-serviceï¼šäº¤æ˜“å¾®æœåŠ¡ï¼ŒåŒ…å«è®¢å•ç›¸å…³åŠŸèƒ½</li><li>pay-serviceï¼šæ”¯ä»˜å¾®æœåŠ¡ï¼ŒåŒ…å«æ”¯ä»˜ç›¸å…³åŠŸèƒ½</li></ul><p>å…¶ä¸­äº¤æ˜“æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€ç”¨æˆ·æœåŠ¡ä¸­çš„ä¸šåŠ¡éƒ½éœ€è¦çŸ¥é“å½“å‰ç™»å½•ç”¨æˆ·æ˜¯è°ï¼Œæš‚æ—¶å†™æ­»</p><h3 id="ç”¨æˆ·å¾®æœåŠ¡"><a href="#ç”¨æˆ·å¾®æœåŠ¡" class="headerlink" title="ç”¨æˆ·å¾®æœåŠ¡"></a>ç”¨æˆ·å¾®æœåŠ¡</h3><p>ç”¨æˆ·å¾®æœåŠ¡éœ€è¦å°†<code>hm-service</code>ä¸­çš„configåŒ…ä¸‹çš„<code>JwtPropertiesã€SecurityConfig </code>ç±»å¯¼å…¥åˆ°<code>user-service</code>æ¨¡å—ä¸‹</p><ul><li>JwtPropertiesæ˜¯JsonWebTokençš„å±æ€§é…ç½®</li><li>SecurityConfigè¯»å–JwtPropertiesçš„ä¿¡æ¯ï¼Œä»¥åŠåˆ›å»ºä¸€ä¸ªPasswordEncoderçš„beanç”¨äºâ€å¯†ç çš„åˆ¤æ–­â€</li></ul><p>å°†<code>hm-service</code>ä¸­çš„utilsåŒ…ä¸‹çš„<code>JwtTool</code>ç±»å¯¼å…¥åˆ°<code>user-service</code>æ¨¡å—ä¸‹</p><ul><li>JwtToolç±»ä¸»è¦æ˜¯åˆ›å»ºtokenå’Œè§£ætoken</li></ul><p>ç”±äºæ‹¦æˆªå™¨å’Œæ‹¦æˆªå™¨çš„é…ç½®æ²¡æœ‰å¯¼å…¥ï¼Œæ‰€ä»¥è¿™ä¸ªtokenä¹Ÿç­‰åŒäºæ²¡æœ‰ï¼Œå¯¹ç™»å½•&#x2F;æ‰£æ¬¾ä»£ç ä¸­çš„<code>UserContext.getUser()</code>ç»Ÿä¸€å†™ä¸º<code>1L</code>ã€‚</p><p>é€šè¿‡swaggeræ¥å£æ–‡æ¡£è¿›è¡Œè°ƒè¯•</p><h3 id="äº¤æ˜“å¾®æœåŠ¡"><a href="#äº¤æ˜“å¾®æœåŠ¡" class="headerlink" title="äº¤æ˜“å¾®æœåŠ¡"></a>äº¤æ˜“å¾®æœåŠ¡</h3><p>ä»<code>controller</code>åŒ…å‘ç°ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªæ¥å£</p><ol><li><code>@ApiOperation(&quot;æ ¹æ®idæŸ¥è¯¢è®¢å•&quot;)</code></li><li><code>@ApiOperation(&quot;åˆ›å»ºè®¢å•&quot;)</code></li><li><code>@ApiOperation(&quot;æ ‡è®°è®¢å•å·²æ”¯ä»˜&quot;)</code></li></ol><p>åªæœ‰åˆ›å»ºè®¢å•<code>createOrder()</code>æ˜¯éœ€è¦è¿›è¡Œè¿œç¨‹è°ƒç”¨</p><ul><li><code>private final ItemClient itemClient;</code>æŸ¥è¯¢å’Œä¿®æ”¹å•†å“ä¿¡æ¯</li><li><code>private final CartClient cartClient;</code>æ¸…ç©ºè´­ç‰©è½¦çš„ç¼“å­˜</li></ul><p>é…ç½®ä¿¡æ¯</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span><span class="string">:8848</span></span><br><span class="line"><span class="comment"># okhttpè¿æ¥æ± </span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>hm-api</code>ä¸­</p><ul><li><p><code>ItemCliemt</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;item-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/items&quot;)</span></span><br><span class="line">    List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">    <span class="meta">@PutMapping(&quot;/items/stock/deduct&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderDetailDTO&gt; items)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>CartClient</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;cart-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CartClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/carts&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteCartItemByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å¯åŠ¨ç±»æ³¨è§£ä»¥åŠé…ç½®ä¿¡æ¯</p><ul><li><code>@EnableFeignClients(clients = &#123;ItemClient.class, CartClient.class&#125;,defaultConfiguration = DefaultFeignConfig.class)</code></li></ul><p>å®Œæ•´çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">createOrder</span><span class="params">(OrderFormDTO orderFormDTO)</span> &#123;</span><br><span class="line">    <span class="comment">//è®¢å•æ•°æ®</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢å•†å“</span></span><br><span class="line">    List&lt;OrderDetailDTO&gt; detailDTOS = orderFormDTO.getDetails();</span><br><span class="line">    <span class="comment">//è·å–å•†å“idå’Œå•†å“æ•°é‡çš„Map</span></span><br><span class="line">    Map&lt;Long, Integer&gt; itemNumMap = detailDTOS.stream()</span><br><span class="line">            .collect(Collectors.toMap(OrderDetailDTO::getItemId, OrderDetailDTO::getNum));</span><br><span class="line">    <span class="comment">//æ‰€æœ‰çš„å•†å“id</span></span><br><span class="line">    Set&lt;Long&gt; itemIds = itemNumMap.keySet();</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢å•†å“client</span></span><br><span class="line">    List&lt;ItemDTO&gt; items = itemClient.queryItemByIds(itemIds);</span><br><span class="line">    <span class="keyword">if</span> (items == <span class="literal">null</span> || items.size() &lt; itemIds.size()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&quot;å•†å“ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åŸºäºå•†å“ä»·æ ¼ã€è´­ä¹°æ•°é‡è®¡ç®—å•†å“æ€»ä»·ï¼štotalFee</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (ItemDTO item : items) &#123;</span><br><span class="line">        total += item.getPrice() * itemNumMap.get(item.getId());</span><br><span class="line">    &#125;</span><br><span class="line">    order.setTotalFee(total);</span><br><span class="line">    <span class="comment">//è®¢å•å…¶å®ƒå±æ€§</span></span><br><span class="line">    order.setPaymentType(orderFormDTO.getPaymentType());</span><br><span class="line">    order.setUserId(<span class="number">1L</span>);<span class="comment">// TODO ä¸‹å•ç”¨æˆ·</span></span><br><span class="line">    order.setStatus(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//å°†Orderå†™å…¥æ•°æ®åº“orderè¡¨ä¸­</span></span><br><span class="line">    save(order);</span><br><span class="line">    <span class="comment">//ä¿å­˜è®¢å•è¯¦æƒ…</span></span><br><span class="line">    List&lt;OrderDetail&gt; details = buildDetails(order.getId(), items, itemNumMap);</span><br><span class="line">    detailService.saveBatch(details);</span><br><span class="line">    <span class="comment">//æ¸…ç†è´­ç‰©è½¦å•†å“client</span></span><br><span class="line">    cartClient.deleteCartItemByIds(itemIds);</span><br><span class="line">    <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        itemClient.deductStock(detailDTOS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> order.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡Swaggerè°ƒå¼â€œåˆ›å»ºè®¢å•â€æ¥å£æ˜¯å¦å®Œæˆäº†è¿œç¨‹è°ƒç”¨</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;addressId&quot;</span><span class="punctuation">:</span> <span class="number">59</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;itemId&quot;</span><span class="punctuation">:</span> <span class="number">317578</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;itemId&quot;</span><span class="punctuation">:</span> <span class="number">546872</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;paymentType&quot;</span><span class="punctuation">:</span> <span class="number">3</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="æ”¯ä»˜å¾®æœåŠ¡"><a href="#æ”¯ä»˜å¾®æœåŠ¡" class="headerlink" title="æ”¯ä»˜å¾®æœåŠ¡"></a>æ”¯ä»˜å¾®æœåŠ¡</h3><p>ä»<code>PayController</code>å‘ç°ä¸¤ä¸ªæ¥å£</p><ul><li><code>@ApiOperation(&quot;ç”Ÿæˆæ”¯ä»˜å•&quot;)</code></li><li><code>@ApiOperation(&quot;å°è¯•åŸºäºç”¨æˆ·ä½™é¢æ”¯ä»˜&quot;)</code></li></ul><p>åœ¨ç”Ÿæˆæ”¯ä»˜å•çš„æ¥å£ä¸­ï¼Œä»…ä»…éœ€è¦ä¿®æ”¹å®ç°ç±»ä¸­çš„<code>buildPayOrder(PayApplyDTO payApplyDTO)</code>æ–¹æ³•</p><ul><li>è¯¥æ¥å£ç”¨æ¥ç”Ÿæˆæ”¯ä»˜è®¢å•</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> PayOrder <span class="title function_">buildPayOrder</span><span class="params">(PayApplyDTO payApplyDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æ•°æ®è½¬æ¢</span></span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">payOrder</span> <span class="operator">=</span> BeanUtils.toBean(payApplyDTO, PayOrder.class);</span><br><span class="line">    <span class="comment">// 2.åˆå§‹åŒ–æ•°æ®</span></span><br><span class="line">    payOrder.setPayOverTime(LocalDateTime.now().plusMinutes(<span class="number">120L</span>));</span><br><span class="line">    payOrder.setStatus(PayStatus.WAIT_BUYER_PAY.getValue());</span><br><span class="line">    payOrder.setBizUserId(<span class="number">1L</span>); <span class="comment">//TODO UserContext.getUser()</span></span><br><span class="line">    <span class="keyword">return</span> payOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨â€œå°è¯•åŸºäºç”¨æˆ·ä½™é¢æ”¯ä»˜â€æ¥å£ä¸­ï¼Œéœ€è¦å¯¹ç”¨æˆ·å’Œè®¢å•æœåŠ¡è¿›è¡Œè¿œç¨‹è°ƒç”¨</p><ul><li>å¯¼å…¥ç›¸å…³ä¾èµ–åœ¨<code>pay-service</code></li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--å…¬å…±api--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hm-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--nacosæœåŠ¡--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>nacoså±æ€§é…ç½®</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span><span class="string">:8848</span></span><br><span class="line"><span class="comment"># okhttpè¿æ¥æ± </span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ç”¨æˆ·å’Œè®¢å•çš„è¿œç¨‹è°ƒç”¨æ¥å£</p><ul><li><p>ä½™é¢æ”¯ä»˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/users/money/deduct&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductMoney</span><span class="params">(<span class="meta">@RequestParam(&quot;pw&quot;)</span> String pw,<span class="meta">@RequestParam(&quot;amount&quot;)</span> Integer amount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹è®¢å•çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;trade-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/orders/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å¼€å¯OpenFeignæ³¨è§£</p><ul><li><code>@EnableFeignClients(basePackages = &quot;com.hmall.api.clients&quot;,defaultConfiguration = DefaultFeignConfig.class)</code></li></ul><p>å…·ä½“ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OrderClient orderClient;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPayOrderByBalance</span><span class="params">(PayOrderFormDTO payOrderFormDTO)</span> &#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢æ”¯ä»˜å•</span></span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">po</span> <span class="operator">=</span> getById(payOrderFormDTO.getId());</span><br><span class="line">    <span class="comment">//åˆ¤æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (!PayStatus.WAIT_BUYER_PAY.equalsValue(po.getStatus())) &#123;</span><br><span class="line">        <span class="comment">// è®¢å•ä¸æ˜¯æœªæ”¯ä»˜ï¼ŒçŠ¶æ€å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;äº¤æ˜“å·²æ”¯ä»˜æˆ–å…³é—­ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°è¯•æ‰£å‡ä½™é¢client</span></span><br><span class="line">    userClient.deductMoney(payOrderFormDTO.getPw(), po.getAmount());</span><br><span class="line">    <span class="comment">//ä¿®æ”¹æ”¯ä»˜å•çŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> markPayOrderSuccess(payOrderFormDTO.getId(), LocalDateTime.now()</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;äº¤æ˜“å·²æ”¯ä»˜æˆ–å…³é—­ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ‡è®°è®¢å•å·²æ”¯ä»˜client</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">bizOrderNo</span> <span class="operator">=</span> po.getBizOrderNo();</span><br><span class="line">    orderClient.updateById(bizOrderNo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡Swaggeræµ‹è¯•ï¼ŒéªŒè¯è¿œç¨‹è°ƒç”¨æ˜¯å¦æˆåŠŸ</p><ul><li>å…ˆä¿®æ”¹<code>pay-order</code>è¡¨ä¸­<code>status</code>å­—æ®µä¸º1ï¼ˆæœªæ”¯ä»˜ï¼‰</li><li>æ”¯ä»˜å•idæ˜¯è¡¨ä¸­çš„idå­—æ®µ</li><li>æ”¯ä»˜è®¢å•idæ˜¯è¡¨ä¸­çš„pay_order_noå­—æ®µï¼Œå¯†ç ä¸º123</li></ul><h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p>å¦‚ä½•æ‰èƒ½åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¸­éƒ½æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Ÿå¦‚ä½•åœ¨å¾®æœåŠ¡ä¹‹é—´ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ</p><ul><li>åˆæ­¥æƒ³æ³•<ul><li>æŠŠæ‹¦æˆªå™¨ä¹Ÿé‡æ–°æ‹†åˆ†ä¸ºä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™æ ·<code>UserContext</code>ç±»å°±å¯ä»¥è·å–tokenä¸­çš„ç”¨æˆ·idï¼Œä»è€Œå¾—åˆ°ç”¨æˆ·ä¿¡æ¯</li><li>ä¸åŒæœåŠ¡çš„çº¿ç¨‹æ˜¯å¦ä¸€è‡´å‘¢ï¼Ÿç¡®ä¿<code>UserContext</code>åœ¨å„ä¸ªæœåŠ¡æ˜¯å¦‚æœå¯ä»¥äº’ç›¸è”ç³»çº¿ç¨‹çš„è¯ï¼Œè·å–åˆ°çš„ç”¨æˆ·idä¹Ÿå°±ä¸€è‡´</li></ul></li></ul><h3 id="å‰åè”è°ƒ"><a href="#å‰åè”è°ƒ" class="headerlink" title="å‰åè”è°ƒ"></a>å‰åè”è°ƒ</h3><p>é»‘é©¬èµ„æ–™æä¾›äº†ä¸€ä¸ª<code>hmall-nginx</code>ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†Nginxä»¥åŠæˆ‘ä»¬çš„å‰ç«¯ä»£ç </p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/kglCi7uMhwqByAp.png" alt="img"></p><p>å°†å…¶æ‹·è´åˆ°ä¸€ä¸ªä¸åŒ…å«ä¸­æ–‡ã€ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦çš„ç›®å½•ï¼Œå¯åŠ¨åå³å¯è®¿é—®åˆ°é¡µé¢</p><ul><li>18080ç«¯å£æ˜¯ç”¨æˆ·ç«¯é¡µé¢</li><li>18081ç«¯å£æ˜¯ç®¡ç†ç«¯é¡µé¢ï¼Œé»‘é©¬å¥½åƒæ²¡æœ‰å†™å®Œå…¨è¿™ä¸ªç®¡ç†ç«¯ï¼Œè®¿é—®18081ç«¯å£æŠ¥é”™</li></ul><p>ä¹‹å‰<code>nginx</code>å†…éƒ¨ä¼šå°†å‘å‘æœåŠ¡ç«¯è¯·æ±‚å…¨éƒ¨ä»£ç†åˆ°8080ç«¯å£ï¼Œä½†æ˜¯ç°åœ¨æ‹†åˆ†äº†Nä¸ªå¾®æœåŠ¡ï¼Œ8080ä¸å¯ç”¨äº†ã€‚é€šè¿‡<code>Nginx</code>é…ç½®ï¼Œå®Œæˆå¯¹ä¸åŒå¾®æœåŠ¡çš„åå‘ä»£ç†</p><ul><li>æ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”ä¸€ä¸ªç«¯å£å·ï¼Œæ¯ä¸ªè¯·æ±‚åˆå¯¹åº”ç€ä¸åŒçš„æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸åŒè¯·æ±‚çš„æ‰€è®¿é—®çš„æœåŠ¡ç«¯å£éƒ½ä¸ä¸€è‡´</li><li>ç¡®ä¿æ¯ä¸€ä¸ªè¯·æ±‚å¯¹åº”çš„æœåŠ¡ä¸€è‡´ï¼Œä¸å†æ˜¯ä¹‹å‰ç»Ÿä¸€çš„8080ç«¯å£</li></ul><p>å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜å‘¢ï¼Ÿéœ€è¦ç”¨åˆ°å¾®æœåŠ¡å½“ä¸­ç½‘å…³çš„çŸ¥è¯†äº†</p><h2 id="ç½‘å…³åŠé…ç½®ç®¡ç†"><a href="#ç½‘å…³åŠé…ç½®ç®¡ç†" class="headerlink" title="ç½‘å…³åŠé…ç½®ç®¡ç†"></a>ç½‘å…³åŠé…ç½®ç®¡ç†</h2><p>å‰æ™¯æè¦ï¼Œç¢°åˆ°çš„é—®é¢˜</p><ul><li>ç”±äºæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰ä¸åŒçš„åœ°å€æˆ–ç«¯å£ï¼Œå…¥å£ä¸åŒï¼Œåœ¨ä¸å‰ç«¯è”è°ƒçš„æ—¶å€™å‡ºç°ä¸€äº›é—®é¢˜<ul><li>è¯·æ±‚ä¸åŒæ•°æ®æ—¶è¦è®¿é—®ä¸åŒçš„å…¥å£ï¼Œéœ€è¦ç»´æŠ¤å¤šä¸ªå…¥å£åœ°å€ï¼Œéº»çƒ¦</li><li>å‰ç«¯æ— æ³•è°ƒç”¨nacosï¼Œæ— æ³•å®æ—¶æ›´æ–°æœåŠ¡åˆ—è¡¨</li></ul></li><li>å•ä½“æ¶æ„æ—¶æˆ‘ä»¬åªéœ€è¦å®Œæˆä¸€æ¬¡ç”¨æˆ·ç™»å½•ã€èº«ä»½æ ¡éªŒï¼Œå°±å¯ä»¥åœ¨æ‰€æœ‰ä¸šåŠ¡ä¸­è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚è€Œå¾®æœåŠ¡æ‹†åˆ†åï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½ç‹¬ç«‹éƒ¨ç½²ï¼Œè¿™å°±å­˜åœ¨ä¸€äº›é—®é¢˜<ul><li>æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦ç¼–å†™ç™»å½•æ ¡éªŒã€ç”¨æˆ·ä¿¡æ¯è·å–çš„åŠŸèƒ½å—ï¼Ÿ</li><li>å½“å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨æ—¶ï¼Œè¯¥å¦‚ä½•ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ</li></ul></li></ul><p>è¿™äº›é—®é¢˜ä¼šé€šè¿‡<strong>ç½‘å…³</strong>æŠ€æœ¯è§£å†³</p><h3 id="ä½•ä¸ºç½‘å…³ï¼Ÿ"><a href="#ä½•ä¸ºç½‘å…³ï¼Ÿ" class="headerlink" title="ä½•ä¸ºç½‘å…³ï¼Ÿ"></a>ä½•ä¸ºç½‘å…³ï¼Ÿ</h3><p>é¡¾æ˜æ€è®®ï¼Œç½‘å…³å°±æ˜¯<strong>ç½‘</strong>ç»œçš„<strong>å…³</strong>å£ã€‚æ•°æ®åœ¨ç½‘ç»œé—´ä¼ è¾“ï¼Œä»ä¸€ç«¯ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ç«¯ç½‘ç»œæ—¶å°±éœ€è¦ç»è¿‡ç½‘å…³æ¥åšæ•°æ®çš„<strong>è·¯ç”±</strong>å’Œ<strong>è½¬å‘</strong>ä»¥åŠæ•°æ®å®‰å…¨çš„<strong>æ ¡éªŒ</strong></p><p>ä¸¾ä¸ªä¾‹å­</p><ul><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/nt7jobRyFH1NJEM.jpg" alt="img"></p></li><li><p>ç½‘å…³å°±åƒæ˜¯ä»¥å‰å›­åŒºä¼ è¾¾å®¤çš„å¤§çˆ·</p><ul><li>è·¯ç”±å°±åƒæ˜¯å¤§çˆ·åˆ°ä½ å¯»æ‰¾ä¹‹åœ°çš„è·¯çº¿</li><li>æ ¡éªŒï¼Œå°±æ˜¯å¤§çˆ·å¯¹ä½ èº«ä»½çš„æ€€ç–‘å’Œç›˜é—®</li></ul></li><li><p>å¤–é¢çš„äººè¦æƒ³è¿›å…¥å›­åŒºï¼Œå¿…é¡»ç»è¿‡å¤§çˆ·çš„è®¤å¯ï¼Œå¦‚æœä½ æ˜¯ä¸æ€€å¥½æ„çš„äººï¼Œè‚¯å®šè¢«ç›´æ¥æ‹¦æˆªï¼ˆèº«ä»½éªŒè¯ï¼‰</p></li><li><p>å¤–é¢çš„äººè¦ä¼ è¯æˆ–é€ä¿¡ï¼Œè¦æ‰¾å¤§çˆ·ï¼Œå¤§çˆ·å¸®ä½ å¸¦ç»™ç›®æ ‡äººï¼ˆè·¯ç”±å’Œè½¬å‘ï¼‰</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/pGM2RItxH954PCj.jpg" alt="imag"></p></li><li><p>ç°åœ¨ï¼Œå¾®æœåŠ¡ç½‘å…³å°±èµ·åˆ°åŒæ ·çš„ä½œç”¨ã€‚å‰ç«¯è¯·æ±‚ä¸èƒ½ç›´æ¥è®¿é—®å¾®æœåŠ¡ï¼Œè€Œæ˜¯è¦å…ˆè¯·æ±‚ç½‘å…³</p><ul><li>ç½‘å…³å¯ä»¥åšå®‰å…¨æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯ç™»å½•èº«ä»½æ ¡éªŒï¼Œæ ¡éªŒé€šè¿‡æ‰æ”¾è¡Œ</li><li>é€šè¿‡è®¤è¯åï¼Œç½‘å…³å†æ ¹æ®è¯·æ±‚åˆ¤æ–­åº”è¯¥è®¿é—®å“ªä¸ªå¾®æœåŠ¡ï¼Œå°†è¯·æ±‚è½¬å‘è¿‡å»</li><li>ç½‘å…³å¯ä»¥ä»Nacosæ³¨å†Œä¸­å¿ƒä¸­è·å–åˆ°æœåŠ¡åˆ—è¡¨ä»¥åŠå…·ä½“æœåŠ¡çš„å¤šä¸ªå®ä¾‹ä¿¡æ¯</li></ul></li></ul><p>åœ¨Spring Cloudä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š</p><ul><li><strong>Spring cloud Gateway</strong>ï¼šåŸºäºSpringçš„WebFluxæŠ€æœ¯ï¼Œå®Œå…¨æ”¯æŒå“åº”å¼ç¼–ç¨‹ï¼Œååèƒ½åŠ›æ›´å¼º</li><li><strong>Netfilx Zuul</strong>ï¼šåŸºäºServletçš„é˜»å¡å¼ç¼–ç¨‹ï¼Œéœ€è¦è°ƒä¼˜æ‰èƒ½è·å¾—ä¸Spring cloud Gatewayç±»ä¼¼çš„æ€§èƒ½</li></ul><h3 id="ç½‘å…³è·¯ç”±"><a href="#ç½‘å…³è·¯ç”±" class="headerlink" title="ç½‘å…³è·¯ç”±"></a>ç½‘å…³è·¯ç”±</h3><h4 id="å¿«é€Ÿå…¥é—¨"><a href="#å¿«é€Ÿå…¥é—¨" class="headerlink" title="å¿«é€Ÿå…¥é—¨"></a>å¿«é€Ÿå…¥é—¨</h4><p>ç”±äºç½‘å…³æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œå› æ­¤ä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªæ¨¡å—å¼€å‘åŠŸèƒ½ã€‚å¤§æ¦‚æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li><p>åˆ›å»ºç½‘å…³å¾®æœåŠ¡</p></li><li><p>å¼•å…¥SpringCloudGatewayã€NacosDiscoveryä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--common--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.heima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hm-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ç½‘å…³--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos discovery--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--è´Ÿè½½å‡è¡¡--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ç¼–å†™å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®ç½‘å…³è·¯ç”±è§„åˆ™</strong></p><ul><li>åœ¨<code>hm-gateway</code>æ¨¡å—çš„<code>resources</code>ç›®å½•æ–°å»ºä¸€ä¸ª<code>application.yaml</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> <span class="comment"># è·¯ç”±è§„åˆ™idï¼Œè‡ªå®šä¹‰ï¼Œå”¯ä¸€</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span> <span class="comment"># è·¯ç”±çš„ç›®æ ‡æœåŠ¡ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åˆ—</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è§„åˆ™ï¼Œç¬¦åˆåˆ™è·¯ç”±åˆ°ç›®æ ‡æœåŠ¡</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span> <span class="comment"># è¿™é‡Œæ˜¯ä»¥è¯·æ±‚è·¯å¾„ä½œä¸ºåˆ¤æ–­è§„åˆ™</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/users/**,/addresses/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">trade</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://trade-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/orders/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pay</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pay-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/pay-orders/**</span></span><br></pre></td></tr></table></figure><ul><li>è¿™æ ·ï¼Œå½“å‰ç«¯è¯·æ±‚æ—¶ï¼Œç½‘å…³å°±ä¼šæ ¹æ®è·¯ç”±æ–­è¨€åˆ¤æ–­æ—¶å“ªä¸€ä¸ªå¾®æœåŠ¡å®ä¾‹ï¼Œç„¶åå†é€šè¿‡è´Ÿè½½å‡è¡¡è°ƒç”¨ä»nacosè·å–åˆ°çš„å®ä¾‹</li></ul></li></ul><h4 id="è·¯ç”±å±æ€§"><a href="#è·¯ç”±å±æ€§" class="headerlink" title="è·¯ç”±å±æ€§"></a>è·¯ç”±å±æ€§</h4><p>yamlæ–‡ä»¶ä¸­æ¯ä¸€ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªJavaç±»ï¼Œè·¯ç”±routeså¯¹åº”çš„Javaç±»æ˜¯<code>GatewayProperties</code></p><ul><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/8gPEKupAa6XOli7.png" alt="image"></p></li><li><p>æ˜¯ä¸€ä¸ªé›†åˆï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥å®šä¹‰å¾ˆå¤šè·¯ç”±è§„åˆ™ã€‚é›†åˆä¸­çš„<code>RouteDefinition</code>å°±æ˜¯å…·ä½“çš„è·¯ç”±è§„åˆ™å®šä¹‰ï¼Œå…¶ä¸­å¸¸è§çš„å±æ€§å¦‚ä¸‹ï¼š</p><ul><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/gVHZ4DQOKMxkeat.png" alt="img"></p></li><li><p>å››ä¸ªå±æ€§å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>id</code>ï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º</li><li><code>predicates</code>ï¼šè·¯ç”±æ–­è¨€ï¼Œå…¶å®å°±æ˜¯åŒ¹é…æ¡ä»¶</li><li><code>filters</code>ï¼šè·¯ç”±è¿‡æ»¤æ¡ä»¶</li><li><code>uri</code>ï¼šè·¯ç”±ç›®æ ‡åœ°å€ï¼Œ<code>lb://</code>ä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å–ç›®æ ‡å¾®æœåŠ¡çš„å®ä¾‹åˆ—è¡¨ï¼Œå¹¶ä¸”è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªè®¿é—®</li></ul></li><li><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨<code>predicates</code>ï¼Œä¹Ÿå°±æ˜¯è·¯ç”±æ–­è¨€ã€‚SpringCloudGatewayä¸­æ”¯æŒçš„æ–­è¨€ç±»å‹æœ‰å¾ˆå¤šï¼š</p></li><li><table><thead><tr><th align="left"><strong>åç§°</strong></th><th align="left"><strong>è¯´æ˜</strong></th><th align="left"><strong>ç¤ºä¾‹</strong></th></tr></thead><tbody><tr><td align="left">After</td><td align="left">æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚</td><td align="left">- After&#x3D;2037-01-20T17:42:47.789-07:00[America&#x2F;Denver]</td></tr><tr><td align="left">Before</td><td align="left">æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td><td align="left">- Before&#x3D;2031-04-13T15:14:47.433+08:00[Asia&#x2F;Shanghai]</td></tr><tr><td align="left">Between</td><td align="left">æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td><td align="left">- Between&#x3D;2037-01-20T17:42:47.789-07:00[America&#x2F;Denver], 2037-01-21T17:42:47.789-07:00[America&#x2F;Denver]</td></tr><tr><td align="left">Cookie</td><td align="left">è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie</td><td align="left">- Cookie&#x3D;chocolate, ch.p</td></tr><tr><td align="left">Header</td><td align="left">è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header</td><td align="left">- Header&#x3D;X-Request-Id, \d+</td></tr><tr><td align="left">Host</td><td align="left">è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhost(åŸŸå)</td><td align="left">- Host&#x3D;<strong>.somehost.org,</strong>.anotherhost.org</td></tr><tr><td align="left">Method</td><td align="left">è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼</td><td align="left">- Method&#x3D;GET,POST</td></tr><tr><td align="left"><strong>Path</strong></td><td align="left">è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™</td><td align="left">- Path&#x3D;&#x2F;red&#x2F;{segment},&#x2F;blue&#x2F;**</td></tr><tr><td align="left">Query</td><td align="left">è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°</td><td align="left">- Query&#x3D;name, Jackæˆ–è€…- Query&#x3D;name</td></tr><tr><td align="left">RemoteAddr</td><td align="left">è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´</td><td align="left">- RemoteAddr&#x3D;192.168.1.1&#x2F;24</td></tr><tr><td align="left">weight</td><td align="left">æƒé‡å¤„ç†</td><td align="left">Weight&#x3D;group1,2</td></tr><tr><td align="left">XForwardedRemoteAddr</td><td align="left">åŸºäºè¯·æ±‚çš„æ¥æºIPåšåˆ¤æ–­</td><td align="left">-XForwardedRemoteAddr&#x3D;192.168.1.1&#x2F;24</td></tr></tbody></table></li></ul></li><li><p><a href="https://spring.io/projects/spring-cloud-gateway/">å®˜ç½‘ç¤ºä¾‹</a></p></li></ul><p>è·¯ç”±è¿‡æ»¤å™¨ï¼Œå’Œæ‹¦æˆªå™¨åŠŸèƒ½æœ‰äº›ç›¸ä¼¼ï¼Œæ‹¦æˆªè¯·æ±‚å’Œå“åº”ä¿¡æ¯ï¼Œå¯ä»¥åšä¿®æ”¹</p><p>ç½‘å…³ä¸­æä¾›äº†33ç§è·¯ç”±è¿‡æ»¤å™¨ï¼Œè¿™é‡Œåˆ—ä¸¾å‡ ç§å¸¸è§çš„è·¯ç”±</p><table><thead><tr><th>åç§°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>AddRequestHeader</td><td>ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´</td><td>AddrequestHeader&#x3D;headerName,headerValue</td></tr><tr><td>RemoveRequestHeader</td><td>ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´</td><td>RemoveRequestHeader&#x3D;headerName</td></tr><tr><td>AddResponseHeader</td><td>ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´</td><td>AddResponseHeader&#x3D;headerName,headerVaLue</td></tr><tr><td>RemoveResponseHeader</td><td>ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´</td><td>RemoveResponseHeader&#x3D;headerName</td></tr><tr><td>RewritePath</td><td>è¯·æ±‚è·¯å¾„é‡å†™</td><td>RewritePath&#x3D;&#x2F;red&#x2F;?(?<segment>.*),&#x2F;$\ {segment}</td></tr><tr><td>StripPrefix</td><td>å»é™¤è¯·æ±‚è·¯å¾„ä¸­çš„Næ®µå‰ç¼€</td><td>StripPrefix&#x3D;1ï¼Œåˆ™è·¯å¾„&#x2F;a&#x2F;bè½¬å‘æ—¶åªä¿ç•™&#x2F;b</td></tr></tbody></table><p>å±€éƒ¨é…ç½®è·¯ç”±è¿‡æ»¤å™¨</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> </span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=truth,never</span> <span class="string">give</span> <span class="string">up</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span></span><br></pre></td></tr></table></figure><p>å…¨å±€é…ç½®è·¯ç”±è¿‡æ»¤å™¨</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> </span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">AddRequestHeader=truth,never</span> <span class="string">give</span> <span class="string">up</span></span><br></pre></td></tr></table></figure><h3 id="ç½‘å…³ç™»å½•æ ¡éªŒ"><a href="#ç½‘å…³ç™»å½•æ ¡éªŒ" class="headerlink" title="ç½‘å…³ç™»å½•æ ¡éªŒ"></a>ç½‘å…³ç™»å½•æ ¡éªŒ</h3><p>å•ä½“æ¶æ„æ—¶æˆ‘ä»¬åªéœ€è¦å®Œæˆä¸€æ¬¡ç”¨æˆ·ç™»å½•ã€èº«ä»½æ ¡éªŒï¼Œå°±å¯ä»¥åœ¨æ‰€æœ‰ä¸šåŠ¡ä¸­è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚è€Œå¾®æœåŠ¡æ‹†åˆ†åï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸å†å…±äº«æ•°æ®ã€‚ä¹Ÿå°±æ„å‘³ç€æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦åšç™»å½•æ ¡éªŒï¼Œè¿™æ˜¾ç„¶ä¸å¯å–</p><p><em><strong>é‰´æƒæ€è·¯åˆ†æ</strong></em></p><p>æˆ‘ä»¬çš„ç™»å½•æ˜¯åŸºäºJWTæ¥å®ç°çš„ï¼Œæ ¡éªŒJWTçš„ç®—æ³•å¤æ‚ï¼Œè€Œä¸”éœ€è¦ç”¨åˆ°ç§˜é’¥ã€‚å¦‚æœæ¯ä¸ªå¾®æœåŠ¡éƒ½å»åšç™»å½•æ ¡éªŒï¼Œè¿™å°±å­˜åœ¨ç€ä¸¤å¤§é—®é¢˜</p><ul><li>æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦çŸ¥é“JWTçš„ç§˜é’¥ï¼Œä¸å®‰å…¨</li><li>æ¯ä¸ªå¾®æœåŠ¡é‡å¤ç¼–å†™ç™»å½•æ ¡éªŒä»£ç ã€æƒé™æ ¡éªŒä»£ç ï¼Œéº»çƒ¦</li></ul><p>æ—¢ç„¶ç½‘å…³æ˜¯æ‰€æœ‰å¾®æœåŠ¡çš„å…¥å£ï¼Œä¸€åˆ‡è¯·æ±‚éƒ½éœ€è¦å…ˆç»è¿‡ç½‘å…³ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠç™»å½•æ ¡éªŒçš„å·¥ä½œæ”¾åˆ°ç½‘å…³å»åšï¼Œè¿™æ ·ä¹‹å‰æ‰€æœ‰çš„é—®é¢˜å°±è§£å†³äº†</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/sxTuLYoZqbEOvHD.png" alt="image"></p><ul><li>åªéœ€è¦åœ¨ç½‘å…³å’Œç”¨æˆ·æœåŠ¡ä¿å­˜ç§˜é’¥</li><li>åªéœ€è¦åœ¨ç½‘å…³å¼€å‘ç™»å½•æ ¡éªŒåŠŸèƒ½</li></ul><p>ä¸è¿‡ï¼Œè¿™é‡Œå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ç½‘å…³è·¯ç”±æ˜¯é…ç½®çš„ï¼Œè¯·æ±‚è½¬å‘æ˜¯Gatewayå†…éƒ¨ä»£ç ï¼Œæˆ‘ä»¬å¦‚ä½•åœ¨è½¬å‘ä¹‹å‰åšç™»å½•æ ¡éªŒï¼Ÿ</li><li>ç½‘å…³æ ¡éªŒJWTä¹‹åï¼Œå¦‚ä½•å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™å¾®æœåŠ¡ï¼Ÿ<ul><li>å¯ä»¥é€šè¿‡è¯·æ±‚å¤´æ‹¦æˆªå™¨æ·»åŠ ç”¨æˆ·id</li></ul></li><li>å¾®æœåŠ¡ä¹‹é—´ä¹Ÿä¼šç›¸äº’è°ƒç”¨ï¼Œè¿™ç§è°ƒç”¨ä¸ç»è¿‡ç½‘å…³ï¼Œåˆè¯¥å¦‚ä½•ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ</li></ul><h4 id="å†…éƒ¨çš„å·¥ä½œåŸç†"><a href="#å†…éƒ¨çš„å·¥ä½œåŸç†" class="headerlink" title="å†…éƒ¨çš„å·¥ä½œåŸç†"></a>å†…éƒ¨çš„å·¥ä½œåŸç†</h4><p>ç™»å½•æ ¡éªŒå¿…é¡»åœ¨è¯·æ±‚è½¬å‘åˆ°å¾®æœåŠ¡ä¹‹å‰åšï¼Œå¦åˆ™å°±å¤±å»äº†æ„ä¹‰ã€‚è€Œç½‘å…³çš„è¯·æ±‚è½¬å‘æ˜¯<code>Gateway</code>å†…éƒ¨ä»£ç å®ç°çš„ï¼Œè¦æƒ³åœ¨è¯·æ±‚è½¬å‘ä¹‹å‰åšç™»å½•æ ¡éªŒï¼Œå°±å¿…é¡»äº†è§£<code>Gateway</code>å†…éƒ¨å·¥ä½œçš„åŸºæœ¬åŸç†</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/cYQuBKo1yHa4vRW.png" alt="image"></p><p>å¦‚å›¾æ‰€ç¤º</p><ol><li>å®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥ç½‘å…³åç”±<code>HandlerMapping</code>å¯¹è¯·æ±‚åšåˆ¤æ–­ï¼Œæ‰¾åˆ°ä¸å½“å‰è¯·æ±‚åŒ¹é…çš„è·¯ç”±è§„åˆ™ï¼ˆ**<code>Route</code>**ï¼‰ï¼Œç„¶åå°†è¯·æ±‚äº¤ç»™<code>WebHandler</code>å»å¤„ç†</li><li><code>WebHandler</code>åˆ™ä¼šåŠ è½½å½“å‰è·¯ç”±ä¸‹éœ€è¦æ‰§è¡Œçš„è¿‡æ»¤å™¨é“¾ï¼ˆ**<code>Filter chain</code><strong>ï¼‰ï¼Œç„¶åæŒ‰ç…§é¡ºåºé€ä¸€æ‰§è¡Œè¿‡æ»¤å™¨ï¼ˆåé¢ç§°ä¸º</strong><code>Filter</code>**ï¼‰</li><li>å›¾ä¸­<code>Filter</code>è¢«è™šçº¿åˆ†ä¸ºå·¦å³ä¸¤éƒ¨åˆ†ï¼Œæ˜¯å› ä¸º<code>Filter</code>å†…éƒ¨çš„é€»è¾‘åˆ†ä¸º<code>pre</code>å’Œ<code>post</code>ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ä¼šåœ¨è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡<strong>ä¹‹å‰</strong>å’Œ<strong>ä¹‹å</strong>è¢«æ‰§è¡Œ</li><li>åªæœ‰æ‰€æœ‰<code>Filter</code>çš„<code>pre</code>é€»è¾‘éƒ½ä¾æ¬¡é¡ºåºæ‰§è¡Œé€šè¿‡åï¼Œè¯·æ±‚æ‰ä¼šè¢«è½¬å‘åˆ°å¾®æœåŠ¡</li><li>å¾®æœåŠ¡è¿”å›ç»“æœåï¼Œå†å€’åºæ‰§è¡Œ<code>Filter</code>çš„<code>post</code>é€»è¾‘</li><li>æœ€ç»ˆæŠŠå“åº”ç»“æœè¿”å›</li></ol><p>æœ€ç»ˆè¯·æ±‚è½¬å‘æ˜¯æœ‰ä¸€ä¸ªåä¸º<code>NettyRoutingFilter</code>çš„è¿‡æ»¤å™¨æ¥æ‰§è¡Œçš„ï¼Œè€Œä¸”è¿™ä¸ªè¿‡æ»¤å™¨æ˜¯æ•´ä¸ªè¿‡æ»¤å™¨é“¾ä¸­é¡ºåºæœ€åçš„ä¸€ä¸ªï¼Œ<strong>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œåœ¨å…¶ä¸­å®ç°ç™»å½•æ ¡éªŒé€»è¾‘ï¼Œå¹¶ä¸”å°†è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºå®šä¹‰åˆ°</strong><code>NettyRoutingFilter</code>ä¹‹å‰ï¼Œè¿™å°±å¯ä»¥è§£å†³è½¬å‘ä¹‹å‰å¦‚ä½•åšç™»å½•æ ¡éªŒçš„é—®é¢˜äº†</p><h4 id="è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨" class="headerlink" title="è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨"></a>è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨</h4><p>ç½‘å…³è¿‡æ»¤å™¨é“¾ä¸­çš„è¿‡æ»¤å™¨æœ‰ä¸¤ç§</p><ul><li>**<code>GatewayFilter</code>**ï¼šè·¯ç”±è¿‡æ»¤å™¨ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥æ˜¯ä»»æ„æŒ‡å®šçš„è·¯ç”±<code>Route</code></li><li>**<code>GlobalFilter</code>**ï¼šå…¨å±€è¿‡æ»¤å™¨ï¼Œä½œç”¨èŒƒå›´æ˜¯æ‰€æœ‰è·¯ç”±</li><li>æ³¨æ„è¿‡æ»¤å™¨é“¾ä¹‹å¤–è¿˜æœ‰ä¸€ç§è¿‡æ»¤å™¨ï¼Œ<strong>HttpHeadersFilter</strong>ï¼Œç”¨æ¥å¤„ç†ä¼ é€’åˆ°ä¸‹æ¸¸å¾®æœåŠ¡çš„è¯·æ±‚å¤´<ul><li>ä¾‹å¦‚<code>org.springframework.cloud.gateway.filter.headers.XForwardedHeadersFilter</code>å¯ä»¥ä¼ é€’ä»£ç†è¯·æ±‚åŸæœ¬çš„hostå¤´åˆ°ä¸‹æ¸¸å¾®æœåŠ¡</li></ul></li></ul><p>å…¶å®<code>GatewayFilter</code>å’Œ<code>GlobalFilter</code>è¿™ä¸¤ç§è¿‡æ»¤å™¨çš„æ–¹æ³•ç­¾åå®Œå…¨ä¸€è‡´</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†è¯·æ±‚å¹¶å°†å…¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…å«æ•´ä¸ªè¿‡æ»¤å™¨é“¾å†…å…±äº«æ•°æ®,å¦‚requestã€responseç­‰å„ç§æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain è¿‡æ»¤å™¨é“¾ï¼ŒåŸºäºå®ƒå‘ä¸‹ä¼ é€’è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ ¹æ®è¿”å›å€¼æ ‡è®°å½“å‰è¯·æ±‚æ˜¯å¦è¢«å®Œæˆæˆ–æ‹¦æˆªï¼Œchain.filter(exchange)å°±æ”¾è¡Œäº†ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span>;</span><br></pre></td></tr></table></figure><p><code>FilteringWebHandler</code>åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œä¼šå°†<code>GlobalFilter</code>è£…é¥°ä¸º<code>GatewayFilter</code>ï¼Œç„¶åæ”¾åˆ°åŒä¸€ä¸ªè¿‡æ»¤å™¨é“¾ä¸­ï¼Œæ’åºä»¥åä¾æ¬¡æ‰§è¡Œ</p><p>è‡ªå®šä¹‰GlobalFilterï¼Œåœ¨<code>hm-gateway</code>ä¸­æ–°å»ºä¸€ä¸ª<code>filters</code>åŒ…ï¼Œå®ç°ä¸€ä¸ªå…¨å±€è¿‡æ»¤å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//TODO ç™»å½•æ ¡éªŒ</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> request.getHeaders();</span><br><span class="line">        System.out.println(<span class="string">&quot;headers =&quot;</span> + headers);</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç™»å½•æ ¡éªŒçš„è¿‡æ»¤å™¨åº”è¯¥æ”¾åœ¨è¯·æ±‚è½¬å‘åˆ°å¾®æœåŠ¡<code>NettyRoutingFilter</code>è¿‡æ»¤å™¨å‰ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><ul><li>æŸ¥çœ‹<code>GlobalFilter</code>çš„å®ç°å¯çŸ¥<code>NettyRoutingFilter</code>è¿‡æ»¤å™¨èƒ½å¤Ÿåœ¨æœ€åæ‰§è¡Œçš„åŸå› æ˜¯å®ç°äº†<code>Ordered</code>æ¥å£ï¼Œä¸”æ’åºå­—æ®µ<strong>ORDER</strong>ä¸ºintæœ€å¤§å€¼<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/23/t36LwvP5hzFRriT.png" alt="image"></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/23/beCm7MkDWS2KFPX.png" alt="img"></li><li><code>ORDER</code>å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ’åºè¶Šé å‰</li></ul></li><li>æ‰€ä»¥åªè¦å®ç°<code>Ordered</code>æ¥å£ï¼Œ<code>ORDER</code>å­—æ®µå€¼å°äº<code>Integer.MAX_VALUE</code>å³å¯</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>,Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//TODO ç™»å½•æ ¡éªŒ</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> request.getHeaders();</span><br><span class="line">        System.out.println(<span class="string">&quot;headers =&quot;</span> + headers);</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>MyGlobalFilter</code>å’Œ<code>NettyRoutingFilter</code>çš„filteræ–¹æ³•åˆ†åˆ«åšæ–­ç‚¹è°ƒè¯•</p><p>è‡ªå®šä¹‰<code>GatewayFilter</code>ä¸æ˜¯ç›´æ¥å®ç°<code>GatewayFilter</code>ï¼Œè€Œæ˜¯å®ç°<code>AbstractGatewayFilterFactory</code>ï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintAnyGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Object config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–è¯·æ±‚</span></span><br><span class="line">                <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">                <span class="comment">// ç¼–å†™è¿‡æ»¤å™¨é€»è¾‘</span></span><br><span class="line">                System.out.println(<span class="string">&quot;è¿‡æ»¤å™¨æ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">                <span class="comment">// æ”¾è¡Œ</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šè¯¥ç±»çš„åç§°ä¸€å®šè¦ä»¥<code>GatewayFilterFactory</code>ä¸ºåç¼€ï¼ï¼ˆæ–¹ä¾¿åç»­é…ç½®ï¼‰ç„¶ååœ¨yamlé…ç½®åæ‰ä¼šç”Ÿæ•ˆ</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrintAny</span> <span class="comment"># æ­¤å¤„ç›´æ¥ä»¥è‡ªå®šä¹‰çš„GatewayFilterFactoryç±»åç§°å‰ç¼€ç±»å£°æ˜è¿‡æ»¤å™¨</span></span><br></pre></td></tr></table></figure><ul><li>æ—¢å¯ä»¥é…ç½®å…¨å±€è·¯ç”±ï¼Œä¹Ÿå¯ä»¥é…ç½®å±€éƒ¨è·¯ç”±</li></ul><p>å¦å¤–ï¼Œè¿™ç§è¿‡æ»¤å™¨è¿˜å¯ä»¥æ”¯æŒåŠ¨æ€é…ç½®å‚æ•°ï¼Œç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintAnyGatewayFilterFactory</span> <span class="comment">// çˆ¶ç±»æ³›å‹æ˜¯å†…éƒ¨ç±»çš„Configç±»å‹</span></span><br><span class="line">                <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;PrintAnyGatewayFilterFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        <span class="comment">// OrderedGatewayFilteræ˜¯GatewayFilterçš„å­ç±»ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š</span></span><br><span class="line">        <span class="comment">// - GatewayFilterï¼šè¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="comment">// - int orderå€¼ï¼šå€¼è¶Šå°ï¼Œè¿‡æ»¤å™¨æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedGatewayFilter</span>(<span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–configå€¼</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> config.getA();</span><br><span class="line">                <span class="type">String</span> <span class="variable">b</span> <span class="operator">=</span> config.getB();</span><br><span class="line">                <span class="type">String</span> <span class="variable">c</span> <span class="operator">=</span> config.getC();</span><br><span class="line">                <span class="comment">// ç¼–å†™è¿‡æ»¤å™¨é€»è¾‘</span></span><br><span class="line">                System.out.println(<span class="string">&quot;a = &quot;</span> + a);</span><br><span class="line">                System.out.println(<span class="string">&quot;b = &quot;</span> + b);</span><br><span class="line">                System.out.println(<span class="string">&quot;c = &quot;</span> + c);</span><br><span class="line">                <span class="comment">// æ”¾è¡Œ</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰é…ç½®å±æ€§ï¼Œæˆå‘˜å˜é‡åç§°å¾ˆé‡è¦ï¼Œä¸‹é¢ä¼šç”¨åˆ°</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String a;</span><br><span class="line">        <span class="keyword">private</span> String b;</span><br><span class="line">        <span class="keyword">private</span> String c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†å˜é‡åç§°ä¾æ¬¡è¿”å›ï¼Œé¡ºåºå¾ˆé‡è¦ï¼Œå°†æ¥è¯»å–å‚æ•°æ—¶æŒ‰è¯¥é¡ºåºè·å–</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">shortcutFieldOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> List.of(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›å½“å‰é…ç½®ç±»çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨çš„Config</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;Config&gt; <span class="title function_">getConfigClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Config.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨yamlæ–‡ä»¶ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrintAny=1,2,3</span> <span class="comment"># æ³¨æ„ï¼Œè¿™é‡Œå¤šä¸ªå‚æ•°ä»¥&quot;,&quot;éš”å¼€ï¼Œå°†æ¥ä¼šæŒ‰ç…§shortcutFieldOrder()æ–¹æ³•è¿”å›çš„å‚æ•°é¡ºåºä¾æ¬¡å¤åˆ¶</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ç§é…ç½®æ–¹å¼å‚æ•°å¿…é¡»ä¸¥æ ¼æŒ‰ç…§<code>shortcutFieldOrder()</code>æ–¹æ³•çš„è¿”å›å‚æ•°åé¡ºåºæ¥èµ‹å€¼</p><p>è¿˜æœ‰ä¸€ç§ç”¨æ³•ï¼Œæ— éœ€æŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œå°±æ˜¯æ‰‹åŠ¨æŒ‡å®šå‚æ•°å</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PrintAny</span></span><br><span class="line">              <span class="attr">args:</span> <span class="comment"># æ‰‹åŠ¨æŒ‡å®šå‚æ•°åï¼Œæ— éœ€æŒ‰ç…§å‚æ•°é¡ºåº</span></span><br><span class="line">                <span class="attr">a:</span> <span class="number">1</span></span><br><span class="line">                <span class="attr">b:</span> <span class="number">2</span></span><br><span class="line">                <span class="attr">c:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><p>è¿™ç§è¿‡æ»¤å™¨çš„ä½¿ç”¨è¾ƒå°‘ï¼Œä¸€èˆ¬éƒ½æ˜¯å®šä¹‰å…¨å±€è¿‡æ»¤å™¨</p><h4 id="è‡ªå®šä¹‰GlobalFilterå®ç°ç™»å½•æ ¡éªŒ"><a href="#è‡ªå®šä¹‰GlobalFilterå®ç°ç™»å½•æ ¡éªŒ" class="headerlink" title="è‡ªå®šä¹‰GlobalFilterå®ç°ç™»å½•æ ¡éªŒ"></a>è‡ªå®šä¹‰<code>GlobalFilter</code>å®ç°ç™»å½•æ ¡éªŒ</h4><p>ç™»å½•æ ¡éªŒéœ€è¦JWTç›¸å…³é…ç½®</p><ul><li>ä»<code>hm-service</code>æœåŠ¡configåŒ…ä¸‹å¯¼å‡ºä¸ç™»å½•æ ¡éªŒæœ‰å…³çš„é…ç½®ï¼š<code>AuthProperties</code>ã€<code>JwtProperties</code>ã€<code>SecurityConfig</code></li><li>ä»<code>hm-service</code>æœåŠ¡utilsåŒ…ä¸‹å¯¼å‡º<code>JwtUtil</code>å·¥å…·ç±»</li><li>ä»<code>hm-service</code>æœåŠ¡ä¸­çš„reasourceæ–‡ä»¶ä¸­è·å–å¯†é’¥<code>hmall.jks</code></li><li>ä»<code>hm-service</code>æœåŠ¡çš„yamlæ–‡ä»¶ä¸­å¤åˆ¶å¯¹åº”çš„å±æ€§é…ç½®</li></ul><p>å®ç°ç™»å½•æ‹¦æˆªè¿‡æ»¤å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>,Ordered &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthProperties authProperties;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtTool jwtTool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦éœ€è¦æ‹¦æˆª</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">RequestPath</span> <span class="variable">requestPath</span> <span class="operator">=</span> request.getPath();</span><br><span class="line">        <span class="keyword">if</span> (isExcludePath(requestPath.toString())) &#123;</span><br><span class="line">            <span class="comment">//ä¸éœ€è¦æ‹¦æˆª</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–token</span></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> request.getHeaders();</span><br><span class="line">        List&lt;String&gt; requestHeader = headers.get(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//è§£æå¾—åˆ°token</span></span><br><span class="line">        Long userId;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userId = jwtTool.parseToken(requestHeader.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//æ‹¦æˆª,è®¾ç½®401çŠ¶æ€ç </span></span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¼ é€’ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        System.out.println(<span class="string">&quot;userId =&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExcludePath</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="comment">//ç”¨äºè·¯å¾„åˆ¤æ–­</span></span><br><span class="line">        List&lt;String&gt; excludePaths = authProperties.getExcludePaths();</span><br><span class="line">        <span class="keyword">for</span> (String excludePath : excludePaths) &#123;</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(excludePath,path)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>éœ€çŸ¥</p><ul><li>å“åº”çŠ¶æ€ç çš„è®¾ç½®APIçš„è°ƒç”¨</li><li>å¯¹äºè¯·æ±‚è·¯å¾„çš„åˆ¤æ–­APIè°ƒç”¨</li></ul><h4 id="ç½‘å…³ä¼ é€’ç”¨æˆ·åˆ°å¾®æœåŠ¡"><a href="#ç½‘å…³ä¼ é€’ç”¨æˆ·åˆ°å¾®æœåŠ¡" class="headerlink" title="ç½‘å…³ä¼ é€’ç”¨æˆ·åˆ°å¾®æœåŠ¡"></a>ç½‘å…³ä¼ é€’ç”¨æˆ·åˆ°å¾®æœåŠ¡</h4><p>é€šè¿‡è®¾ç½®è¯·æ±‚å¤´ï¼ŒæŠŠç”¨æˆ·idä¼ åˆ°å¾®æœåŠ¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¼ é€’ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="type">ServerWebExchange</span> <span class="variable">webExchange</span> <span class="operator">=</span> exchange.mutate() <span class="comment">//å¯¹ä¸‹æ¸¸è¯·æ±‚åšä¿®æ”¹</span></span><br><span class="line">        .request(builder -&gt; builder.header(<span class="string">&quot;user-info&quot;</span>, userId.toString()))</span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">//æ”¾è¡Œ</span></span><br><span class="line"><span class="keyword">return</span> chain.filter(webExchange);</span><br></pre></td></tr></table></figure><p>å¾®æœåŠ¡è·å–è¯¥ä¿¡æ¯ï¼Œå¯ä»¥åœ¨æ¯ä¸ªæ–¹æ³•ä¸­éƒ½è·å–<code>user-info</code>è¿™ä¸ªè¯·æ±‚å¤´ï¼Œä¸è¿‡å¤ªè¿‡éº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¾®æœåŠ¡ä¸ç½‘å…³è½¬å‘ä¹‹å‰ï¼Œå†åŠ ä¸€ä¸ªSpringMVCçš„æ‹¦æˆªå™¨ï¼Œå’Œä»¥å¾€ä¸€æ ·ï¼ŒæŠŠè¯¥ç”¨æˆ·idä¿å­˜åœ¨<code>ThreadLocal</code>ä¸­ï¼Œå¦‚å›¾æ‰€ç¤º</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/23/pFzPiCrJWKwI7as.png" alt="image"></p><p>ç”±äºæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è·å–ç™»å½•ç”¨æˆ·çš„éœ€æ±‚ï¼Œå› æ­¤æ‹¦æˆªå™¨æˆ‘ä»¬ç›´æ¥å†™åœ¨<code>hm-common</code>ä¸­ï¼Œå¹¶å†™å¥½è‡ªåŠ¨è£…é…ã€‚è¿™æ ·å¾®æœåŠ¡åªéœ€è¦å¼•å…¥<code>hm-common</code>å°±å¯ä»¥ç›´æ¥å…·å¤‡æ‹¦æˆªå™¨åŠŸèƒ½ï¼Œæ— éœ€é‡å¤ç¼–å†™</p><p>ç”¨æˆ·ä¿¡æ¯æ‹¦æˆª</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.è·å–è¯·æ±‚å¤´ä¸­çš„ token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;user-info&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.æ ¡éªŒtoken</span></span><br><span class="line">        <span class="keyword">if</span> (userId == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.å­˜å…¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">        UserContext.setUser(Long.valueOf(userId));</span><br><span class="line">        <span class="comment">// 4.æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æ¸…ç†ç”¨æˆ·</span></span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>configé…ç½®ï¼Œæ·»åŠ æ‹¦æˆªå™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span><span class="comment">//è¡¨ç¤ºä»…å¯¹åŒ…å«äº†springMvcçš„æ ¸å¿ƒç±»ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æ·»åŠ æ‹¦æˆªå™¨</span></span><br><span class="line">        <span class="type">UserInfoInterceptor</span> <span class="variable">userInfoInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfoInterceptor</span>();</span><br><span class="line">        registry.addInterceptor(userInfoInterceptor);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé…ç½®ç±»é»˜è®¤æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼Œå› ä¸ºå®ƒæ‰€åœ¨çš„åŒ…æ˜¯<code>com.hmall.common.config</code>ï¼Œä¸å…¶å®ƒå¾®æœåŠ¡çš„æ‰«æåŒ…ä¸ä¸€è‡´ï¼Œæ— æ³•è¢«æ‰«æåˆ°ï¼Œå› æ­¤æ— æ³•ç”Ÿæ•ˆ</p><p>éœ€è¦è§£å†³çš„2ä¸ªé—®é¢˜ï¼šSpringBootæ— æ³•æ‰«æåˆ°è¯¥é…ç½®ã€è¯¥æ‹¦æˆªå™¨ä»…ä»…åªåœ¨SpringMVCä¸­ç”Ÿæ•ˆï¼ˆhm-gatewaryä¹Ÿå¼•å…¥äº†hm-commonä¾èµ–ï¼‰</p><ol><li><p>åŸºäºSpringBootçš„è‡ªåŠ¨è£…é…åŸç†ï¼Œæˆ‘ä»¬è¦å°†å…¶æ·»åŠ åˆ°<code>resources</code>ç›®å½•ä¸‹çš„<code>META-INF/spring.factories</code>æ–‡ä»¶ä¸­</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MyBatisConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MvcConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.JsonConfig</span></span><br></pre></td></tr></table></figure></li><li><p><code>@ConditionalOnClass</code>æ³¨è§£æ˜¯Spring Bootä¸­çš„ä¸€ä¸ªæ¡ä»¶æ³¨è§£ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŒ‡å®šåœ¨ç±»è·¯å¾„ä¸­å­˜åœ¨ç‰¹å®šçš„ç±»æ—¶æ‰åŠ è½½æŸä¸ªé…ç½®ç±»æˆ–Bean</p><ul><li>åœ¨è¿™é‡Œhm-gatewayä¸æ˜¯åŸºäºspringMvcçš„ï¼Œæ‰€ä»¥è¯¥MvcConfigä¸åº”è¯¥ç”Ÿæ•ˆï¼Œå¦åˆ™è¯¥æ‹¦æˆªå™¨ä¼šæœ‰é”™è¯¯</li></ul></li></ol><p>ä¿®æ”¹å…¶ä»–å¾®æœåŠ¡ä¸­ç”¨1Læ›¿æ¢çš„<code>UserContext.getUser()</code>ï¼Œé€šè¿‡Swaggerè¿›è¡Œè°ƒè¯•</p><h4 id="å¾®æœåŠ¡è·å–ç”¨æˆ·"><a href="#å¾®æœåŠ¡è·å–ç”¨æˆ·" class="headerlink" title="å¾®æœåŠ¡è·å–ç”¨æˆ·"></a>å¾®æœåŠ¡è·å–ç”¨æˆ·</h4><p>å‰ç«¯å‘èµ·çš„è¯·æ±‚éƒ½ä¼šç»è¿‡ç½‘å…³å†åˆ°å¾®æœåŠ¡ï¼Œç”±äºæˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨åŠŸèƒ½ï¼Œå¾®æœåŠ¡å¯ä»¥è½»æ¾è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚ä½†æœ‰äº›ä¸šåŠ¡æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œè¯·æ±‚åˆ°è¾¾å¾®æœåŠ¡åè¿˜éœ€è¦è°ƒç”¨å…¶å®ƒå¤šä¸ªå¾®æœåŠ¡ã€‚æ¯”å¦‚ä¸‹å•ä¸šåŠ¡ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/23/NKjDf8HL5vG7l4E.jpg" alt="image"></p><ul><li>ä¸‹å•çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è°ƒç”¨å•†å“æœåŠ¡æ‰£å‡åº“å­˜ï¼Œè°ƒç”¨è´­ç‰©è½¦æœåŠ¡æ¸…ç†ç”¨æˆ·è´­ç‰©è½¦ã€‚è€Œæ¸…ç†è´­ç‰©è½¦æ—¶å¿…é¡»çŸ¥é“å½“å‰ç™»å½•çš„ç”¨æˆ·IDã€‚ä½†æ˜¯ï¼Œ<strong>è®¢å•æœåŠ¡è°ƒç”¨è´­ç‰©è½¦æ—¶å¹¶æ²¡æœ‰ä¼ é€’ç”¨æˆ·ä¿¡æ¯</strong>ï¼Œè€Œä¸”å¾®æœåŠ¡åˆ™æ˜¯é€šè¿‡OpenFeignå‘é€httpè¯·æ±‚åˆ°è´­ç‰©è½¦æœåŠ¡ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰<code>user-info</code>çš„è¯·æ±‚å¤´ä¿¡æ¯ï¼ï¼ï¼</li><li>æ‰€ä»¥ï¼Œåœ¨è´­ç‰©è½¦æœåŠ¡ä¸­çš„è´­ç‰©è½¦æ¸…ç†è¿‡ç¨‹ä¸­å› ä¸ºæ²¡æœ‰ç”¨æˆ·IDè€Œå¤±è´¥</li><li>ç”±äºå¾®æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯æ˜¯é€šè¿‡æ‹¦æˆªå™¨åœ¨è¯·æ±‚å¤´ä¸­è¯»å–ï¼Œå› æ­¤è¦æƒ³å®ç°å¾®æœåŠ¡ä¹‹é—´çš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’ï¼Œå°±<strong>å¿…é¡»åœ¨å¾®æœåŠ¡å‘èµ·è°ƒç”¨æ—¶æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚å¤´</strong></li></ul><p>å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨æ˜¯åŸºäºOpenFeignæ¥å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å‘é€çš„è¯·æ±‚ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®©æ¯ä¸€ä¸ªç”±OpenFeignå‘èµ·çš„è¯·æ±‚è‡ªåŠ¨æºå¸¦ç™»å½•ç”¨æˆ·ä¿¡æ¯å‘¢ï¼Ÿ</p><ul><li><p>è¿™é‡Œè¦å€ŸåŠ©Feignä¸­æä¾›çš„ä¸€ä¸ªæ‹¦æˆªå™¨æ¥å£ï¼š<code>feign.RequestInterceptor</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called for every request. </span></span><br><span class="line"><span class="comment">   * Add data using methods on the supplied &#123;<span class="doctag">@link</span> RequestTemplate&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>openfeignæ¯æ¬¡å‘èµ·è¿œç¨‹è°ƒç”¨å‰,éƒ½ä¼šè¢«<code>RequestInterceptor</code>æ‹¦æˆªï¼Œåº•å±‚éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨applyæ–¹æ³•ï¼ï¼ï¼</p></li><li><p>æˆ‘ä»¬åªéœ€è¦å®ç°è¿™ä¸ªæ¥å£ï¼Œç„¶åå®ç°applyæ–¹æ³•ï¼Œåˆ©ç”¨<code>RequestTemplate</code>ç±»æ¥æ·»åŠ è¯·æ±‚å¤´ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°è¯·æ±‚å¤´ä¸­ã€‚è¿™æ ·ä»¥æ¥ï¼Œæ¯æ¬¡OpenFeignå‘èµ·è¯·æ±‚çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¼ é€’ç”¨æˆ·ä¿¡æ¯</p></li><li><p>ç”±äº<code>FeignClient</code>å…¨éƒ¨éƒ½æ˜¯åœ¨<code>hm-api</code>æ¨¡å—ï¼Œå› æ­¤æˆ‘ä»¬åœ¨<code>hm-api</code>æ¨¡å—çš„<code>com.hmall.api.config.DefaultFeignConfig</code>ä¸­ç¼–å†™è¿™ä¸ªæ‹¦æˆªå™¨:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RequestInterceptor <span class="title function_">requestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">            <span class="comment">//å¼•å…¥hm-commonä¾èµ–</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">userInfo</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">            <span class="keyword">if</span> (userInfo != <span class="literal">null</span> )&#123;</span><br><span class="line">                requestTemplate.header(<span class="string">&quot;user-info&quot;</span>,userInfo.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¿™æ ·æ¯æ¬¡è¿œç¨‹è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šå…ˆæ‹¦æˆªï¼Œæ·»åŠ <code>user-info</code>è¯·æ±‚å¤´</p></li></ul><h4 id="ç« èŠ‚å°ç»“ï¼Œä¸€å›¾æ¦‚æ‹¬"><a href="#ç« èŠ‚å°ç»“ï¼Œä¸€å›¾æ¦‚æ‹¬" class="headerlink" title="ç« èŠ‚å°ç»“ï¼Œä¸€å›¾æ¦‚æ‹¬"></a>ç« èŠ‚å°ç»“ï¼Œä¸€å›¾æ¦‚æ‹¬</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/23/A4cgCz8jTZwmJua.png" alt="image"></p><p>å¾ˆå¤šåŠŸèƒ½çš„å®ç°ä¾èµ–äºæ‹¦æˆªå™¨çš„é…ç½®ã€‚</p><h2 id="é…ç½®ç®¡ç†"><a href="#é…ç½®ç®¡ç†" class="headerlink" title="é…ç½®ç®¡ç†"></a>é…ç½®ç®¡ç†</h2><p>çœ‹ä¸€çœ‹å¾®æœåŠ¡ä¸­å…³äºé…ç½®çš„é—®é¢˜ï¼š</p><ul><li>ç½‘å…³è·¯ç”±åœ¨é…ç½®æ–‡ä»¶ä¸­å†™æ­»äº†ï¼Œå¦‚æœå˜æ›´å¿…é¡»<strong>é‡å¯</strong>å¾®æœåŠ¡</li><li>æŸäº›ä¸šåŠ¡é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­å†™æ­»äº†ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½è¦<strong>é‡å¯</strong>æœåŠ¡</li><li>æ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰å¾ˆå¤šé‡å¤çš„é…ç½®ï¼ˆæ¥å£æ–‡æ¡£ã€æ•°æ®åº“ã€æ—¥å¿—ç­‰ï¼‰ï¼Œç»´æŠ¤æˆæœ¬é«˜</li></ul><p>æ¯ä¸€æ¬¡çš„é‡å¯éƒ½æ„å‘³ç€ï¼Œå½“æ—¶ç¨‹åºæ— æ³•è¿è¡Œï¼Œç€ä¸ä»…å¯¹ç”¨æˆ·ä½“éªŒä¸å¥½ä¹Ÿå¢åŠ äº†è¿ç»´çš„å·¥ä½œé‡ã€‚ä¸è¿‡ä¹Ÿæœ‰ç€è§£å†³çš„æ–¹æ³•ï¼Œè¿™äº›é—®é¢˜éƒ½å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„<strong>é…ç½®ç®¡ç†å™¨æœåŠ¡</strong>è§£å†³ã€‚è€ŒNacosä¸ä»…ä»…å…·å¤‡æ³¨å†Œä¸­å¿ƒåŠŸèƒ½ï¼Œä¹Ÿå…·å¤‡é…ç½®ç®¡ç†çš„åŠŸèƒ½ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/dXhbDrm8EngGR7U.jpg" alt="img"></p><ul><li>å¾®æœåŠ¡å…±äº«çš„é…ç½®å¯ä»¥ç»Ÿä¸€äº¤ç»™Nacosä¿å­˜å’Œç®¡ç†ï¼Œåœ¨Nacosæ§åˆ¶å°ä¿®æ”¹é…ç½®åï¼ŒNacosä¼šå°†é…ç½®å˜æ›´æ¨é€ç»™ç›¸å…³çš„å¾®æœåŠ¡ï¼Œå¹¶ä¸”æ— éœ€é‡å¯å³å¯ç”Ÿæ•ˆï¼Œå®ç°é…ç½®<strong>çƒ­æ›´æ–°</strong></li><li>ç½‘å…³çš„è·¯ç”±åŒæ ·æ˜¯é…ç½®ï¼Œå› æ­¤åŒæ ·å¯ä»¥åŸºäºè¿™ä¸ªåŠŸèƒ½å®ç°<strong>åŠ¨æ€è·¯ç”±</strong>åŠŸèƒ½ï¼Œæ— éœ€é‡å¯ç½‘å…³å³å¯ä¿®æ”¹è·¯ç”±é…ç½®</li></ul><h3 id="é…ç½®å…±äº«"><a href="#é…ç½®å…±äº«" class="headerlink" title="é…ç½®å…±äº«"></a>é…ç½®å…±äº«</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠå¾®æœåŠ¡å…±äº«çš„é…ç½®æŠ½å–åˆ°Nacosä¸­ç»Ÿä¸€ç®¡ç†ï¼Œè¿™æ ·å°±ä¸éœ€è¦æ¯ä¸ªå¾®æœåŠ¡éƒ½é‡å¤é…ç½®äº†ã€‚åˆ†ä¸ºä¸¤æ­¥ï¼š</p><ul><li>åœ¨Nacosä¸­æ·»åŠ å…±äº«é…ç½®</li><li>å¾®æœåŠ¡æ‹‰å–é…ç½®</li></ul><p>è¿™é‡Œå…ˆè¿›è¡Œå¯ä»¥å…±äº«çš„nacosé…ç½®ï¼Œåœ¨nacosé…ç½®ç®¡ç†ä¸‹çš„é…ç½®åˆ—è¡¨æ ä¸­æ–°å»ºé…ç½®</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/nzZAbUMslgJCFKN.png" alt="image"></p><ul><li>jdbcå…±äº«é…ç½®</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;&#123;hm.db.host:192.168.80.132&#125;:$&#123;hm.db.port:3306&#125;/$&#123;hm.db.database&#125;?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.db.username&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.db.pw&#125;</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><ul><li>æ³¨æ„è¿™é‡Œçš„jdbcçš„ç›¸å…³å‚æ•°å¹¶æ²¡æœ‰å†™æ­»ï¼Œä¾‹å¦‚ï¼š<ul><li><code>æ•°æ®åº“ip</code>ï¼šé€šè¿‡<code>$&#123;hm.db.host:192.168.80.132&#125;</code>é…ç½®äº†é»˜è®¤å€¼ä¸º<code>192.168.80.132</code>ï¼ŒåŒæ—¶å…è®¸é€šè¿‡<code>$&#123;hm.db.host&#125;</code>æ¥è¦†ç›–é»˜è®¤å€¼</li><li><code>æ•°æ®åº“ç«¯å£</code>ï¼šé€šè¿‡<code>$&#123;hm.db.port:3306&#125;</code>é…ç½®äº†é»˜è®¤å€¼ä¸º<code>3306</code>ï¼ŒåŒæ—¶å…è®¸é€šè¿‡<code>$&#123;hm.db.port&#125;</code>æ¥è¦†ç›–é»˜è®¤å€¼</li><li><code>æ•°æ®åº“database</code>ï¼šå¯ä»¥é€šè¿‡<code>$&#123;hm.db.database&#125;</code>æ¥è®¾å®šï¼Œæ— é»˜è®¤å€¼</li></ul></li><li>logå…±äº«é…ç½®</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmall:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span></span><br></pre></td></tr></table></figure><ul><li>swaggerå…±äº«é…ç½®</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">$&#123;hm.swagger.title:é»‘é©¬å•†åŸæ¥å£æ–‡æ¡£&#125;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">$&#123;hm.swagger.desc:&quot;é»‘é©¬å•†åŸæ¥å£æ–‡æ¡£&quot;&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">zhanghuyi@itcast.cn</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">è™å“¥</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">$&#123;hm.swagger.package&#125;</span></span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬åªéœ€è¦åœ¨<code>application.yaml</code>ä¸­å®Œå–„å„è‡ªé¡¹ç›®çš„é…ç½®ä¿¡æ¯å³å¯</li></ul><p>å°†æ‹‰å–åˆ°çš„å…±äº«é…ç½®ä¸æœ¬åœ°çš„<code>application.yaml</code>é…ç½®åˆå¹¶ï¼Œå®Œæˆé¡¹ç›®ä¸Šä¸‹æ–‡çš„åˆå§‹åŒ–ã€‚ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯»å–Nacosé…ç½®æ˜¯SpringCloudä¸Šä¸‹æ–‡ï¼ˆ<code>ApplicationContext</code>ï¼‰åˆå§‹åŒ–æ—¶å¤„ç†çš„ï¼Œå‘ç”Ÿåœ¨é¡¹ç›®çš„å¼•å¯¼é˜¶æ®µã€‚ç„¶åæ‰ä¼šåˆå§‹åŒ–Spring Bootä¸Šä¸‹æ–‡ï¼Œå»è¯»å–<code>application.yaml</code>ã€‚ä¹Ÿå°±æ˜¯è¯´å¼•å¯¼é˜¶æ®µï¼Œ<code>application.yaml</code>æ–‡ä»¶å°šæœªè¯»å–ï¼Œæ ¹æœ¬ä¸çŸ¥é“nacosåœ°å€ï¼Œè¯¥å¦‚ä½•å»åŠ è½½nacosä¸­çš„é…ç½®æ–‡ä»¶å‘¢ï¼Ÿ</p><ul><li><p>SpringCloudåœ¨åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„æ—¶å€™ä¼šå…ˆè¯»å–ä¸€ä¸ªåä¸º<code>bootstrap.yaml</code>(æˆ–è€…<code>bootstrap.properties</code>)çš„å¼•å¯¼æ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬å°†nacosåœ°å€é…ç½®åˆ°<code>bootstrap.yaml</code>ä¸­ï¼Œé‚£ä¹ˆåœ¨é¡¹ç›®å¼•å¯¼é˜¶æ®µå°±å¯ä»¥è¯»å–nacosä¸­çš„é…ç½®äº†</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/yiUHbdR39FwZ2Np.jpg" alt="image"></p></li></ul><p>å› æ­¤ï¼Œå¾®æœåŠ¡æ•´åˆNacosé…ç½®ç®¡ç†çš„æ­¥éª¤å¦‚ä¸‹</p><ol><li><p>å¼•å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacosé…ç½®ç®¡ç†--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--è¯»å–bootstrapæ–‡ä»¶--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>æ–°å»ºbootstrap.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cart-service</span> <span class="comment"># æœåŠ¡åç§°</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span><span class="string">:8848</span> <span class="comment"># nacosåœ°å€</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># æ–‡ä»¶åç¼€å</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># å…±äº«é…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-jdbc.yaml</span> <span class="comment"># å…±äº«mybatisé…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># å…±äº«æ—¥å¿—é…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-swagger.yaml</span> <span class="comment"># å…±äº«æ—¥å¿—é…ç½®</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹application.yam</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯OKHttpè¿æ¥æ± æ”¯æŒ</span></span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">swagger:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">è´­ç‰©è½¦æœåŠ¡æ¥å£æ–‡æ¡£</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">com.hmall.cart.controller</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">hm-cart</span></span><br></pre></td></tr></table></figure></li></ol><p>è°ƒè¯•ï¼ŒéªŒè¯è´­ç‰©è½¦æ¥å£çš„åŠŸèƒ½</p><h3 id="é…ç½®çƒ­æ›´æ–°"><a href="#é…ç½®çƒ­æ›´æ–°" class="headerlink" title="é…ç½®çƒ­æ›´æ–°"></a>é…ç½®çƒ­æ›´æ–°</h3><p>é…ç½®çƒ­æ›´æ–°ï¼šå½“ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®æ—¶ï¼Œå¾®æœåŠ¡æ— éœ€é‡å¯å³å¯ä½¿é…ç½®ç”Ÿæ•ˆ</p><p>å‰ææ¡ä»¶ï¼š</p><ul><li>nacosçš„é…ç½®æ–‡ä»¶<ul><li>**<code>spring.active.profile</code>**ï¼šå°±æ˜¯spring bootä¸­çš„<code>spring.active.profile</code>ï¼Œå¯ä»¥çœç•¥ï¼Œåˆ™æ‰€æœ‰profileå…±äº«è¯¥é…ç½®</li></ul></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/u3qIc2UtgBrf8DH.png" alt="image"></p><ul><li>å¾®æœåŠ¡ä¸­è¦ä»¥ç‰¹å®šæ–¹å¼è¯»å–éœ€è¦çƒ­æ›´æ–°çš„é…ç½®å±æ€§ï¼Œä¸¤ç§æ–¹å¼ï¼Œæ³¨è§£ä¸åŒ</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/jnQkBSRhzd3XfVv.png" alt="img"></p><p>é€šè¿‡ä¿®æ”¹<code>cat-service</code>ä¸­æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ä»£ç åŠŸèƒ½ï¼Œå¼•å…¥<code>CartProperties</code>beanï¼Œä¿®æ”¹<code>checkCartsFull()</code>æ–¹æ³•å¦‚ä¸‹ï¼Œè°ƒè¯•çƒ­æ›´æ–°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkCartsFull</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> lambdaQuery().eq(Cart::getUserId, userId).count();</span><br><span class="line">    <span class="keyword">if</span> (count &gt;= cartProperties.getMaxItems()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(StrUtil.format(<span class="string">&quot;ç”¨æˆ·è´­ç‰©è½¦è¯¾ç¨‹ä¸èƒ½è¶…è¿‡&#123;&#125;&quot;</span>, <span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èƒ½å¤Ÿå®ç°çƒ­æ›´æ–°ï¼Œä¾èµ–äºå½“nacosçš„é…ç½®æœåŠ¡ä¿®æ”¹æ—¶ï¼Œä¼šæ¨é€æœ€æ–°çš„é…ç½®ä¿¡æ¯åˆ°å¾®æœåŠ¡</p><h3 id="åŠ¨æ€è·¯ç”±"><a href="#åŠ¨æ€è·¯ç”±" class="headerlink" title="åŠ¨æ€è·¯ç”±"></a>åŠ¨æ€è·¯ç”±</h3><p>ç½‘å…³çš„è·¯ç”±é…ç½®å…¨éƒ¨æ˜¯åœ¨é¡¹ç›®å¯åŠ¨æ—¶ç”±<code>org.springframework.cloud.gateway.route.CompositeRouteDefinitionLocator</code>åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™åŠ è½½ï¼Œå¹¶ä¸”ä¸€ç»åŠ è½½å°±ä¼šç¼“å­˜åˆ°å†…å­˜ä¸­çš„<strong>è·¯ç”±è¡¨</strong>å†…ï¼ˆä¸€ä¸ªMapï¼‰ï¼Œä¸ä¼šæ”¹å˜ã€‚å½“æˆ‘ä»¬çš„è·¯ç”±éœ€è¦åšå‡ºä¿®æ”¹æ—¶ï¼Œå°±éœ€è¦é‡å¯ç½‘å…³å¾®æœåŠ¡ï¼Œè¿™æ ·çš„è¯å…¶ä»–å¾®æœåŠ¡å…¨éƒ¨å¤±æ•ˆäº†ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦åƒé…ç½®çƒ­æ›´æ–°ä¸€æ ·ï¼Œè®©è·¯ç”±ä¹Ÿå®ç°çƒ­æ›´æ–°</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¿…é¡»<strong>ç›‘å¬Nacosçš„é…ç½®å˜æ›´</strong>ï¼Œç„¶åæ‰‹åŠ¨æŠŠæœ€æ–°çš„è·¯ç”±æ›´æ–°åˆ°è·¯ç”±è¡¨ä¸­ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªéš¾ç‚¹ï¼š</p><ul><li>å¦‚ä½•ç›‘å¬Nacosé…ç½®å˜æ›´ï¼Ÿ</li><li>å¦‚ä½•æŠŠè·¯ç”±ä¿¡æ¯æ›´æ–°åˆ°è·¯ç”±è¡¨ï¼Ÿ</li></ul><p>åœ¨Nacoså®˜ç½‘ä¸­ç»™å‡ºäº†æ‰‹åŠ¨ç›‘å¬Nacosé…ç½®å˜æ›´çš„SDKï¼š<code>https://nacos.io/zh-cn/docs/sdk.html</code></p><p>å¦‚æœå¸Œæœ› Nacos æ¨é€é…ç½®å˜æ›´å®ç°ç›‘å¬æ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨ Nacos åŠ¨æ€ç›‘å¬é…ç½®æ¥å£æ¥å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(String dataId, String group, Listener listener)</span>;</span><br></pre></td></tr></table></figure><ul><li><p>è¯·æ±‚å‚æ•°è¯´æ˜</p><table><thead><tr><th align="left"><strong>å‚æ•°å</strong></th><th align="left"><strong>å‚æ•°ç±»å‹</strong></th><th align="left"><strong>æè¿°</strong></th></tr></thead><tbody><tr><td align="left">dataId</td><td align="left">string</td><td align="left">é…ç½® IDï¼Œä¿è¯å…¨å±€å”¯ä¸€æ€§ï¼Œåªå…è®¸è‹±æ–‡å­—ç¬¦å’Œ 4 ç§ç‰¹æ®Šå­—ç¬¦ï¼ˆâ€.â€ã€â€:â€ã€â€-â€œã€â€_â€ï¼‰ã€‚ä¸è¶…è¿‡ 256 å­—èŠ‚</td></tr><tr><td align="left">group</td><td align="left">string</td><td align="left">é…ç½®åˆ†ç»„ï¼Œä¸€èˆ¬æ˜¯é»˜è®¤çš„DEFAULT_GROUP</td></tr><tr><td align="left">listener</td><td align="left">Listener</td><td align="left">ç›‘å¬å™¨ï¼Œé…ç½®å˜æ›´è¿›å…¥ç›‘å¬å™¨çš„å›è°ƒå‡½æ•°</td></tr></tbody></table></li><li><p>ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">serverAddr</span> <span class="operator">=</span> <span class="string">&quot;&#123;serverAddr&#125;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">&quot;&#123;dataId&#125;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> <span class="string">&quot;&#123;group&#125;&quot;</span>;</span><br><span class="line"><span class="comment">// 1.åˆ›å»ºConfigServiceï¼Œè¿æ¥Nacos</span></span><br><span class="line"><span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">properties.put(<span class="string">&quot;serverAddr&quot;</span>, serverAddr);</span><br><span class="line"><span class="type">ConfigService</span> <span class="variable">configService</span> <span class="operator">=</span> NacosFactory.createConfigService(properties);</span><br><span class="line"><span class="comment">// 2.è¯»å–é…ç½®</span></span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> configService.getConfig(dataId, group, <span class="number">5000</span>);</span><br><span class="line"><span class="comment">// 3.æ·»åŠ é…ç½®ç›‘å¬å™¨</span></span><br><span class="line">configService.addListener(dataId, group, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">        <span class="comment">// é…ç½®å˜æ›´çš„é€šçŸ¥å¤„ç†</span></span><br><span class="line">                System.out.println(<span class="string">&quot;recieve1:&quot;</span> + configInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–çº¿ç¨‹æ± </span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ul><p>è¿™é‡Œæ ¸å¿ƒçš„æ­¥éª¤æœ‰2æ­¥ï¼š</p><ol><li>åˆ›å»ºConfigServiceï¼Œç›®çš„æ˜¯è¿æ¥åˆ°Nacos</li><li>æ·»åŠ é…ç½®ç›‘å¬å™¨ï¼Œç¼–å†™é…ç½®å˜æ›´çš„é€šçŸ¥å¤„ç†é€»è¾‘</li></ol><p>ç”±äºæˆ‘ä»¬é‡‡ç”¨äº†<code>spring-cloud-starter-alibaba-nacos-config</code>è‡ªåŠ¨è£…é…ï¼Œå› æ­¤<code>ConfigService</code>å·²ç»åœ¨<code>com.alibaba.cloud.nacos.NacosConfigAutoConfiguration</code>ä¸­è‡ªåŠ¨åˆ›å»ºå¥½äº†ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/758zUjnuNesRDcW.png" alt="image"></p><p>NacosConfigManagerä¸­æ˜¯è´Ÿè´£ç®¡ç†Nacosçš„ConfigServiceçš„ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/24/HTzaMxrhWItuZdD.png" alt="image"></p><p>å› æ­¤ï¼Œåªè¦æˆ‘ä»¬æ‹¿åˆ°<code>NacosConfigManager</code>å°±ç­‰äºæ‹¿åˆ°äº†<code>ConfigService</code>ï¼Œç¬¬ä¸€æ­¥å°±å®ç°äº†</p><p>ç¬¬äºŒæ­¥ï¼Œç¼–å†™ç›‘å¬å™¨ã€‚è™½ç„¶å®˜æ–¹æä¾›çš„SDKæ˜¯ConfigServiceä¸­çš„addListenerï¼Œä¸è¿‡é¡¹ç›®ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¸ä»…ä»…éœ€è¦æ·»åŠ ç›‘å¬å™¨ï¼Œä¹Ÿéœ€è¦è¯»å–é…ç½®ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨çš„APIæ˜¯è¿™ä¸ªï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String <span class="title function_">getConfigAndSignListener</span><span class="params">(</span></span><br><span class="line"><span class="params">    String dataId, // é…ç½®æ–‡ä»¶id</span></span><br><span class="line"><span class="params">    String group, // é…ç½®ç»„ï¼Œèµ°é»˜è®¤</span></span><br><span class="line"><span class="params">    <span class="type">long</span> timeoutMs, // è¯»å–é…ç½®çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="params">    Listener listener // ç›‘å¬å™¨</span></span><br><span class="line"><span class="params">)</span> <span class="keyword">throws</span> NacosException;</span><br></pre></td></tr></table></figure><p>æ—¢å¯ä»¥é…ç½®ç›‘å¬å™¨ï¼Œå¹¶ä¸”ä¼šæ ¹æ®dataIdå’Œgroupè¯»å–é…ç½®å¹¶è¿”å›ã€‚å°±å¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨æ—¶å…ˆæ›´æ–°ä¸€æ¬¡è·¯ç”±ï¼Œåç»­éšç€é…ç½®å˜æ›´é€šçŸ¥åˆ°ç›‘å¬å™¨ï¼Œå®Œæˆè·¯ç”±æ›´æ–°</p><p><strong>æ›´æ–°è·¯ç”±ï¼š</strong></p><p>æ›´æ–°è·¯ç”±è¦ç”¨åˆ°<code>org.springframework.cloud.gateway.route.RouteDefinitionWriter</code>è¿™ä¸ªæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.gateway.route;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RouteDefinitionWriter</span> &#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ›´æ–°è·¯ç”±åˆ°è·¯ç”±è¡¨ï¼Œå¦‚æœè·¯ç”±idé‡å¤ï¼Œåˆ™ä¼šè¦†ç›–æ—§çš„è·¯ç”±</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">Mono&lt;Void&gt; <span class="title function_">save</span><span class="params">(Mono&lt;RouteDefinition&gt; route)</span>;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ®è·¯ç”±idåˆ é™¤æŸä¸ªè·¯ç”±</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">Mono&lt;Void&gt; <span class="title function_">delete</span><span class="params">(Mono&lt;String&gt; routeId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ›´æ–°çš„è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯<code>RouteDefinition</code>ï¼ŒåŒ…å«ä¸‹åˆ—å¸¸è§å­—æ®µï¼š</p><ul><li>idï¼šè·¯ç”±id</li><li>predicatesï¼šè·¯ç”±åŒ¹é…è§„åˆ™</li><li>filtersï¼šè·¯ç”±è¿‡æ»¤å™¨</li><li>uriï¼šè·¯ç”±ç›®çš„åœ°</li></ul><p>æˆ‘ä»¬ä¿å­˜åˆ°Nacosçš„é…ç½®ä¹Ÿéœ€è¦ç¬¦åˆè¿™ä¸ªå¯¹è±¡ç»“æ„ï¼Œå¦‚æœæˆ‘ä»¬åƒä¹‹å‰yamlæ ¼å¼é…ç½®çš„è¯ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“å¦‚ä½•æŠŠyamlæ ¼å¼çš„æ•°æ®æ˜ å°„åˆ°RouteDefinitionï¼Œä½†åœ¨ä¹‹å‰çš„å¤–å–ã€redisé¡¹ç›®ä¸­æˆ‘ä»¬çŸ¥é“Jsonæ•°æ®å’Œå¯¹è±¡æ˜ å°„ï¼Œå› æ­¤å¯¹è·¯ç”±çš„é…ç½®æˆ‘ä»¬é‡‡ç”¨jsonæ ¼å¼ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;item&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/items/**&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_genkey_1&quot;</span><span class="punctuation">:</span><span class="string">&quot;/search/**&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://item-service&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé…ç½®ç­‰åŒäºï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span></span><br></pre></td></tr></table></figure><p><strong>åŠ¨æ€è·¯ç”±çš„å®ç°:</strong></p><ol><li><p>åœ¨ç½‘å…³å¾®æœåŠ¡ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--ç»Ÿä¸€é…ç½®ç®¡ç†--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--åŠ è½½bootstrap--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ç½‘å…³çš„<code>resources</code>ç›®å½•åˆ›å»º<code>bootstrap.yaml</code>æ–‡ä»¶ï¼Œç½‘å…³ä¸éœ€è¦jdbcå’Œswaggeré…ç½®</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># å…±äº«æ—¥å¿—é…ç½®</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹<code>gateway</code>çš„<code>resources</code>ç›®å½•ä¸‹çš„<code>application.yml</code>ï¼ŒæŠŠä¹‹å‰çš„è·¯ç”±ç§»é™¤:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span> <span class="comment"># ç«¯å£</span></span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">classpath:hmall.jks</span> <span class="comment"># ç§˜é’¥åœ°å€</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">hmall</span> <span class="comment"># ç§˜é’¥åˆ«å</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hmall123</span> <span class="comment"># ç§˜é’¥æ–‡ä»¶å¯†ç </span></span><br><span class="line">    <span class="attr">tokenTTL:</span> <span class="string">30m</span> <span class="comment"># ç™»å½•æœ‰æ•ˆæœŸ</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">excludePaths:</span> <span class="comment"># æ— éœ€ç™»å½•æ ¡éªŒçš„è·¯å¾„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/search/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/users/login</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/items/**</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨<code>gateway</code>ä¸­å®šä¹‰é…ç½®ç›‘å¬å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicRouteLoader</span> &#123; <span class="comment">//åŠ¨æ€è·¯ç”±åŠ è½½</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RouteDefinitionWriter writer; <span class="comment">//è·¯ç”±æ›´æ–°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosConfigManager nacosConfigManager; <span class="comment">//è·å–ConfigServiceï¼Œè·å–ã€ç›‘å¬é…ç½®</span></span><br><span class="line">    <span class="comment">// è·¯ç”±é…ç½®æ–‡ä»¶çš„idå’Œåˆ†ç»„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">&quot;gateway-routes.json&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> <span class="string">&quot;DEFAULT_GROUP&quot;</span>;</span><br><span class="line">    <span class="comment">// ä¿å­˜æ›´æ–°è¿‡çš„è·¯ç”±id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; routeIds = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span> <span class="comment">//å½“è¯¥ç±»åŠ è½½å®Œæˆåï¼Œæ‰§è¡Œè¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRouteConfigListener</span><span class="params">()</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        <span class="comment">// 1.æ³¨å†Œç›‘å¬å™¨å¹¶é¦–æ¬¡æ‹‰å–é…ç½®</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">configInfo</span> <span class="operator">=</span> nacosConfigManager.getConfigService()</span><br><span class="line">                .getConfigAndSignListener(dataId, group, <span class="number">5000</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">                        <span class="comment">//æ›´æ–°è·¯ç”±é…ç½®</span></span><br><span class="line">                        updateConfigInfo(configInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 2.é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ›´æ–°ä¸€æ¬¡é…ç½®</span></span><br><span class="line">        updateConfigInfo(configInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;ç›‘å¬åˆ°è·¯ç”±é…ç½®å˜æ›´ï¼Œ&#123;&#125;&quot;</span>, configInfo);</span><br><span class="line">        <span class="comment">// 1.ååºåˆ—åŒ–</span></span><br><span class="line">        List&lt;RouteDefinition&gt; routeDefinitions = JSONUtil.toList(configInfo,                         RouteDefinition.class);</span><br><span class="line">        <span class="comment">// 2.æ›´æ–°å‰å…ˆæ¸…ç©ºæ—§è·¯ç”±</span></span><br><span class="line">        <span class="comment">// 2.1.æ¸…é™¤æ—§è·¯ç”±</span></span><br><span class="line">        <span class="keyword">for</span> (String routeId : routeIds) &#123;</span><br><span class="line">            writer.delete(Mono.just(routeId)).subscribe();</span><br><span class="line">        &#125;</span><br><span class="line">        routeIds.clear();</span><br><span class="line">        <span class="comment">// 2.2.åˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„è·¯ç”±è¦æ›´æ–°</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtils.isEmpty(routeDefinitions)) &#123;</span><br><span class="line">            <span class="comment">// æ— æ–°è·¯ç”±é…ç½®ï¼Œç›´æ¥ç»“æŸ</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.æ›´æ–°è·¯ç”±</span></span><br><span class="line">        routeDefinitions.forEach(routeDefinition -&gt; &#123;</span><br><span class="line">            <span class="comment">// 3.1.æ›´æ–°è·¯ç”±</span></span><br><span class="line">            writer.save(Mono.just(routeDefinition)).subscribe();</span><br><span class="line">            <span class="comment">// 3.2.è®°å½•è·¯ç”±idï¼Œæ–¹ä¾¿å°†æ¥åˆ é™¤</span></span><br><span class="line">            routeIds.add(routeDefinition.getId());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>é‡å¯ç½‘å…³ï¼Œä»»æ„è®¿é—®ä¸€ä¸ªæ¥å£ï¼Œæ¯”å¦‚ <code>http://localhost:8080/search/list?pageNo=1&amp;pageSize=1</code>,è¯·æ±‚404</p><p>æˆ‘ä»¬åœ¨Nacosæ§åˆ¶å°æ·»åŠ è·¯ç”±ï¼Œè·¯ç”±æ–‡ä»¶åä¸º<code>gateway-routes.json</code>ï¼Œç±»å‹ä¸º<code>json</code>ï¼Œæ— éœ€é‡å¯ç½‘å…³ï¼Œå†æ¬¡è®¿é—®ï¼Œå¦‚æœè®¿é—®æˆåŠŸï¼Œé‚£ä¹ˆé…ç½®åŠ¨æ€è·¯ç”±æˆåŠŸ</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;item&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/items/**&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_genkey_1&quot;</span><span class="punctuation">:</span><span class="string">&quot;/search/**&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://item-service&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cart&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/carts/**&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://cart-service&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/users/**&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_genkey_1&quot;</span><span class="punctuation">:</span><span class="string">&quot;/addresses/**&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://user-service&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trade&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/orders/**&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://trade-service&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pay&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/pay-orders/**&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://pay-service&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h2 id="æœåŠ¡ä¿æŠ¤"><a href="#æœåŠ¡ä¿æŠ¤" class="headerlink" title="æœåŠ¡ä¿æŠ¤"></a>æœåŠ¡ä¿æŠ¤</h2><h3 id="é›ªå´©é—®é¢˜"><a href="#é›ªå´©é—®é¢˜" class="headerlink" title="é›ªå´©é—®é¢˜"></a>é›ªå´©é—®é¢˜</h3><p>åœ¨å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜å­˜åœ¨å‡ ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œä¸€ä¸ªæ˜¯<strong>ä¸šåŠ¡å¥å£®æ€§</strong>é—®é¢˜ï¼Œå¦ä¸€ä¸ªæ˜¯æœåŠ¡é›ªå´©é—®é¢˜ </p><p>ä¸šåŠ¡å¥å£®æ€§é—®é¢˜ï¼š</p><ul><li>ä¾‹å¦‚åœ¨ä¹‹å‰çš„æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨ä¸šåŠ¡ä¸­ï¼Œè´­ç‰©è½¦æœåŠ¡éœ€è¦æŸ¥è¯¢æœ€æ–°çš„å•†å“ä¿¡æ¯ï¼Œä¸è´­ç‰©è½¦æ•°æ®åšå¯¹æ¯”ï¼Œæé†’ç”¨æˆ·ã€‚å¤§å®¶è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœå•†å“æœåŠ¡æŸ¥è¯¢æ—¶å‘ç”Ÿæ•…éšœï¼ŒæŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨åœ¨è°ƒç”¨å•†å“æœåŠ¡æ—¶ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿä¼šå¼‚å¸¸ï¼Ÿä»è€Œå¯¼è‡´è´­ç‰©è½¦æŸ¥è¯¢å¤±è´¥ã€‚</li><li>ä½†ä»ä¸šåŠ¡è§’åº¦æ¥è¯´ï¼Œä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒï¼Œå³ä¾¿æ˜¯å•†å“æŸ¥è¯¢å¤±è´¥ï¼Œè´­ç‰©è½¦åˆ—è¡¨ä¹Ÿåº”è¯¥æ­£ç¡®å±•ç¤ºå‡ºæ¥ï¼Œå“ªæ€•æ˜¯ä¸åŒ…å«æœ€æ–°çš„å•†å“ä¿¡æ¯</li></ul><p>é›ªå´©é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼š </p><ul><li>å¾®æœåŠ¡ç›¸äº’è°ƒç”¨ï¼ŒæœåŠ¡æä¾›è€…å‡ºç°æ•…éšœæˆ–é˜»å¡</li><li>æœåŠ¡è°ƒç”¨è€…æ²¡æœ‰åšå¥½å¼‚å¸¸å¤„ç†ï¼Œå¯¼è‡´è‡ªèº«æ•…éšœ</li><li>è°ƒç”¨é“¾ä¸­çš„æ‰€æœ‰æœåŠ¡çº§è”å¤±è´¥ï¼Œå¯¼è‡´æ•´ä¸ªé›†ç¾¤æ•…éšœ<ul><li>æœåŠ¡ä¸æœåŠ¡ä¹‹é—´å…³è”æ€§éƒ¨åˆ†é”™è¯¯ï¼Œä¸”æ²¡æœ‰åº”å¯¹æªæ–½ï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡é›†ç¾¤ç˜«ç—ªï¼ˆå¾ˆå¤šæœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨éå¸¸å¤šï¼‰</li></ul></li></ul><p>è§£å†³é—®é¢˜çš„æ€è·¯ï¼š</p><ul><li>å°½é‡é¿å…æœåŠ¡å‡ºç°æ•…éšœæˆ–é˜»å¡ï¼ˆæœåŠ¡æä¾›è€…ï¼‰<ul><li>ä¿è¯ä»£ç çš„å¥å£®æ€§</li><li>ä¿è¯ç½‘ç»œçš„ç•…é€š</li><li>èƒ½åº”å¯¹è¾ƒé«˜çš„å¹¶å‘è¯·æ±‚</li></ul></li><li>æœåŠ¡è°ƒç”¨è€…åšå¥½è¿œç¨‹è°ƒç”¨å¼‚å¸¸çš„åå¤‡æ–¹æ¡ˆï¼Œé¿å…æ•…éšœæ‰©æ•£</li></ul><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>ä¿è¯æœåŠ¡è¿è¡Œçš„å¥å£®æ€§ï¼Œé¿å…çº§è”å¤±è´¥å¯¼è‡´çš„é›ªå´©é—®é¢˜ï¼Œå°±å±äºå¾®æœåŠ¡ä¿æŠ¤</p><p>æœåŠ¡ä¿æŠ¤æ–¹æ¡ˆ</p><ul><li><strong>è¯·æ±‚é™æµ</strong>ï¼šé™åˆ¶è®¿é—®å¾®æœåŠ¡çš„è¯·æ±‚çš„å¹¶å‘é‡ï¼Œé¿å…æœåŠ¡å› æµé‡æ¿€å¢å‡ºç°æ•…éšœ<ul><li>è¯·æ±‚é™æµå¾€å¾€ä¼šæœ‰ä¸€ä¸ªé™æµå™¨ï¼Œæ•°é‡é«˜ä½èµ·ä¼çš„å¹¶å‘è¯·æ±‚æ›²çº¿ï¼Œç»è¿‡é™æµå™¨å°±å˜çš„éå¸¸å¹³ç¨³ã€‚è¿™å°±åƒæ˜¯æ°´ç”µç«™çš„å¤§åï¼Œèµ·åˆ°è“„æ°´çš„ä½œç”¨ï¼Œå¯ä»¥é€šè¿‡å¼€å…³æ§åˆ¶æ°´æµå‡ºçš„å¤§å°ï¼Œè®©ä¸‹æ¸¸æ°´æµå§‹ç»ˆç»´æŒåœ¨ä¸€ä¸ªå¹³ç¨³çš„é‡</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/UVZdzL2aBeP63NG.jpg" alt="é™æµå›¾"></li><li>QPSï¼ˆQueries Per Secondï¼‰è¡¡é‡çš„æ˜¯æœåŠ¡å™¨æ¯ç§’èƒ½å¤Ÿå“åº”çš„æŸ¥è¯¢æ¬¡æ•°ï¼Œâ€Œä¹Ÿå°±æ˜¯æœ€å¤§ååèƒ½åŠ›ã€‚â€Œè¿™ä¸ªæŒ‡æ ‡å¯¹äºè¯„ä¼°ç³»ç»Ÿçš„æ€§èƒ½å’Œå®¹é‡è§„åˆ’éå¸¸é‡è¦ï¼Œâ€Œå› ä¸ºå®ƒç›´æ¥å…³ç³»åˆ°ç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒçš„ç”¨æˆ·æ•°é‡å’Œä¸šåŠ¡è§„æ¨¡</li></ul></li><li><strong>çº¿ç¨‹éš”ç¦»</strong>ï¼šä¹Ÿå«åšèˆ±å£æ¨¡å¼ï¼Œæ¨¡æ‹Ÿèˆ¹èˆ±éš”æ¿çš„é˜²æ°´åŸç†ã€‚é€šè¿‡é™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡è€Œå°†æ•…éšœä¸šåŠ¡éš”ç¦»ï¼Œé¿å…æ•…éšœæ‰©æ•£<ul><li>è½®èˆ¹çš„èˆ¹èˆ±ä¼šè¢«éš”æ¿åˆ†å‰²ä¸ºNä¸ªç›¸äº’éš”ç¦»çš„å¯†é—­èˆ±ï¼Œå‡å¦‚è½®èˆ¹è§¦ç¤è¿›æ°´ï¼Œåªæœ‰æŸåçš„éƒ¨åˆ†å¯†é—­èˆ±ä¼šè¿›æ°´ï¼Œè€Œå…¶ä»–èˆ±ç”±äºç›¸äº’éš”ç¦»ï¼Œå¹¶ä¸ä¼šè¿›æ°´ã€‚è¿™æ ·å°±æŠŠè¿›æ°´æ§åˆ¶åœ¨éƒ¨åˆ†èˆ¹ä½“ï¼Œé¿å…äº†æ•´ä¸ªèˆ¹èˆ±è¿›æ°´è€Œæ²‰æ²¡</li><li>ä¸ºäº†é¿å…æŸä¸ªæ¥å£æ•…éšœæˆ–å‹åŠ›è¿‡å¤§å¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šæ¯ä¸ªæ¥å£å¯ä»¥ä½¿ç”¨çš„èµ„æºèŒƒå›´ï¼Œä¹Ÿå°±æ˜¯å°†å…¶â€œéš”ç¦»â€èµ·æ¥</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/yCu5imlG9fPzUD1.png" alt="çº¿ç¨‹éš”ç¦»"></li><li>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ç»™æŸ¥è¯¢è´­ç‰©è½¦ä¸šåŠ¡é™å®šå¯ç”¨çº¿ç¨‹æ•°é‡ä¸Šé™ä¸º20ï¼Œè¿™æ ·å³ä¾¿æŸ¥è¯¢è´­ç‰©è½¦çš„è¯·æ±‚å› ä¸ºæŸ¥è¯¢å•†å“æœåŠ¡è€Œå‡ºç°æ•…éšœï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æœåŠ¡å™¨çš„çº¿ç¨‹èµ„æºè¢«è€—å°½ï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒæ¥å£</li></ul></li><li><strong>æœåŠ¡ç†”æ–­</strong>ï¼šç”±æ–­è·¯å™¨ç»Ÿè®¡è¯·æ±‚çš„å¼‚å¸¸æ¯”ä¾‹æˆ–æ…¢è°ƒç”¨æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼šç†”æ–­è¯¥ä¸šåŠ¡ï¼Œåˆ™æ‹¦æˆªè¯¥æ¥å£çš„è¯·æ±‚ã€‚ç†”æ–­æœŸé—´ï¼Œæ‰€æœ‰è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œå…¨éƒ½èµ°fallbacké€»è¾‘ï¼ˆä¹Ÿå°±æ˜¯é™çº§é€»è¾‘ï¼‰<ul><li>çº¿ç¨‹éš”ç¦»è™½ç„¶é¿å…äº†é›ªå´©é—®é¢˜ï¼Œä½†æ•…éšœæœåŠ¡ï¼ˆå•†å“æœåŠ¡ï¼‰ä¾ç„¶ä¼šæ‹–æ…¢è´­ç‰©è½¦æœåŠ¡ï¼ˆæœåŠ¡è°ƒç”¨æ–¹ï¼‰çš„æ¥å£å“åº”é€Ÿåº¦ã€‚è€Œä¸”å•†å“æŸ¥è¯¢çš„æ•…éšœä¾ç„¶ä¼šå¯¼è‡´æŸ¥è¯¢è´­ç‰©è½¦åŠŸèƒ½å‡ºç°æ•…éšœï¼Œä»è€Œè´­ç‰©è½¦ä¸šåŠ¡ä¹Ÿå˜çš„ä¸å¯ç”¨</li><li>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦åšä¸¤ä»¶äº‹æƒ…<ul><li><strong>ç¼–å†™æœåŠ¡é™çº§é€»è¾‘</strong>ï¼šå°±æ˜¯æœåŠ¡è°ƒç”¨å¤±è´¥åçš„å¤„ç†é€»è¾‘ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥è¿”å›å‹å¥½æç¤ºæˆ–é»˜è®¤æ•°æ®</li><li><strong>å¼‚å¸¸ç»Ÿè®¡å’Œç†”æ–­</strong>ï¼šç»Ÿè®¡æœåŠ¡æä¾›æ–¹çš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå½“æ¯”ä¾‹è¿‡é«˜è¡¨æ˜è¯¥æ¥å£ä¼šå½±å“åˆ°å…¶å®ƒæœåŠ¡ï¼Œåº”è¯¥æ‹’ç»è°ƒç”¨è¯¥æ¥å£ï¼Œè€Œæ˜¯ç›´æ¥èµ°é™çº§é€»è¾‘</li></ul></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/162UJkNGRPp3nrO.png" alt="æœåŠ¡ç†”æ–­"></li></ul></li></ul><h3 id="æœåŠ¡ä¿æŠ¤æŠ€æœ¯"><a href="#æœåŠ¡ä¿æŠ¤æŠ€æœ¯" class="headerlink" title="æœåŠ¡ä¿æŠ¤æŠ€æœ¯"></a>æœåŠ¡ä¿æŠ¤æŠ€æœ¯</h3><p>å¾®æœåŠ¡ä¿æŠ¤çš„æŠ€æœ¯æœ‰å¾ˆå¤šï¼Œç›®å‰å›½å†…ä½¿ç”¨è¾ƒå¤šçš„è¿˜æ˜¯Sentinelä»¥åŠHystrixï¼Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ Sentinelçš„ä½¿ç”¨</p><p>Sentinelæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾å¾®æœåŠ¡æµé‡æ§åˆ¶ç»„ä»¶ï¼Œç›®å‰å·²ç»åŠ å…¥åˆ°SpringCloudAlibabaä¸­</p><ul><li>å®˜æ–¹ç½‘ç«™ï¼š<code>https://sentinelguard.io/zh-cn</code></li></ul><p>Sentinel çš„ä½¿ç”¨å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p><ul><li><strong>æ ¸å¿ƒåº“</strong>ï¼ˆJaråŒ…ï¼‰ï¼šä¸ä¾èµ–ä»»ä½•æ¡†æ¶&#x2F;åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäº Java 8 åŠä»¥ä¸Šçš„ç‰ˆæœ¬çš„è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹ Dubbo &#x2F; Spring Cloud ç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚åœ¨é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–å³å¯å®ç°æœåŠ¡é™æµã€éš”ç¦»ã€ç†”æ–­ç­‰åŠŸèƒ½</li><li><strong>æ§åˆ¶å°</strong>ï¼ˆDashboardï¼‰ï¼šDashboard ä¸»è¦è´Ÿè´£ç®¡ç†æ¨é€è§„åˆ™ã€ç›‘æ§ã€ç®¡ç†æœºå™¨ä¿¡æ¯ç­‰</li></ul><p><strong>æ­å»ºSentinelçš„æ§åˆ¶å°</strong></p><ul><li>ä¸‹è½½jaråŒ…ï¼š<code>https://github.com/alibaba/Sentinel/releases</code>ï¼Œé»‘é©¬èµ„æ–™ä¸­æœ‰1.8.6ç‰ˆæœ¬</li><li>è¿è¡Œï¼Œå°†jaråŒ…æ”¾åœ¨ä»»æ„éä¸­æ–‡ã€ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„ç›®å½•ä¸‹<ul><li><code>java -Dserver.port=8090 -Dcsp.sentinel.dashboard.server=localhost:8090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.6.jar</code></li><li>å…¶å®ƒå¯åŠ¨æ—¶å¯é…ç½®å‚æ•°å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<code>https://github.com/alibaba/Sentinel/wiki/%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E9%A1%B9</code></li></ul></li><li>è®¿é—®<code>http://localhost:8090</code>é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°sentinelçš„æ§åˆ¶å°ï¼Œè´¦å·å’Œå¯†ç å‡ä¸ºsentinel<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/REmGzvrtV1PDXAp.png" alt="img"></li></ul></li></ul><p><strong>å¾®æœåŠ¡æ•´åˆsentinel</strong></p><ul><li><p>åœ¨<code>cart-service</code>æ¨¡å—ä¸­æ•´åˆsentinelï¼Œè¿æ¥<code>sentinel-dashboard</code>æ§åˆ¶å°</p></li><li><p>å¼•å…¥sentinelä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®æ§åˆ¶å°ï¼Œä¿®æ”¹application.yamlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8090</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯<code>cart-service</code>ï¼Œç„¶åè®¿é—®æŸ¥è¯¢è´­ç‰©è½¦æ¥å£ï¼Œsentinelçš„å®¢æˆ·ç«¯å°±ä¼šå°†æœåŠ¡è®¿é—®çš„ä¿¡æ¯æäº¤åˆ°<code>sentinel-dashboard</code>æ§åˆ¶å°</p></li></ul><p><strong>ç°‡ç‚¹é“¾è·¯</strong></p><p>æ‰€è°“ç°‡ç‚¹é“¾è·¯ï¼Œå°±æ˜¯å•æœºè°ƒç”¨é“¾è·¯ï¼Œæ˜¯ä¸€æ¬¡è¯·æ±‚è¿›å…¥æœåŠ¡åç»è¿‡çš„æ¯ä¸€ä¸ªè¢«<code>Sentinel</code>ç›‘æ§çš„èµ„æºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Sentinel</code>ä¼šç›‘æ§<code>SpringMVC</code>çš„æ¯ä¸€ä¸ª<code>Endpoint</code>ï¼ˆæ¥å£ï¼‰</p><p>å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>/carts</code>è¿™ä¸ªæ¥å£è·¯å¾„å°±æ˜¯å…¶ä¸­ä¸€ä¸ªç°‡ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥<strong>å¯¹å…¶è¿›è¡Œé™æµã€ç†”æ–­ã€éš”ç¦»</strong>ç­‰ä¿æŠ¤æªæ–½</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/Sx9BP8Zq5gkYElf.png" alt="img"></p><p>ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSpringMVCæ¥å£æ˜¯æŒ‰ç…§Restfulé£æ ¼è®¾è®¡ï¼Œå› æ­¤è´­ç‰©è½¦çš„æŸ¥è¯¢ã€åˆ é™¤ã€ä¿®æ”¹ç­‰æ¥å£å…¨éƒ¨éƒ½æ˜¯<code>/carts</code>è·¯å¾„ï¼Œé»˜è®¤æƒ…å†µä¸‹Sentinelä¼šæŠŠè¯·æ±‚è·¯å¾„ä½œä¸ºç°‡ç‚¹èµ„æºçš„åç§°ï¼Œæ— æ³•åŒºåˆ†è·¯å¾„ç›¸åŒä½†è¯·æ±‚æ–¹å¼ä¸åŒçš„æ¥å£ï¼ŒæŸ¥è¯¢ã€åˆ é™¤ã€ä¿®æ”¹ç­‰éƒ½è¢«è¯†åˆ«ä¸ºä¸€ä¸ªç°‡ç‚¹èµ„æºï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€‰æ‹©æ‰“å¼€Sentinelçš„è¯·æ±‚æ–¹å¼å‰ç¼€ï¼ŒæŠŠ<code>è¯·æ±‚æ–¹å¼ + è¯·æ±‚è·¯å¾„</code>ä½œä¸ºç°‡ç‚¹èµ„æºå</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8090</span></span><br><span class="line">      <span class="attr">http-method-specify:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯è¯·æ±‚æ–¹å¼å‰ç¼€</span></span><br></pre></td></tr></table></figure><p>é‡å¯æœåŠ¡ï¼Œé€šè¿‡é¡µé¢è®¿é—®è´­ç‰©è½¦çš„ç›¸å…³æ¥å£</p><p>åœ¨ç°‡ç‚¹é“¾è·¯åé¢ç‚¹å‡»æµæ§æŒ‰é’®ï¼Œå³å¯å¯¹å…¶åšé™æµé…ç½®</p><p>åœ¨å¼¹å‡ºçš„èœå•ä¸­è¿™æ ·å¡«å†™ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/XZu3s2px4TfVgYD.png" alt="img"></p><p>è¿™æ ·å°±æŠŠæŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨è¿™ä¸ªç°‡ç‚¹èµ„æºçš„æµé‡é™åˆ¶åœ¨äº†æ¯ç§’6ä¸ªï¼Œä¹Ÿå°±æ˜¯æœ€å¤§QPSä¸º6.</p><p>åˆ©ç”¨Jemeteråšé™æµæµ‹è¯•ï¼Œæˆ‘ä»¬æ¯ç§’å‘å‡º10ä¸ªè¯·æ±‚ï¼Œæœ€ç»ˆç›‘æ§ç»“æœå¦‚ä¸‹ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/KGkH6vCyhnoIrAW.png" alt="img"></p><p>å¯ä»¥çœ‹å‡º<code>GET:/carts</code>è¿™ä¸ªæ¥å£çš„é€šè¿‡QPSç¨³å®šåœ¨6é™„è¿‘ï¼Œè€Œæ‹’ç»çš„QPSåœ¨4é™„è¿‘ï¼Œç¬¦åˆé¢„æœŸ</p><h3 id="çº¿ç¨‹éš”ç¦»"><a href="#çº¿ç¨‹éš”ç¦»" class="headerlink" title="çº¿ç¨‹éš”ç¦»"></a>çº¿ç¨‹éš”ç¦»</h3><p>é™æµå¯ä»¥é™ä½æœåŠ¡å™¨å‹åŠ›ï¼Œå°½é‡å‡å°‘å› å¹¶å‘æµé‡å¼•èµ·çš„æœåŠ¡æ•…éšœçš„æ¦‚ç‡ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨é¿å…æœåŠ¡æ•…éšœã€‚ä¸€æ—¦æŸä¸ªæœåŠ¡å‡ºç°æ•…éšœï¼Œæˆ‘ä»¬å¿…é¡»éš”ç¦»å¯¹è¿™ä¸ªæœåŠ¡çš„è°ƒç”¨ï¼Œé¿å…å‘ç”Ÿé›ªå´©</p><p>æ¯”å¦‚ï¼ŒæŸ¥è¯¢è´­ç‰©è½¦çš„æ—¶å€™éœ€è¦æŸ¥è¯¢å•†å“ï¼Œä¸ºäº†é¿å…å› å•†å“æœåŠ¡å‡ºç°æ•…éšœå¯¼è‡´è´­ç‰©è½¦æœåŠ¡çº§è”å¤±è´¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè´­ç‰©è½¦ä¸šåŠ¡ä¸­æŸ¥è¯¢å•†å“çš„éƒ¨åˆ†éš”ç¦»èµ·æ¥ï¼Œé™åˆ¶å¯ç”¨çš„çº¿ç¨‹èµ„æº</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/BTaphNYZQbngc23.png" alt="image"></p><p>è¿™æ ·ï¼Œå³ä¾¿å•†å“æœåŠ¡å‡ºç°æ•…éšœï¼Œæœ€å¤šå¯¼è‡´æŸ¥è¯¢è´­ç‰©è½¦ä¸šåŠ¡æ•…éšœï¼Œå¹¶ä¸”<strong>å¯ç”¨çš„çº¿ç¨‹èµ„æºä¹Ÿè¢«é™å®šåœ¨ä¸€å®šèŒƒå›´</strong>ï¼Œä¸ä¼šå¯¼è‡´æ•´ä¸ªè´­ç‰©è½¦æœåŠ¡ï¼Œå¦‚ä¿®æ”¹ã€åˆ é™¤ç­‰æœåŠ¡å´©æºƒ</p><p>å¯¹æŸ¥è¯¢å•†å“çš„FeignClientæ¥å£åšçº¿ç¨‹éš”ç¦»ï¼Œå¼€å¯è¿œç¨‹è°ƒç”¨feignclientä½œä¸ºç°‡ç‚¹ï¼Œå¯ä»¥è¢«æµé‡ç›‘æ§</p><ul><li>ä¿®æ”¹cart-serviceæ¨¡å—çš„application.ymlæ–‡ä»¶ï¼Œå¼€å¯Feignçš„sentinelåŠŸèƒ½</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹SpringBooté¡¹ç›®çš„tomcatæœ€å¤§çº¿ç¨‹æ•°æ˜¯200ï¼Œå…è®¸çš„æœ€å¤§è¿æ¥æ˜¯8492ï¼Œå•æœºæµ‹è¯•å¾ˆéš¾æ‰“æ»¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸‹cart-serviceæ¨¡å—çš„application.ymlæ–‡ä»¶ï¼Œä¿®æ”¹tomcatè¿æ¥ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">threads:</span></span><br><span class="line">      <span class="attr">max:</span> <span class="number">50</span> <span class="comment"># å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="attr">accept-count:</span> <span class="number">50</span> <span class="comment"># æœ€å¤§æ’é˜Ÿç­‰å¾…æ•°é‡</span></span><br><span class="line">    <span class="attr">max-connections:</span> <span class="number">100</span> <span class="comment"># å…è®¸çš„æœ€å¤§è¿æ¥</span></span><br></pre></td></tr></table></figure><p>é‡å¯cart-serviceæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°æŸ¥è¯¢å•†å“çš„FeignClientè‡ªåŠ¨å˜æˆäº†ä¸€ä¸ªç°‡ç‚¹èµ„æº</p><p><strong>é…ç½®çº¿ç¨‹éš”ç¦»</strong></p><ul><li><p>ç‚¹å‡»æŸ¥è¯¢å•†å“çš„FeignClientå¯¹åº”çš„ç°‡ç‚¹èµ„æºåé¢çš„æµæ§æŒ‰é’®ï¼Œè®¾ç½®çº¿ç¨‹éš”ç¦»æ•°ä¸º5</p></li><li><p>æ³¨æ„ï¼Œè¿™é‡Œå‹¾é€‰çš„æ˜¯å¹¶å‘çº¿ç¨‹æ•°é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæŸ¥è¯¢åŠŸèƒ½æœ€å¤šä½¿ç”¨5ä¸ªçº¿ç¨‹ï¼Œè€Œä¸æ˜¯5QPSã€‚å¦‚æœæŸ¥è¯¢å•†å“çš„æ¥å£æ¯ç§’å¤„ç†2ä¸ªè¯·æ±‚ï¼Œåˆ™5ä¸ªçº¿ç¨‹çš„å®é™…QPSåœ¨10å·¦å³ï¼Œè€Œè¶…å‡ºçš„è¯·æ±‚è‡ªç„¶ä¼šè¢«æ‹’ç»</p></li><li><p>åˆ©ç”¨Jemeteræµ‹è¯•ï¼Œæ¯ç§’å‘é€100ä¸ªè¯·æ±‚ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/ZztfsLIe23brWp9.png" alt="img"></p></li><li><p>æ­¤æ—¶å¦‚æœæˆ‘ä»¬é€šè¿‡é¡µé¢è®¿é—®è´­ç‰©è½¦çš„å…¶å®ƒæ¥å£ï¼Œä¾‹å¦‚æ·»åŠ è´­ç‰©è½¦ã€ä¿®æ”¹è´­ç‰©è½¦å•†å“æ•°é‡ï¼Œå‘ç°å¹¶ä¸å—é«˜å¹¶å‘çš„å½±å“</p><ul><li>å“åº”æ—¶é—´éå¸¸çŸ­ï¼Œè¿™å°±è¯æ˜çº¿ç¨‹éš”ç¦»èµ·åˆ°äº†ä½œç”¨ï¼Œå°½ç®¡æŸ¥è¯¢è´­ç‰©è½¦è¿™ä¸ªæ¥å£å¹¶å‘å¾ˆé«˜ï¼Œä½†æ˜¯å®ƒèƒ½ä½¿ç”¨çš„çº¿ç¨‹èµ„æºè¢«é™åˆ¶äº†ï¼Œå› æ­¤ä¸ä¼šå½±å“å¤ªå¤§åˆ°å…¶å®ƒæ¥å£</li></ul></li></ul><h3 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h3><p>åœ¨ä¸Šä¸€èŠ‚ï¼Œçº¿ç¨‹éš”ç¦»ä¸­æˆ‘ä»¬å‘ç°è´­ç‰©è½¦çš„æŸ¥è¯¢åŠŸèƒ½å®Œå…¨ç˜«ç—ªï¼Œå°½ç®¡å¯ä»¥æ–°å¢ã€ä¿®æ”¹ï¼Œä½†æ˜¯æ²¡æœ‰é¡µé¢ä¸Šçš„ä¿¡æ¯åé¦ˆï¼Œç”¨æˆ·ä»¥ä¸ºæ²¡æœ‰æ·»åŠ æˆåŠŸäºæ˜¯ç»§ç»­æ–°å¢ï¼ˆå®é™…ä¸Šæ•°æ®åº“å·²ç»æ–°å¢å®Œæ¯•ï¼‰ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´è¯¯æ“ä½œ</p><p>å¥½çš„åšæ³•åº”è¯¥æ˜¯ï¼Œå³ä½¿æŸ¥è¯¢ä¸šåŠ¡å‡ºç°é—®é¢˜ï¼Œè¿”å›ä¸€äº›é»˜è®¤æ•°æ®æˆ–è€…å‹å¥½æç¤º</p><p><strong>Fallbackçš„å®ç°</strong></p><p>ç»™FeignClientç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘æœ‰ä¸¤ç§æ–¹å¼</p><ul><li>æ–¹å¼ä¸€ï¼šFallbackClassï¼Œæ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†</li><li>æ–¹å¼äºŒï¼šFallbackFactoryï¼Œå¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ï¼Œä¸€èˆ¬é€‰æ‹©è¿™ç§æ–¹å¼</li></ul><p>æ­¥éª¤ä¸€ï¼šåœ¨hm-apiæ¨¡å—ä¸­ç»™<code>ItemClient</code>å®šä¹‰é™çº§å¤„ç†ç±»ï¼Œå®ç°<code>FallbackFactory</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemClientFallback</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;ItemClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ItemClient <span class="title function_">create</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ItemClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(Collection&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è¿œç¨‹è°ƒç”¨ItemClient#queryItemByIdsæ–¹æ³•å‡ºç°å¼‚å¸¸ï¼Œå‚æ•°ï¼š&#123;&#125;&quot;</span>, ids, cause);</span><br><span class="line">                <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductStock</span><span class="params">(List&lt;OrderDetailDTO&gt; items)</span> &#123;</span><br><span class="line">                <span class="comment">// åº“å­˜æ‰£å‡ä¸šåŠ¡éœ€è¦è§¦å‘äº‹åŠ¡å›æ»šï¼ŒæŸ¥è¯¢å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(cause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“ä¸šåŠ¡è¯·æ±‚æ— å¼‚å¸¸æ—¶ç€æ­£ç¡®è°ƒç”¨ItemClientï¼Œå½“å‡ºç°å¼‚å¸¸æ—¶è°ƒç”¨ItemClientFallback</li></ul><p>æ­¥éª¤äºŒï¼šåœ¨<code>hm-api</code>æ¨¡å—ä¸­çš„<code>com.hmall.api.config.DefaultFeignConfig</code>ç±»ä¸­å°†<code>ItemClientFallback</code>æ³¨å†Œä¸ºä¸€ä¸ª<code>Bean</code></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/p8TM9kHcm2ZBEwI.png" alt="img"></p><ul><li>ç›´æ¥åœ¨å…¶ç±»åä¸ŠåŠ <code>@Component</code>æ³¨è§£ï¼Œä¸ºä»€ä¹ˆä¸è¡Œï¼Ÿæ³¨æ„è¯¥ä¸šåŠ¡æ˜¯<code>hm-api</code>ï¼Œä¸ä¼šæ‰«æåˆ°fallbackåŒ…ï¼Œè€ŒconfigåŒ…å·²ç»åœ¨å…¶ä»–ä¸šåŠ¡çš„å¯åŠ¨é¡¹ä¸­é…ç½®è¿‡ï¼Œå¯ä»¥æ‰«æ</li></ul><p>æ­¥éª¤ä¸‰ï¼šåœ¨<code>hm-api</code>æ¨¡å—ä¸­çš„<code>ItemClient</code>æ¥å£ä¸­ä½¿ç”¨<code>ItemClientFallbackFactory</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;,fallbackFactory = ItemClientFallback.class)</span></span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡ç†”æ–­"><a href="#æœåŠ¡ç†”æ–­" class="headerlink" title="æœåŠ¡ç†”æ–­"></a>æœåŠ¡ç†”æ–­</h3><p>æŸ¥è¯¢å•†å“çš„RTè¾ƒé«˜ï¼ˆæ¨¡æ‹Ÿçš„500msï¼‰ï¼Œä»è€Œå¯¼è‡´æŸ¥è¯¢è´­ç‰©è½¦çš„RTä¹Ÿå˜çš„å¾ˆé•¿ã€‚è¿™æ ·ä¸ä»…æ‹–æ…¢äº†è´­ç‰©è½¦æœåŠ¡ï¼Œæ¶ˆè€—äº†è´­ç‰©è½¦æœåŠ¡çš„æ›´å¤šèµ„æºï¼Œè€Œä¸”ç”¨æˆ·ä½“éªŒä¹Ÿå¾ˆå·®</p><p>å¯¹äºå•†å“æœåŠ¡è¿™ç§ä¸å¤ªå¥åº·çš„æ¥å£ï¼Œæˆ‘ä»¬åº”è¯¥åœæ­¢è°ƒç”¨ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ï¼Œé¿å…å½±å“åˆ°å½“å‰æœåŠ¡ã€‚ä¹Ÿå°±æ˜¯å°†å•†å“æŸ¥è¯¢æ¥å£<strong>ç†”æ–­</strong>ã€‚å½“å•†å“æœåŠ¡æ¥å£æ¢å¤æ­£å¸¸åï¼Œå†å…è®¸è°ƒç”¨ã€‚è¿™å…¶å®å°±æ˜¯<strong>æ–­è·¯å™¨</strong>çš„å·¥ä½œæ¨¡å¼äº†</p><p>Sentinelä¸­çš„æ–­è·¯å™¨ä¸ä»…å¯ä»¥ç»Ÿè®¡æŸä¸ªæ¥å£çš„<strong>æ…¢è¯·æ±‚æ¯”ä¾‹</strong>ï¼Œè¿˜å¯ä»¥ç»Ÿè®¡<strong>å¼‚å¸¸è¯·æ±‚æ¯”ä¾‹</strong>ã€‚å½“è¿™äº›æ¯”ä¾‹è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå°±ä¼š<strong>ç†”æ–­</strong>è¯¥æ¥å£ï¼Œå³<strong>æ‹¦æˆªè®¿é—®è¯¥æ¥å£çš„ä¸€åˆ‡è¯·æ±‚ï¼Œé™çº§å¤„ç†</strong>ï¼›å½“è¯¥æ¥å£æ¢å¤æ­£å¸¸æ—¶ï¼Œå†æ”¾è¡Œå¯¹äºè¯¥æ¥å£çš„è¯·æ±‚</p><p>æ–­è·¯å™¨çš„å·¥ä½œçŠ¶æ€åˆ‡æ¢æœ‰ä¸€ä¸ª<strong>çŠ¶æ€æœº</strong>æ¥æ§åˆ¶</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/SGJxiIdasmQuTY3.png" alt="image"></p><p>çŠ¶æ€æœºåŒ…æ‹¬ä¸‰ä¸ªçŠ¶æ€</p><ul><li><strong>closed</strong>ï¼šå…³é—­çŠ¶æ€ï¼Œæ–­è·¯å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å¼€å§‹ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ã€‚è¶…è¿‡é˜ˆå€¼åˆ™åˆ‡æ¢åˆ°opençŠ¶æ€</li><li><strong>open</strong>ï¼šæ‰“å¼€çŠ¶æ€ï¼ŒæœåŠ¡è°ƒç”¨è¢«<strong>ç†”æ–­</strong>ï¼Œè®¿é—®è¢«ç†”æ–­æœåŠ¡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ã€‚OpençŠ¶æ€æŒç»­ä¸€æ®µæ—¶é—´åä¼šè¿›å…¥half-opençŠ¶æ€</li><li><strong>half-open</strong>ï¼šåŠå¼€çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ“ä½œã€‚<ul><li>è¯·æ±‚æˆåŠŸï¼šåˆ™åˆ‡æ¢åˆ°closedçŠ¶æ€</li><li>è¯·æ±‚å¤±è´¥ï¼šåˆ™åˆ‡æ¢åˆ°opençŠ¶æ€</li></ul></li></ul><p>é€šè¿‡sentinelæ·»åŠ ç†”æ–­è§„åˆ™ï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/25/nDU13ci6PsqRhuy.png" alt="img"></p><p>è¿™ç§æ˜¯æŒ‰ç…§æ…¢è°ƒç”¨æ¯”ä¾‹æ¥åšç†”æ–­ï¼Œä¸Šè¿°é…ç½®çš„å«ä¹‰</p><ul><li>RTè¶…è¿‡200æ¯«ç§’çš„è¯·æ±‚è°ƒç”¨å°±æ˜¯æ…¢è°ƒç”¨</li><li>ç»Ÿè®¡æœ€è¿‘1000mså†…çš„æœ€å°‘5æ¬¡è¯·æ±‚ï¼Œå¦‚æœæ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº0.5ï¼Œåˆ™è§¦å‘ç†”æ–­</li><li>ç†”æ–­æŒç»­æ—¶é•¿20s</li></ul><p>åœ¨ä¸€å¼€å§‹ä¸€æ®µæ—¶é—´æ˜¯å…è®¸è®¿é—®çš„ï¼Œåæ¥è§¦å‘ç†”æ–­åï¼ŒæŸ¥è¯¢å•†å“æœåŠ¡çš„æ¥å£é€šè¿‡QPSç›´æ¥ä¸º0ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½è¢«ç†”æ–­äº†ã€‚è€ŒæŸ¥è¯¢è´­ç‰©è½¦çš„æœ¬èº«å¹¶æ²¡æœ‰å—åˆ°å½±å“</p><h2 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h2><h3 id="ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡"><a href="#ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡"></a>ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡</h3><p>é¡¹ç›®ä¸­çš„ä¸‹å•ä¸šåŠ¡æ•´ä½“æµç¨‹ï¼š<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/26/T5jO4cyzAhUi3dG.png" alt="image"></p><p>ç”±äºè®¢å•ã€è´­ç‰©è½¦ã€å•†å“åˆ†åˆ«åœ¨ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼Œè€Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå› æ­¤ä¸‹å•è¿‡ç¨‹ä¸­å°±ä¼šè·¨å¤šä¸ªæ•°æ®åº“å®Œæˆä¸šåŠ¡ã€‚è€Œæ¯ä¸ªå¾®æœåŠ¡éƒ½ä¼šæ‰§è¡Œè‡ªå·±çš„æœ¬åœ°äº‹åŠ¡ã€‚è¿™ä¹Ÿå¯¼è‡´äº†å½“åº“å­˜æœåŠ¡æäº¤äº‹åŠ¡å¤±è´¥æ—¶ï¼Œåªæœ‰äº¤æ˜“æœåŠ¡ä¸åº“å­˜æœåŠ¡ä¼šå›æ»šï¼Œè´­ç‰©è½¦æœåŠ¡ä¸ä¼šå›æ»šï¼ŒACIDå¤±æ•ˆï¼</p><ul><li>äº¤æ˜“æœåŠ¡ï¼šä¸‹å•äº‹åŠ¡</li><li>è´­ç‰©è½¦æœåŠ¡ï¼šæ¸…ç†è´­ç‰©è½¦äº‹åŠ¡</li><li>åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜äº‹åŠ¡</li></ul><p>é€šè¿‡ä¿®æ”¹è´­ç‰©è½¦ä¸­ä¸€å•†å“çš„åº“å­˜ä¸º0ï¼Œè¿›è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹å„ä¸ªæœåŠ¡æ‰§è¡Œæƒ…å†µï¼Œè´­ç‰©è½¦ä¼šæ­£å¸¸æ¸…ç†</p><p>äº‹åŠ¡å¹¶æœªéµå¾ªACIDçš„åŸåˆ™ï¼Œå½’å…¶åŸå› å°±æ˜¯å‚ä¸äº‹åŠ¡çš„å¤šä¸ªå­ä¸šåŠ¡åœ¨ä¸åŒçš„å¾®æœåŠ¡ï¼Œè·¨è¶Šäº†ä¸åŒçš„æ•°æ®åº“ã€‚è™½ç„¶æ¯ä¸ªå•ç‹¬çš„ä¸šåŠ¡éƒ½èƒ½åœ¨æœ¬åœ°éµå¾ªACIDï¼Œä½†æ˜¯å®ƒä»¬äº’ç›¸ä¹‹é—´æ²¡æœ‰æ„ŸçŸ¥ï¼Œä¸çŸ¥é“æœ‰äººå¤±è´¥äº†ï¼Œæ— æ³•ä¿è¯æœ€ç»ˆç»“æœçš„ç»Ÿä¸€ï¼Œä¹Ÿå°±æ— æ³•éµå¾ªACIDçš„äº‹åŠ¡ç‰¹æ€§äº†</p><p>æ•´ä¸ªä¸šåŠ¡ä¸­ï¼Œå„ä¸ªæœ¬åœ°äº‹åŠ¡æ˜¯æœ‰å…³è”çš„ã€‚å› æ­¤æ¯ä¸ªå¾®æœåŠ¡çš„æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥ç§°ä¸º<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚å¤šä¸ªæœ‰å…³è”çš„åˆ†æ”¯äº‹åŠ¡ä¸€èµ·å°±ç»„æˆäº†<strong>å…¨å±€äº‹åŠ¡</strong>ã€‚æˆ‘ä»¬å¿…é¡»ä¿è¯æ•´ä¸ªå…¨å±€äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–å¤±è´¥</p><p>ä»¥ä¸Šåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œå‡ºç°ä»¥ä¸‹æƒ…å†µä¹‹ä¸€å°±å¯èƒ½äº§ç”Ÿåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜</p><ul><li>ä¸šåŠ¡è·¨å¤šä¸ªæœåŠ¡å®ç°</li><li>ä¸šåŠ¡è·¨å¤šä¸ªæ•°æ®æºå®ç°</li></ul><h3 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h3><p>è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œä½†å®ç°èµ·æ¥éƒ½æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨å¼€æºçš„æ¡†æ¶æ¥è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚åœ¨ä¼—å¤šçš„å¼€æºåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ä¸­ï¼ŒåŠŸèƒ½æœ€å®Œå–„ã€ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯é˜¿é‡Œå·´å·´åœ¨2019å¹´å¼€æºçš„Seata</p><ul><li>å®˜æ–¹æ–‡æ¡£ï¼š<code>https://www.seata.io/zh-cn/docs/overview/what-is-seata.html</code></li></ul><p>å…¶å®åˆ†å¸ƒå¼äº‹åŠ¡äº§ç”Ÿçš„ä¸€ä¸ªé‡è¦åŸå› ï¼Œå°±æ˜¯å‚ä¸äº‹åŠ¡çš„å¤šä¸ªåˆ†æ”¯äº‹åŠ¡äº’ç›¸æ— æ„ŸçŸ¥ï¼Œä¸çŸ¥é“å½¼æ­¤çš„æ‰§è¡ŒçŠ¶æ€ã€‚å› æ­¤è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå°±æ˜¯æ‰¾ä¸€ä¸ªç»Ÿä¸€çš„<strong>äº‹åŠ¡åè°ƒè€…</strong>ï¼Œä¸å¤šä¸ªåˆ†æ”¯äº‹åŠ¡é€šä¿¡ï¼Œæ£€æµ‹æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä¿è¯å…¨å±€äº‹åŠ¡ä¸‹çš„æ¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–å¤±è´¥å³å¯ã€‚å¤§å¤šæ•°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶éƒ½æ˜¯åŸºäºè¿™ä¸ªç†è®ºæ¥å®ç°</p><p>Seataçš„å·¥ä½œæ¶æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/26/yzT9GWvVNCuKYnx.png" alt="image"></p><p>Seataçš„äº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²</p><ul><li><strong>TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…ï¼š</strong>ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š</li><li><strong>TM (Transaction Manager) -</strong> <strong>äº‹åŠ¡ç®¡ç†å™¨ï¼š</strong>å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡</li><li><strong>RM (Resource Manager) -</strong> <strong>èµ„æºç®¡ç†å™¨ï¼š</strong>ç®¡ç†åˆ†æ”¯äº‹åŠ¡ï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š</li></ul><p>ä¸‹å•ä¸šåŠ¡ä¸­ï¼Œè°ƒç”¨<code>createOrder()</code>æ–¹æ³•å°±æ˜¯å¼€å¯å…¨å±€äº‹åŠ¡ï¼Œå…¶ä¸­çš„è´­ç‰©è½¦ã€åº“å­˜ä¸šåŠ¡å°±æ˜¯åˆ†æ”¯äº‹ç‰©çš„æ³¨å†Œå’ŒæŠ¥å‘Šï¼Œæ–¹æ³•ç»“æŸå®Œæ¯•å°±ä¼šæäº¤ã€å›æ»šå…¨å±€äº‹åŠ¡ï¼Œé‚£ä¹ˆTCå°±å¼€å§‹åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ»šè¿™äº›åˆ†æ”¯äº‹åŠ¡</p><p>å…¶ä¸­ï¼Œ<strong>TM</strong>å’Œ<strong>RM</strong>å¯ä»¥ç†è§£ä¸ºSeataçš„å®¢æˆ·ç«¯éƒ¨åˆ†ï¼Œå¼•å…¥åˆ°å‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡ä¾èµ–ä¸­å³å¯ã€‚å°†æ¥<strong>TM</strong>å’Œ<strong>RM</strong>å°±ä¼šååŠ©å¾®æœåŠ¡ï¼Œå®ç°æœ¬åœ°åˆ†æ”¯äº‹åŠ¡ä¸<strong>TC</strong>ä¹‹é—´äº¤äº’ï¼Œå®ç°äº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚è€Œ<strong>TC</strong>æœåŠ¡åˆ™æ˜¯äº‹åŠ¡åè°ƒä¸­å¿ƒï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œéœ€è¦å•ç‹¬éƒ¨ç½²</p><h3 id="éƒ¨ç½²TCæœåŠ¡"><a href="#éƒ¨ç½²TCæœåŠ¡" class="headerlink" title="éƒ¨ç½²TCæœåŠ¡"></a>éƒ¨ç½²TCæœåŠ¡</h3><ol><li><p>å‡†å¤‡æ•°æ®åº“è¡¨</p><ul><li>Seataæ”¯æŒå¤šç§å­˜å‚¨æ¨¡å¼ï¼Œä½†è€ƒè™‘åˆ°æŒä¹…åŒ–çš„éœ€è¦ï¼Œä¸€èˆ¬é€‰æ‹©åŸºäºæ•°æ®åº“å­˜å‚¨ã€‚æ‰§è¡Œé»‘é©¬èµ„æ–™æä¾›çš„<code>seata-tc.sql</code>ï¼Œå¯¼å…¥æ•°æ®åº“è¡¨</li></ul></li><li><p>å‡†å¤‡é…ç½®æ–‡ä»¶</p><ul><li>é»‘é©¬èµ„æ–™å‡†å¤‡äº†ä¸€ä¸ªseataç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†seataè¿è¡Œæ—¶æ‰€éœ€è¦çš„é…ç½®æ–‡ä»¶</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/26/crLJOQfTyi2d9NA.png" alt="image"></li></ul></li><li><p>åŸºäºdockeréƒ¨ç½²</p><ul><li><p>æ‹·è´seataç›®å½•å’Œseataé•œåƒåˆ°dockerçš„<code>/root</code>ç›®å½•ä¸‹</p></li><li><p>éœ€è¦æ³¨æ„ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„è¿æ¥éƒ½æ˜¯é€šè¿‡æœåŠ¡åç§°ï¼Œæ‰€ä»¥è¦ç¡®ä¿nacosã€mysqléƒ½åœ¨hm-netç½‘ç»œä¸­ã€‚å¦‚æœæŸä¸ªå®¹å™¨ä¸åœ¨hm-netç½‘ç»œï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„å‘½ä»¤å°†æŸå®¹å™¨åŠ å…¥æŒ‡å®šç½‘ç»œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker network connect [ç½‘ç»œå] [å®¹å™¨å]</span><br></pre></td></tr></table></figure></li><li><p>åœ¨è™šæ‹Ÿæœºçš„<code>/root</code>ç›®å½•æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run --name seata \</span><br><span class="line">-p 8099:8099 \</span><br><span class="line">-p 7099:7099 \</span><br><span class="line">-e SEATA_IP=192.168.80.132 \</span><br><span class="line">-v ./seata:/seata-server/resources \</span><br><span class="line">--privileged=true \</span><br><span class="line">--network heima \</span><br><span class="line">-d \</span><br><span class="line">seataio/seata-server:1.5.2</span><br></pre></td></tr></table></figure></li></ul></li><li><p>é€šè¿‡<code>è™šæ‹ŸæœºIP:7099</code>æŸ¥çœ‹UIæ§åˆ¶å°æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p></li></ol><h3 id="å¾®æœåŠ¡é›†æˆSeata"><a href="#å¾®æœåŠ¡é›†æˆSeata" class="headerlink" title="å¾®æœåŠ¡é›†æˆSeata"></a>å¾®æœåŠ¡é›†æˆSeata</h3><p>ä¸ºäº†æ–¹ä¾¿å„ä¸ªå¾®æœåŠ¡é›†æˆseataï¼Œæˆ‘ä»¬éœ€è¦æŠŠseataé…ç½®å…±äº«åˆ°nacosï¼Œå› æ­¤<code>trade-service</code>æ¨¡å—ä¸ä»…ä»…è¦å¼•å…¥seataä¾èµ–ï¼Œè¿˜è¦å¼•å…¥nacosä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--ç»Ÿä¸€é…ç½®ç®¡ç†--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--è¯»å–bootstrapæ–‡ä»¶--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶æ¬¡åœ¨nacosä¸Šæ·»åŠ ä¸€ä¸ªå…±äº«çš„seataé…ç½®ï¼Œå‘½åä¸º<code>shared.seata.yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">registry:</span> <span class="comment"># TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span> <span class="comment"># æ³¨å†Œä¸­å¿ƒç±»å‹ nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span><span class="string">:8848</span> <span class="comment"># nacosåœ°å€</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span> <span class="comment"># namespaceï¼Œé»˜è®¤ä¸ºç©º</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment"># åˆ†ç»„ï¼Œé»˜è®¤æ˜¯DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span> <span class="comment"># seataæœåŠ¡åç§°</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">hmall</span> <span class="comment"># äº‹åŠ¡ç»„åç§°</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span> <span class="comment"># äº‹åŠ¡ç»„ä¸tcé›†ç¾¤çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">      <span class="attr">hmall:</span> <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure><ul><li>ä¸€ä¸ªæœåŠ¡çš„è·å–é€”å¾„ï¼šå‘½åç©ºé—´-åˆ†ç»„-æœåŠ¡åç§°-é›†ç¾¤-å…·ä½“çš„å®ä¾‹</li><li>æ³¨æ„ç™»å½•å¯†ç ä¿®æ”¹ä¸ºnacosï¼ˆå¦‚æœä¹‹å‰å¯¹nacosç™»å½•å¯†ç æœ‰è¿‡ä¿®æ”¹ï¼‰</li></ul><p>ç„¶åï¼Œæ”¹é€ <code>trade-service</code>æ¨¡å—ï¼Œæ·»åŠ <code>bootstrap.yaml</code>ï¼Œä¿®æ”¹<code>appplication.yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">trade-service</span> <span class="comment"># æœåŠ¡åç§°</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.132</span> <span class="comment"># nacosåœ°å€</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># æ–‡ä»¶åç¼€å</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># å…±äº«é…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared.jdbc.yaml</span> <span class="comment"># å…±äº«mybatisé…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared.log.yaml</span> <span class="comment"># å…±äº«æ—¥å¿—é…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared.swagger.yaml</span> <span class="comment"># å…±äº«æ—¥å¿—é…ç½®</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared.seata.yaml</span> <span class="comment"># å…±äº«seataé…ç½®</span></span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå¯¹æ¶‰åŠåˆ°åˆ†å¸ƒå¼æœåŠ¡çš„è´­ç‰©è½¦å’Œå•†å“æœåŠ¡è¿›è¡Œä¿®æ”¹</p><p>æ³¨æ„jdkå…¶ä»–ç‰ˆæœ¬ï¼ˆé11ï¼‰å¦‚æœæŠ¥é”™å°±åœ¨æœåŠ¡é…ç½®ä¸Š<code>--add-opens=java.base/java.lang=ALL-UNNAMED</code></p><h3 id="XAæ¨¡å¼"><a href="#XAæ¨¡å¼" class="headerlink" title="XAæ¨¡å¼"></a>XAæ¨¡å¼</h3><p>åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šä¾‹å¦‚ï¼š<strong>XA</strong>ã€<strong>TCC</strong>ã€<strong>AT</strong>ã€<strong>SAGA</strong>ç­‰ï¼ŒSeataä¹Ÿå¯¹è¿™4ç§æ–¹æ¡ˆæ”¯æŒï¼Œè¿™é‡Œé»‘é©¬ä¸»è¦è®²è§£XAã€ATæ¨¡å¼</p><p><code>XA</code> è§„èŒƒ æ˜¯<code> X/Open</code> ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed Transaction Processingï¼‰æ ‡å‡†ï¼ŒXA è§„èŒƒæè¿°äº†å…¨å±€çš„<code>TM</code>ä¸å±€éƒ¨çš„<code>RM</code>ä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“éƒ½å¯¹ XA è§„èŒƒæä¾›äº†æ”¯æŒ</p><p>XAæ˜¯è§„èŒƒï¼Œç›®å‰ä¸»æµæ•°æ®åº“éƒ½å®ç°äº†è¿™ç§è§„èŒƒï¼Œå®ç°çš„åŸç†éƒ½æ˜¯åŸºäº<strong>ä¸¤é˜¶æ®µæäº¤</strong></p><p>Seataå¯¹åŸå§‹çš„XAæ¨¡å¼åšäº†ç®€å•çš„å°è£…å’Œæ”¹é€ ï¼Œä»¥é€‚åº”è‡ªå·±çš„äº‹åŠ¡æ¨¡å‹ï¼ŒåŸºæœ¬æ¶æ„å¦‚å›¾</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/26/CMKzw8ZJk1UrHb6.png" alt="image"></p><ul><li><code>RM</code>ä¸€é˜¶æ®µçš„å·¥ä½œ<ol><li>æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°<code>TC</code></li><li>æ‰§è¡Œåˆ†æ”¯ä¸šåŠ¡sqlä½†ä¸æäº¤</li><li>æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€åˆ°<code>TC</code></li></ol></li><li><code>TC</code>äºŒé˜¶æ®µçš„å·¥ä½œ<ol><li><code>TC</code>æ£€æµ‹å„åˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€</li><li>å¦‚æœéƒ½æˆåŠŸï¼Œé€šçŸ¥æ‰€æœ‰RMæäº¤äº‹åŠ¡</li><li>å¦‚æœæœ‰å¤±è´¥ï¼Œé€šçŸ¥æ‰€æœ‰RMå›æ»šäº‹åŠ¡</li></ol></li><li><code>RM</code>äºŒé˜¶æ®µçš„å·¥ä½œ<ol><li>æ¥æ”¶<code>TC</code>æŒ‡ä»¤ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡</li></ol></li></ul><p><code>XA</code>æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ACIDåŸåˆ™</li><li>å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥</li></ul><p><code>XA</code>æ¨¡å¼çš„ç¼ºç‚¹ï¼š</p><ul><li>å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼ˆæ’ä»–é”ï¼Œä¸€è‡´ç­‰å¾…å…¶ä»–åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½æäº¤ï¼‰ï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®</li><li>ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡</li></ul><p><strong>å®ç°XAæ¨¡å¼</strong></p><p>å› ä¸ºå¯¼å…¥äº†seataçš„staterçš„ä¾èµ–ï¼Œæ‰€ä»¥å®ç°éå¸¸ç®€å•</p><ul><li><p>é¦–å…ˆï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè¦é‡‡ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼ï¼Œåœ¨Nacosä¸­çš„å…±äº«shared-seata.yamlé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">data-source-proxy-mde:</span> <span class="string">XA</span></span><br></pre></td></tr></table></figure></li><li><p>å…¶æ¬¡ï¼Œå°†<code>@GlobalTransactional</code>æ ‡è®°åˆ†å¸ƒå¼äº‹åŠ¡çš„å…¥å£æ–¹æ³•</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/26/JKPdAfDRe9lFCVL.png" alt="image"></p></li></ul><h3 id="ATæ¨¡å¼"><a href="#ATæ¨¡å¼" class="headerlink" title="ATæ¨¡å¼"></a>ATæ¨¡å¼</h3><p>Seataä¸»æ¨çš„æ˜¯ATæ¨¡å¼ï¼ŒATæ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡å´å¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·</p><p>Seataçš„ATæ¨¡å¼åŸºæœ¬æ¶æ„å¦‚å›¾</p><ul><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/26/7rXms39chTb4zVM.png" alt="img"></p></li><li><p>é˜¶æ®µä¸€<code>RM</code>çš„å·¥ä½œ</p><ul><li>æ³¨å†Œåˆ†æ”¯äº‹åŠ¡</li><li>è®°å½•undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰</li><li>æ‰§è¡Œä¸šåŠ¡sqlå¹¶æäº¤</li><li>æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€</li></ul></li><li><p>é˜¶æ®µäºŒæäº¤æ—¶<code>RM</code>çš„å·¥ä½œï¼šåˆ é™¤undo-logå³å¯</p></li><li><p>é˜¶æ®µäºŒå›æ»šæ—¶<code>RM</code>çš„å·¥ä½œï¼šæ ¹æ®undo-logæ¢å¤æ•°æ®åˆ°æ›´æ–°å‰</p></li></ul><p><code>AT</code>æ¨¡å¼ä¸<code>XA</code>æ¨¡å¼æœ€å¤§çš„åŒºåˆ«ï¼š</p><ul><li><code>XA</code>æ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›<code>AT</code>æ¨¡å¼ä¸€é˜¶æ®µç›´æ¥æäº¤ï¼Œä¸é”å®šèµ„æºï¼ˆä¼˜ç‚¹æ˜¯æ€§èƒ½å¥½ï¼Œç¼ºç‚¹æ˜¯æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼‰</li><li><code>XA</code>æ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›<code>AT</code>æ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å®ç°æ•°æ®å›æ»š</li><li><code>XA</code>æ¨¡å¼å¼ºä¸€è‡´ï¼›<code>AT</code>æ¨¡å¼æœ€ç»ˆä¸€è‡´</li></ul><p><strong>ATæ¨¡å¼çš„å®ç°</strong></p><ol><li>å»æ‰nacosé…ç½®æ–‡ä»¶ä¸­çš„XAæ¨¡å¼å³å¯ï¼ˆé»˜è®¤æ˜¯ATï¼‰</li><li>å°†é»‘é©¬èµ„æ–™ä¸­sqlæ–‡ä»¶<code>undo_log</code>è¡¨å¯¼å…¥åˆ°å‡ ä¸ªåˆ†æ”¯æœåŠ¡å¯¹åº”çš„æ•°æ®åº“ä¸­</li></ol><p>é—®é¢˜ï¼šå½“è¿˜æœªæ¢å¤å¿«ç…§æ—¶ï¼Œåˆ«äººä¹Ÿä¿®æ”¹äº†æ•°æ®ï¼Œæ˜¯å¦ä¼šé€ æˆå¹¶å‘é—®é¢˜ï¼Ÿã€</p><ul><li>åœ¨æäº¤æ•°æ®å¿«ç…§å‰ä¼šå‘TCï¼ˆäº‹åŠ¡åè°ƒå™¨ï¼‰æ³¨å†Œåˆ†æ”¯ï¼Œç”³è¯·ä¸€ä¸ªä¸»é”®ç­‰äºç›®æ ‡æ•°æ®ä¸»é”®å€¼çš„<strong>å…¨å±€é”</strong></li><li>Seataé€šè¿‡å…¨å±€é”å®ç°äº†å†™éš”ç¦»ï¼Œç¡®ä¿å…¶ä»–äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡æœªé‡Šæ”¾å…¨å±€é”æ—¶æ— æ³•ä¿®æ”¹åŒä¸€æ•°å€¼ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåˆ«çš„çº¿ç¨‹æˆ–è€…è¿›ç¨‹åœ¨å…¨å±€äº‹åŠ¡ç»“æŸå‰å°è¯•ä¿®æ”¹ç›¸åº”çš„æ•°æ®ï¼Œå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¨å±€é”é‡Šæ”¾ã€‚å› æ­¤ï¼Œä¸ä¼šå‘ç”Ÿè„å†™é—®é¢˜ï¼Œä»è€Œé¿å…äº†å¹¶å‘é—®é¢˜</li></ul><hr>]]></content>
      
      
      <categories>
          
          <category> é»‘é©¬å­¦ä¹ è¯¾ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tools</title>
      <link href="/cn/Tools/"/>
      <url>/cn/Tools/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸€äº›å°å·¥å…·çš„ä»‹ç»ä¸ä½¿ç”¨ï¼Œæ„Ÿè°¢è¿™äº›åšä¸»ï¼</p></blockquote><h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="ä¸ªäººåšå®¢ç½‘ç«™æ­å»º"><a href="#ä¸ªäººåšå®¢ç½‘ç«™æ­å»º" class="headerlink" title="ä¸ªäººåšå®¢ç½‘ç«™æ­å»º"></a>ä¸ªäººåšå®¢ç½‘ç«™æ­å»º</h2><ol><li>è¿™ä¸ªåšä¸»çš„æ•™ç¨‹éå¸¸è¯¦ç»†ï¼Œä¸”é…æœ‰æ–‡å­—+è§†é¢‘è®²è§£<code>https://ihcll.cn/83/</code></li><li>Githubå’ŒGiteeå…¶å®éƒ½å·®ä¸å¤šï¼Œçœ‹ä¸ªäººå–œæ¬¢</li></ol><h2 id="ä¸ªäººåšå®¢ç½‘ç«™é…ç½®"><a href="#ä¸ªäººåšå®¢ç½‘ç«™é…ç½®" class="headerlink" title="ä¸ªäººåšå®¢ç½‘ç«™é…ç½®"></a>ä¸ªäººåšå®¢ç½‘ç«™é…ç½®</h2><ol><li><code>ButterFly</code> ä¸»é¢˜é…ç½®&amp;ç¾åŒ–<ol><li>å®˜ç½‘<code>https://github.com/jerryc127/hexo-theme-butterfly</code></li><li><code>https://www.cnblogs.com/MoYu-zc/p/14395965.html</code></li></ol></li><li>PicGo + Typora + Smmsè·å–å›¾ç‰‡è¶…é“¾ä»¥åŠä¸Šä¼ <ol><li>Smmså›¾åºŠç½‘ç«™å®˜ç½‘<code>https://smms.app/</code></li><li><code>https://blog.csdn.net/dante1987/article/details/127706832</code></li></ol></li><li>å…è´¹å›¾ç‰‡å‹ç¼©<ol><li><code>https://saerasoft.com/caesium/</code></li></ol></li><li>å…¶ä»–å…è´¹å›¾åºŠï¼ˆå¦‚æœSmmsä¸å¯ç”¨çš„è¯å¯ä»¥æ›´æ¢ï¼‰<ol><li><code>https://www.picgo.net/</code> </li><li><code>https://imgse.com/</code></li></ol></li><li>åšå®¢URLä¼˜åŒ–<ol><li>æ•™ç¨‹ï¼š<code>https://blog.csdn.net/qq_45890533/article/details/124185573</code></li></ol></li></ol><h2 id="å„ç§æ–‡ä»¶çš„æ ¼å¼è½¬æ¢"><a href="#å„ç§æ–‡ä»¶çš„æ ¼å¼è½¬æ¢" class="headerlink" title="å„ç§æ–‡ä»¶çš„æ ¼å¼è½¬æ¢"></a>å„ç§æ–‡ä»¶çš„æ ¼å¼è½¬æ¢</h2><ol><li>æ ¼å¼åŒ–å·¥å‚<ol><li>å®˜ç½‘<code>http://www.pcgeshi.com/index.html</code>ä¸‹è½½</li></ol></li></ol><h2 id="æ–‡å­—æ‰«æã€è¯†åˆ«å·¥å…·"><a href="#æ–‡å­—æ‰«æã€è¯†åˆ«å·¥å…·" class="headerlink" title="æ–‡å­—æ‰«æã€è¯†åˆ«å·¥å…·"></a>æ–‡å­—æ‰«æã€è¯†åˆ«å·¥å…·</h2><ol><li>Umi-OCR<ol><li>å®˜ç½‘<code>https://github.com/hiroi-sora/Umi-OCR</code></li></ol></li></ol><h2 id="Virtual-Private-Server-è™šæ‹Ÿä¸“ç”¨æœåŠ¡å™¨"><a href="#Virtual-Private-Server-è™šæ‹Ÿä¸“ç”¨æœåŠ¡å™¨" class="headerlink" title="Virtual Private Server(è™šæ‹Ÿä¸“ç”¨æœåŠ¡å™¨)"></a>Virtual Private Server(è™šæ‹Ÿä¸“ç”¨æœåŠ¡å™¨)</h2><ol><li>å›½å†…å¤§å‚ï¼šè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ã€ç™¾åº¦äº‘ç­‰</li><li>racknerd<ol><li>å›½å¤–çš„ï¼Œä»·æ ¼ä¾¿å®œï¼Œå»¶è¿Ÿä¹Ÿä¸ç®—å¤ªé«˜</li><li><code>https://my.racknerd.com/cart.php?a=confproduct&amp;i=0</code></li></ol></li><li>å°å…”äº’è”<ol><li>ä»·æ ¼ä¸é”™ï¼Œé…ç½®ä¹Ÿè¿˜å¥½</li><li>å®˜ç½‘: <code>https://hl.luoltu.com/cart</code></li></ol></li><li>å„å¤§VPSå•†å®¶æ¨èï¼š<code>https://topvps.info/review</code></li></ol><h2 id="è¯ä¹¦ç­¾å‘"><a href="#è¯ä¹¦ç­¾å‘" class="headerlink" title="è¯ä¹¦ç­¾å‘"></a>è¯ä¹¦ç­¾å‘</h2><ol><li>acmeè‡ªç­¾<ol><li>å®˜ç½‘: <code>https://github.com/acmesh-official/acme.sh</code></li></ol></li><li>é˜¿é‡Œäº‘ã€è…¾è®¯äº‘</li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Rediså®æˆ˜ç¯‡å­¦ä¹ ç¬”è®°</title>
      <link href="/cn/Redis/"/>
      <url>/cn/Redis/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨æ­¤ç‰¹åˆ«æ„Ÿè°¢é»‘é©¬ç¨‹åºå‘˜Redisè¯¾ç¨‹~~<br><a href="https://www.bilibili.com/video/BV1cr4y1671t?p=70&vd_source=7341c7fca3b496e9108bb1fd49c634ef">é»‘é©¬ç¨‹åºå‘˜çš„Redisè¯¾ç¨‹</a></p></blockquote><h1 id="å†…å®¹æ¦‚è¿°"><a href="#å†…å®¹æ¦‚è¿°" class="headerlink" title="å†…å®¹æ¦‚è¿°"></a>å†…å®¹æ¦‚è¿°</h1><ul><li><em><strong>çŸ­ä¿¡ç™»å½•</strong></em><ul><li>é€šè¿‡Rediså…±äº«Sessionå®ç°</li><li>åœ¨è‹ç©¹å¤–å–é¡¹ç›®ä¸­é€šè¿‡Json Web Tokenå®ç°ç™»å½•ï¼›é»‘é©¬ç‚¹è¯„é€šè¿‡Rediså…±äº«sessionå®ç°çŸ­-  -ä¿¡éªŒè¯ç™»å½•ã€‚</li></ul></li><li><em><strong>æ·»åŠ ç¼“å­˜</strong></em><ul><li>åŸºäºRediså®ç°ç»™å•†æˆ·æ·»åŠ ç¼“å­˜ï¼Œè®¾ç½®æ›´æ–°ç­–ç•¥ï¼Œæ»¡è¶³è¯»å†™ä¸€è‡´</li><li>è§£å†³ç¼“å­˜ä¸­å­˜åœ¨3å¤§é—®é¢˜ï¼Œç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©ã€ç¼“å­˜å‡»ç©¿</li><li>å¯¹é”çš„ç†è§£å’Œçº¿ç¨‹æ± çš„åˆ›å»º&amp;ä½¿ç”¨ï¼ˆå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼‰</li></ul></li><li><em><strong>ä¼˜æƒ å·ç§’æ€</strong></em><ul><li>åŸºæœ¬ä¼˜æƒ å·å’Œç§’æ€ä¼˜æƒ å·ä»¥åŠä¼˜æƒ å·è®¢å•çš„æ·»åŠ </li><li>é€šè¿‡åŠ ä¹è§‚é”&amp;æ‚²è§‚é”çš„æ–¹å¼è§£å†³åº“å­˜è¶…å–é—®é¢˜</li><li>é€šè¿‡åŠ é”å®ç°å¯¹å•æœºçŠ¶æ€ä¸‹ä¸€äººä¸€å•çš„ç»†ç²’åº¦æ§åˆ¶</li><li>é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜åˆ†æ</li></ul></li><li><em><strong>åˆ†å¸ƒå¼é”</strong></em><ul><li>åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œä»¥åŠè¯¯åˆ é—®é¢˜ã€è·å–ã€åˆ¤æ–­ã€åˆ é™¤é”çš„åŸå­æ€§é—®é¢˜</li><li>çº¿ç¨‹æ ‡è¯†è§£å†³è¯¯åˆ é—®é¢˜</li><li>luaè„šæœ¬è§£å†³åŸå­æ€§é—®é¢˜</li><li><strong>åˆ†å¸ƒå¼é”-Redisson</strong><ul><li>Redissonå®ç°å¯é‡å…¥ã€å¯é‡è¯•ã€è¶…æ—¶ç»­çº¦</li><li>å®ç°çš„åŸç†ä»¥åŠWatch Dogæœºåˆ¶</li><li>Redissoné€šè¿‡è”é”å®ç°ä¸»ä»ä¸€è‡´æ€§</li></ul></li></ul></li><li><em><strong>ç§’æ€ä¼˜åŒ–</strong></em><ul><li>å¼‚æ­¥â€ç§’æ€â€çš„æ€è·¯åˆ†æ</li><li>åŸºäºluaè„šæœ¬å®Œæˆè®¢å•ä¸šåŠ¡çš„åˆ¤æ–­</li><li>é€šè¿‡é˜»å¡å¯¹å’ä¸ç‹¬ç«‹çº¿ç¨‹å¤„ç†è®¢å•å¼‚æ­¥ä»»åŠ¡å®Œæˆä¸‹å•</li></ul></li><li><em><strong>Redisæ¶ˆæ¯é˜Ÿåˆ—</strong></em><ul><li>è®¤è¯†ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¸‚é¢ä¸Šå¸¸ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶</li><li>åŸºäºRedisçš„Listã€PubSubã€Streamç»“æ„å®ç°æ¶ˆæ¯é˜Ÿåˆ—</li><li>ä¸‰ç§ç»“æ„å¯¹å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜ç¼ºç‚¹</li><li>åŸºäºStreamç»“æ„çš„æ¶ˆè´¹è€…ç»„æ¨¡å¼ä¸‹å®ç°å¤šæ¶ˆè´¹ç§’æ€ä¸‹å•</li></ul></li><li><em><strong>è¾¾äººæ¢åº—</strong></em><ul><li>å¦‚ä½•åŸºäºäº‘å­˜å‚¨æœåŠ¡å®ç°ç…§ç‰‡ä¸Šä¼ </li><li>åŸºäºRedisçš„Seté›†åˆå®ç°ç”¨æˆ·æ˜¯å¦å¯¹æŸåšæ–‡è¿›è¡Œè¿‡ç‚¹èµ</li><li>åŸºäºRedisçš„SortedSeté›†åˆå®ç°ç”¨æˆ·æ˜¯å¦å¯¹æŸåšæ–‡è¿›è¡Œè¿‡ç‚¹èµï¼Œä»¥åŠç‚¹èµç”¨æˆ·é€šè¿‡æ—¶é—´å…ˆåæ’åº</li><li>äº†è§£MySQLçš„æŸ¥è¯¢ç»“æœæœºåˆ¶ï¼Œå®ç°ç»™å®šé¡ºåºä¸Šä¼ </li></ul></li><li><em><strong>å¥½å‹å…³æ³¨</strong></em><ul><li>å¤šå¯¹å¤šå‹è¡¨ç»“æ„å…³ç³»çš„å»ºç«‹</li><li>åŸºäºSortedSetå®ç°â€äº¤é›†â€æŸ¥è¯¢</li><li>ä»€ä¹ˆæ—¶Feedæµï¼ŒFeedæµçš„å®ç°æ–¹å¼</li><li>SortedSetçš„ZREVRANGEBYSCOREå‘½ä»¤ï¼Œå®ç°æ»šåŠ¨åˆ†</li></ul></li><li><em><strong>é™„è¿‘å•†é“º</strong></em><ul><li>äº†è§£Redisä¸­GEOè¿™ç§æ•°æ®ç»“æ„çš„ä½¿ç”¨</li><li>é€šè¿‡GEOæ¥å®ç°é™„è¿‘å•†é“ºçš„ä½ç½®æœç´¢</li></ul></li><li><em><strong>ç”¨æˆ·ç­¾åˆ°</strong></em><ul><li>äº†è§£Redisä¸­BitMapè¿™ç§æ•°æ®ç»“æ„çš„ä½¿ç”¨</li><li>é€šè¿‡BitMapå®ç°ç­¾åˆ°åŠŸèƒ½å’Œè¿ç»­ç­¾åˆ°æ¬¡æ•°</li></ul></li><li><em><strong>UVç»Ÿè®¡</strong></em><ul><li>äº†è§£LogLogæ¦‚ç‡ç»Ÿè®¡ç®—æ³•</li><li>äº†è§£Redisä¸­HyperLogLogè¿™ç§æ•°æ®ç»“æ„åº”ç”¨</li></ul></li></ul><hr><h1 id="é¡¹ç›®ç®€ä»‹"><a href="#é¡¹ç›®ç®€ä»‹" class="headerlink" title="é¡¹ç›®ç®€ä»‹"></a>é¡¹ç›®ç®€ä»‹</h1><ul><li>å‰åç«¯åˆ†ç¦»å¼€å‘</li><li>å‰ç«¯é€šè¿‡NginxæœåŠ¡å™¨å¯åŠ¨ã€‚<ul><li>åœ¨â€œè‹ç©¹å¤–å–â€é¡¹ç›®ä¸­åŒæ ·æ˜¯é‡‡ç”¨Nginxè¿™ç§è½»é‡çš„åå‘ä»£ç†æœåŠ¡å™¨ã€‚</li><li>é€šè¿‡nignxçš„è´Ÿè½½å‡è¡¡èƒ½æ˜¾è‘—é™ä½TomcatæœåŠ¡å™¨çš„å‹åŠ›ã€‚</li></ul></li><li>è¯¥é¡¹ç›®ä¸­å¯¹mysqlçš„å¹¶å‘éœ€æ±‚ä¹Ÿä¼šéå¸¸å¤§ï¼Œé™¤äº†é€šè¿‡mysqlé›†ç¾¤å¤–ï¼Œä¹Ÿé€šè¿‡éƒ¨ç½²Redisé›†ç¾¤æ¥å‡è½»å¯¹mysqlçš„å¹¶å‘å‹åŠ›ã€‚</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/aN8L7DiBSnEY3jF.png" alt="url"></li></ul><h2 id="å¯¼å…¥å‰ç«¯å·¥ç¨‹"><a href="#å¯¼å…¥å‰ç«¯å·¥ç¨‹" class="headerlink" title="å¯¼å…¥å‰ç«¯å·¥ç¨‹"></a>å¯¼å…¥å‰ç«¯å·¥ç¨‹</h2><ol><li><p>åœ¨é»‘é©¬æä¾›çš„èµ„æ–™ä¸­ï¼Œæ‰¾åˆ°<strong>NginxåŒ…</strong>ï¼ŒæŠŠåŒ…æ”¾åˆ°æˆ‘ä»¬çš„workspaceä¸­ã€‚</p><ol><li>è¯¥workspaceä¸èƒ½åŒ…å«ä¸­æ–‡è·¯å¾„ï¼Œä¸ç„¶nginxå¯åŠ¨å¤±è´¥</li></ol></li><li><p>å¯åŠ¨<code>start nginx</code>ï¼Œä¸€é—ªè€Œè¿‡è¯´æ˜å¯åŠ¨æˆåŠŸï¼›æˆ–è€…æŸ¥çœ‹ä»»åŠ¡è¿›ç¨‹æœ‰æ— nginx</p><ol><li>è®¿é—®<code>http://localhost:8080/</code>å³å¯çœ‹åˆ°</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/3QyCqIgpf8KPv4X.webp" alt="url" style="zoom:50%;" /></li></ol></li></ol><h2 id="å¯¼å…¥åç«¯å·¥ç¨‹"><a href="#å¯¼å…¥åç«¯å·¥ç¨‹" class="headerlink" title="å¯¼å…¥åç«¯å·¥ç¨‹"></a>å¯¼å…¥åç«¯å·¥ç¨‹</h2><ol><li>åœ¨é»‘é©¬æä¾›çš„èµ„æ–™ä¸­ï¼Œæ‰¾åˆ°<code>hm-dianping</code>é¡¹ç›®å¯¼å…¥</li><li>å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®<code>http://localhost:8081/shop-type/list</code>,å¦‚æœå‡ºç°jsonæ•°æ®ï¼Œä»£è¡¨æˆåŠŸã€‚</li><li>ç¤ºä¾‹</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/zxsLiRaClJ2bd43.webp" alt="url" style="zoom: 33%;" /></li></ol><h2 id="æ•°æ®åº“æ­å»º"><a href="#æ•°æ®åº“æ­å»º" class="headerlink" title="æ•°æ®åº“æ­å»º"></a>æ•°æ®åº“æ­å»º</h2><h3 id="è¡¨ç»“æ„è¯´æ˜"><a href="#è¡¨ç»“æ„è¯´æ˜" class="headerlink" title="è¡¨ç»“æ„è¯´æ˜"></a>è¡¨ç»“æ„è¯´æ˜</h3><ul><li>å¯¼å…¥é»‘é©¬èµ„æ–™ä¸­çš„sqlæ–‡ä»¶å®Œæˆæ•°æ®åº“çš„å»ºè¡¨</li></ul><table><thead><tr><th align="center">è¡¨</th><th align="center">è¯´æ˜</th></tr></thead><tbody><tr><td align="center">tb_user</td><td align="center">ç”¨æˆ·è¡¨</td></tr><tr><td align="center">tb_user_info</td><td align="center">ç”¨æˆ·è¯¦æƒ…è¡¨</td></tr><tr><td align="center">tb_shop</td><td align="center">å•†æˆ·ä¿¡æ¯è¡¨</td></tr><tr><td align="center">tb_shop_type</td><td align="center">å•†æˆ·ç±»å‹è¡¨</td></tr><tr><td align="center">tb_blog</td><td align="center">ç”¨æˆ·æ—¥è®°è¡¨ï¼ˆè¾¾äººæ¢åº—æ—¥è®°ï¼‰</td></tr><tr><td align="center">tb_follow</td><td align="center">ç”¨æˆ·å…³æ³¨è¡¨</td></tr><tr><td align="center">tb_voucher</td><td align="center">ä¼˜æƒ åˆ¸è¡¨</td></tr><tr><td align="center">tb_voucher_order</td><td align="center">ä¼˜æƒ åˆ¸çš„è®¢å•è¡¨</td></tr></tbody></table><h3 id="å­—ç¬¦é›†-æ’åºå­—ç¬¦é›†"><a href="#å­—ç¬¦é›†-æ’åºå­—ç¬¦é›†" class="headerlink" title="å­—ç¬¦é›†&amp;æ’åºå­—ç¬¦é›†"></a>å­—ç¬¦é›†&amp;æ’åºå­—ç¬¦é›†</h3><ul><li>å­—ç¬¦é›†æ˜¯<code>utf8mb4</code></li><li><ul><li>åœ¨MySQLä¸­ä¿ç•™å››å­—èŠ‚é•¿åº¦çš„<code>utf-8</code>ç¼–ç çš„å­—ç¬¦ï¼Œå…¼å®¹æ€§æ›´å¥½ï¼ˆä¸utf-8ç›¸æ¯”ï¼‰ï¼Œç©ºé—´å ç”¨æ¯”utf-8ç¨å¤§ï¼Œmysqlå®˜æ–¹å»ºè®®ä½¿ç”¨varcharä»£æ›¿charä½¿ç”¨</li><li>è¯¦ç»†è¯·çœ‹<code>https://blog.csdn.net/munangs/article/details/126617226</code></li></ul></li><li>æ’åºå­—ç¬¦é›†æ˜¯<code>utf8mb4_general_ci</code><ul><li>æ¨èä½¿ç”¨ <code>utf8mb4_0900_ai_ci</code> ä½œä¸ºé»˜è®¤æ’åºå­—ç¬¦é›†ï¼›<code>utf8mb4_general_ci</code>åœ¨æ¯”è¾ƒå’Œæ’åºçš„æ€§èƒ½ä¸Šéƒ½è¿˜è¡Œï¼Œ ä½†æ˜¯æ²¡æœ‰å®ç° <strong>Unicode</strong> æ’åºè§„åˆ™ï¼Œåœ¨é‡åˆ°æŸäº›ç‰¹æ®Šè¯­è¨€æˆ–è€…å­—ç¬¦é›†ï¼Œæ’åºç»“æœå¯èƒ½ä¸ä¸€è‡´</li></ul></li></ul><h2 id="Redisæ­å»º"><a href="#Redisæ­å»º" class="headerlink" title="Redisæ­å»º"></a>Redisæ­å»º</h2><ol><li>é…ç½®ä¿¡æ¯</li></ol> <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ==redis==</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">lettuce:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">time-between-eviction-runs:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure><ol start="2"><li>é€‰æ‹©<ol><li>ç”±äºæ˜¯ä¸ªäººæ“ä½œï¼Œç›´æ¥ä½¿ç”¨<strong>Windows</strong>ç³»ç»Ÿä¸‹çš„<strong>Redis</strong></li><li>åœ¨â€è‹ç©¹å¤–å–â€œä¸­ä½¿ç”¨çš„æ˜¯RedisTemplateï¼Œç„¶åé…ç½®<strong>å­—ç¬¦ä¸²åºåˆ—åŒ–å™¨</strong>ï¼›è€Œè¿™é‡Œçš„StringRedisTemplateç»§æ‰¿RedisTemplateä¸”é»˜è®¤åºåˆ—åŒ–å™¨å°±æ˜¯<strong>å­—ç¬¦ä¸²åºåˆ—åŒ–å™¨</strong>ï¼Œå› æ­¤ä¹‹åç›´æ¥è£…é…StringRedisTemplateä½¿ç”¨å³å¯</li><li>RedisTemplate å’Œ StringRedisTemplateåŒºåˆ«<ol><li>è¯¦æƒ…çœ‹<code>https://blog.csdn.net/zhanyu1/article/details/90760226</code></li></ol></li></ol></li></ol><hr><h1 id="çŸ­ä¿¡ç™»å½•"><a href="#çŸ­ä¿¡ç™»å½•" class="headerlink" title="çŸ­ä¿¡ç™»å½•"></a>çŸ­ä¿¡ç™»å½•</h1><h2 id="åŸºäºSessionçš„ç™»å½•æµç¨‹"><a href="#åŸºäºSessionçš„ç™»å½•æµç¨‹" class="headerlink" title="åŸºäºSessionçš„ç™»å½•æµç¨‹"></a>åŸºäºSessionçš„ç™»å½•æµç¨‹</h2><ol><li>é€šè¿‡æ¥æ”¶åˆ°çš„æ‰‹æœºå·å‘é€éªŒè¯ç </li><li>çŸ­ä¿¡éªŒè¯ç ç™»å½•ã€æ³¨å†Œ</li><li>æ ¡éªŒç™»å½•çŠ¶æ€</li></ol><h3 id="å‘é€éªŒè¯ç å®ç°"><a href="#å‘é€éªŒè¯ç å®ç°" class="headerlink" title="å‘é€éªŒè¯ç å®ç°"></a>å‘é€éªŒè¯ç å®ç°</h3><ol><li><p>æŸ¥çœ‹å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ol><li>Postè¯·æ±‚ï¼Œè·¯å¾„ä¸º<code>/user/code</code></li><li>è¯·æ±‚å‚æ•°ä¸º<code>String phone, HttpSession session</code></li></ol></li><li><p>ç”µè¯å·ç è§„èŒƒæ ¡éªŒ</p><ol><li>è¿™é‡Œé€šè¿‡å·¥å…·ç±»<code>RegexUtils</code>å’Œ<code>RegexPatterns</code>å¸¸é‡ç±»åšæ­£åˆ™åˆ¤æ–­</li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ‰‹æœºå·æ­£åˆ™</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PHONE_REGEX</span> <span class="operator">=</span> </span><br><span class="line">    <span class="string">&quot;^1([38][0-9]|4[579]|5[0-3,5-9]|6[6]|7[0135678]|9[89])\\d&#123;8&#125;$&quot;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æ˜¯æ— æ•ˆæ‰‹æœºæ ¼å¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> phone è¦æ ¡éªŒçš„æ‰‹æœºå·</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true:ç¬¦åˆï¼Œfalseï¼šä¸ç¬¦åˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isPhoneInvalid</span><span class="params">(String phone)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mismatch(phone, RegexPatterns.PHONE_REGEX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>ç”ŸæˆéªŒè¯ç <ol><li>é»‘é©¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªéšæœºæ•°å·¥å…·ç±»ï¼Œç”Ÿæˆ6ä½çš„æ•°å­—éšæœºæ•°ã€‚</li><li><code>RandomUtil</code>å·¥å…·ç±»</li></ol></li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--ä¾èµ–--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="4"><li><p>ä¿å­˜éªŒè¯ç åˆ°sessionä¸­</p></li><li><p>å‘é€éªŒè¯ç </p></li><li><p>å…·ä½“serviceå±‚ä»£ç å®ç°</p><ol><li>ä»£ç é€»è¾‘</li><li>æ‰‹æœºå·æ ¡éªŒ</li></ol><ul><li>é”™è¯¯ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æ­£ç¡®ï¼Œç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç <ul><li>æ²¡æœ‰çŸ­ä¿¡æœåŠ¡æ¥å£ï¼Œç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°æŸ¥çœ‹</li><li>ä¿å­˜åˆ°<code>session</code>åŸŸä¸­</li></ul></li></ul></li></ol> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‘é€éªŒè¯ç </span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isInvalid</span> <span class="operator">=</span> RegexUtils.isPhoneInvalid(phone);</span><br><span class="line">    <span class="keyword">if</span> (isInvalid)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.PHONE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">yzm</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">    session.setAttribute(<span class="string">&quot;code&quot;</span>,yzm);</span><br><span class="line">    log.info(<span class="string">&quot;yzm:&#123;&#125;&quot;</span>,yzm);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çŸ­ä¿¡ç™»å½•å®ç°"><a href="#çŸ­ä¿¡ç™»å½•å®ç°" class="headerlink" title="çŸ­ä¿¡ç™»å½•å®ç°"></a>çŸ­ä¿¡ç™»å½•å®ç°</h3><ol><li><p>æŸ¥çœ‹å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p></li><li><p>Postè¯·æ±‚è·¯å¾„ä¸º<code>/user/login</code></p><ol><li>è¯·æ±‚å‚æ•°ä¸º<code>LoginFormDTO loginForm, HttpSession session</code></li></ol></li><li><p>æŸ¥çœ‹<code>LoginFormDTO </code>çš„ç»„æˆç»“æ„</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFormDTO</span> &#123;</span><br><span class="line">    <span class="comment">//ç”µè¯</span></span><br><span class="line">    <span class="keyword">private</span> String phone; </span><br><span class="line">    <span class="comment">//è¾“å…¥çš„éªŒè¯ç </span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="comment">//å¯†ç </span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><p>å®ç°é€»è¾‘</p><ol><li><p>æ ¡éªŒæ‰‹æœºå·æ˜¯å¦æœ‰æ•ˆ</p><ol><li>æ— æ•ˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æœ‰æ•ˆï¼Œåˆ¤æ–­æ‰‹æœºå·æ˜¯å¦ä¸€è‡´<ol><li>ä¸ä¸€è‡´ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>ä¸€è‡´ï¼Œé€šè¿‡è·å–<code>session</code>åŸŸä¸­yzmè¿›è¡Œæ ¡éªŒ<ol><li>é”™è¯¯ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æ­£ç¡®ï¼Œæ ¹æ®æ‰‹æœºå·åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·<ol><li>ç”¨æˆ·å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·åˆ°session</li><li>ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·ï¼Œä¿å­˜æ•°æ®åº“ä¸­</li></ol></li></ol></li></ol></li></ol><p>2.åˆ›å»ºæ–°ç”¨æˆ·</p><ol><li>å¯¹Userå®ä½“ç±»åˆ›å»ºä¸€ä¸ªå®ç°æ–¹æ³•</li><li>æ ¹æ®ç”µè¯å·ç å’Œ<code>IdGenerator</code>æ„å»ºä¸€ä¸ª<code>User</code>å®ä½“</li><li>ä¿å­˜æ•°æ®åº“</li><li>ä¿å­˜åˆ°<code>session</code></li></ol></li></ol></li><li><p>å…·ä½“serviceå±‚ä»£ç å®ç°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isInvalid</span> <span class="operator">=</span> RegexUtils.isPhoneInvalid(loginForm.getPhone());</span><br><span class="line">    <span class="keyword">if</span> (isInvalid)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.PHONE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;code&quot;</span>).toString();    </span><br><span class="line">    <span class="keyword">if</span> (!loginForm.getCode().equals(yzm))&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.CODE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getByPhone(loginForm.getPhone());</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>)&#123;</span><br><span class="line">        session.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">User</span> <span class="variable">newUser</span> <span class="operator">=</span> createUserWithPhone(loginForm.getPhone());</span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> userMapper.insert(newUser);</span><br><span class="line">    <span class="keyword">if</span> (row != <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_USER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>,newUser);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ç”µè¯å·ç åˆ›å»ºç”¨æˆ·</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> phone</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">createUserWithPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setPhone(phone);</span><br><span class="line">    user.setId(YitIdHelper.nextId());</span><br><span class="line">    user.setCreateTime(LocalDateTime.now());</span><br><span class="line">    user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//åç§°é‡‡ç”¨çš„æ˜¯RandomUtilçš„éšæœºå­—ç¬¦ä¸²</span></span><br><span class="line">    user.setNickName(SystemConstants.USER_NICK_NAME_PREFIX + RandomUtil.randomString(<span class="number">10</span>));</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¿™é‡Œçš„ä¸»é”®ç”Ÿæˆç­–ç•¥é‡‡ç”¨<strong>é›ªèŠ±ç®—æ³•id</strong>ç”Ÿæˆ</p><ul><li><p>é…ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.yitter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yitter-idgenerator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>é…ç½®è¯¦æƒ…è§å®˜ç½‘</p><ul><li><code>https://github.com/yitter/idgenerator/tree/master/Java</code></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdGeneratorUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…¨å±€ åˆå§‹åŒ–ï¼ˆåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º IdGeneratorOptions å¯¹è±¡ï¼Œå¯åœ¨æ„é€ å‡½æ•°ä¸­è¾“å…¥ WorkerId(é»˜è®¤ä¸º0)</span></span><br><span class="line">        <span class="type">IdGeneratorOptions</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdGeneratorOptions</span>();</span><br><span class="line">        <span class="comment">// ä¿å­˜å‚æ•°ï¼ˆåŠ¡å¿…è°ƒç”¨ï¼Œå¦åˆ™å‚æ•°è®¾ç½®ä¸ç”Ÿæ•ˆï¼‰ï¼š</span></span><br><span class="line">        YitIdHelper.setIdGenerator(options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>æµç¨‹å›¾</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/ib7vXEtZzQGeTNY.webp" alt="img"></p></li></ol><p></p><h2 id="ç™»å½•æ‹¦æˆª"><a href="#ç™»å½•æ‹¦æˆª" class="headerlink" title="ç™»å½•æ‹¦æˆª"></a>ç™»å½•æ‹¦æˆª</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><ul><li><p>ä¸ºä»€ä¹ˆéœ€è¦ç™»å½•æ‹¦æˆªå™¨ï¼Ÿ</p><ul><li>ä¸€èˆ¬æ¥è¯´ï¼Œåªæœ‰é™æ€ã€ç™»å½•å’Œæ³¨å†Œé¡µé¢æ˜¯ç”¨æˆ·å¯ä»¥ç›´æ¥<code>url</code>è®¿é—®çš„ã€‚å…¶ä»–ä¸€åˆ‡çš„<code>url</code>éƒ½éœ€è¦è¢«æ‹¦æˆªï¼Œè¿›è¡Œåˆ¤æ–­</li><li>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é˜²æ­¢ç”¨æˆ·ä¸ç™»å½•å°±è®¿é—®ç³»ç»Ÿèµ„æº</li></ul></li><li><p>ç™»å½•æ‹¦æˆªå™¨çš„ä¸šåŠ¡å®ç°åŸç†ï¼Ÿ</p><ul><li>åœ¨è¢«æ‹¦æˆªçš„è¯·æ±‚ä¸­æŸ¥çœ‹sessionåŸŸé‡Œæ˜¯å¦æœ‰ç”¨æˆ·çš„ç™»å½•æ•°æ®ï¼ˆåŸºäºSessionå®ç°ï¼‰</li><li>åœ¨â€è‹ç©¹å¤–å–â€œä¸­æ˜¯é€šè¿‡è¯·æ±‚å¤´è·å–ç™»å½•ä»¤ç‰Œæ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ã€‚</li></ul></li></ul><h3 id="é»‘é©¬æä¾›çš„Tomcatçš„è¿è¡ŒåŸç†"><a href="#é»‘é©¬æä¾›çš„Tomcatçš„è¿è¡ŒåŸç†" class="headerlink" title="é»‘é©¬æä¾›çš„Tomcatçš„è¿è¡ŒåŸç†"></a>é»‘é©¬æä¾›çš„Tomcatçš„è¿è¡ŒåŸç†</h3><ol><li><p>è¿è¡ŒåŸç†å›¾</p></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/qRTaSxXzjNgB6H8.webp" alt="img" style="zoom: 50%;" /></li><li><p>ç¤ºä¾‹</p><ol><li>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šè®¿é—®æˆ‘ä»¬å‘<code>tomcat</code>æ³¨å†Œçš„<strong>ç«¯å£</strong>ï¼Œä»»ä½•ç¨‹åºæƒ³è¦è¿è¡Œï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å½“å‰ç«¯å£å·è¿›è¡Œ<strong>ç›‘å¬</strong>ï¼Œ<code>tomcat</code>ä¹Ÿä¸ä¾‹å¤–</li><li>å½“ç›‘å¬çº¿ç¨‹çŸ¥é“ç”¨æˆ·æƒ³è¦å’Œ<code>tomcat</code>è¿æ¥æ—¶ï¼Œä¼šç”±ç›‘å¬çº¿ç¨‹åˆ›å»º<code>socket</code>è¿æ¥</li><li><code>socket</code>éƒ½æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œç”¨æˆ·é€šè¿‡<code>socket</code>äº’ç›¸ä¼ é€’æ•°æ®ï¼Œå½“<code>tomcat</code>ç«¯çš„<code>socket</code>æ¥å—åˆ°æ•°æ®åï¼Œæ­¤æ—¶ç›‘å¬çº¿ç¨‹ä¼šä»<code>tomcat</code>çš„çº¿ç¨‹æ± ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç”¨æˆ·è¯·æ±‚</li><li>åœ¨æˆ‘ä»¬çš„æœåŠ¡éƒ¨ç½²åˆ°<code>tomcat</code>åï¼Œçº¿ç¨‹ä¼šæ‰¾åˆ°ç”¨æˆ·æƒ³è¦è®¿é—®çš„å·¥ç¨‹ï¼Œç„¶åç”¨è¿™ä¸ªçº¿ç¨‹è½¬å‘åˆ°å·¥ç¨‹ä¸­çš„<code>controller</code>ï¼Œ<code>service</code>ï¼Œ<code>dao</code>ä¸­ï¼Œå¹¶ä¸”è®¿é—®å¯¹åº”çš„<code>DataBase</code></li><li>åœ¨ç”¨æˆ·æ‰§è¡Œå®Œè¯·æ±‚åï¼Œå†ç»Ÿä¸€è¿”å›ï¼Œå†æ‰¾åˆ°<code>tomcat</code>ç«¯çš„<code>socket</code>ï¼Œå†å°†æ•°æ®å†™å›åˆ°ç”¨æˆ·ç«¯çš„<code>socket</code>ï¼Œå®Œæˆè¯·æ±‚å’Œå“åº”</li></ol></li><li><p>é€šè¿‡ä»¥ä¸Šè®²è§£ï¼Œå¯ä»¥å¾—çŸ¥ <strong>æ¯ä¸ªç”¨æˆ·å…¶å®éƒ½æ˜¯å»tomcatçº¿ç¨‹æ± ä¸­æ‰¾çš„ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆå·¥ä½œ</strong>ï¼Œ ä½¿ç”¨å®Œæˆåå†è¿›è¡Œå›æ”¶ï¼Œæ—¢ç„¶æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹(æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¸ä¸€è‡´)çš„ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ªç”¨æˆ·å»è®¿é—®æˆ‘ä»¬çš„å·¥ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>threadlocal</code>æ¥åšåˆ°<strong>çº¿ç¨‹éš”ç¦»</strong>ï¼Œå³æ¯ä¸ªçº¿ç¨‹åªæ“ä½œè‡ªå·±çš„ä¸€ä»½æ•°æ®</p></li></ol><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><ol><li>é€šè¿‡<code>threadLocal</code>çš„æºç ï¼Œä¼šå‘ç°åœ¨<code>threadLocal</code>ä¸­ï¼Œæ— è®ºæ˜¯ä»–çš„<code>put()</code>æ–¹æ³•å’Œä»–çš„<code>get()</code>æ–¹æ³•ï¼Œéƒ½æ˜¯å…ˆè·å¾—å½“å‰ç”¨æˆ·çš„çº¿ç¨‹ï¼Œç„¶åä»çº¿ç¨‹ä¸­å–å‡ºçº¿ç¨‹çš„æˆå‘˜å˜é‡<code>map</code>ï¼Œåªè¦çº¿ç¨‹ä¸ä¸€æ ·ï¼Œ<code>map</code>å°±ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥åšåˆ°<strong>çº¿ç¨‹éš”ç¦»</strong></li><li>æºç </li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/f5vKJtoRbkAz4Ey.webp" alt="img" style="zoom:50%;" /></li></ol><h3 id="Sessionå…±äº«é—®é¢˜"><a href="#Sessionå…±äº«é—®é¢˜" class="headerlink" title="Sessionå…±äº«é—®é¢˜"></a>Sessionå…±äº«é—®é¢˜</h3><ul><li><p>æ ¸å¿ƒæ€è·¯åˆ†æ</p><ul><li><p>æ¯ä¸ª<code>tomcat</code>ä¸­éƒ½æœ‰ä¸€ä»½å±äºè‡ªå·±çš„<code>session</code>,å‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€å°<code>tomcat</code>ï¼Œå¹¶ä¸”æŠŠè‡ªå·±çš„ä¿¡æ¯å­˜æ”¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨çš„<code>session</code>ä¸­</p></li><li><p>ä½†æ˜¯ç¬¬äºŒæ¬¡ï¼Œè¿™ä¸ªç”¨æˆ·è®¿é—®åˆ°äº†ç¬¬äºŒå°<code>tomcat</code>ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒå°æœåŠ¡å™¨ä¸Šï¼Œè‚¯å®šæ²¡æœ‰ç¬¬ä¸€å°æœåŠ¡å™¨å­˜æ”¾çš„<code>session</code></p></li><li><p>æ‰€ä»¥æ­¤æ—¶æ•´ä¸ªç™»å½•æ‹¦æˆªåŠŸèƒ½å°±ä¼šå‡ºç°é—®é¢˜</p></li></ul></li><li><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><ul><li>æ—©æœŸçš„æ–¹æ¡ˆæ˜¯<strong>sessionæ‹·è´</strong>ï¼Œå°±æ˜¯è¯´è™½ç„¶æ¯ä¸ª<code>tomcat</code>ä¸Šéƒ½æœ‰ä¸åŒçš„<code>session</code>ï¼Œä½†æ˜¯æ¯å½“ä»»æ„ä¸€å°æœåŠ¡å™¨çš„<code>session</code>ä¿®æ”¹æ—¶ï¼Œéƒ½ä¼š<strong>åŒæ­¥</strong>ç»™å…¶ä»–çš„TomcatæœåŠ¡å™¨çš„<code>session</code>ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°sessionçš„å…±äº«</li></ul></li><li><p>ä½†æ˜¯è¿™ç§æ–¹æ¡ˆå…·æœ‰ä¸¤ä¸ªå¤§é—®é¢˜</p><ol><li>æ¯å°æœåŠ¡å™¨ä¸­éƒ½éœ€è¦å®Œæ•´çš„ä¸€ä»½sessionæ•°æ®ï¼ŒæœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚</li><li>sessionæ‹·è´æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å»¶è¿Ÿ</li><li>æ‰€ä»¥è¿™é‡Œé‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯åŸºäº<strong>Redis</strong>æ¥å®Œæˆï¼ŒRedisæ•°æ®æœ¬èº«å°±æ˜¯å…±äº«çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…sessionå…±äº«çš„é—®é¢˜</li></ol></li><li><p>è¿™æ ·çš„å®ç°å°±éœ€è¦å¯¹ç™»å½•&amp;æ³¨å†ŒåŠŸèƒ½ä»£ç ï¼Œè¿›è¡Œä¸€å®šä¿®æ”¹ï¼ŒæŠŠç”¨æˆ·æ•°æ®Userç›´æ¥ç¼“å­˜åˆ°redisä¸­</p></li><li><p>åœ¨sessionä¸­ä¿å­˜ç”¨æˆ·æ•°æ®ï¼Œå¦‚æœæµè§ˆå™¨ä¿¡æ¯è¢«æˆªå–çš„è¯ï¼Œä¼šå­˜åœ¨é‡è¦ä¿¡æ¯æ³„éœ²é—®é¢˜</p><ul><li>å› æ­¤é»‘é©¬ä¼šæœ‰<code>UserDTO</code>ç±»æ¥å¯¹ç”¨æˆ·æ•°æ®è¿›è¡Œéšè—</li><li>ä¸è¿‡åœ¨<strong>Redis</strong>ä¸­ä¸ä¼šå­˜åœ¨è¿™äº›é—®é¢˜ï¼Œä½†ä¸ºäº†å®‰å…¨ï¼Œè¿˜æ˜¯éœ€è¦å¯¹ç¼“å­˜çš„ç”¨æˆ·æ•°æ®è¿›è¡Œéšè—</li></ul></li></ul><h3 id="Redisçš„è®¾è®¡"><a href="#Redisçš„è®¾è®¡" class="headerlink" title="Redisçš„è®¾è®¡"></a>Redisçš„è®¾è®¡</h3><ol><li><p>ä½¿ç”¨Redisï¼Œä¸å¯é¿å…çš„éœ€è¦è€ƒè™‘keyå’Œvalueçš„è®¾è®¡ã€‚</p></li><li><p>KEYéœ€è¦æ»¡è¶³</p><ol><li>å”¯ä¸€æ€§</li><li>éæ•æ„Ÿæ€§</li></ol></li><li><p>Valueåˆ™éœ€è¦è€ƒè™‘ä½¿ç”¨ä½•ç§æ•°æ®ç»“æ„ç¼“å­˜<code>User</code>å®ä½“æ•°æ®</p><ol><li>ç›´æ¥å­—ç¬¦ä¸²ï¼Œä»¥Jsonå½¢å¼å­˜å‚¨</li><li>Hashç»“æ„ï¼Œkey-field-valueå½¢å¼</li></ol></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/uiY4Lnp8svU2GDb.webp" alt="img" style="zoom: 33%;" /></li><li><p>é€‰æ‹©</p><ol><li>KEYé€šè¿‡<code>IdGeneratorUtill</code>å·¥å…·ç±»éšæœºç”Ÿæˆtokenå³å¯ï¼Œå‰ç«¯æºå¸¦è¿™ä¸ªtokenè®¿é—®</li><li>å› ä¸º<code>User</code>æ•°æ®å·²ç»è¢«éšè—ï¼Œä»¥åŠä¸ä¼šé€šè¿‡Rediså¯¹å…¶ä¸­çš„ä¸ªåˆ«æ•°æ®æŸ¥çœ‹ï¼Œå› æ­¤é€‰æ‹©Stringç±»å‹ä»¥Jsonå½¢å¼å­˜å‚¨</li></ol></li></ol><h3 id="åŸºäºRediså®ç°ç™»å½•"><a href="#åŸºäºRediså®ç°ç™»å½•" class="headerlink" title="åŸºäºRediså®ç°ç™»å½•"></a>åŸºäºRediså®ç°ç™»å½•</h3><ol><li><p>é€šè¿‡tokenåšç™»å½•ä»¤ç‰Œï¼Œ30åˆ†é’Ÿçš„æœ‰æ•ˆæœŸ</p></li><li><p>å°†<code>UserDto</code>è½¬ä¸ºJsonå­—ç¬¦ä¸²</p></li><li><p>è¿”å›token</p></li><li><p>ç”±äºåªæ˜¯å¯¹<code>session</code>çš„åŠŸèƒ½ä¿®æ”¹ï¼Œå…¶ä»–ä¸åšå¤ªå¤§æ”¹å˜ï¼Œå› æ­¤ç›´æ¥è´´ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‘é€éªŒè¯ç </span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isInvalid</span> <span class="operator">=</span> RegexUtils.isPhoneInvalid(phone);</span><br><span class="line">    <span class="keyword">if</span> (isInvalid)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.PHONE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">yzm</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">    stringRedisTemplate.opsForValue()</span><br><span class="line">        .set(RedisConstants.LOGIN_CODE_KEY+phone,yzm,<span class="number">1</span>,TimeUnit.MINUTES);</span><br><span class="line">    log.info(<span class="string">&quot;yzm:&#123;&#125;&quot;</span>,yzm);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">//ç™»å½•</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">       <span class="type">boolean</span> <span class="variable">isInvalid</span> <span class="operator">=</span> RegexUtils.isPhoneInvalid(loginForm.getPhone());</span><br><span class="line">       <span class="keyword">if</span> (isInvalid)&#123;</span><br><span class="line">           <span class="keyword">return</span> Result.fail(MessageConstants.PHONE_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">String</span> <span class="variable">yzm</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">           .get(RedisConstants.LOGIN_CODE_KEY + loginForm.getPhone());</span><br><span class="line">       <span class="keyword">if</span> (!loginForm.getCode().equals(yzm))&#123;</span><br><span class="line">           <span class="keyword">return</span> Result.fail(MessageConstants.CODE_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getByPhone(loginForm.getPhone());</span><br><span class="line">       <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">       <span class="keyword">if</span> (user != <span class="literal">null</span>)&#123;</span><br><span class="line">       <span class="type">long</span> <span class="variable">token</span> <span class="operator">=</span> YitIdHelper.nextId();</span><br><span class="line">       BeanUtils.copyProperties(user,userDTO);</span><br><span class="line">       <span class="type">String</span> <span class="variable">userDtoStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(userDTO);</span><br><span class="line">       stringRedisTemplate.opsForValue().set(RedisConstants.LOGIN_USER_KEY+token,</span><br><span class="line">                userDtoStr,RedisConstants.LOGIN_USER_TTL,TimeUnit.MINUTES);</span><br><span class="line">       <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//æ³¨å†Œ</span></span><br><span class="line">       <span class="type">User</span> <span class="variable">newUser</span> <span class="operator">=</span> createUserWithPhone(loginForm.getPhone());</span><br><span class="line">       <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> userMapper.insert(newUser);</span><br><span class="line">       <span class="keyword">if</span> (row != <span class="number">1</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> Result.fail(MessageConstants.NEW_USER_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">long</span> <span class="variable">token</span> <span class="operator">=</span> YitIdHelper.nextId();</span><br><span class="line">   BeanUtils.copyProperties(newUser,userDTO);</span><br><span class="line">   <span class="type">String</span> <span class="variable">userDtoStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(userDTO);</span><br><span class="line">   stringRedisTemplate.opsForValue().set(RedisConstants.LOGIN_USER_KEY+token,userDtoStr</span><br><span class="line">       ,RedisConstants.LOGIN_USER_TTL,TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> ![img](https:<span class="comment">//s2.loli.net/2024/07/02/xngTCto7pmvbcaB.webp)</span></span><br><span class="line"></span><br><span class="line">### å®ç°ç™»å½•æ‹¦æˆªå™¨</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> ä»£ç é€»è¾‘</span><br><span class="line"></span><br><span class="line">   <span class="number">1.</span> ä»è¯·æ±‚å¤´ä¸­è·å–`token`</span><br><span class="line">   <span class="number">1.</span> æ ¹æ®`token`ä»**Redis**ä¸­è·å–ç”¨æˆ·æ•°æ®</span><br><span class="line">      <span class="number">1.</span> å¤±è´¥ï¼Œè®¾ç½®å“åº”çŠ¶æ€ç <span class="number">401</span>ï¼ˆæ‹¦æˆªï¼‰</span><br><span class="line">      <span class="number">1.</span> æˆåŠŸï¼Œä¿å­˜ç”¨æˆ·åˆ°threadlocalä¸­</span><br><span class="line">         <span class="number">1.</span> åˆ·æ–°`token`çš„ç¼“å­˜æ—¶é—´</span><br><span class="line">         <span class="number">1.</span> æ”¾è¡Œ</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> å…·ä½“ä»£ç </span><br><span class="line"></span><br><span class="line">   ```java</span><br><span class="line">   <span class="comment">//ç™»å½•æ‹¦æˆªå™¨</span></span><br><span class="line">   <span class="meta">@Component</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">       <span class="meta">@Resource</span></span><br><span class="line">       <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">       </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">           <span class="type">String</span> <span class="variable">userDtoStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">               .get(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">           <span class="keyword">if</span> (userDtoStr == <span class="literal">null</span> )&#123;</span><br><span class="line">               response.setStatus(<span class="number">401</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> JSONUtil.toBean(userDtoStr,UserDTO.class);</span><br><span class="line">           <span class="keyword">if</span> (userDTO == <span class="literal">null</span>)&#123;</span><br><span class="line">               response.setStatus(<span class="number">401</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">          UserHolder.saveUser(userDTO);</span><br><span class="line">        stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY+token,</span><br><span class="line">                                  RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ æ‹¦æˆªå™¨</p><ul><li><p>è®¾ç½®æ‹¦æˆªè·¯å¾„å’Œæ”¾è¡Œè·¯å¾„ï¼›è¿™é‡Œç›´æ¥ç²˜è´´é»‘é©¬çš„ä»£ç å³å¯</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;LoginInterceptoræ‹¦æˆªå™¨.....&quot;</span>);</span><br><span class="line">        registry.addInterceptor(loginInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="å®ç°çŠ¶æ€ç™»å½•åˆ·æ–°"><a href="#å®ç°çŠ¶æ€ç™»å½•åˆ·æ–°" class="headerlink" title="å®ç°çŠ¶æ€ç™»å½•åˆ·æ–°"></a>å®ç°çŠ¶æ€ç™»å½•åˆ·æ–°</h3><ol><li><p>é—®é¢˜</p><ul><li>ç™»å½•æ‹¦æˆªå™¨åªæ˜¯æ‹¦æˆªäº†éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼ˆurlï¼‰ï¼›å¦‚æœç”¨æˆ·è®¿é—®ä¸è¢«æ‹¦æˆªçš„<code>url</code>è¶…è¿‡30minä»¥ä¸Š<code>token</code>è¿˜æ˜¯ä¼šè¿‡æœŸ</li></ul></li><li><p>è§£å†³</p><ul><li>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ‹¦æˆªå™¨ä¸“é—¨ç”¨æ¥å¤„ç†ä»¤ç‰Œåˆ·æ–°é—®é¢˜ï¼Œè‡³äºæ˜¯å¦<strong>Redis</strong>ç¼“å­˜ç”¨æˆ·æ•°æ®åˆ™æ”¾è¡Œè‡³ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†</li><li>ä»¤ç‰Œåˆ·æ–°æ‹¦æˆªå™¨éœ€è¦å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæ‹¦æˆª</li></ul></li><li><p>å®ç°é€»è¾‘</p><ol><li><p>ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨</p></li><li><p>ä»è¯·æ±‚å¤´ä¸­è·å–<code>token</code></p><ol><li>ä¸å­˜åœ¨ï¼Œæ”¾è¡Œï¼ˆå¯èƒ½æ˜¯ç™»å½•ï¼‰</li><li>å­˜åœ¨ï¼Œä»Redisä¸­è·å–ç”¨æˆ·æ•°æ®<ol><li>ä¸å­˜åœ¨ï¼Œæ”¾è¡Œï¼ˆtokeè¿‡æœŸï¼‰</li><li>å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·æ•°æ®åˆ°<code>threadlocal</code>ä¸­<ol><li>åˆ·æ–°tokenæœ‰æ•ˆæœŸ</li><li>æ”¾è¡Œ</li></ol></li></ol></li><li>åœ¨è¯·æ±‚å®Œæˆåç§»é™¤ç”¨æˆ·<ol><li><code>afterCompletion</code>æ–¹æ³•ä¸­è°ƒç”¨<code>UserHolder.removeUser();</code></li></ol></li></ol></li><li><p>ç¬¬äºŒä¸ªæ‹¦æˆªå™¨</p><ol><li><p>ç›´æ¥åˆ¤æ–­<code>threadlocal</code>ä¸­æ˜¯å¦å­˜åœ¨ç”¨æˆ·æ•°æ®</p><ol><li>ä¸å­˜åœ¨ï¼Œå“åº”401ï¼Œæ‹¦æˆª</li><li>å­˜åœ¨ï¼Œæ”¾è¡Œ</li></ol></li><li><p>åœ¨è¯·æ±‚å®Œæˆåç§»é™¤ç”¨æˆ·</p><ol><li>åœ¨<code>afterCompletion</code>æ–¹æ³•ä¸­<code>UserHolder.removeUser();</code></li></ol></li></ol></li></ol></li><li><p>æˆ‘ä»¬é‡å¯æœåŠ¡å™¨ï¼Œç™»å½•ï¼Œç„¶åå»Redisçš„å›¾å½¢åŒ–ç•Œé¢æŸ¥çœ‹<code>token</code>çš„<code>ttl</code>ï¼Œå¦‚æœæ¯æ¬¡åˆ‡æ¢ç•Œé¢ä¹‹åï¼Œ<code>ttl</code>éƒ½ä¼šé‡ç½®ï¼Œè¯´æ˜ä»£ç æ²¡æœ‰é—®é¢˜  </p></li><li><p>å®ç°ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»¤ç‰Œåˆ·æ–°æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenRefeshInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request,HttpServletResponse response,</span></span><br><span class="line"><span class="params">       Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userDtoStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">            .get(RedisConstants.LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="keyword">if</span> (userDtoStr == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> JSONUtil.toBean(userDtoStr, UserDTO.class);</span><br><span class="line">        <span class="keyword">if</span> (userDTO == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY+token,</span><br><span class="line">                                   RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ·»åŠ æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TokenRefeshInterceptor tokenRefeshInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Interceptoræ‹¦æˆªå™¨.....&quot;</span>);</span><br><span class="line">        registry.addInterceptor(tokenRefeshInterceptor)</span><br><span class="line">                        .addPathPatterns(<span class="string">&quot;/**&quot;</span>).order(<span class="number">0</span>);</span><br><span class="line">        registry.addInterceptor(loginInterceptor)</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span></span><br><span class="line">                ).order(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æµç¨‹å›¾<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/AQhWkJPjN1po6sa.webp" alt="img"></p></li><li><p>æ‹¦æˆªå™¨å®ç°åŸç†å›¾ï¼ˆå›å¿†çŸ¥è¯†ï¼‰</p><ol><li>å‚è€ƒåˆ«äººåšå®¢<code>https://cyborg2077.github.io/2022/09/10/SSMIntegration/</code></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/02/XKz4xigFZQ5oBEj.webp" alt="img"></li></ol></li><li><p>å®ç°æµç¨‹</p><ol><li><p>æµè§ˆå™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œä¼šå…ˆåˆ°<code>Tomcat</code>æœåŠ¡å™¨çš„webæœåŠ¡å™¨</p></li><li><p><code>Tomcat</code>æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå…ˆå»åˆ¤æ–­è¯·æ±‚çš„æ˜¯é™æ€èµ„æºè¿˜æ˜¯åŠ¨æ€èµ„æº</p></li><li><p>å¦‚æœæ˜¯é™æ€èµ„æºï¼Œä¼šç›´æ¥åˆ°<code>Tomcat</code>çš„é¡¹ç›®éƒ¨ç½²ç›®å½•ä¸‹ç›´æ¥è®¿é—®</p></li><li><p>å¦‚æœæ˜¯åŠ¨æ€èµ„æºï¼Œå°±éœ€è¦äº¤ç»™é¡¹ç›®çš„åå°ä»£ç è¿›è¡Œå¤„ç†</p></li><li><p>åœ¨æ‰¾åˆ°å…·ä½“çš„æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å»é…ç½®<strong>è¿‡æ»¤å™¨</strong>ï¼ˆå¯ä»¥é…ç½®å¤šä¸ªï¼‰ï¼ŒæŒ‰ç…§é¡ºåºè¿›è¡Œæ‰§è¡Œï¼ˆåœ¨è¿™é‡Œå°±å¯ä»¥è¿›è¡Œæƒé™æ ¡éªŒï¼‰</p></li><li><p>ç„¶åè¿›å…¥åˆ°ä¸­å¤®å¤„ç†å™¨ï¼ˆSpringMVCä¸­çš„å†…å®¹ï¼‰ï¼ŒSpringMVCä¼šæ ¹æ®é…ç½®çš„è§„åˆ™è¿›è¡Œæ‹¦æˆª</p></li><li><p>å¦‚æœæ»¡è¶³è§„åˆ™ï¼Œåˆ™è¿›è¡Œå¤„ç†ï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„<code>Controller</code>ç±»ä¸­çš„æ–¹æ³•è¿›è¡Œï¼Œå®Œæˆåè¿”å›ç»“æœ</p></li><li><p>å¦‚æœä¸æ»¡è¶³è§„åˆ™ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†</p></li><li><p>è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ª<code>Controller</code>æ–¹æ³•æ‰§è¡Œçš„å‰åæ·»åŠ ä¸šåŠ¡ï¼Œå…·ä½“è¯¥å¦‚ä½•æ¥å®ç°ï¼Ÿ </p><ul><li><p>è¿™ä¸ªå°±æ˜¯æ‹¦æˆªå™¨è¦åšçš„äº‹</p></li><li><p>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰æ˜¯ä¸€ç§åŠ¨æ€æ‹¦æˆªæ–¹æ³•è°ƒç”¨çš„æœºåˆ¶ï¼Œåœ¨<strong>SpringMVC</strong>ä¸­åŠ¨æ€æ‹¦æˆªæ§åˆ¶å™¨æ–¹æ³•çš„æ‰§è¡Œ</p><ul><li><p>åœ¨æŒ‡å®šçš„æ–¹æ³•è°ƒç”¨å‰åæ‰§è¡Œé¢„å…ˆè®¾å®šçš„ä»£ç </p></li><li><p>é˜»æ­¢åŸå§‹æ–¹æ³•çš„æ‰§è¡Œ</p></li></ul></li><li><p>æ€»ç»“</p><ul><li>æ‹¦æˆªå™¨å°±æ˜¯ç”¨æ¥ä½œå¢å¼º</li><li>ä½†æ˜¯è¿™ä¸ªæ‹¦æˆªå™¨åŒä¹‹å‰å­¦çš„è¿‡æ»¤å™¨å¾ˆåƒï¼Œä¸ç®¡æ˜¯ä»ä½œç”¨ä¸Šæ¥çœ‹è¿˜æ˜¯ä»æ‰§è¡Œé¡ºåºä¸Šæ¥çœ‹</li><li>é‚£ä¹ˆæ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ <ul><li>å½’å±ä¸åŒï¼š<code>Filter</code>å±äº<strong>Servlet</strong>æŠ€æœ¯ï¼Œè€Œ<code>Interceptor</code>å±äº<strong>SpringMVC</strong>æŠ€æœ¯</li><li>æ‹¦æˆªå†…å®¹ä¸åŒï¼š<code>Filter</code>å¯¹æ‰€æœ‰è®¿é—®è¿›è¡Œå¢å¼ºï¼Œ<code>Interceptor</code>ä»…å¯¹<strong>SpringMVC</strong>çš„è®¿é—®è¿›è¡Œå¢å¼º</li></ul></li></ul></li></ul></li></ol></li></ol><p></p><hr><h1 id="å•†æˆ·æŸ¥è¯¢ç¼“å­˜"><a href="#å•†æˆ·æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="å•†æˆ·æŸ¥è¯¢ç¼“å­˜"></a>å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h1><h2 id="ç¼“å­˜ä»‹ç»"><a href="#ç¼“å­˜ä»‹ç»" class="headerlink" title="ç¼“å­˜ä»‹ç»"></a>ç¼“å­˜ä»‹ç»</h2><h3 id="ä½•ä¸ºç¼“å­˜ï¼Ÿ"><a href="#ä½•ä¸ºç¼“å­˜ï¼Ÿ" class="headerlink" title="ä½•ä¸ºç¼“å­˜ï¼Ÿ"></a>ä½•ä¸ºç¼“å­˜ï¼Ÿ</h3><ul><li><p>ç¼“å­˜å°±åƒæ˜¯è‡ªè¡Œè½¦,è¶Šé‡è½¦çš„é¿éœ‡å™¨</p></li><li><p>ä¸¾ä¸ªä¾‹å­</p></li><li><p>è¶Šé‡è½¦,å±±åœ°è‡ªè¡Œè½¦,éƒ½æ‹¥æœ‰â€é¿éœ‡å™¨â€,<strong>é˜²æ­¢</strong>è½¦ä½“åŠ é€Ÿåå› æƒ¯æ€§,åœ¨é…·ä¼¼â€Uâ€å­—æ¯çš„åœ°å½¢ä¸Šé£è·ƒ,ç¡¬ç€é™†å¯¼è‡´çš„<strong>æŸå®³</strong>,åƒä¸ªå¼¹ç°§ä¸€æ ·</p></li><li><p>åŒæ ·,å®é™…å¼€å‘ä¸­,ç³»ç»Ÿä¹Ÿéœ€è¦â€é¿éœ‡å™¨â€,é˜²æ­¢è¿‡é«˜çš„æ•°æ®è®¿é—®çŒ›å†²ç³»ç»Ÿ,å¯¼è‡´å…¶æ“ä½œçº¿ç¨‹æ— æ³•åŠæ—¶å¤„ç†ä¿¡æ¯è€Œç˜«ç—ª</p></li><li><p><strong>ç¼“å­˜(Cache),å°±æ˜¯æ•°æ®äº¤æ¢çš„</strong>ç¼“å†²åŒº,ä¿—ç§°çš„ç¼“å­˜å°±æ˜¯<strong>ç¼“å†²åŒºå†…çš„æ•°æ®</strong>,ä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–,å­˜å‚¨äºæœ¬åœ°ï¼Œä¾‹å¦‚:</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ¬åœ°ç”¨äºé«˜å¹¶å‘</span></span><br><span class="line">Static <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(); </span><br><span class="line"><span class="comment">//ç”¨äºredisç­‰ç¼“å­˜</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;K,V&gt; USER_CACHE = CacheBuilder.newBuilder().build(); </span><br><span class="line"><span class="comment">//æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">Static <span class="keyword">final</span> Map&lt;K,V&gt; map =  <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br></pre></td></tr></table></figure><ul><li>ç”±äºå…¶è¢«<strong>Static</strong>ä¿®é¥°,æ‰€ä»¥éšç€ç±»çš„åŠ è½½è€Œè¢«åŠ è½½åˆ°<strong>å†…å­˜ä¹‹ä¸­</strong>,ä½œä¸ºæœ¬åœ°ç¼“å­˜,ç”±äºå…¶åˆè¢«<strong>final</strong>ä¿®é¥°,æ‰€ä»¥å…¶å¼•ç”¨(map)å’Œå¯¹è±¡(new HashMap())ä¹‹é—´çš„å…³ç³»æ˜¯å›ºå®šçš„,ä¸èƒ½æ”¹å˜,å› æ­¤ä¸ç”¨æ‹…å¿ƒèµ‹å€¼(&#x3D;)å¯¼è‡´ç¼“å­˜å¤±æ•ˆ</li></ul><h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜</h3><ol><li>ç¼“å­˜çš„ä½œç”¨<ol><li>é™ä½æœåŠ¡å™¨è´Ÿè½½</li><li>æé«˜æœåŠ¡è¯»å†™å“åº”é€Ÿåº¦</li></ol></li></ol><h3 id="å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ"><a href="#å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ"></a>å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ</h3><ul><li>å®é™…å¼€å‘ä¸­ï¼Œä¼šæ„ç­‘<strong>å¤šçº§ç¼“å­˜</strong>æ¥ä½¿ç³»ç»Ÿè¿è¡Œé€Ÿåº¦è¿›ä¸€æ­¥æå‡,ä¾‹å¦‚:æœ¬åœ°ç¼“å­˜ä¸redisä¸­çš„ç¼“å­˜å¹¶å‘ä½¿ç”¨</li><li>ç¼“å­˜ç±»åˆ«<ul><li><strong>æµè§ˆå™¨ç¼“å­˜</strong>ï¼šä¸»è¦æ˜¯å­˜åœ¨äºæµè§ˆå™¨ç«¯çš„ç¼“å­˜</li><li><strong>åº”ç”¨å±‚ç¼“å­˜ï¼š</strong>å¯ä»¥åˆ†ä¸ºtomcatæœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚ä¹‹å‰æåˆ°çš„mapï¼Œæˆ–è€…æ˜¯ä½¿ç”¨redisä½œä¸ºç¼“å­˜</li><li><strong>æ•°æ®åº“ç¼“å­˜ï¼š</strong>åœ¨æ•°æ®åº“ä¸­æœ‰ä¸€ç‰‡ç©ºé—´æ˜¯ buffer poolï¼Œå¢æ”¹æŸ¥æ•°æ®éƒ½ä¼šå…ˆåŠ è½½åˆ°mysqlçš„ç¼“å­˜ä¸­</li><li><strong>CPUç¼“å­˜ï¼š</strong>å½“ä»£è®¡ç®—æœºæœ€å¤§çš„é—®é¢˜æ˜¯ cpuæ€§èƒ½æå‡äº†ï¼Œä½†å†…å­˜è¯»å†™é€Ÿåº¦æ²¡æœ‰è·Ÿä¸Šï¼Œæ‰€ä»¥ä¸ºäº†é€‚åº”å½“ä¸‹çš„æƒ…å†µï¼Œå¢åŠ äº†cpuçš„L1ï¼ŒL2ï¼ŒL3çº§çš„ç¼“å­˜</li></ul></li><li>å¦‚å›¾<ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/TF29enWVtdBSNav.png" alt="img"></li></ul></li></ul><h3 id="æœ¬é¡¹ç›®ä½¿ç”¨ç¼“å­˜åŠå…¶å­˜åœ¨çš„é—®é¢˜"><a href="#æœ¬é¡¹ç›®ä½¿ç”¨ç¼“å­˜åŠå…¶å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="æœ¬é¡¹ç›®ä½¿ç”¨ç¼“å­˜åŠå…¶å­˜åœ¨çš„é—®é¢˜"></a>æœ¬é¡¹ç›®ä½¿ç”¨ç¼“å­˜åŠå…¶å­˜åœ¨çš„é—®é¢˜</h3><blockquote><p>è¯¦ç»†ä»‹ç»è§â€œç¼“å­˜â€</p></blockquote><ol><li><p>è¯¥é»‘é©¬ç‚¹è¯„ä¸‹é¡¹ç›®ï¼Œä¸»è¦æ˜¯ä½¿ç”¨Redisç¼“å­˜</p></li><li><p>Redisç¼“å­˜æœ‰ç€ä»¥ä¸‹é—®é¢˜</p><ol><li><p>ç¼“å­˜ç©¿é€</p></li><li><p>ç¼“å­˜é›ªå´©</p></li><li><p>ç¼“å­˜å‡»ç©¿</p></li></ol></li><li><p>Redisç¼“å­˜çš„æ›´æ–°ç­–ç•¥çš„é€‰æ‹©</p></li><li><p>å†…å­˜æ·˜æ±°</p></li><li><p>è¶…æ—¶å‰”é™¤</p></li><li><p>ä¸»åŠ¨æ›´æ–°</p></li></ol><h2 id="å•†æˆ·ç¼“å­˜æ·»åŠ "><a href="#å•†æˆ·ç¼“å­˜æ·»åŠ " class="headerlink" title="å•†æˆ·ç¼“å­˜æ·»åŠ "></a>å•†æˆ·ç¼“å­˜æ·»åŠ </h2><h3 id="ç¼“å­˜æ¨¡å‹å’Œæ€è·¯"><a href="#ç¼“å­˜æ¨¡å‹å’Œæ€è·¯" class="headerlink" title="ç¼“å­˜æ¨¡å‹å’Œæ€è·¯"></a>ç¼“å­˜æ¨¡å‹å’Œæ€è·¯</h3><ul><li><p>æ“ä½œæ–¹å¼</p></li><li><ul><li>æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥redisã€‚</li></ul></li><li><p>æµç¨‹å›¾</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/SeLHug4r79CMJox.png" alt="img"></li></ul></li></ul><h3 id="å•†æˆ·ç¼“å­˜æŸ¥è¯¢"><a href="#å•†æˆ·ç¼“å­˜æŸ¥è¯¢" class="headerlink" title="å•†æˆ·ç¼“å­˜æŸ¥è¯¢"></a>å•†æˆ·ç¼“å­˜æŸ¥è¯¢</h3><ol><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ol><li><p>GETè¯·æ±‚ï¼Œè¯·æ±‚è·¯å¾„ä¸º<code>/shop/&#123;id&#125;</code></p></li><li><p>è¯·æ±‚å‚æ•°ä¸º<code>Long id</code></p></li></ol></li><li><p>è¿”å›æ•°æ®å¯¹è±¡</p><ol><li><code>pojo/entity/Shop</code></li></ol></li><li><p>ä»£ç é€»è¾‘</p><ol><li>ä»redisä¸­æ ¹æ®å•†æˆ·idæŸ¥è¯¢ç¼“å­˜<ol><li>æœ‰ï¼Œç›´æ¥è¿”å›æ•°æ®</li><li>æ— ï¼Œæ ¹æ®å•†æˆ·idæŸ¥è¯¢æ•°æ®åº“<ol><li>æ— ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æœ‰ï¼Œå†™å…¥Redisï¼Œè¿”å›æ•°æ®</li></ol></li></ol></li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">shopStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="keyword">if</span> (shopStr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopStr, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.OPERATE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    stringRedisTemplate.opsForValue().set(RedisConstants.CACHE_SHOP_KEY+id,jsonStr);</span><br><span class="line">    stringRedisTemplate.expire(RedisConstants.CACHE_SHOP_KEY+id,RedisConstants.CACHE_SHOP_TTL,      TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><ul><li><p>åœ¨ç¼“å­˜æ›´æ–°ç­–ç•¥çš„é€‰æ‹©ä¸Šï¼Œé€šè¿‡â€œ<strong>ä¸»åŠ¨æ›´æ–°</strong>â€æ–¹å¼æ¥ç»å¤§ç¨‹åº¦ä¸Šä¿éšœâ€œ<strong>æ•°æ®ä¸€è‡´æ€§</strong>â€</p></li><li><p>åœ¨<strong>ä¸»åŠ¨æ›´æ–°çš„ä¸‰å¤§ç­–ç•¥ä¸­</strong>é€‰æ‹©Cache Aside Patternï¼ˆç”±ç¼“å­˜çš„è°ƒç”¨è€…ï¼Œåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰æ–¹å¼ï¼Œåœ¨å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œæ—¶ï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜</p><ul><li>è¿™æ ·åšçš„å¯¹æ•°æ®ä¸€è‡´æ€§è§£å†³çš„æ›´å¥½ï¼Œä½†æ˜¯å¯¹æ€§èƒ½çš„è¦æ±‚è¾ƒé«˜</li></ul></li><li><p><strong>è€Œåœ¨å¯¹ç¼“å­˜é—®é¢˜çš„å¤„ç†ä¸Š</strong></p><ul><li>å…ˆåˆ é™¤ç¼“å­˜</li><li>å•ä½“ç³»ç»Ÿâ€“ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li><li>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†å¤„ç†ç¼“å­˜</li></ul></li></ul><h3 id="å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´"><a href="#å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´" class="headerlink" title="å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´"></a>å®ç°å•†é“ºç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´</h3><ol><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ol><li>Putè¯·æ±‚ï¼Œè¯·æ±‚è·¯å¾„ä¸º<code>/shop</code></li><li>è¯·æ±‚å‚æ•°ä¸º<code>Shop shop</code></li></ol></li><li><p>å®ç°é€»è¾‘</p><ol><li><p>ç¡®ä¿ç¼“å­˜å¤„ç†å’Œæ•°æ®åº“æ“ä½œä¸ºä¸€ä¸ªåŸå­æ€§æ“ä½œ</p><ol><li>åœ¨æ›´æ–°æ–¹æ³•ä¸Šæ·»åŠ <code>@Transactional</code>æ³¨è§£</li></ol></li><li><p>å…ˆå¯¹shopæ•°æ®è¿›è¡Œæ•°æ®åº“ä¿®æ”¹</p><ol><li>å¤±è´¥ï¼Œè¿”å›å¼‚å¸¸ä¿¡æ¯</li><li>æˆåŠŸï¼Œåˆ é™¤è¯¥shopå¯¹åº”çš„ç¼“å­˜ä¿¡æ¯</li></ol></li><li><p>è¿”å›æˆåŠŸä¿¡æ¯</p></li></ol></li><li><p>å®ç°ä»£ç </p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (shop.getId() == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        shopMapper.updateById(shop);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_UPDATE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    stringRedisTemplate.delete(RedisConstants.CACHE_SHOP_KEY + shop.getId());</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰å¤§ç¼“å­˜é—®é¢˜"><a href="#ä¸‰å¤§ç¼“å­˜é—®é¢˜" class="headerlink" title="ä¸‰å¤§ç¼“å­˜é—®é¢˜"></a>ä¸‰å¤§ç¼“å­˜é—®é¢˜</h2><h3 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h3><ul><li><p>ç¼“å­˜ç©¿é€æŒ‡çš„æ˜¯å¤§é‡çš„è¯·æ±‚<strong>é¿å¼€äº†å¯¹ç¼“å­˜çš„è°ƒç”¨</strong>ï¼Œè€Œç›´æ¥å°†è¯·æ±‚æ‰“åˆ°äº†æ•°æ®åº“</p></li><li><p>ä¸¾ä¸ªä¾‹å­</p><ul><li>åœ¨å¯¹å•†æˆ·æŸ¥è¯¢æ˜¯é€šè¿‡<code>id</code>ï¼›å¦‚æœäººä¸ºä¿®æ”¹<code>id=-1</code>è¿›è¡Œæ¶æ„æŸ¥è¯¢</li><li><code>String shopStr = stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);</code>è¿”å›çš„<strong>shopStr</strong>ä¸€å®šä¸º<strong>null</strong>ï¼ˆä¸»é”®idç­–ç•¥ä¸ºautoï¼Œæ‰€ä»¥idä¸€å®š&gt;&#x3D;1ï¼‰ï¼Œä»è€Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ä¸­ï¼Œé€ æˆç ´å</li><li><code>Shop shop = shopMapper.selectById(id);</code>è¯¥å¯¹æ•°æ®çš„æŸ¥è¯¢ç»“æœ<strong>shop</strong>ä¹Ÿä¸€å®šä¸º<strong>nullï¼›</strong>æ—¢ä¸ä¼šå“åº”æ­£ç¡®æ•°æ®ï¼Œä¹Ÿä¸ä¼šç¼“å­˜æ•°æ®åˆ°redisä¸­ï¼Œé™·å…¥æ¶æ€§å¾ªç¯</li></ul></li><li><p>è§£å†³æ–¹æ³•</p><ol><li><strong>ç¼“å­˜nullå€¼</strong><ol><li>æˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚Redisé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§<strong>ä¸å­˜åœ¨çš„æ•°æ®</strong>ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯â€˜å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨â€™ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°Redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨Redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šæ‰“åˆ°åˆ°æ•°æ®åº“äº†</li></ol></li><li><strong>å¸ƒéš†è¿‡æ»¤å™¨</strong><ol><li>å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼›è¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®Redisï¼Œå“ªæ€•Redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°Redisä¸­ï¼›å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li><li>å¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</li></ol></li><li>æµç¨‹å›¾<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/Ki7VfZRHNEMCG9x.webp" alt="img"></li></ol></li><li><strong>å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹</strong><ol><li>å¯¹äºåŸºç¡€æ•°æ®è¡¨ä¸­idçš„è‡ªå¢ç­–ç•¥çš„ä¿®æ”¹</li></ol></li><li><strong>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</strong><ol><li>å¯¹idçš„ç‰¹åˆ¤ï¼Œä¾‹å¦‚ï¼Œå¯¹id&lt;&#x3D;0çš„è¯·æ±‚ç›´æ¥è¿”å›</li></ol></li><li><strong>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</strong></li><li><strong>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</strong></li></ol></li></ul><h4 id="ä»£ç é€»è¾‘ï¼ˆç¼“å­˜nullå€¼ï¼‰"><a href="#ä»£ç é€»è¾‘ï¼ˆç¼“å­˜nullå€¼ï¼‰" class="headerlink" title="ä»£ç é€»è¾‘ï¼ˆç¼“å­˜nullå€¼ï¼‰"></a>ä»£ç é€»è¾‘ï¼ˆç¼“å­˜nullå€¼ï¼‰</h4><ul><li>å¯¹idåˆ¤æ–­æ˜¯å¦&lt;&#x3D;0ä»¥åŠæ˜¯å¦ä¸ºnull<ul><li>æ˜¯ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>å¦ï¼Œé€šè¿‡idæŸ¥è¯¢ç¼“å­˜</li><li>ç©ºå€¼ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯<ul><li>æœ‰ï¼Œè¿”å›æ•°æ®ä¿¡æ¯</li><li>æ— ï¼ŒæŸ¥è¯¢æ•°æ®åº“<ul><li>æœ‰ï¼Œå†™å…¥redisï¼Œè¿”å›æ•°æ®</li><li>æ— ï¼Œå°†nullå€¼ä¹Ÿå†™å…¥redisï¼Œè¿”å›é”™è¯¯</li></ul></li></ul></li></ul></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(id == <span class="literal">null</span> || id &lt; SystemConstants.ONE )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">shopStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(shopStr, <span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopStr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopStr, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().</span><br><span class="line">                set(key,<span class="string">&quot;&quot;</span>,RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key,jsonStr);</span><br><span class="line">    stringRedisTemplate.expire(key,RedisConstants.CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/6u2dBt5fG9ObhLl.png" alt="img"></p><h4 id="ä»£ç é€»è¾‘ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰"><a href="#ä»£ç é€»è¾‘ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰" class="headerlink" title="ä»£ç é€»è¾‘ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰"></a>ä»£ç é€»è¾‘ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰</h4><ul><li><p>å®ç°åŸç†<code>https://www.cnblogs.com/z941030/p/9218356.html</code></p><ul><li><p>å¸ƒéš†è¿‡æ»¤å™¨å®ç°è¾ƒä¸ºå¤æ‚ï¼Œè¿™é‡Œé€šè¿‡å°è£…äº†å¸ƒéš†è¿‡æ»¤å™¨çš„Javaå·¥å…·ç±»åº“ï¼ˆ<code>https://www.hutool.cn/docs/#/</code>ï¼‰å®ç°ã€‚</p></li><li><p>å¯¼å…¥<code>hutool</code>çš„ä¾èµ–å³å¯</p></li></ul></li><li><p>æ ¹æ®<code>hutool</code>çš„å¸ƒéš†è¿‡æ»¤å™¨å®ç°è‡ªå®šä¹‰ä¸€ä¸ªå·¥å…·ç±»ï¼Œæ–¹ä¾¿ä½¿ç”¨</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingleBloomFilterUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰è¿‡æ»¤å™¨é¢„å…ˆå¼€è¾Ÿçš„æœ€å¤§åŒ…å«è®°å½•,é€šå¸¸è¦æ¯”é¢„è®¡å­˜å…¥çš„è®°å½•å¤šä¸€å€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CURRENT_BIT</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰è¿‡æ»¤å™¨é¢„è®¡æ‰€è¦åŒ…å«çš„è®°å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Hashå‡½æ•°ä¸ªæ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_NUMBER</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BitMapçš„å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">M</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BitSetBloomFilter BIT_SET_BLOOM_FILTER;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BitMapBloomFilter BIT_MAP_BLOOM_FILTER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–é…ç½®</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">     <span class="keyword">static</span> &#123;</span><br><span class="line">        BIT_SET_BLOOM_FILTER = BloomFilterUtil.createBitSet(CURRENT_BIT, N, HASH_NUMBER);</span><br><span class="line">        BIT_MAP_BLOOM_FILTER = BloomFilterUtil.createBitMap(M);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å®ç°é€»è¾‘</p><ul><li><p>æ·»åŠ å•†æˆ·æ•°æ®</p><ul><li>å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æˆåŠŸï¼Œæ·»åŠ å¯¹åº”å­—ç¬¦ä¸²ï¼ˆKEYï¼‰åˆ°å¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¿”å›æˆåŠŸä¿¡æ¯ã€‚</li></ul></li><li><p>æŸ¥è¯¢å•†æˆ·æ•°æ®</p><ul><li>æŸ¥çœ‹è¯·æ±‚ä¸­çš„å•†æˆ·idç”Ÿæˆçš„KEYæ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­<ul><li>ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>å­˜åœ¨ï¼Œæ”¾è¡Œåˆ°Redisä¸­æŸ¥è¯¢</li><li>åç»­é€»è¾‘ä¸€è‡´</li></ul></li></ul></li></ul></li><li><p>å®ç°ä»£ç </p><ol><li>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡<ol><li>Postè¯·æ±‚ <code>/shop</code></li><li>è¯·æ±‚å‚æ•°ä¸º<code>Shop shop</code></li></ol></li></ol></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ·»åŠ å•†æˆ·æ•°æ®</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveShop</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        shopMapper.insert(shop);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> shop.getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY+id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">add</span> <span class="operator">=</span> SingleBloomFilterUtil.BIT_MAP_BLOOM_FILTER.add(key);</span><br><span class="line">    <span class="keyword">if</span> (!add)&#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ·»åŠ å¸ƒéš†è¿‡æ»¤å™¨é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(id == <span class="literal">null</span> || id &lt; SystemConstants.ONE )&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">contains</span> <span class="operator">=</span> SingleBloomFilterUtil.BIT_MAP_BLOOM_FILTER.contains(key);</span><br><span class="line">    <span class="keyword">if</span> (!contains)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">shopStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (shopStr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopStr, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key,jsonStr);</span><br><span class="line">    stringRedisTemplate.expire(key,RedisConstants.CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h3><ul><li><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨<strong>åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆ</strong>æˆ–è€…<strong>RedisæœåŠ¡å®•æœº</strong>ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›</p></li><li><p>å½¢è±¡åœ°è¯´å°±æ˜¯Redisä¸å·¥ä½œäº†ï¼Œè®¸å¤šå®¢æˆ·åœ°è¯·æ±‚éƒ½è½¬å‘äº†æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/wHomaTDXNALB5ht.webp" alt="img"></li></ul></li><li><p>è¿™é‡Œåœ°è§£å†³å¯¹è±¡ä¸»è¦åˆ†ä¸º2ç§</p><ol><li><p><strong>é’ˆå¯¹æ•°æ®åŒæ—¶è¿‡æœŸå¤„ç†æ–¹æ¡ˆ</strong></p><ol><li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼›ç¡®ä¿å¤§é‡åœ°keyä¸ä¼šåŒä¸€æ—¶é—´å¤±æ•ˆ</li><li>è®¾ç½®å¤šçº§ç¼“å­˜<ol><li>æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜</li><li>è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯ï¼Œè¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜</li><li>å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰</li><li>å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcatï¼›è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜ï¼›å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li></ol></li></ol></li><li><p><strong>RedisæœåŠ¡å®•æœºæ–¹æ¡ˆï¼ˆé›†ç¾¤ã€é™çº§é™æµæ¶‰åŠå¾®æœåŠ¡æ¶æ„ï¼Œè¿™é‡Œäº†è§£å³å¯)</strong></p><ol><li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li><li>æœåŠ¡ç†”æ–­æˆ–è¯·æ±‚é™æµæœºåˆ¶</li></ol></li></ol></li><li><p><strong>ä»£ç å®ç°</strong></p></li><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ul><li>GETè¯·æ±‚ï¼Œè¯·æ±‚è·¯å¾„ä¸º<code>/shop/&#123;id&#125;</code></li><li>è¯·æ±‚å‚æ•°ä¸º<code>Long id</code></li></ul></li><li><p>ä»£ç é€»è¾‘</p><ul><li>å¯¹Redisç¼“å­˜çš„TTLåšä¿®æ”¹å³å¯</li><li>æ–°å»ºä¸€ä¸ªç¼“å­˜å·¥å…·ç±»</li></ul></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheUtil</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cache</span><span class="params">(String key,String value, <span class="type">long</span> ttl, TimeUnit unit)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key,value,ttl,unit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç¼“å­˜å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æŠŠéšæœºæ•°åŠ åŸºæœ¬ç¼“å­˜æ—¶é—´ä½œä¸ºæ•´ä½“TTL</strong></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//0-9çš„éšæœºæ•°</span></span><br><span class="line"><span class="type">String</span> <span class="variable">randomTime</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//è‡ªåŠ¨æ‹†/è£…</span></span><br><span class="line"><span class="type">long</span> <span class="variable">keyTtl</span> <span class="operator">=</span> Long.parseLong(randomTime) + RedisConstants.CACHE_SHOP_TTL;</span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„å·¥å…·ç±»ä½¿ç”¨</span></span><br><span class="line">cacheUtil.cache(key,jsonStr,keyTtl,TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure><ul><li><p>å®ç°æˆåŠŸæ ‡è¯†</p><ul><li><p>ç‚¹å‡»<code>ç¾é£Ÿ-&gt;102èŒ¶é¤å…</code></p></li><li><p>æŸ¥çœ‹ç¼“å­˜ä¿¡æ¯ï¼ŒTTLæ˜¯ä¸€ä¸ªå›ºå®šå€¼åŠ ä¸Šéšæœºå€¼</p></li><li><p>å†æ¬¡åˆ·æ–°æµè§ˆå™¨ï¼Œè‹¥æ²¡æœ‰è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œåˆ™æˆåŠŸ</p></li></ul></li></ul><h3 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h3><ul><li><p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«<strong>çƒ­ç‚¹Key</strong>é—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«<strong>é«˜å¹¶å‘è®¿é—®</strong>å¹¶ä¸”ç¼“å­˜<strong>é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚</strong>çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„<strong>å†²å‡»</strong></p></li><li><p>å½¢è±¡æ¥è¯´ï¼Œå°±æ˜¯æœ‰ä¸€ä¸ªå•†å®¶è¢«éå¸¸å¤šçš„äººå…‰é¡¾ï¼ˆè¯·æ±‚ï¼‰ï¼›ä½†æ˜¯æœ‰ä¸€å¤©ğŸ”‘åäº†ï¼Œå¹¶ä¸”ä¿®å¤è¿™æŠŠé’¥åŒ™èŠ±è´¹çš„æ—¶é—´è¾ƒé•¿ï¼Œè¿™æ—¶å°±æœ‰éå¸¸å¤šçš„å®¢äººè¢«æ‹’ä¹‹é—¨å¤–æ— æ³•æŸ¥çœ‹ï¼ˆæ— æ³•è·å–ç¼“å­˜ï¼‰ï¼Œå®ƒä»¬åªå¥½ä¸€è‚¡è„‘åœ°å»æ‰¾è€æ¿å¼€é—¨ï¼ˆå¯¹æ•°æ®åº“è¯·æ±‚ï¼‰ï¼Œä½†ç”±äºæ•°é‡å¤ªå¤šã€ä¿®å¤æ—¶é—´é•¿ï¼Œè€æ¿çš„å®¶ç‚¸äº†ï¼ˆæ•°æ®åº“æ— æ³•æ‰¿å—è¿™äº›å‹åŠ›ï¼‰</p></li><li><p>åŒºåˆ†</p><ul><li>ç¼“å­˜ç©¿é€æ˜¯æ²¡æœ‰æ•°æ®è€Œç»•è¿‡RedisæŸ¥è¯¢ï¼Œä¸”æ•°æ®åº“ä¹Ÿæ— æ³•è·å–æ•°æ®</li><li>ç¼“å­˜å‡»ç©¿æ˜¯Redisä¸­çš„æ•°æ®å¤±æ•ˆäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼Œåªä¸è¿‡è®¿é—®é‡è¿‡äºåºå¤§</li></ul></li><li><p>ç¼“å­˜å‡»ç©¿é—®é¢˜åˆ†æ</p><ul><li>å‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®é‡æ–°åŠ è½½åˆ°ç¼“å­˜çš„ï¼Œæ­¤æ—¶åªè¦çº¿ç¨‹1èµ°å®Œè¿™ä¸ªé€»è¾‘ï¼Œå…¶ä»–çº¿ç¨‹å°±éƒ½èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ï¼Œä½†æ˜¯å‡è®¾åœ¨çº¿ç¨‹1æ²¡æœ‰èµ°å®Œçš„æ—¶å€™ï¼Œåç»­çš„çº¿ç¨‹2ï¼Œçº¿ç¨‹3ï¼Œçº¿ç¨‹4åŒæ—¶è¿‡æ¥è®¿é—®å½“å‰è¿™ä¸ªæ–¹æ³•ï¼Œ é‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåŒä¸€æ—¶åˆ»æ¥è®¿é—®æŸ¥è¯¢ç¼“å­˜ï¼Œéƒ½æ²¡æŸ¥åˆ°ï¼Œæ¥ç€åŒä¸€æ—¶é—´å»è®¿é—®æ•°æ®åº“ï¼ŒåŒæ—¶çš„å»æ‰§è¡Œæ•°æ®åº“ä»£ç ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/8NcgrRnM7VPFt5u.png" alt="img"></li></ul></li><li><p>è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§</p><ol><li><strong>äº’æ–¥é”</strong></li><li><strong>é€»è¾‘è¿‡æœŸ</strong></li></ol></li></ul><h4 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h4><ol><li><p>å› ä¸ºé”èƒ½å®ç°äº’æ–¥æ€§ã€‚å‡è®¾çº¿ç¨‹è¿‡æ¥ï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„æ¥è®¿é—®æ•°æ®åº“ï¼Œä»è€Œé¿å…å¯¹äºæ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå› ä¸ºæ­¤æ—¶ä¼šè®©æŸ¥è¯¢ä»<strong>å¹¶è¡Œå˜æˆäº†ä¸²è¡Œ</strong>ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨<strong>tryLockæ–¹æ³• + double check</strong>æ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p></li><li><p>å‡è®¾ç°åœ¨çº¿ç¨‹1è¿‡æ¥è®¿é—®ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä»–è·å¾—åˆ°äº†é”çš„èµ„æºï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šä¸€ä¸ªäººå»æ‰§è¡Œé€»è¾‘ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è·å¾—åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹2å°±å¯ä»¥è¿›è¡Œåˆ°ä¼‘çœ ï¼Œç›´åˆ°çº¿ç¨‹1æŠŠé”é‡Šæ”¾åï¼Œçº¿ç¨‹2è·å¾—åˆ°é”ï¼Œç„¶åå†æ¥æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æ‹¿åˆ°æ•°æ®äº†</p></li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/fJsEceWOzwG637q.png" alt="img" style="zoom:50%;" /></li><li><p>å‰ç½®çŸ¥è¯†</p><ol><li>åˆ©ç”¨Redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯redisä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œåœ¨<code>stringRedisTemplate</code>è°ƒç”¨çš„æ–¹æ³•ä¸­è¿”å›trueï¼Œ å¦‚æœæœ‰è¿™ä¸ªkeyåˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨<code>stringRedisTemplate</code>è°ƒç”¨çš„æ–¹æ³•ä¸­è¿”å›falseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡trueï¼Œæˆ–è€…æ˜¯falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥keyï¼ŒæˆåŠŸæ’å…¥çš„keyçš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹</li></ol></li><li><p>æµç¨‹å›¾</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/ARcgeuNtTh1sviL.png" alt="img"></li></ol></li><li><p>ä»£ç é€»è¾‘</p><ol><li>æ ¹æ®idæŸ¥è¯¢ç¼“å­˜<ol><li>å‘½ä¸­ï¼Œç›´æ¥è¿”å›</li><li>æœªå‘½ä¸­ï¼Œå°è¯•è·å–é”<ol><li>è·å–å¤±è´¥ï¼Œä¼‘çœ ã€åŒé‡æ£€æŸ¥ï¼ˆåˆ¤æ–­ï¼‰ã€é‡æ–°æŸ¥æ‰¾ï¼ˆé€’å½’ï¼‰</li><li>æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“<ol><li>æ— ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æœ‰ï¼Œå†™å…¥Rediså¹¶è¿”å›æ•°æ®</li><li>é‡Šæ”¾é”</li></ol></li></ol></li></ol></li></ol></li><li><p>å…·ä½“ä»£ç </p><ol><li>RedisUtil</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key,String value)</span>&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®è¶…æ—¶æ—¶é—´é˜²æ­¢æ­»é”</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> stringRedisTemplate</span><br><span class="line">            .opsForValue()</span><br><span class="line">            .setIfAbsent(key, value,RedisConstants.LOCK_SHOP_TTL,</span><br><span class="line">                    TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><code>queryWithMutex</code>å®ç°</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(id == <span class="literal">null</span> || id &lt; SystemConstants.ONE )&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shopStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (shopStr != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopStr, Shop.class);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é”çš„key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="comment">//é”çš„æ˜¯idå¯¹åº”çš„å•†æˆ·æŸ¥è¯¢çº¿ç¨‹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockValue</span> <span class="operator">=</span> RandomUtil.randomString(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">//ç”³æ˜shop</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> redisUtil.tryLock(lockKey, lockValue);</span><br><span class="line">            <span class="comment">//è·å–å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                Thread.sleep(RedisConstants.TTL * <span class="number">10</span>);</span><br><span class="line">                <span class="comment">//åŒé‡æ£€æŸ¥</span></span><br><span class="line">                shopStr = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">                <span class="keyword">if</span> (shopStr != <span class="literal">null</span>)&#123;</span><br><span class="line">                    shop = JSONUtil.toBean(shopStr, Shop.class);</span><br><span class="line">                    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å†æ¬¡å°è¯•</span></span><br><span class="line">                queryWithMutex(id);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è·å–æˆåŠŸ</span></span><br><span class="line">            shop = shopMapper.selectById(id);</span><br><span class="line">            <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å†™å…¥redis</span></span><br><span class="line">            shopStr = JSONUtil.toJsonStr(shop);</span><br><span class="line">          stringRedisTemplate.opsForValue().</span><br><span class="line">              set(key,shopStr,RedisConstants.CACHE_SHOP_TTL,TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisUtil.unlock(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨Jmeterè¿›è¡Œæµ‹è¯• </p><ol><li>é¦–å…ˆå°†Redisä¸­çš„çƒ­ç‚¹å•†å“æ•°æ®åˆ é™¤ï¼Œæ¨¡æ‹ŸTTLåˆ°æœŸï¼Œç„¶åç”¨Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œå¼€100ä¸ªçº¿ç¨‹æ¥è®¿é—®è¿™ä¸ªæ²¡æœ‰ç¼“å­˜çš„çƒ­ç‚¹æ•°æ®</li><li>å¦‚æœåå°æ—¥å¿—<strong>åªè¾“å‡ºäº†ä¸€æ¡SQLè¯­å¥</strong>ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„äº’æ–¥é”æ˜¯ç”Ÿæ•ˆçš„ï¼Œæ²¡æœ‰é€ æˆå¤§é‡ç”¨æˆ·éƒ½å»æŸ¥è¯¢æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLè¯­å¥ã€‚</li></ol></li></ol><h4 id="é€»è¾‘è¿‡æœŸ"><a href="#é€»è¾‘è¿‡æœŸ" class="headerlink" title="é€»è¾‘è¿‡æœŸ"></a>é€»è¾‘è¿‡æœŸ</h4><ol><li><p>é€»è¾‘è¿‡æœŸæ˜¯æŒ‡ä¸ç»™<strong>çƒ­ç‚¹KEY</strong>è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè€Œæ˜¯æ‰‹åŠ¨ç»™<strong>çƒ­ç‚¹KEY</strong>è®¾ç½®<strong>é€»è¾‘è¿‡æœŸå€¼</strong>ï¼Œè¿™æ ·é™¤äº†Redisé›†ç¾¤å®•æœºï¼Œå¦åˆ™çš„è¯éƒ½å¯ä»¥è·å–åˆ°çƒ­ç‚¹æ•°æ®ï¼ˆçƒ­ç‚¹keyä¸ä¼šå¤±æ•ˆï¼‰ï¼›ä¸è¿‡åœ¨å¯¹æ•°æ®çš„ç²¾ç¡®ä¸Šéœ€è¦æ ¹æ®é€»è¾‘è¿‡æœŸå€¼æ¥åˆ¤æ–­</p></li><li><p>é€»è¾‘åˆ†æ</p><ol><li>å½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢Redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›Redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”</li></ol></li><li><p>æµç¨‹å›¾</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/x4sVjAmkf2RtXeJ.png" alt="img"></li></ol></li><li><p>è®¾è®¡é€»è¾‘è¿‡æœŸå€¼</p><ol><li>æ•°æ®ç¼“å­˜æ—¶ï¼Œå¯¹<code>shop</code>æ•°æ®å¤šä¸€ä¸ª<code>expiredTime</code>å­—æ®µå€¼<ol><li>å¯¹<code>Shop</code>ç±»æ–°å¢å­—æ®µ<code>expiredTime</code>ï¼ˆä¾µå…¥æ€§ä¸”å¯¹å®ä½“ç±»åšäº†ä¿®æ”¹ï¼‰</li><li>æ–°å»ºRedisDataå±æ€§ç±»ï¼Œå«é€»è¾‘è¿‡æœŸå­—æ®µï¼Œç»§æ‰¿<code>Shop</code>ï¼ˆå¯ä»¥ï¼‰</li><li>æ–°å»ºRedisDataå±æ€§ç±»ï¼Œå«é€»è¾‘è¿‡æœŸå­—æ®µå’Œ<code>Object data</code>-&gt;<code>Shop</code>ï¼ˆæœ€å¥½ï¼‰</li></ol></li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="comment">//è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="comment">//å•†æˆ·æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><p>ä»£ç é€»è¾‘</p><ol><li>å¯¹éœ€è¦ç¼“å­˜çš„æ•°æ®é¢„å¤„ç†<ol><li>å°†é€»è¾‘è¿‡æœŸå€¼åœ¨æ·»åŠ å•†æˆ·çš„æ—¶å€™å°±è¿›è¡Œç¼“å­˜</li></ol></li><li>æ ¹æ®idæŸ¥è¯¢ç¼“å­˜<ol><li>æœªå‘½ä¸­ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>å‘½ä¸­ï¼ŒæŸ¥çœ‹é€»è¾‘è¿‡æœŸå€¼æ˜¯å¦è¿‡æœŸ<ol><li>æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›æ•°æ®</li><li>è¿‡æœŸï¼Œå°è¯•è·å–é”<ol><li>å¤±è´¥ï¼Œè¿”å›æ—§çš„å•†æˆ·ä¿¡æ¯(ä¸ç²¾ç¡®) + æ¶ˆæ¯æç¤ºè¯´æ˜</li><li>æˆåŠŸï¼Œ<strong>å¼€å¯ç‹¬ç«‹çº¿ç¨‹</strong>ï¼ˆç¼“å­˜é‡å»ºï¼‰<ol><li>æŸ¥è¯¢æ•°æ®åº“ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰<ol><li>å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯(æ²¡æœ‰ç‰¹æ®Šæƒ…å†µéƒ½æ˜¯ä¸€å®šæœ‰)</li><li>æˆåŠŸï¼Œå†™å…¥Redisï¼Œè®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´</li><li>è¿”å›æ•°æ®</li></ol></li></ol></li></ol></li><li>é‡Šæ”¾é”</li></ol></li></ol></li></ol></li><li><p>ç¼“å­˜é¢„å¤„ç†ä»£ç </p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜é¢„çƒ­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveShopWithRedisData</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE)&#123;</span><br><span class="line">        log.error(MessageConstants.ID_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">        log.info(MessageConstants.CACHE_PRE_SAVE_SUCCESS);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é€»è¾‘è¿‡æœŸå€¼2åˆ†é’Ÿ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span>  <span class="operator">=</span> LocalDateTime.now().plusSeconds(RedisConstants.CACHE_NULL_TTL);</span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> RedisData.builder()</span><br><span class="line">            .expireTime(expireTime)</span><br><span class="line">            .data(shop).build();</span><br><span class="line">    <span class="type">String</span> <span class="variable">redisDataStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(redisData);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key,redisDataStr);</span><br><span class="line">    log.info(MessageConstants.CACHE_PRE_SAVE_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="7"><li>ç¼“å­˜é‡å»ºä»£ç </li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–ç¼“å­˜é‡å»ºä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getCacheRunnable2</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å»ºç«‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopMapper.selectById(id);</span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é€»è¾‘è¿‡æœŸå€¼2åˆ†é’Ÿ</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span>  <span class="operator">=</span> LocalDateTime.now().plusSeconds(RedisConstants.CACHE_SHOP_TTL);</span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> RedisData.builder()</span><br><span class="line">                .expireTime(expireTime)</span><br><span class="line">                .data(shop).build();</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisDataStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(redisData);</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">        <span class="comment">//å†™å…¥redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,redisDataStr);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="7"><li>çº¿ç¨‹æ± åˆ›å»º<ol><li>åˆ›å»ºçº¿ç¨‹æ± ï¼ˆæ‰‹åŠ¨ï¼Œé»‘é©¬é€šè¿‡<code>Executors</code>å·¥å…·è‡ªåŠ¨ç”Ÿæˆçº¿ç¨‹æ± {<strong>ä¸æ¨è</strong>ï¼‰</li><li>åŸå› å¯çœ‹ï¼Œ<a href="https://blog.csdn.net/weixin_43702295/article/details/135354378?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-135354378-blog-132420498.235%5Ev43%5Epc_blog_bottom_relevance_base8&spm=1001.2101.3001.4242.1&utm_relevant_index=3">ThreadPoolExecutoræ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± </a></li><li>å…·ä½“å‚æ•°è¯´æ˜<code>https://blog.csdn.net/c85736722/article/details/135738604</code></li><li>å¢å¼ºï¼Œè½»é‡çº§çš„åŠ¨æ€å¯æ§çº¿ç¨‹æ± &#96;<a href="https://dynamictp.cn/%60%60%60">https://dynamictp.cn/```</a></li><li>&#96;&#96;&#96;excute&amp;submit<code>æ–¹æ³•çš„ä½¿ç”¨åŒºåˆ«</code><a href="https://www.cnblogs.com/jxxblogs/p/11882381.html%60">https://www.cnblogs.com/jxxblogs/p/11882381.html`</a></li><li>æµç¨‹å›¾<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/sMIaeoTgH6WnB4u.webp" alt="img"></li></ol></li><li>çº¿ç¨‹æ± å·¥å…·ç±»</li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIZE_CORE_POOL</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIZE_MAX_POOL</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜æ´»æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ALIVE_TIME</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—(ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—å¯ä»¥é¿å…èµ„æºè€—å°½çš„é—®é¢˜)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;Runnable&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼ŒAbortPolicy() æŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RejectedExecutionHandler</span> <span class="variable">DEFAULT_HANDLER</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">pool</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(SIZE_CORE_POOL,</span><br><span class="line">                    SIZE_MAX_POOL,</span><br><span class="line">                    ALIVE_TIME,</span><br><span class="line">                    TimeUnit.MILLISECONDS,</span><br><span class="line">                    queue,</span><br><span class="line">                    ThreadPoolUtil.myDefaultThreadFactory(),</span><br><span class="line">                    DEFAULT_HANDLER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é¢„å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        pool.prestartAllCoreThreads();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">     * â€˜<span class="doctag">@Data</span>â€™æ³¨è§£å¯¹staticå˜é‡æ— æ•ˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">getPool</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadFactory <span class="title function_">myDefaultThreadFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyDefaultThreadFactory</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</span></span><br><span class="line"><span class="comment">     * ç”¨äºåˆ›å»ºå…·æœ‰ç‰¹å®šå‘½åè§„åˆ™å’Œé»˜è®¤å±æ€§çš„æ–°çº¿ç¨‹,æ–¹ä¾¿å‡ºé”™æ—¶å›æº¯</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œå’Œæºç ä¸€è‡´-Executors.defaultThreadFactory()çš„æºç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyDefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸€ä¸ªåŸå­æ•´æ•°ï¼Œç”¨äºç”Ÿæˆçº¿ç¨‹æ± ç¼–å·</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">POOL_NUMBER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//çº¿ç¨‹ç»„ï¼Œç”¨äºæŒ‡å®šæ–°çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹ç»„</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</span><br><span class="line">        <span class="comment">//ä¸€ä¸ªåŸå­æ•´æ•°ï¼Œç”¨äºç”Ÿæˆçº¿ç¨‹ç¼–å·</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">threadNumber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//çº¿ç¨‹åç§°å‰ç¼€ï¼Œç”¨äºæ ‡è¯†çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹æ± å’Œçº¿ç¨‹ç¼–å·</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å‘Šè¯‰ç¼–è¯‘å™¨å¿½ç•¥ä¸&quot;removal&quot;ç›¸å…³çš„è­¦å‘Š,ç”¨äºå¤„ç†å³å°†è¢«ç§»é™¤æˆ–å·²è¿‡æ—¶çš„APIæ—¶</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;removal&quot;)</span></span><br><span class="line">        MyDefaultThreadFactory() &#123;</span><br><span class="line">            <span class="type">SecurityManager</span> <span class="variable">s</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">            group = (s != <span class="literal">null</span>) ? s.getThreadGroup() :</span><br><span class="line">                    Thread.currentThread().getThreadGroup();</span><br><span class="line">            <span class="comment">//è®¾ç½®çº¿ç¨‹åç§°å‰ç¼€</span></span><br><span class="line">            namePrefix = <span class="string">&quot;pool-&quot;</span> +</span><br><span class="line">                    POOL_NUMBER.getAndIncrement() +</span><br><span class="line">                    <span class="string">&quot;-thread-&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(<span class="meta">@NonNull</span> Runnable r)</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œä¼ å…¥çº¿ç¨‹ç»„ã€ä»»åŠ¡ï¼ˆRunnableå¯¹è±¡ï¼‰ã€çº¿ç¨‹åç§°å’Œæ ˆå¤§å°</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(group, r,</span><br><span class="line">                    namePrefix + threadNumber.getAndIncrement(),</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//è®¾ç½®çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (t.isDaemon()) &#123;</span><br><span class="line">                t.setDaemon(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¸ºæ­£å¸¸ä¼˜å…ˆçº§ï¼ˆNORM_PRIORITYï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY) &#123;</span><br><span class="line">                t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="8"><li>å…·ä½“ä»£ç </li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryWithLogicalExpire</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">redisDataStr</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(redisDataStr, RedisData.class);</span><br><span class="line">    <span class="keyword">if</span> (redisDataStr == <span class="literal">null</span> || redisData == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–é€»è¾‘è¿‡æœŸå€¼</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">//å•†æˆ·æ•°æ®,è¿™é‡Œçš„è½¬æ¢å¾ˆé‡è¦</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="comment">//å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(now))&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//è·å–çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="type">ThreadPoolExecutor</span> <span class="variable">pool</span> <span class="operator">=</span> threadPoolUtil.getPool();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> redisUtil.tryLock(lockKey, RedisConstants.KEY_VALUE);</span><br><span class="line">        <span class="comment">//è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">            <span class="comment">//è·å–ä»»åŠ¡</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">cacheRunnable</span> <span class="operator">=</span> getCacheRunnable2(id);</span><br><span class="line">            <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            pool.execute(cacheRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        redisUtil.unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›æ—§æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="9"><li><p>ä½¿ç”¨Jmeterè¿›è¡Œæµ‹è¯• </p><ul><li><p>å…ˆæ¥å¤ç°ä¸€éåœºæ™¯ï¼Œå½“æŸä¸ªç”¨æˆ·å»Redisä¸­è®¿é—®ç¼“å­˜çš„æ•°æ®æ—¶ï¼Œå‘ç°è¯¥æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œäºæ˜¯æ–°å¼€ä¸€ä¸ªçº¿ç¨‹å»é‡æ„ç¼“å­˜æ•°æ®ï¼Œä½†åœ¨é‡æ„å®Œæˆä¹‹å‰ï¼Œç”¨æˆ·å¾—åˆ°çš„æ•°æ®éƒ½æ˜¯æ—§æ•°æ®ï¼Œé‡æ„å®Œæˆä¹‹åï¼Œæ‰æ˜¯æ–°æ•°æ®</p></li><li><p>æˆ‘æŠŠé€»è¾‘è¿‡æœŸæ–¹æ³•ä½œä¸ºä¸€ä¸ªæ–°çš„è¯·æ±‚<code>/cache/&#123;id&#125;</code>,æ‰€ä»¥å…ˆå‘é€ä¸€ä¸ªè¯¥è¯·æ±‚å®Œæˆ<strong>ç¼“å­˜é¢„çƒ­</strong>ï¼Œè¿‡æœŸæ—¶é—´ä¸º2åˆ†é’Ÿï¼Œä½¿å…¶å¿«é€Ÿè¿‡æœŸï¼›å†ä½¿ç”¨åŸºäºé€»è¾‘è¿‡æœŸçš„è¯·æ±‚æ–¹æ³•æŸ¥è¯¢å•†æˆ·ä¿¡æ¯</p></li><li><p>ä¹‹åå»æ•°æ®åº“æŠŠè¿™ä¸ªæ•°æ®ä¿®æ”¹ä¸€ä¸‹ï¼Œè¿™æ ·é€»è¾‘è¿‡æœŸå‰å’Œé€»è¾‘è¿‡æœŸåçš„æ•°æ®å°±ä¸ä¸€è‡´ï¼Œå½“ç”¨æˆ·æ¥è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦èŠ±æ—¶é—´æ¥è¿›è¡Œé‡æ„ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„å®Œæˆä¹‹å‰ï¼Œéƒ½åªèƒ½è·å¾—è„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¿®æ”¹å‰çš„æ•°æ®ï¼‰ï¼Œåªæœ‰å½“é‡æ„å®Œæ¯•ä¹‹åï¼Œæ‰èƒ½è·å¾—æ–°æ•°æ®ï¼ˆæˆ‘ä»¬ä¿®æ”¹åçš„æ•°æ®ï¼‰  </p></li><li><p>æ³¨æ„ï¼šæµ‹è¯•çº¿ç¨‹æ•°ä¸èƒ½è¿‡å¤§ï¼Œå¦åˆ™çº¿ç¨‹æ± ä¼šçˆ†æ‰</p></li><li><p>ç»“æœ</p><ul><li>å‰ä¸¤åˆ†é’Ÿé€»è¾‘è¿‡æœŸå€¼å­˜åœ¨ï¼Œæ§åˆ¶å°ä¸ä¼šè¾“å‡ºsqlæŸ¥è¯¢ï¼›ç»“æŸåï¼Œé€šè¿‡jmeteræµ‹è¯•ï¼Œé€»è¾‘ç¼“å­˜æ—¶é—´å˜ä¸ºä¸º30åˆ†é’Ÿï¼Œä¸”ç¼“å­˜æ•°æ®å¾—åˆ°ä¿®æ”¹</li></ul></li></ul></li><li><p>ç¼“å­˜æ•ˆæœå›¾</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/dgj3bwH1LocX7uz.png" alt="img"></p></li><li><p>äº’æ–¥é”ä¸é€»è¾‘è¿‡æœŸæ¯”è¾ƒå›¾</p></li><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/05/dgj3bwH1LocX7uz.png" alt="img"></p></li></ol><h3 id="ç¼“å­˜å·¥å…·ç±»"><a href="#ç¼“å­˜å·¥å…·ç±»" class="headerlink" title="ç¼“å­˜å·¥å…·ç±»"></a>ç¼“å­˜å·¥å…·ç±»</h3><ul><li>å¯¹äºç¼“å­˜é—®é¢˜çš„è§£å†³ï¼Œéƒ½æ˜¯ç‰¹å®šæƒ…å†µç‰¹å®šä½¿ç”¨ï¼Œå› æ­¤ä¼šå»æ„å»ºä¸€ä¸ªç¼“å­˜å·¥å…·ç±»æ¥ä½¿ç”¨</li><li>è¿™é‡Œç›´æ¥è´´é»‘å—ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicalExpire</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®é€»è¾‘è¿‡æœŸ</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));</span><br><span class="line">        <span class="comment">// å†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R,ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        <span class="comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å°†ç©ºå€¼å†™å…¥redis</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="comment">// è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥redis</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, unit);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">            <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">        <span class="comment">// 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="comment">// 6.ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="comment">// 6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (isLock)&#123;</span><br><span class="line">            <span class="comment">// 6.3.æˆåŠŸï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">                    <span class="type">R</span> <span class="variable">newR</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                    <span class="comment">// é‡å»ºç¼“å­˜</span></span><br><span class="line">                    <span class="built_in">this</span>.setWithLogicalExpire(key, newR, time, unit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                    unlock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯w</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">            <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(shopJson, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">        <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.å®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="comment">// 4.1.è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">            <span class="comment">// 4.2.åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">                <span class="comment">// 4.3.è·å–é”å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•</span></span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 4.4.è·å–é”æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            r = dbFallback.apply(id);</span><br><span class="line">            <span class="comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å°†ç©ºå€¼å†™å…¥redis</span></span><br><span class="line">                stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">                <span class="comment">// è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 6.å­˜åœ¨ï¼Œå†™å…¥redis</span></span><br><span class="line">            <span class="built_in">this</span>.set(key, r, time, unit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7.é‡Šæ”¾é”</span></span><br><span class="line">            unlock(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="ä¼˜æƒ å·ç§’æ€"><a href="#ä¼˜æƒ å·ç§’æ€" class="headerlink" title="ä¼˜æƒ å·ç§’æ€"></a>ä¼˜æƒ å·ç§’æ€</h1><h2 id="Rediså®ç°å…¨å±€å”¯ä¸€ID"><a href="#Rediså®ç°å…¨å±€å”¯ä¸€ID" class="headerlink" title="Rediså®ç°å…¨å±€å”¯ä¸€ID"></a>Rediså®ç°å…¨å±€å”¯ä¸€ID</h2><h3 id="ä½•ä¸ºå…¨å±€å”¯ä¸€ID"><a href="#ä½•ä¸ºå…¨å±€å”¯ä¸€ID" class="headerlink" title="ä½•ä¸ºå…¨å±€å”¯ä¸€ID"></a>ä½•ä¸ºå…¨å±€å”¯ä¸€ID</h3><ul><li>æŸ¥çœ‹æ–‡æ¡£ â€œä½•ä¸ºå…¨å±€å”¯ä¸€IDâ€</li></ul><h3 id="ä¼˜æƒ å·ä»‹ç»"><a href="#ä¼˜æƒ å·ä»‹ç»" class="headerlink" title="ä¼˜æƒ å·ä»‹ç»"></a>ä¼˜æƒ å·ä»‹ç»</h3><ol><li><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/8r2BmCj1dcEUbuM.webp" alt="img"></li></ol></li><li><p>å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°<code>tb_voucher_order</code>è¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜</p><ol><li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li><li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li></ol></li><li><p>åœºæ™¯åˆ†æ</p><ol><li>å¦‚æœæˆ‘ä»¬çš„idå…·æœ‰å¤ªæ˜æ˜¾çš„è§„åˆ™ï¼Œç”¨æˆ·æˆ–è€…è¯´å•†ä¸šå¯¹æ‰‹å¾ˆå®¹æ˜“çŒœæµ‹å‡ºæ¥æˆ‘ä»¬çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å•†åŸåœ¨ä¸€å¤©æ—¶é—´å†…ï¼Œå–å‡ºäº†å¤šå°‘å•ï¼Œè¿™æ˜æ˜¾ä¸åˆé€‚</li><li>éšç€æˆ‘ä»¬å•†åŸè§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œ<strong>mysql</strong>çš„å•è¡¨çš„å®¹é‡ä¸å®œè¶…è¿‡500Wï¼Œæ•°æ®é‡è¿‡å¤§ä¹‹åï¼Œæˆ‘ä»¬è¦è¿›è¡Œæ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œä»–ä»¬ä»é€»è¾‘ä¸Šè®²ä»–ä»¬æ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„idæ˜¯ä¸èƒ½ä¸€æ ·çš„ï¼Œ äºæ˜¯ä¹æˆ‘ä»¬éœ€è¦ä¿è¯idçš„å”¯ä¸€æ€§</li></ol></li><li><p><strong>å…¨å±€IDç”Ÿæˆå™¨</strong>ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·</p></li></ol><h3 id="åŸºäºRediså®ç°å…¨å±€å”¯ä¸€ID"><a href="#åŸºäºRediså®ç°å…¨å±€å”¯ä¸€ID" class="headerlink" title="åŸºäºRediså®ç°å…¨å±€å”¯ä¸€ID"></a>åŸºäºRediså®ç°å…¨å±€å”¯ä¸€ID</h3><ol><li><p>å‰æ</p></li><li><p>redisçš„<code>incrå‘½ä»¤</code></p><ol><li>Redisçš„<code>INCR</code>å‘½ä»¤æ˜¯ä¸€ä¸ªç”¨äºå¯¹å­˜å‚¨åœ¨Redisé”®ä¸­çš„æ•´æ•°å€¼è¿›è¡Œè‡ªå¢æ“ä½œçš„å‘½ä»¤ï¼›å¦‚æœç›®æ ‡é”®ä¸å­˜åœ¨ï¼Œåˆ™é¦–å…ˆå°†å…¶åˆå§‹åŒ–ä¸º0ï¼Œç„¶åæ‰§è¡Œè‡ªå¢æ“ä½œï¼›æ­¤å‘½ä»¤è¿”å›è‡ªå¢åçš„å€¼<ol start="2"><li>å¯¹äº<code>INCR</code>å‘½ä»¤ï¼Œå…¶æ ¸å¿ƒä½œç”¨æ˜¯å®ç°å¯¹<strong>æ•°å­—å­—ç¬¦ä¸²çš„è‡ªå¢æ“ä½œ</strong>ï¼›ç”±äºRedisæ²¡æœ‰ä¸“ç”¨çš„æ•´æ•°ç±»å‹ï¼Œé”®å¯¹åº”çš„å­—ç¬¦ä¸²åœ¨æ‰§è¡Œ<code>INCR</code>å‘½ä»¤æ—¶ä¼šè¢«è§£é‡Šä¸ºåè¿›åˆ¶ï¼ˆ64ä½æœ‰ç¬¦å·æ•´æ•°ï¼‰<ol start="3"><li><code>INCR</code>å‘½ä»¤å…·æœ‰<strong>åŸå­æ€§ç‰¹å¾</strong>ï¼Œè¿™æ„å‘³ç€åœ¨å¤šçº¿ç¨‹æˆ–å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å¯¹åŒä¸€ä¸ªé”®æ‰§è¡ŒINCRå‘½ä»¤ï¼Œè€Œä¸ä¼šå‡ºç°ç«æ€æ¡ä»¶æˆ–æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜</li></ol></li></ol></li></ol></li><li><p>RedisUtil</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtil</span> &#123;</span><br><span class="line">    <span class="comment">//åŸå§‹æ—¶é—´æˆ³BASE_TIME</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1704067200L</span>;</span><br><span class="line">    <span class="comment">//ç§»åŠ¨çš„ä½æ•°bit</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BIT</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">//1ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowEpochSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="comment">//æ—¶é—´å·®</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowEpochSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">//2ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">//2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">//2.2.è‡ªå¢é•¿</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line">        <span class="comment">//3æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BIT | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CountDownLatch-ä¿¡å·æª"><a href="#CountDownLatch-ä¿¡å·æª" class="headerlink" title="CountDownLatch ä¿¡å·æª"></a>CountDownLatch ä¿¡å·æª</h3><blockquote><p>è¡¥å……çŸ¥è¯†ï¼Œäº†è§£å³å¯</p></blockquote><ol><li>ä¸»è¦çš„ä½œç”¨æ˜¯åŒæ­¥åè°ƒåœ¨å¤šçº¿ç¨‹çš„ç­‰å¾…äºå”¤é†’é—®é¢˜</li><li>æˆ‘ä»¬å¦‚æœæ²¡æœ‰CountDownLatch ï¼Œé‚£ä¹ˆç”±äºç¨‹åºæ˜¯å¼‚æ­¥çš„ï¼Œå½“å¼‚æ­¥ç¨‹åºæ²¡æœ‰æ‰§è¡Œå®Œæ—¶ï¼Œä¸»çº¿ç¨‹å°±å·²ç»æ‰§è¡Œå®Œäº†ï¼Œç„¶åæˆ‘ä»¬æœŸæœ›çš„æ˜¯åˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œä¹‹åï¼Œä¸»çº¿ç¨‹å†èµ°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶éœ€è¦ä½¿ç”¨åˆ°CountDownLatch</li><li>CountDownLatch ä¸­æœ‰ä¸¤ä¸ªæœ€é‡è¦çš„æ–¹æ³•<ol><li>countDown</li><li>await<ol><li>awaitæ–¹æ³•æ˜¯é˜»å¡æ–¹æ³•ï¼Œæˆ‘ä»¬æ‹…å¿ƒåˆ†çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œæ—¶ï¼Œmainçº¿ç¨‹å°±å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨awaitå¯ä»¥è®©mainçº¿ç¨‹é˜»å¡</li><li>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™mainçº¿ç¨‹ä¸å†é˜»å¡å‘¢ï¼Ÿå½“CountDownLatch å†…éƒ¨ç»´æŠ¤çš„ å˜é‡å˜ä¸º0æ—¶ï¼Œå°±ä¸å†é˜»å¡ï¼Œç›´æ¥æ”¾è¡Œï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™CountDownLatch ç»´æŠ¤çš„å˜é‡å˜ä¸º0 å‘¢?</li><li>æˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€æ¬¡countDown ï¼Œå†…éƒ¨å˜é‡å°±å‡å°‘1ï¼Œæˆ‘ä»¬è®©åˆ†çº¿ç¨‹å’Œå˜é‡ç»‘å®šï¼Œ æ‰§è¡Œå®Œä¸€ä¸ªåˆ†çº¿ç¨‹å°±å‡å°‘ä¸€ä¸ªå˜é‡ï¼Œå½“åˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œï¼ŒCountDownLatch ç»´æŠ¤çš„å˜é‡å°±æ˜¯0ï¼Œæ­¤æ—¶awaitå°±ä¸å†é˜»å¡ï¼Œç»Ÿè®¡å‡ºæ¥çš„æ—¶é—´ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ†çº¿ç¨‹æ‰§è¡Œå®Œåçš„æ—¶é—´</li></ol></li></ol></li></ol><h2 id="ä¼˜æƒ å·"><a href="#ä¼˜æƒ å·" class="headerlink" title="ä¼˜æƒ å·"></a>ä¼˜æƒ å·</h2><h3 id="ä¼˜æƒ å·ç®€ä»‹"><a href="#ä¼˜æƒ å·ç®€ä»‹" class="headerlink" title="ä¼˜æƒ å·ç®€ä»‹"></a>ä¼˜æƒ å·ç®€ä»‹</h3><ol><li><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œ<strong>ç‰¹ä»·åˆ¸</strong>ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/L8cAIHxgqzKe9hW.webp" alt="img"></li></ol></li><li><p>ä¼˜æƒ å·çš„è¡¨ç»“æ„ä¿¡æ¯</p></li><li><ol><li><code>tb_voucher</code> ä¼˜æƒ å·è¡¨ï¼Œä¸»è¦åŒ…å«ä¼˜æƒ çš„å•†å®¶idã€ä¼˜æƒ å·ç±»å‹ã€æ˜¯å¦ä¸Šæ¶ã€ä¼˜æƒ ä»·æ ¼ã€å¼€å§‹ã€ç»“æŸæ—¶é—´</li><li><code>tb_seckill_voucher</code>ç§’æ€å·è¡¨ï¼Œä¸»è¦åŒ…å«å…³è”çš„ä¼˜æƒ å·idã€åº“å­˜ã€æŠ¢è´­ã€ç»“æŸæ—¶é—´</li></ol></li></ol><h3 id="æ·»åŠ ä¼˜æƒ å·"><a href="#æ·»åŠ ä¼˜æƒ å·" class="headerlink" title="æ·»åŠ ä¼˜æƒ å·"></a>æ·»åŠ ä¼˜æƒ å·</h3><h4 id="æ–°å¢æ™®é€šä¼˜æƒ å·"><a href="#æ–°å¢æ™®é€šä¼˜æƒ å·" class="headerlink" title="æ–°å¢æ™®é€šä¼˜æƒ å·"></a>æ–°å¢æ™®é€šä¼˜æƒ å·</h4><ol><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p></li><li><ol><li>Postè¯·æ±‚<code>/vocher</code></li><li>ä¼ è¾“å‚æ•°<code>Voucher voucher</code></li></ol></li><li><p>ä»£ç å®ç°</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> voucherMapper.insert(voucher);</span><br><span class="line">    <span class="keyword">if</span> (row != SystemConstants.ONE)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–°å¢ç§’æ€ä¼˜æƒ å·"><a href="#æ–°å¢ç§’æ€ä¼˜æƒ å·" class="headerlink" title="æ–°å¢ç§’æ€ä¼˜æƒ å·"></a>æ–°å¢ç§’æ€ä¼˜æƒ å·</h4><ol><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ol><li>Postè¯·æ±‚<code>/vocher/seckill</code></li><li>ä¼ è¾“å‚æ•°<code>Voucher voucher</code></li><li>å­˜å‚¨å¯¹è±¡å®ä½“<code>SeckillVoucher</code></li></ol></li><li><p>ä»£ç é€»è¾‘</p><ol><li><p>åˆ¤æ–­<code>voucher</code>æ˜¯å¦ä¸ºç©º</p><ol><li><p>æ˜¯ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</p></li><li><p>ä¸æ˜¯ï¼Œå­˜å…¥æ•°æ®åº“ä¸­</p><ol><li>å¾—åˆ°ä¼˜æƒ å·idï¼Œnew<code>SeckillVoucher</code>å¯¹è±¡ä¿å­˜ç§’æ€å·ä¿¡æ¯</li><li>å­˜å‚¨æ•°æ®åº“</li></ol></li><li><p>ç”±äºæ¶‰åŠä¸¤å¼ è¡¨ä¹‹é—´çš„æ“ä½œ</p><ol><li>å¼€å¯äº‹åŠ¡æ³¨è§£<code>@Transactional(rollbackFor = Exception.class)</code></li></ol></li></ol></li></ol></li><li><p>å…·ä½“å®ç°</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (voucher == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    voucherMapper.insert(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherMapper.insert(seckillVoucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æµ‹è¯•<ol><li>ç”±äºè¿™é‡Œå¹¶æ²¡æœ‰åå°ç®¡ç†é¡µé¢ï¼Œæ‰€ä»¥ç”¨apifox&#x2F;postmanç­‰æ¨¡æ‹Ÿå‘é€è¯·æ±‚æ¥æ–°å¢ç§’æ€åˆ¸</li><li>è¯·æ±‚è·¯å¾„<code>http://localhost:8081/voucher/seckill</code>ï¼Œ è¯·æ±‚æ–¹å¼POST</li><li>JSONæ•°æ®å¦‚ä¸‹ï¼Œæ³¨æ„ä¼˜æƒ åˆ¸çš„æˆªæ­¢æ—¥æœŸè®¾ç½®ï¼Œè‹¥ä¼˜æƒ åˆ¸è¿‡æœŸï¼Œåˆ™ä¸ä¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºã€‚</li></ol></li></ol><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shopId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;100å…ƒä»£é‡‘åˆ¸&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subTitle&quot;</span><span class="punctuation">:</span><span class="string">&quot;å‘¨ä¸€è‡³å‘¨äº”å¯ç”¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="string">&quot;å…¨åœºé€šç”¨\\næ— éœ€é¢„çº¦\\nå¯æ— é™å åŠ &quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payValue&quot;</span><span class="punctuation">:</span><span class="number">8000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actualValue&quot;</span><span class="punctuation">:</span><span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beginTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2024-06-21T00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2024-06-30T23:59:59&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="ä¼˜æƒ å·æŸ¥è¯¢"><a href="#ä¼˜æƒ å·æŸ¥è¯¢" class="headerlink" title="ä¼˜æƒ å·æŸ¥è¯¢"></a>ä¼˜æƒ å·æŸ¥è¯¢</h3><ol><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ol><li>GETè¯·æ±‚<code>/vocher/list/&#123;shopId&#125;</code></li><li>ä¼ è¾“å‚æ•°<code>Long shopId</code></li></ol></li><li><p>ä»£ç å®ç°</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryVoucherOfShop</span><span class="params">(Long shopId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (shopId == <span class="literal">null</span> || shopId &lt; SystemConstants.ONE)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ¹æ®shopIdæŸ¥è¯¢ä¼˜æƒ å·é›†åˆ</span></span><br><span class="line">    List&lt;Voucher&gt; vouchers = voucherMapper.queryVoucherOfShop(shopId);</span><br><span class="line">    <span class="keyword">if</span> (vouchers == <span class="literal">null</span> || vouchers.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(vouchers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç§’æ€ä¸‹å•"><a href="#ç§’æ€ä¸‹å•" class="headerlink" title="ç§’æ€ä¸‹å•"></a>ç§’æ€ä¸‹å•</h2><h3 id="ä½•ä¸ºç§’æ€ä¸‹å•"><a href="#ä½•ä¸ºç§’æ€ä¸‹å•" class="headerlink" title="ä½•ä¸ºç§’æ€ä¸‹å•"></a>ä½•ä¸ºç§’æ€ä¸‹å•</h3><ol><li><p>ä¸‹å•æ ¸å¿ƒæ€è·¯ï¼šå½“æˆ‘ä»¬ç‚¹å‡»æŠ¢è´­æ—¶ï¼Œä¼šè§¦å‘æŠ¢è´­è¯·æ±‚</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/F8UDYuExPikIjVv.webp" alt="img"></li></ol></li><li><p>ç§’æ€ä¸‹å•éœ€è¦è€ƒè™‘çš„é—®é¢˜</p><ul><li><p>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</p></li><li><p>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</p></li></ul></li><li><p>ä¸‹å•æ ¸å¿ƒé€»è¾‘åˆ†æ</p></li><li><p>å½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯</p></li><li><p>åˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶</p></li><li><p>æ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸ</p></li></ol><h3 id="å®ç°ç§’æ€ä¸‹å•"><a href="#å®ç°ç§’æ€ä¸‹å•" class="headerlink" title="å®ç°ç§’æ€ä¸‹å•"></a>å®ç°ç§’æ€ä¸‹å•</h3><ol><li><p>å‰åç«¯è¯·æ±‚æ¥å£å’Œä¼ è¾“å¯¹è±¡</p><ol><li>Postè¯·æ±‚<code>/vocher-order/seckill/&#123;id&#125;</code></li><li>ä¼ è¾“å‚æ•°<code>Long id</code></li></ol></li><li><p>ä»£ç é€»è¾‘</p><ol><li>ä¼˜æƒ å·idåˆ¤æ–­<ol><li>ä¸å¯ç”¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>å¯ç”¨ï¼ŒæŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯<ol><li>åˆ¤æ–­æ—¶é—´çŠ¶æ€æ˜¯å¦æ»¡è¶³<ol><li>ä¸æ»¡è¶³ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æ»¡è¶³ï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ<ol><li>ä¸è¶³ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>è¶³å¤Ÿï¼Œåº“å­˜-1ï¼Œå¹¶åˆ›å»ºä¼˜æƒ å·è®¢å•ä¿å­˜åˆ°æ•°æ®åº“ä¸­<ol><li>ä¼˜æƒ åŠµè®¢å•idé‡‡ç”¨<code>RedisUtil</code>çš„å…¨å±€å”¯ä¸€id</li><li>è¿”å›è®¢å•id</li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></li><li><p>å®é™…ä»£ç </p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">getOrder</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> seckillVoucher.getBeginTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> seckillVoucher.getEndTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span> (now.isBefore(beginTime) || now.isAfter(endTime))&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_TIME_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">stock</span> <span class="operator">=</span> seckillVoucher.getStock();</span><br><span class="line">    <span class="keyword">if</span> (stock &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    stock = stock - <span class="number">1</span>;</span><br><span class="line">    seckillVoucher.setStock(stock);</span><br><span class="line">    seckillVoucherMapper.updateById(seckillVoucher);</span><br><span class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisUtil.getId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    voucherOrder.setVoucherId(id);</span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> voucherOrderMapper.insert(voucherOrder);</span><br><span class="line">    <span class="keyword">if</span> (row != SystemConstants.ONE)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åº“å­˜è¶…å–"><a href="#åº“å­˜è¶…å–" class="headerlink" title="åº“å­˜è¶…å–"></a>åº“å­˜è¶…å–</h2><h3 id="åº“å­˜è¶…å–é—®é¢˜åˆ†æ"><a href="#åº“å­˜è¶…å–é—®é¢˜åˆ†æ" class="headerlink" title="åº“å­˜è¶…å–é—®é¢˜åˆ†æ"></a>åº“å­˜è¶…å–é—®é¢˜åˆ†æ</h3><ol><li>åº“å­˜åˆ¤æ–­ä»£ç </li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">stock</span> <span class="operator">=</span> seckillVoucher.getStock();</span><br><span class="line"><span class="keyword">if</span> (stock &lt; SystemConstants.ONE) &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">stock = stock - <span class="number">1</span>;</span><br><span class="line">seckillVoucher.setStock(stock);</span><br><span class="line">seckillVoucherMapper.updateById(seckillVoucher);</span><br></pre></td></tr></table></figure><ol start="2"><li><p>åˆ†æ</p><ol><li><p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜</p></li><li><p>åˆ†æå›¾<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/mOqj71hNkaIl9BS.webp" alt="img"></p></li></ol></li><li><p>æˆ‘ä»¬ä¹‹å‰çš„ä»£ç å…¶å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå½“é‡åˆ°é«˜å¹¶å‘åœºæ™¯æ—¶ï¼Œä¼šå‡ºç°è¶…å–ç°è±¡</p><ol><li>æˆ‘ä»¬å¯ä»¥ç”¨<code>Jmeter</code>å¼€200ä¸ªçº¿ç¨‹æ¥æ¨¡æ‹ŸæŠ¢ä¼˜æƒ åˆ¸çš„åœºæ™¯ï¼ŒURL ï¼š<code>localhost:8081/voucher-order/seckill/13</code>ï¼ŒPOSTè¯·æ±‚</li><li>ç»“æœå›¾å¼‚å¸¸ç‡åº”åœ¨50%å·¦å³<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/I5JjWySKV8m9YQr.webp" alt="img"></li><li>ç§’æ€å·åº“å­˜åº”ä¸º0<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/25zIhH9RDJsBja6.webp" alt="img"></li><li>Redisåºåˆ—å·å€¼åº”ä¸º100</li><li>è®¢å•æ•°æ®åº”åœ¨100</li></ol></li></ol><h3 id="è¶…å–é—®é¢˜è§£å†³"><a href="#è¶…å–é—®é¢˜è§£å†³" class="headerlink" title="è¶…å–é—®é¢˜è§£å†³"></a>è¶…å–é—®é¢˜è§£å†³</h3><ol><li><p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼›è€Œå¯¹äºåŠ é”ï¼Œé€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p><ol><li><p>æ‚²è§‚é”</p><ol><li>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ</li><li>ä¾‹å¦‚synchronizedã€Lockéƒ½å±äºæ‚²è§‚é”</li></ol></li><li><p>ä¹è§‚é”</p><ol><li>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶ä¸¢åˆ¤æ–­æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®åšäº†ä¿®æ”¹</li><li>å¦‚æœæ²¡æœ‰ä¿®æ”¹åˆ™è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰æ›´æ–°æ•°æ®</li><li>å¦‚æœå·²ç»è¢«å…¶çº¿ç¨‹ä¿®æ”¹è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–å¼‚å¸¸</li></ol></li></ol></li><li><p>æ‚²è§‚é”å®ç°</p><ol><li><p>é€šè¿‡<code>Synchronized</code>å…³é”®å­—å®ç°</p><ol><li>ç›´æ¥å¯¹æŠ¢è´­æ–¹æ³•åŠ é”</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">getOrder</span><span class="params">(Long id)</span> &#123;....&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡synchronized(èµ„æº)åŠ é”ï¼Œæ›´ä¸ºç²¾ç¡®</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> seckillVoucher.getBeginTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> seckillVoucher.getEndTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span> (now.isBefore(beginTime) || now.isAfter(endTime)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_TIME_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">stock</span> <span class="operator">=</span> seckillVoucher.getStock();</span><br><span class="line">    <span class="keyword">if</span> (stock &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    stock = stock - <span class="number">1</span>;</span><br><span class="line">    seckillVoucher.setStock(stock);</span><br><span class="line">    seckillVoucherMapper.updateById(seckillVoucher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¹è§‚é”å®ç°</p><ol><li><p>ç‰ˆæœ¬å·æ³•</p><ol><li>é€»è¾‘ï¼šæ¯ä¸€æ•°æ®ä¼šæœ‰ä¸€ä¸ª<strong>ç‰ˆæœ¬å·</strong>ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®ä¼šå¯¹ç‰ˆæœ¬å·+1ï¼Œå†æäº¤å›æ•°æ®æ—¶ï¼Œä¼šå»æ ¡éªŒæ˜¯å¦æ¯”ä¹‹å‰çš„ç‰ˆæœ¬å¤§1 ï¼Œå¦‚æœå¤§1 ï¼Œåˆ™è¿›è¡Œæ“ä½œæˆåŠŸï¼Œè¿™å¥—æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘åœ¨äºï¼Œå¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œç‰ˆæœ¬å·åªæ¯”åŸæ¥å¤§1 ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰äººå¯¹ä»–è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œä»–çš„æ“ä½œå°±æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å¤§1ï¼Œåˆ™æ•°æ®è¢«ä¿®æ”¹è¿‡</li><li>é»‘é©¬è¯¾ç¨‹ä¸­å¹¶æ²¡æœ‰å¯¹æ•°æ®è¡¨æ–°å¢ä¸€ä¸ªå­—æ®µversionæ¥è¿›è¡Œåˆ¤æ–­ï¼Œå› ä¸ºåº“å­˜stockæœ¬èº«ä¹Ÿå¯ç”¨æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼›å†ç›´æ¥ï¼Œå°±æ˜¯åˆ¤æ–­åº“å­˜æ˜¯å¦&gt;0å³å¯</li><li>ä»£ç é€»è¾‘<ol><li>å†å¯¹åº“å­˜è¿›è¡Œ-1æ—¶ï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å¤§äº0<ol><li>æœ‰ï¼ŒæŠ¢è´­å¤±è´¥</li><li>æ— ï¼ŒæŠ¢è´­æˆåŠŸ</li></ol></li></ol></li><li>å®é™…ä»£ç </li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">getOrderWithPositive</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> seckillVoucher.getBeginTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> seckillVoucher.getEndTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span> (now.isBefore(beginTime) || now.isAfter(endTime)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_TIME_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å…³é”®sql</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> seckillVoucherMapper.updateByIdAndStock(seckillVoucher);</span><br><span class="line">    <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisUtil.getId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    voucherOrder.setVoucherId(id);</span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> voucherOrderMapper.insert(voucherOrder);</span><br><span class="line">    <span class="keyword">if</span> (row != SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5.ä¹è§‚é”å®ç°</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">update</span> id<span class="operator">=</span>&quot;updateByIdAndStock&quot;<span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">update</span> hmdp.tb_seckill_voucher </span><br><span class="line">        <span class="comment">-- ä¸æ˜¯ç”¨æŸ¥è¯¢åˆ°çš„#&#123;stock&#125;-1,è€Œæ˜¯æœ¬æ¥çš„stock - 1</span></span><br><span class="line">        <span class="keyword">set</span> stock <span class="operator">=</span> tb_seckill_voucher.stock <span class="operator">-</span> <span class="number">1</span> </span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        <span class="comment">-- å¦‚æœåˆ¤æ–­stock = #&#123;stock&#125;ï¼Œé‚£ä¹ˆå½“100ä¸ªçº¿ç¨‹åˆ¤æ–­æ—¶åªæœ‰1ä¸ªå¯ä»¥å®Œæˆé”™è¯¯ç‡è¾ƒé«˜</span></span><br><span class="line">        voucher_id <span class="operator">=</span> #&#123;voucherId&#125; <span class="keyword">and</span> stock <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">update</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li></ol></li><li><p>æ—¶é—´æˆ³æ³•</p><ol><li>æ—¶é—´æˆ³æ³•å®ç°ä¹è§‚é”æ˜¯<strong>åœ¨æ•°æ®è¡¨ä¸­å¢åŠ ä¸€ä¸ªæ—¶é—´æˆ³å­—æ®µï¼Œå½“æ•°æ®è¢«è¯»å–æ—¶è®°å½•ä¸‹å½“å‰çš„æ—¶é—´æˆ³ï¼Œå½“æ•°æ®è¢«æ›´æ–°æ—¶ï¼Œæ£€æŸ¥å½“å‰æ—¶é—´æˆ³æ˜¯å¦ä¸è¯»å–æ—¶çš„æ—¶é—´æˆ³ä¸€è‡´</strong>ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™è¯´æ˜æ•°æ®å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ï¼Œå½“å‰äº‹åŠ¡æ‰§è¡Œå¤±è´¥</li><li>å’Œç‰ˆæœ¬å·æ³•åŸç†ä¸€è‡´</li></ol></li><li><p>CAS( Compare And Swap  )è‡ªæ—‹æ³•</p></li><li><p>Jmeteræµ‹è¯•</p><ol><li>æµ‹è¯•ç»“æœç¬¦åˆåº”ç¬¦åˆ200äºº100è®¢å•ï¼Œåº“å­˜ä¸º0</li></ol></li></ol><h2 id="ä¸€äººä¸€å•"><a href="#ä¸€äººä¸€å•" class="headerlink" title="ä¸€äººä¸€å•"></a>ä¸€äººä¸€å•</h2><ol><li><p>éœ€æ±‚ : ä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p></li><li><p>ç°åœ¨çš„é—®é¢˜ï¼š</p><ol><li>ä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šå•</li><li>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œç„¶åå†æ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢æ˜¯å¦å·²ç»ä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œå¦‚æœä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œåˆ™ä¸å†ä¸‹å•ï¼Œå¦åˆ™è¿›è¡Œä¸‹å•</li><li>æµç¨‹å›¾<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/6UVt8aApBmqLJoc.webp" alt="img"></li></ol></li></ol></li><li><p>ä»£ç é€»è¾‘</p><ol><li>Idéç©ºåˆ¤æ–­</li><li>æ ¹æ®IDæŸ¥è¯¢ç§’æ€å·ä¿¡æ¯<ol><li>æ— ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æœ‰ï¼Œåˆ¤æ–­å¼€å§‹å’Œç»“æŸæ—¶é—´<ol><li>ä¸åœ¨èŒƒå›´ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>åœ¨èŒƒå›´ï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦æ»¡è¶³<ol><li><p>ä¸æ»¡è¶³ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</p></li><li><p>æ»¡è¶³ï¼Œæ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢</p><ol><li>å·²è´­ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</li><li>æœªè´­ï¼Œåº“å­˜-1ï¼Œä¸”æ–°å¢è®¢å•</li></ol></li><li><p>è¿”å›è®¢å•Id</p></li></ol></li></ol></li></ol></li></ol></li><li><p>å…·ä½“ä»£ç </p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">getOrderOnly</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherMapper.selectById(id);</span><br><span class="line">        <span class="keyword">if</span> (seckillVoucher == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> seckillVoucher.getBeginTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> seckillVoucher.getEndTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span> (now.isBefore(beginTime) || now.isAfter(endTime)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_TIME_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">stock</span> <span class="operator">=</span> seckillVoucher.getStock();</span><br><span class="line">        <span class="keyword">if</span> (stock &lt; SystemConstants.ONE) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> voucherOrderMapper.selectByUserIdAndVoucherId(userId,id);</span><br><span class="line">        <span class="keyword">if</span> (voucherOrder != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.ORDER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åº“å­˜ä¿®æ”¹</span></span><br><span class="line">        seckillVoucherMapper.updateByIdAndStock(seckillVoucher);</span><br><span class="line">        <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisUtil.getId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        order.setId(orderId);</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setVoucherId(id);</span><br><span class="line">        <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> voucherOrderMapper.insert(order);</span><br><span class="line">        <span class="keyword">if</span> (row != SystemConstants.ONE) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><p><strong>å­˜åœ¨é—®é¢˜</strong></p><ol><li><p>é«˜å¹¶å‘æ—¶ï¼ŒæŸ¥è¯¢æ•°æ®åº“éƒ½ä¸å­˜åœ¨è®¢å•çš„æƒ…å†µ</p></li><li><p>æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ é”ï¼Œä½†æ˜¯<strong>ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®</strong>ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œ</p></li><li><p>åœ¨å¯¹æ‚²è§‚é”æ“ä½œæ—¶ï¼Œéœ€è¦è€ƒè™‘ç»†ç²’åº¦é—®é¢˜</p><ol><li>å¦‚æœç›´æ¥å¯¹æ•´ä¸ªæ–¹æ³•åŠ é”ï¼Œå›ºç„¶å¯ä»¥å®ç°ä¸€äººä¸€å•</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">getOrderOnly</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> seckillVoucher.getBeginTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> seckillVoucher.getEndTime();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="keyword">if</span> (now.isBefore(beginTime) || now.isAfter(endTime)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_TIME_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">stock</span> <span class="operator">=</span> seckillVoucher.getStock();</span><br><span class="line">    <span class="keyword">if</span> (stock &lt; SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> voucherOrderMapper.selectByUserIdAndVoucherId(userId, id);</span><br><span class="line">    <span class="keyword">if</span> (voucherOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.ORDER_ERROR);</span><br><span class="line">    </span><br><span class="line">    seckillVoucherMapper.updateByIdAndStock(seckillVoucher);</span><br><span class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisUtil.getId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setVoucherId(id);</span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> voucherOrderMapper.insert(order);</span><br><span class="line">    <span class="keyword">if</span> (row != SystemConstants.ONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½†æ˜¯è¿™æ ·æ·»åŠ é”ï¼Œé”çš„ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶<strong>é”ç²’åº¦</strong>æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ§åˆ¶é”çš„ç²’åº¦ï¼Œä»¥ä¸‹è¿™æ®µä»£ç éœ€è¦ä¿®æ”¹ä¸ºï¼š</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>  Result <span class="title function_">getOrderOnly</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt; SystemConstants.ONE) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.ID_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherMapper.selectById(id);</span><br><span class="line">        <span class="keyword">if</span> (seckillVoucher == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.DATA_QUERY_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> seckillVoucher.getBeginTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> seckillVoucher.getEndTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span> (now.isBefore(beginTime) || now.isAfter(endTime)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_TIME_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">stock</span> <span class="operator">=</span> seckillVoucher.getStock();</span><br><span class="line">        <span class="keyword">if</span> (stock &lt; SystemConstants.ONE) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.VOUCHER_STOCK_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åªéœ€è¦å¯¹åŒä¸€ä¸ªç”¨æˆ·çš„è¿›ç¨‹è¿›è¡Œé”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">            <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> voucherOrderMapper.</span><br><span class="line">                selectByUserIdAndVoucherId(userId, id);</span><br><span class="line">            <span class="keyword">if</span> (voucherOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> Result.fail(MessageConstants.ORDER_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            seckillVoucherMapper.updateByIdAndStock(seckillVoucher);</span><br><span class="line">            <span class="comment">//åˆ›å»ºè®¢å•</span></span><br><span class="line">            <span class="type">VoucherOrder</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">            <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisUtil.getId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            order.setId(orderId);</span><br><span class="line">            order.setUserId(userId);</span><br><span class="line">            order.setVoucherId(id);</span><br><span class="line">            <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> voucherOrderMapper.insert(order);</span><br><span class="line">            <span class="keyword">if</span> (row != SystemConstants.ONE) &#123;</span><br><span class="line">                <span class="keyword">return</span> Result.fail(MessageConstants.NEW_DATA_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><p>åˆ†æ</p><ol><li><p>å› ä¸ºä¸€äººä¸€å•åªæ˜¯é˜²æ­¢åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è·å–ç§’æ€å·ï¼Œæ‰€ä»¥åœ¨å¯¹è¿›ç¨‹åŠ é”æ—¶ï¼Œåªéœ€è¦å¯¹åŒä¸€ç”¨æˆ·çš„ä¸åŒè¿›ç¨‹åŠ é”</p></li><li><p>ä»–ä»¬æœ‰ç€å…±åŒçš„é”èµ„æºå°±æ˜¯ä»–ä»¬çš„ç”¨æˆ·ID</p></li><li><p>åˆå› ä¸º<code>userId.toString()</code>çš„å¯¹è±¡æ˜¯newå‡ºæ¥çš„ï¼Œä¸èƒ½ä¿éšœå…±åŒé”èµ„æºï¼Œæ‰€ä»¥èµ„æºå¯¹è±¡ä¸º<code>userId.toString().intern()</code>ï¼Œè¿™æ˜¯ä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è·å–ç”¨æˆ·Idï¼Œç¡®ä¿äº†å”¯ä¸€æ€§</p></li><li><p>æºç åˆ†æ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toString</span><span class="params">(<span class="type">long</span> i)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> stringSize(i);</span><br><span class="line">    <span class="keyword">if</span> (COMPACT_STRINGS) &#123;</span><br><span class="line">        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        getChars(i, size, buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, LATIN1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[size * <span class="number">2</span>];</span><br><span class="line">        StringUTF16.getChars(i, size, buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, UTF16);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/DzYkTI5KfyUhQ8B.webp" alt="img"></p></li></ol></li></ol></li></ol></li></ol><h2 id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜"><a href="#é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜" class="headerlink" title="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜"></a>é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h2><blockquote><p>æ¥æºï¼šé»‘é©¬èµ„æ–™</p></blockquote><h3 id="é›†ç¾¤ç¯å¢ƒæ¨¡æ‹Ÿ"><a href="#é›†ç¾¤ç¯å¢ƒæ¨¡æ‹Ÿ" class="headerlink" title="é›†ç¾¤ç¯å¢ƒæ¨¡æ‹Ÿ"></a>é›†ç¾¤ç¯å¢ƒæ¨¡æ‹Ÿ</h3><ul><li><p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†</p></li><li><p>æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082ï¼š</p><ol><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/dayKHhn1wQkilqY.webp" alt="img"></p></li><li><p>ç„¶åä¿®æ”¹nginxçš„confç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡</p><ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/TXO42QwxqrF7ZMP.webp" alt="img"></li></ol></li></ol></li><li><p>åç»­å…·ä½“æ“ä½œï¼Œè§‚çœ‹é»‘é©¬è§†é¢‘</p></li></ul><h3 id="æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ"><a href="#æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ" class="headerlink" title="æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ"></a>æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ</h3><ul><li>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œæ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ª<strong>å±äºè‡ªå·±çš„jvm</strong>ï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„</li><li>ä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥</li><li>è¿™å°±æ˜¯é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsynchronizedé”å¤±æ•ˆçš„åŸå› (åŸºäºJVMå†…å­˜å®ç°)ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨<strong>åˆ†å¸ƒå¼é”</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/07/GVv4HNpIJlWXyDj.webp" alt="img"></li></ul><hr><h1 id="é™„è¿‘å•†æˆ·"><a href="#é™„è¿‘å•†æˆ·" class="headerlink" title="é™„è¿‘å•†æˆ·"></a>é™„è¿‘å•†æˆ·</h1><h2 id="GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•"><a href="#GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•"></a>GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</h2><blockquote><p>åœ¨é»‘é©¬çš„â€œè‹ç©¹å¤–å–ä¸­â€é€šè¿‡ç™¾åº¦åœ°å›¾çš„apiè°ƒç”¨æ¥å®Œæˆå¯¹åœ°ç†ä½ç½®çš„åˆ¤æ–­</p><p>MongoDBã€Elasticsearchç­‰æŠ€æœ¯å‡å¯å®ç°GEO</p><p>ä¸‰è€…çš„æ¯”è¾ƒ<code>https://blog.csdn.net/u014401141/article/details/134646577</code></p></blockquote><ol><li><code>GEO</code>å°±æ˜¯Geolocationçš„ç®€å†™ï¼Œä»£è¡¨åœ°ç†åæ ‡</li><li>Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®</li><li>å¸¸è§çš„å‘½ä»¤æœ‰<ul><li><code>GEOADD</code>æ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li><li><code>GEODIST</code>è®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li><li><code>GEOHASH</code>å°†æŒ‡å®š<code>member</code>çš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li><li><code>GEOPOS</code>è¿”å›æŒ‡å®šmemberçš„åæ ‡</li><li><code>GEORADIUS</code>æŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ï¼›6.2ç‰ˆæœ¬ä»¥åå·²åºŸå¼ƒ</li><li><code>GEOSEARCH</code>åœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢<code>member</code>ï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ï¼›èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©ï¼›6.2.æ–°åŠŸèƒ½</li><li><code>GEOSEARCHSTORE</code>ä¸<code>GEOSEARCH</code>åŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyï¼›6.2.æ–°åŠŸèƒ½</li></ul></li></ol><h2 id="å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO"><a href="#å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO" class="headerlink" title="å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO"></a>å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h2><ol><li>éœ€æ±‚<ol><li>å°†æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å¯¼å…¥åˆ°Redisä¸­çš„GEOå»</li><li>GEOåœ¨Redisä¸­å°±ä¸€ä¸ªmenberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œæˆ‘ä»¬æŠŠxå’Œyè½´ä¼ å…¥åˆ°Redisåšçš„ç»çº¬åº¦ä½ç½®ï¼Œä½†ä¸èƒ½æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾å…¥åˆ°member</li><li>Redisä½œä¸ºä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡æ•°æ®ï¼ŒRedisè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªåœ°æ–¹å­˜å‚¨ä»–çš„å•†å®¶idå³å¯</li><li>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨Redisä¸­å¹¶æ²¡æœ‰å­˜å‚¨typeï¼Œæ— æ³•æ ¹æ®typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼›æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„ï¼Œä»¥<code>typeId</code>ä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/ThWJZilfkvMeLyD.png" alt="img" style="zoom:50%;" /></li></ol></li><li>ä»£ç ç¼–å†™<ol><li>åœ¨<code>HmDianPingApplicationTests</code>æµ‹è¯•ç±»å®Œæˆå¯¹å•†æˆ·æ•°æ®çš„å¯¼å…¥</li><li>Streamæµçš„ä½¿ç”¨æ ¹æ®å•†æˆ·ç±»å‹idåˆ†ç»„ï¼Œå¾—åˆ°ç‰¹å®šçš„<code>List&lt;Shop&gt;</code>é›†åˆ</li><li>å…·ä½“ä»£ç å¦‚ä¸‹</li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">// 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            <span class="comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()),    shop.getId().toString());</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>æˆåŠŸç¤ºä¾‹<ol><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/BCQlSUaI91NHFyX.png" alt="img"></li></ol></li></ol><h2 id="å®ç°é™„è¿‘å•†æˆ·æœç´¢åŠŸèƒ½"><a href="#å®ç°é™„è¿‘å•†æˆ·æœç´¢åŠŸèƒ½" class="headerlink" title="å®ç°é™„è¿‘å•†æˆ·æœç´¢åŠŸèƒ½"></a>å®ç°é™„è¿‘å•†æˆ·æœç´¢åŠŸèƒ½</h2><ol><li><p>ç‰ˆæœ¬ä¿®æ”¹</p><ul><li>SpringDataRedisçš„ 2.3.9 ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2 æä¾›çš„<code>GEOSEARCH</code>å‘½ä»¤ï¼Œéœ€è¦ä¿®æ”¹ç‰ˆæœ¬</li><li>ä¿®æ”¹pomæ–‡ä»¶å¦‚ä¸‹</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-data-redis&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lettuce-core&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å…·ä½“åœºæ™¯è¯´æ˜</p><ul><li>å½“ç‚¹å‡»ç¾é£Ÿä¹‹åï¼Œä¼šå‡ºç°ä¸€ç³»åˆ—çš„å•†å®¶ï¼Œå•†å®¶ä¸­å¯ä»¥æŒ‰ç…§å¤šç§æ’åºæ–¹å¼</li><li>æ­¤æ—¶å…³æ³¨çš„æ˜¯è·ç¦»ï¼Œè¿™ä¸ªåœ°æ–¹å°±éœ€è¦ä½¿ç”¨åˆ°GEOï¼Œå‘åå°ä¼ å…¥å½“å‰appæ”¶é›†çš„åœ°å€(æ­¤å¤„å‰ç«¯æ˜¯å†™æ­»çš„) ï¼Œä»¥å½“å‰åæ ‡ä½œä¸ºåœ†å¿ƒï¼ŒåŒæ—¶ç»‘å®šç›¸åŒçš„åº—å®¶ç±»å‹typeï¼Œä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ŒæŠŠè¿™å‡ ä¸ªæ¡ä»¶ä¼ å…¥åå°ï¼Œåå°æŸ¥è¯¢å‡ºå¯¹åº”çš„å•†æˆ·æ•°æ®å†è¿”å›</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/K1btmcF8uJPN7Dp.png" alt="img" style="zoom:50%;" /></li></ul></li><li><p>ä¾ç…§ä¸Šå›¾ä¿®æ”¹<code>ShopControllerä»£ç </code></p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®å•†é“ºç±»å‹åˆ†é¡µæŸ¥è¯¢å•†é“ºä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> current å½“å‰é¡µ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> typeId ç±»å‹Id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x ç»åº¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y çº¬åº¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å•†é“ºåˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">return</span> shopService.typeOfPage(typeId,current,x,y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>ä¸šåŠ¡ä»£ç å®ç°ï¼Œç”±äºæ¶‰åŠåˆ°è®¸å¤šä¸å¸¸ç”¨apiçš„è°ƒç”¨ï¼Œè¿™é‡Œç›´æ¥å¯¼å…¥é»‘é©¬ä»£ç å†åšä¿®æ”¹<ol><li>æŸ¥è¯¢åˆ°çš„æ˜¯<code>&lt;ShopId,distance&gt;</code>ï¼Œå¯¹å…¶è§£æå’Œå°è£…</li><li>é€»è¾‘åˆ†é¡µçš„å®ç°ï¼Œ<code>Map</code>ã€<code>List</code>é›†åˆçš„ä½¿ç”¨</li><li>éœ€è¦è¿”å›çš„æ˜¯åŒ…å«<code>distance</code>ä¿¡æ¯çš„å•†æˆ·é›†åˆ</li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">typeOfPage</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">        PageHelper.startPage(current, SystemConstants.MAX_PAGE_SIZE);</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shop</span>().setTypeId(Long.valueOf(typeId));</span><br><span class="line">        Page&lt;Shop&gt; page = shopMapper.pageQuery(shop);</span><br><span class="line">        <span class="keyword">if</span> (page == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(MessageConstants.PAGE_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Shop&gt; pageResult = page.getResult();</span><br><span class="line">        <span class="keyword">if</span> (pageResult.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µï¼›ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.SHOP_GEO_KEY + typeId;</span><br><span class="line">    <span class="comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 5 WITHDISTANCE</span></span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">            .radius(</span><br><span class="line">            key,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Circle</span>(x, y, <span class="number">10000</span>),</span><br><span class="line">            <span class="comment">//ä»ä¸€å¼€å§‹è¿”å›endä¸ªæ•°æ®</span></span><br><span class="line">            RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().limit(end)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// è§£æå‡ºid</span></span><br><span class="line">    <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™æ˜¯è¿”å›Zsetä¸­çš„æ•°æ®</span></span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">    <span class="keyword">if</span> (list.size() &lt;= from) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æˆªå– from ~ endçš„éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">//æŸ¥è¯¢åˆ°çš„å•†æˆ·idé›†åˆ</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">    <span class="comment">//æ¯ä¸€ä¸ªå•†æˆ·IDå¯¹åº”çš„è·ç¦»map</span></span><br><span class="line">    Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">    <span class="comment">//å°†å‰fromä¸ªæ•°æ®è·³è¿‡</span></span><br><span class="line">    list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">        <span class="comment">// è·å–åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">        ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">        <span class="comment">// è·å–è·ç¦»</span></span><br><span class="line">        distanceMap.put(shopIdStr, result.getDistance());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// æ ¹æ®idæŸ¥è¯¢Shop</span></span><br><span class="line">    List&lt;Shop&gt; shops = shopMapper.selectByIds(ids);</span><br><span class="line">    <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">        <span class="comment">//æ ¹æ®idè·å–å¯¹åº”è·ç¦»</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> shop.getId().toString();</span><br><span class="line">        shop.setDistance(distanceMap.get(idStr).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>ç¤ºä¾‹<ol><li>ç”±äºRedisç‰ˆæœ¬ä¸º5.xï¼Œæ— æ³•ä½¿ç”¨GEOSEARCHï¼Œæ— æ³•æ˜¾ç¤ºè·ç¦»å€¼</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/s6VtWB15UfQNk4p.png" alt="img"></li></ol></li></ol><hr><h1 id="ç”¨æˆ·ç­¾åˆ°"><a href="#ç”¨æˆ·ç­¾åˆ°" class="headerlink" title="ç”¨æˆ·ç­¾åˆ°"></a>ç”¨æˆ·ç­¾åˆ°</h1><h2 id="Redis-BitMap-ä½å›¾-åŠŸèƒ½"><a href="#Redis-BitMap-ä½å›¾-åŠŸèƒ½" class="headerlink" title="Redis-BitMap(ä½å›¾)åŠŸèƒ½"></a>Redis-BitMap(ä½å›¾)åŠŸèƒ½</h2><h3 id="ä¸ºä½•ä½¿ç”¨BitMap"><a href="#ä¸ºä½•ä½¿ç”¨BitMap" class="headerlink" title="ä¸ºä½•ä½¿ç”¨BitMap"></a>ä¸ºä½•ä½¿ç”¨BitMap</h3><ul><li><p>é’ˆå¯¹ç­¾åˆ°åŠŸèƒ½å®Œå…¨å¯ä»¥é€šè¿‡mysqlæ¥å®Œæˆï¼Œæ¯”å¦‚è¯´ä»¥ä¸‹è¿™å¼ è¡¨</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/ZvRdbJB3MPfT5oC.png" alt="img"></li><li>ç”¨æˆ·ä¸€æ¬¡ç­¾åˆ°ï¼Œå°±æ˜¯ä¸€æ¡è®°å½•ï¼Œå‡å¦‚æœ‰1000ä¸‡ç”¨æˆ·ï¼Œå¹³å‡æ¯äººæ¯å¹´ç­¾åˆ°æ¬¡æ•°ä¸º10æ¬¡ï¼Œåˆ™è¿™å¼ è¡¨ä¸€å¹´çš„æ•°æ®é‡ä¸º 1äº¿æ¡</li><li>æ¯ç­¾åˆ°ä¸€æ¬¡éœ€è¦ä½¿ç”¨ï¼ˆ8 + 8 + 1 + 1 + 3 + 1ï¼‰å…±22 å­—èŠ‚çš„å†…å­˜ï¼Œä¸€ä¸ªæœˆåˆ™æœ€å¤šéœ€è¦600å¤šå­—èŠ‚</li></ul></li><li><p><strong>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</strong></p><ul><li><p>å…¶å®å¯ä»¥è€ƒè™‘å°æ—¶å€™ä¸€ä¸ªæŒºå¸¸è§çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å°æ—¶å€™ï¼Œå’±ä»¬å‡†å¤‡ä¸€å¼ å°å°çš„å¡ç‰‡ï¼Œä½ åªè¦ç­¾åˆ°å°±æ‰“ä¸Šä¸€ä¸ªå‹¾ï¼Œæˆ‘æœ€ååˆ¤æ–­ä½ æ˜¯å¦ç­¾åˆ°ï¼Œå…¶å®åªéœ€è¦åˆ°å°å¡ç‰‡ä¸Šçœ‹ä¸€çœ‹ä½ åœ¨å½“å¤©æ˜¯å¦æœ‰æ‰“å‹¾</p><ul><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/bkmguLt5KiyxdVX.png" alt="img" style="zoom:50%;" /></li><li><p>å¯ä»¥é‡‡ç”¨ç±»ä¼¼è¿™æ ·çš„æ–¹æ¡ˆæ¥å®ç°æˆ‘ä»¬çš„ç­¾åˆ°éœ€æ±‚ï¼Œè€ŒRedisçš„BitMapæ°å¥½å¯ä»¥å®ç°æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0</p><ul><li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/gSw9XfQOMN1ZAmq.png" alt="img"></p></li><li><p>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾ï¼ˆBitMapï¼‰è¿™æ ·å°±ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°äº†å¤§é‡æ•°æ®çš„è¡¨ç¤º</p></li></ul></li></ul></li></ul></li><li><p>Redisä¸­æ˜¯åˆ©ç”¨Stringç±»å‹æ•°æ®ç»“æ„å®ç°BitMapï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯ 2^32ä¸ªbitä½</p></li></ul><h3 id="BitMapçš„æ“ä½œå‘½ä»¤"><a href="#BitMapçš„æ“ä½œå‘½ä»¤" class="headerlink" title="BitMapçš„æ“ä½œå‘½ä»¤"></a>BitMapçš„æ“ä½œå‘½ä»¤</h3><ul><li><code>SETBIT</code>ï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li><li><code>GETBIT </code>ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li><li><code>BITCOUNT</code> ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li><li><code>BITFIELD</code> ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼ï¼ˆä¸€èˆ¬éƒ½ç”¨ä½œæŸ¥è¯¢ï¼‰</li><li><code>BITFIELD_RO</code> ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li><li><code>BITOP</code> ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ ã€æˆ–ã€å¼‚æˆ–ï¼‰</li><li><code>BITPOS</code>ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li></ul><h2 id="å®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½"><a href="#å®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½" class="headerlink" title="å®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½"></a>å®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½</h2><ol><li>éœ€æ±‚<ul><li>å®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/6wkTK9svhFqYouW.png" alt="img" style="zoom:50%;" /></li></ul></li><li>æ€è·¯<ul><li>æˆ‘ä»¬å¯ä»¥æŠŠå¹´å’Œæœˆä½œä¸º<code>bitMap</code>çš„keyï¼Œç„¶åä¿å­˜åˆ°ä¸€ä¸ªbitMapä¸­ï¼Œæ¯æ¬¡ç­¾åˆ°å°±åˆ°å¯¹åº”çš„ä½ä¸ŠæŠŠæ•°å­—ä»0å˜æˆ1ï¼Œåªè¦å¯¹åº”æ˜¯1ï¼Œå°±è¡¨æ˜è¯´æ˜è¿™ä¸€å¤©å·²ç»ç­¾åˆ°äº†ï¼Œåä¹‹åˆ™æ²¡æœ‰ç­¾åˆ°</li><li>é€šè¿‡æ¥å£æ–‡æ¡£å‘ç°ï¼Œæ­¤æ¥å£å¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•çš„å‚æ•°ï¼Œæ²¡æœ‰å‚æ•°æ€ä¹ˆç¡®å®æ˜¯å“ªä¸€å¤©ç­¾åˆ°å‘¢ï¼Ÿè¿™ä¸ªå¾ˆå®¹æ˜“ï¼Œå¯ä»¥é€šè¿‡åå°ä»£ç ç›´æ¥è·å–å³å¯ï¼Œç„¶ååˆ°å¯¹åº”çš„åœ°å€ä¸Šå»ä¿®æ”¹<code>bitMap</code></li></ul></li><li>ä»£ç å¦‚ä¸‹</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="keyword">if</span> (userDTO == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.LOGIN_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–key</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> userDTO.getId();</span><br><span class="line">    <span class="comment">//å½“å¤©æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyy-MM&quot;</span>).format(now);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//å½“å¤©åœ¨è¯¥æœˆç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç­¾åˆ°ç»Ÿè®¡"><a href="#ç­¾åˆ°ç»Ÿè®¡" class="headerlink" title="ç­¾åˆ°ç»Ÿè®¡"></a>ç­¾åˆ°ç»Ÿè®¡</h2><ol><li><p>ä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ</p><ul><li>ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°</li></ul></li><li><p>Javaé€»è¾‘ä»£ç </p><ul><li>è·å¾—å½“å‰è¿™ä¸ªæœˆçš„æœ€åä¸€æ¬¡ç­¾åˆ°æ•°æ®ï¼Œå®šä¹‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åä¸åœçš„å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°è·å¾—ç¬¬ä¸€ä¸ªé0çš„æ•°å­—å³å¯ï¼Œæ¯å¾—åˆ°ä¸€ä¸ªé0çš„æ•°å­—è®¡æ•°å™¨+1ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œå°±å¯ä»¥è·å¾—å½“å‰æœˆçš„ç­¾åˆ°æ€»å¤©æ•°äº†</li></ul></li><li><p>å¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ</p><ul><li>å‘½ä»¤<code>  BITFIELD key GET u[dayOfMonth] 0</code></li><li>å‡è®¾ä»Šå¤©æ˜¯10å·ï¼Œé‚£ä¹ˆä»å½“å‰æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œè·å¾—åˆ°å½“å‰è¿™ä¸€å¤©çš„ä½æ•°ï¼Œæ˜¯10å·ï¼Œé‚£ä¹ˆå°±æ˜¯10ä½ï¼›å»æ‹¿è¿™æ®µæ—¶é—´çš„æ•°æ®ï¼Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®äº†</li></ul></li><li><p>é‚£ä¹ˆè¿™10å¤©é‡Œè¾¹ç­¾åˆ°äº†å¤šå°‘æ¬¡å‘¢ï¼Ÿ</p><ul><li>ç»Ÿè®¡æœ‰å¤šå°‘ä¸ª1å³å¯</li></ul></li><li><p>å¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ</p><ul><li><code>bitMap</code>è¿”å›çš„æ•°æ®æ˜¯10è¿›åˆ¶ï¼Œå“ªå‡å¦‚è¯´è¿”å›ä¸€ä¸ªæ•°å­—8ï¼Œé‚£ä¹ˆæˆ‘å“ªå„¿çŸ¥é“åˆ°åº•å“ªäº›æ˜¯0ï¼Œå“ªäº›æ˜¯1å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦è®©å¾—åˆ°çš„10è¿›åˆ¶æ•°å­—å’Œ1åš<strong>ä¸è¿ç®—</strong>å°±å¯ä»¥äº†</li><li>å› ä¸º1åªæœ‰é‡è§1 æ‰æ˜¯1ï¼Œå…¶ä»–æ•°å­—éƒ½æ˜¯0 ï¼Œæˆ‘ä»¬æŠŠç­¾åˆ°ç»“æœå’Œ1è¿›è¡Œ<strong>ä¸</strong>æ“ä½œï¼Œæ¯ä¸ä¸€æ¬¡ï¼Œå°±æŠŠç­¾åˆ°ç»“æœ<strong>å‘å³ç§»</strong>åŠ¨ä¸€ä½ï¼Œä¾æ¬¡å†…æ¨ï¼Œå°±èƒ½å®Œæˆé€ä¸ªéå†çš„æ•ˆæœäº†</li></ul></li><li><p>éœ€æ±‚</p><ol><li>å®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</li><li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/03/Azuv8UpeX3DYrJB.png" alt="img" style="zoom:50%;" /></li></ol></li><li><p>ä»£ç é€»è¾‘</p><ol><li>ä¸ç­¾åˆ°åŠŸèƒ½ä¸€æ ·å¾—åˆ°ç”¨æˆ·idã€keyã€dateOfMonth<ol><li>æ ¹æ®keyè·å–bitMapæ•°æ®<ol><li>é€šè¿‡&amp;å’Œ&gt;å¾—åˆ°è¿ç»­ç­¾åˆ°æ¬¡æ•°count</li><li>è¿”å›count</li></ol></li></ol></li></ol></li><li><p>å…·ä½“ä»£ç </p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="keyword">if</span> (userDTO == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(MessageConstants.LOGIN_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–key</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> userDTO.getId();</span><br><span class="line">    <span class="comment">//å½“å¤©æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyy-MM&quot;</span>).format(now);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//å½“å¤©åœ¨è¯¥æœˆç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//è·å–bitMapæ•°æ®</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue()</span><br><span class="line">        .bitField(key, BitFieldSubCommands.create()                                           .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">sign</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sign == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sign &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">        sign = sign &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ"><a href="#ä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ" class="headerlink" title="ä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ"></a>ä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ</h2><blockquote><p>å€¼å¾—ä¸€æçš„æ˜¯å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚å°±æ˜¯åŸºäºBitMap</p></blockquote><ol><li><p>å›é¡¾<strong>ç¼“å­˜ç©¿é€</strong></p><ol><li>å®¢æˆ·ç«¯å‘èµ·äº†ä¸€ä¸ªæ•°æ®åº“ä¸å­˜åœ¨ï¼ŒRedisé‡Œè¾¹ä¹Ÿä¸å­˜åœ¨çš„æ•°æ®</li><li>é€šå¸¸ä½ å¯ä»¥æŠŠè¿™ç§è¡Œä¸ºçœ‹æˆä¸€ä¸ªæ”»å‡»</li></ol></li><li><p>è§£å†³æ–¹æ¡ˆ</p><ol><li>åˆ¤æ–­id&lt;0</li><li>ç¼“å­˜ç©ºæ•°æ®</li></ol></li><li><p>é—®é¢˜</p><ul><li>ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼šé‡åˆ°çš„é—®é¢˜æ˜¯å¦‚æœç”¨æˆ·è®¿é—®çš„æ˜¯idä¸å­˜åœ¨çš„æ•°æ®ï¼Œåˆ™æ­¤æ—¶å°±æ— æ³•ç”Ÿæ•ˆ</li><li>ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆï¼šå¦‚æœæ˜¯ä¸åŒçš„idé‚£ä¸‹æ¬¡è¿‡æ¥ä¾ç„¶ç›´å‡»æ•°æ®</li></ul></li><li><p>å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p><ul><li>å°†æ•°æ®åº“ä¸­çš„IDå†™å…¥Listé›†åˆä¸­</li><li>æ¯ä¸€æ¬¡æŸ¥è¯¢åˆ¤æ–­idæ˜¯å¦åœ¨é›†åˆä¸­<ul><li>ä¸åœ¨ï¼Œç›´æ¥è¿”å›</li><li>åœ¨ï¼Œæ”¾è¡Œ</li></ul></li></ul></li><li><p>æ–°çš„é—®é¢˜æ˜¯è¿™ä¸ªä¸»é”®å¾ˆé•¿ï¼Œå ç”¨å†…å­˜</p><ol><li>æ‰€ä»¥å¦‚æœé‡‡ç”¨ä»¥ä¸Šæ–¹æ¡ˆï¼Œè¿™ä¸ªListä¹Ÿä¼šå¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>bitmap</code>æ¥å‡å°‘Listçš„å­˜å‚¨ç©ºé—´</li></ol></li><li><p>å†…å­˜é—®é¢˜çš„è§£å†³</p><ol><li>å¯ä»¥æŠŠlistæ•°æ®æŠ½è±¡æˆä¸€ä¸ªéå¸¸å¤§çš„<code>bitmap</code>ï¼Œä¸å†ä½¿ç”¨listï¼Œè€Œæ˜¯å°†dbä¸­çš„idæ•°æ®åˆ©ç”¨å“ˆå¸Œæ€æƒ³</li><li>ä¾‹å¦‚<ol><li>id % <code>bitmap.size</code>  &#x3D; xx ç®—å‡ºå½“å‰è¿™ä¸ªidåº”è¯¥è½åœ¨<code>bitmap</code>çš„å“ªä¸ªç´¢å¼•ä¸Šï¼Œç„¶åå°†è¿™ä¸ªå€¼ä»0å˜æˆ1</li><li>ç„¶åå½“ç”¨æˆ·æ¥æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ­¤æ—¶å·²ç»æ²¡æœ‰äº†Listï¼Œè®©ç”¨æˆ·ç”¨ä»–æŸ¥è¯¢çš„idå»ç”¨ç›¸åŒçš„å“ˆå¸Œç®—æ³•ï¼Œ ç®—å‡ºæ¥å½“å‰è¿™ä¸ªidåº”å½“è½åœ¨<code>bitmap</code>çš„å“ªä¸€ä½</li><li>ç„¶ååˆ¤æ–­è¿™ä¸€ä½æ˜¯0ï¼Œè¿˜æ˜¯1ï¼Œå¦‚æœæ˜¯0åˆ™è¡¨æ˜è¿™ä¸€ä½ä¸Šçš„æ•°æ®ä¸€å®šä¸å­˜åœ¨</li><li>é‡‡ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç†ï¼Œéœ€è¦é‡ç‚¹è€ƒè™‘ä¸€ä¸ªäº‹æƒ…ï¼Œå°±æ˜¯è¯¯å·®ç‡ï¼ˆæŒ‡å½“å‘ç”Ÿå“ˆå¸Œå†²çªçš„æ—¶å€™ï¼Œäº§ç”Ÿçš„è¯¯å·®ï¼‰</li><li>æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå°±æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†</li></ol></li></ol></li></ol><hr><h1 id="UVç»Ÿè®¡"><a href="#UVç»Ÿè®¡" class="headerlink" title="UVç»Ÿè®¡"></a>UVç»Ÿè®¡</h1><h2 id="HyperLogLogæ¦‚ç‡ç»Ÿè®¡ç®—æ³•"><a href="#HyperLogLogæ¦‚ç‡ç»Ÿè®¡ç®—æ³•" class="headerlink" title="HyperLogLogæ¦‚ç‡ç»Ÿè®¡ç®—æ³•"></a>HyperLogLogæ¦‚ç‡ç»Ÿè®¡ç®—æ³•</h2><blockquote><p>è¿™é‡Œä¸»è¦ç†è§£ä½•ä¸ºHyperLogLogå’ŒLogLogç»Ÿè®¡ç®—æ³•ä»¥åŠæœ‰ä½•åº”ç”¨</p><p><code>https://juejin.cn/post/6844903785744056333#heading-0</code>å¾ˆå¥½çš„è§£é‡Š</p></blockquote><ol><li><p>é¦–å…ˆææ‡‚ä¸¤ä¸ªæ¦‚å¿µ</p><ol><li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡</li><li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡</li></ol></li><li><p>é€šå¸¸æ¥è¯´UVä¼šæ¯”PVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡ä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ï¼›æ‰€ä»¥æˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠè¿™ä¸¤ä¸ªå€¼ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼</p></li><li><p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p></li><li><p><strong>Hyperloglog(HLL)<strong>æ˜¯ä»</strong>Loglog</strong>ç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•åŸç†å¯ä»¥å‚è€ƒ</p><ol><li><code>https://juejin.cn/post/6844903785744056333#heading-0</code>å†™çš„å¾ˆå¥½</li></ol></li><li><p>Redisä¸­çš„HLLæ˜¯åŸºäºStringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜<strong>æ°¸è¿œå°äº16kb</strong>ï¼Œ<strong>å†…å­˜å ç”¨ä½</strong>çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<strong>æœ‰å°äº0.81ï¼…çš„è¯¯å·®</strong>ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> é»‘é©¬å­¦ä¹ è¯¾ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
